<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.1.0"/>
    <title>test.support API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../test.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;test</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="variable" href="#PIPE_MAX_SIZE">PIPE_MAX_SIZE</a>
            </li>
            <li>
                    <a class="variable" href="#verbose">verbose</a>
            </li>
            <li>
                    <a class="variable" href="#max_memuse">max_memuse</a>
            </li>
            <li>
                    <a class="variable" href="#use_resources">use_resources</a>
            </li>
            <li>
                    <a class="variable" href="#failfast">failfast</a>
            </li>
            <li>
                    <a class="class" href="#Error">Error</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#TestFailed">TestFailed</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#TestDidNotRun">TestDidNotRun</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#ResourceDenied">ResourceDenied</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="function" href="#import_module">import_module</a>
            </li>
            <li>
                    <a class="function" href="#import_fresh_module">import_fresh_module</a>
            </li>
            <li>
                    <a class="class" href="#CleanImport">CleanImport</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#CleanImport.__init__">CleanImport</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#unload">unload</a>
            </li>
            <li>
                    <a class="function" href="#forget">forget</a>
            </li>
            <li>
                    <a class="function" href="#record_original_stdout">record_original_stdout</a>
            </li>
            <li>
                    <a class="function" href="#get_original_stdout">get_original_stdout</a>
            </li>
            <li>
                    <a class="function" href="#captured_stdout">captured_stdout</a>
            </li>
            <li>
                    <a class="function" href="#captured_stdin">captured_stdin</a>
            </li>
            <li>
                    <a class="function" href="#captured_stderr">captured_stderr</a>
            </li>
            <li>
                    <a class="variable" href="#TESTFN">TESTFN</a>
            </li>
            <li>
                    <a class="variable" href="#SAVEDCWD">SAVEDCWD</a>
            </li>
            <li>
                    <a class="function" href="#unlink">unlink</a>
            </li>
            <li>
                    <a class="function" href="#rmtree">rmtree</a>
            </li>
            <li>
                    <a class="function" href="#temp_cwd">temp_cwd</a>
            </li>
            <li>
                    <a class="function" href="#findfile">findfile</a>
            </li>
            <li>
                    <a class="function" href="#create_empty_file">create_empty_file</a>
            </li>
            <li>
                    <a class="function" href="#can_symlink">can_symlink</a>
            </li>
            <li>
                    <a class="function" href="#fs_is_case_insensitive">fs_is_case_insensitive</a>
            </li>
            <li>
                    <a class="function" href="#is_resource_enabled">is_resource_enabled</a>
            </li>
            <li>
                    <a class="function" href="#requires">requires</a>
            </li>
            <li>
                    <a class="function" href="#requires_freebsd_version">requires_freebsd_version</a>
            </li>
            <li>
                    <a class="function" href="#requires_linux_version">requires_linux_version</a>
            </li>
            <li>
                    <a class="function" href="#requires_mac_ver">requires_mac_ver</a>
            </li>
            <li>
                    <a class="function" href="#requires_hashdigest">requires_hashdigest</a>
            </li>
            <li>
                    <a class="function" href="#check_syntax_error">check_syntax_error</a>
            </li>
            <li>
                    <a class="function" href="#check_syntax_warning">check_syntax_warning</a>
            </li>
            <li>
                    <a class="class" href="#TransientResource">TransientResource</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TransientResource.__init__">TransientResource</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="variable" href="#time_out">time_out</a>
            </li>
            <li>
                    <a class="variable" href="#socket_peer_reset">socket_peer_reset</a>
            </li>
            <li>
                    <a class="variable" href="#ioerror_peer_reset">ioerror_peer_reset</a>
            </li>
            <li>
                    <a class="function" href="#transient_internet">transient_internet</a>
            </li>
            <li>
                    <a class="class" href="#BasicTestRunner">BasicTestRunner</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#BasicTestRunner.__init__">BasicTestRunner</a>
                        </li>
                        <li>
                                <a class="function" href="#BasicTestRunner.run">run</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#run_unittest">run_unittest</a>
            </li>
            <li>
                    <a class="function" href="#run_doctest">run_doctest</a>
            </li>
            <li>
                    <a class="function" href="#skip_unless_symlink">skip_unless_symlink</a>
            </li>
            <li>
                    <a class="function" href="#requires_gzip">requires_gzip</a>
            </li>
            <li>
                    <a class="function" href="#requires_bz2">requires_bz2</a>
            </li>
            <li>
                    <a class="function" href="#requires_lzma">requires_lzma</a>
            </li>
            <li>
                    <a class="function" href="#bigmemtest">bigmemtest</a>
            </li>
            <li>
                    <a class="function" href="#bigaddrspacetest">bigaddrspacetest</a>
            </li>
            <li>
                    <a class="function" href="#cpython_only">cpython_only</a>
            </li>
            <li>
                    <a class="function" href="#get_attribute">get_attribute</a>
            </li>
            <li>
                    <a class="function" href="#requires_IEEE_754">requires_IEEE_754</a>
            </li>
            <li>
                    <a class="function" href="#skip_unless_xattr">skip_unless_xattr</a>
            </li>
            <li>
                    <a class="function" href="#requires_zlib">requires_zlib</a>
            </li>
            <li>
                    <a class="function" href="#anticipate_failure">anticipate_failure</a>
            </li>
            <li>
                    <a class="function" href="#load_package_tests">load_package_tests</a>
            </li>
            <li>
                    <a class="function" href="#detect_api_mismatch">detect_api_mismatch</a>
            </li>
            <li>
                    <a class="function" href="#check__all__">check__all__</a>
            </li>
            <li>
                    <a class="function" href="#skip_unless_bind_unix_socket">skip_unless_bind_unix_socket</a>
            </li>
            <li>
                    <a class="function" href="#skip_if_buggy_ucrt_strfptime">skip_if_buggy_ucrt_strfptime</a>
            </li>
            <li>
                    <a class="function" href="#ignore_warnings">ignore_warnings</a>
            </li>
            <li>
                    <a class="variable" href="#is_jython">is_jython</a>
            </li>
            <li>
                    <a class="variable" href="#is_android">is_android</a>
            </li>
            <li>
                    <a class="function" href="#check_impl_detail">check_impl_detail</a>
            </li>
            <li>
                    <a class="variable" href="#unix_shell">unix_shell</a>
            </li>
            <li>
                    <a class="function" href="#setswitchinterval">setswitchinterval</a>
            </li>
            <li>
                    <a class="variable" href="#HOST">HOST</a>
            </li>
            <li>
                    <a class="variable" href="#IPV6_ENABLED">IPV6_ENABLED</a>
            </li>
            <li>
                    <a class="function" href="#find_unused_port">find_unused_port</a>
            </li>
            <li>
                    <a class="function" href="#bind_port">bind_port</a>
            </li>
            <li>
                    <a class="function" href="#open_urlresource">open_urlresource</a>
            </li>
            <li>
                    <a class="function" href="#bind_unix_socket">bind_unix_socket</a>
            </li>
            <li>
                    <a class="function" href="#temp_umask">temp_umask</a>
            </li>
            <li>
                    <a class="function" href="#reap_children">reap_children</a>
            </li>
            <li>
                    <a class="class" href="#TestHandler">TestHandler</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TestHandler.__init__">TestHandler</a>
                        </li>
                        <li>
                                <a class="function" href="#TestHandler.shouldFlush">shouldFlush</a>
                        </li>
                        <li>
                                <a class="function" href="#TestHandler.emit">emit</a>
                        </li>
                        <li>
                                <a class="function" href="#TestHandler.matches">matches</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#threading_setup">threading_setup</a>
            </li>
            <li>
                    <a class="function" href="#threading_cleanup">threading_cleanup</a>
            </li>
            <li>
                    <a class="function" href="#reap_threads">reap_threads</a>
            </li>
            <li>
                    <a class="function" href="#start_threads">start_threads</a>
            </li>
            <li>
                    <a class="function" href="#check_warnings">check_warnings</a>
            </li>
            <li>
                    <a class="function" href="#check_no_resource_warning">check_no_resource_warning</a>
            </li>
            <li>
                    <a class="function" href="#check_no_warnings">check_no_warnings</a>
            </li>
            <li>
                    <a class="class" href="#EnvironmentVarGuard">EnvironmentVarGuard</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EnvironmentVarGuard.__init__">EnvironmentVarGuard</a>
                        </li>
                        <li>
                                <a class="function" href="#EnvironmentVarGuard.keys">keys</a>
                        </li>
                        <li>
                                <a class="function" href="#EnvironmentVarGuard.set">set</a>
                        </li>
                        <li>
                                <a class="function" href="#EnvironmentVarGuard.unset">unset</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#run_with_locale">run_with_locale</a>
            </li>
            <li>
                    <a class="function" href="#swap_item">swap_item</a>
            </li>
            <li>
                    <a class="function" href="#swap_attr">swap_attr</a>
            </li>
            <li>
                    <a class="class" href="#Matcher">Matcher</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Matcher.__init__">Matcher</a>
                        </li>
                        <li>
                                <a class="function" href="#Matcher.matches">matches</a>
                        </li>
                        <li>
                                <a class="function" href="#Matcher.match_value">match_value</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#set_memlimit">set_memlimit</a>
            </li>
            <li>
                    <a class="class" href="#SuppressCrashReport">SuppressCrashReport</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SuppressCrashReport.__init__">SuppressCrashReport</a>
                        </li>
                        <li>
                                <a class="variable" href="#SuppressCrashReport.old_value">old_value</a>
                        </li>
                        <li>
                                <a class="variable" href="#SuppressCrashReport.old_modes">old_modes</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#sortdict">sortdict</a>
            </li>
            <li>
                    <a class="function" href="#run_with_tz">run_with_tz</a>
            </li>
            <li>
                    <a class="variable" href="#PGO">PGO</a>
            </li>
            <li>
                    <a class="function" href="#missing_compiler_executable">missing_compiler_executable</a>
            </li>
            <li>
                    <a class="function" href="#fd_count">fd_count</a>
            </li>
            <li>
                    <a class="variable" href="#ALWAYS_EQ">ALWAYS_EQ</a>
            </li>
            <li>
                    <a class="variable" href="#LARGEST">LARGEST</a>
            </li>
            <li>
                    <a class="variable" href="#SMALLEST">SMALLEST</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../test.html">test</a><wbr>.support    </h1>

                        <div class="docstring"><p>Supporting definitions for the Python regression tests.</p>
</div>

                        <input id="support-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="support-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&quot;&quot;&quot;Supporting definitions for the Python regression tests.&quot;&quot;&quot;</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">!=</span> <span class="s1">&#39;test.support&#39;</span><span class="p">:</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a>    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;support must be imported from the test package&#39;</span><span class="p">)</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span> <span class="nn">asyncio.events</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span> <span class="nn">collections.abc</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">import</span> <span class="nn">contextlib</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span> <span class="nn">errno</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">import</span> <span class="nn">faulthandler</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">import</span> <span class="nn">fnmatch</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span> <span class="nn">functools</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">import</span> <span class="nn">gc</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">import</span> <span class="nn">glob</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a><span class="kn">import</span> <span class="nn">hashlib</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="kn">import</span> <span class="nn">importlib</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">import</span> <span class="nn">importlib.util</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">import</span> <span class="nn">locale</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="kn">import</span> <span class="nn">logging.handlers</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">import</span> <span class="nn">nntplib</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="kn">import</span> <span class="nn">platform</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a><span class="kn">import</span> <span class="nn">re</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a><span class="kn">import</span> <span class="nn">shutil</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="kn">import</span> <span class="nn">socket</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="kn">import</span> <span class="nn">stat</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a><span class="kn">import</span> <span class="nn">struct</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="kn">import</span> <span class="nn">subprocess</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a><span class="kn">import</span> <span class="nn">sys</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="kn">import</span> <span class="nn">sysconfig</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a><span class="kn">import</span> <span class="nn">tempfile</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a><span class="kn">import</span> <span class="nn">_thread</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a><span class="kn">import</span> <span class="nn">threading</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="kn">import</span> <span class="nn">time</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="kn">import</span> <span class="nn">types</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="kn">import</span> <span class="nn">unittest</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a><span class="kn">import</span> <span class="nn">urllib.error</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="kn">import</span> <span class="nn">warnings</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="kn">from</span> <span class="nn">.testresult</span> <span class="kn">import</span> <span class="n">get_test_runner</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a>    <span class="kn">import</span> <span class="nn">multiprocessing.process</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>    <span class="n">multiprocessing</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a>    <span class="kn">import</span> <span class="nn">zlib</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a>    <span class="n">zlib</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a>    <span class="kn">import</span> <span class="nn">gzip</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a>    <span class="n">gzip</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>    <span class="kn">import</span> <span class="nn">bz2</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>    <span class="n">bz2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>    <span class="kn">import</span> <span class="nn">lzma</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>    <span class="n">lzma</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>    <span class="kn">import</span> <span class="nn">resource</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a>    <span class="n">resource</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a>    <span class="kn">import</span> <span class="nn">_hashlib</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>    <span class="n">_hashlib</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>    <span class="c1"># globals</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>    <span class="s2">&quot;PIPE_MAX_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="s2">&quot;max_memuse&quot;</span><span class="p">,</span> <span class="s2">&quot;use_resources&quot;</span><span class="p">,</span> <span class="s2">&quot;failfast&quot;</span><span class="p">,</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>    <span class="c1"># exceptions</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>    <span class="s2">&quot;Error&quot;</span><span class="p">,</span> <span class="s2">&quot;TestFailed&quot;</span><span class="p">,</span> <span class="s2">&quot;TestDidNotRun&quot;</span><span class="p">,</span> <span class="s2">&quot;ResourceDenied&quot;</span><span class="p">,</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>    <span class="c1"># imports</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>    <span class="s2">&quot;import_module&quot;</span><span class="p">,</span> <span class="s2">&quot;import_fresh_module&quot;</span><span class="p">,</span> <span class="s2">&quot;CleanImport&quot;</span><span class="p">,</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>    <span class="c1"># modules</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>    <span class="s2">&quot;unload&quot;</span><span class="p">,</span> <span class="s2">&quot;forget&quot;</span><span class="p">,</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>    <span class="c1"># io</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>    <span class="s2">&quot;record_original_stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;get_original_stdout&quot;</span><span class="p">,</span> <span class="s2">&quot;captured_stdout&quot;</span><span class="p">,</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>    <span class="s2">&quot;captured_stdin&quot;</span><span class="p">,</span> <span class="s2">&quot;captured_stderr&quot;</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>    <span class="c1"># filesystem</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>    <span class="s2">&quot;TESTFN&quot;</span><span class="p">,</span> <span class="s2">&quot;SAVEDCWD&quot;</span><span class="p">,</span> <span class="s2">&quot;unlink&quot;</span><span class="p">,</span> <span class="s2">&quot;rmtree&quot;</span><span class="p">,</span> <span class="s2">&quot;temp_cwd&quot;</span><span class="p">,</span> <span class="s2">&quot;findfile&quot;</span><span class="p">,</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>    <span class="s2">&quot;create_empty_file&quot;</span><span class="p">,</span> <span class="s2">&quot;can_symlink&quot;</span><span class="p">,</span> <span class="s2">&quot;fs_is_case_insensitive&quot;</span><span class="p">,</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>    <span class="c1"># unittest</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>    <span class="s2">&quot;is_resource_enabled&quot;</span><span class="p">,</span> <span class="s2">&quot;requires&quot;</span><span class="p">,</span> <span class="s2">&quot;requires_freebsd_version&quot;</span><span class="p">,</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>    <span class="s2">&quot;requires_linux_version&quot;</span><span class="p">,</span> <span class="s2">&quot;requires_mac_ver&quot;</span><span class="p">,</span> <span class="s2">&quot;requires_hashdigest&quot;</span><span class="p">,</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>    <span class="s2">&quot;check_syntax_error&quot;</span><span class="p">,</span> <span class="s2">&quot;check_syntax_warning&quot;</span><span class="p">,</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>    <span class="s2">&quot;TransientResource&quot;</span><span class="p">,</span> <span class="s2">&quot;time_out&quot;</span><span class="p">,</span> <span class="s2">&quot;socket_peer_reset&quot;</span><span class="p">,</span> <span class="s2">&quot;ioerror_peer_reset&quot;</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>    <span class="s2">&quot;transient_internet&quot;</span><span class="p">,</span> <span class="s2">&quot;BasicTestRunner&quot;</span><span class="p">,</span> <span class="s2">&quot;run_unittest&quot;</span><span class="p">,</span> <span class="s2">&quot;run_doctest&quot;</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>    <span class="s2">&quot;skip_unless_symlink&quot;</span><span class="p">,</span> <span class="s2">&quot;requires_gzip&quot;</span><span class="p">,</span> <span class="s2">&quot;requires_bz2&quot;</span><span class="p">,</span> <span class="s2">&quot;requires_lzma&quot;</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>    <span class="s2">&quot;bigmemtest&quot;</span><span class="p">,</span> <span class="s2">&quot;bigaddrspacetest&quot;</span><span class="p">,</span> <span class="s2">&quot;cpython_only&quot;</span><span class="p">,</span> <span class="s2">&quot;get_attribute&quot;</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>    <span class="s2">&quot;requires_IEEE_754&quot;</span><span class="p">,</span> <span class="s2">&quot;skip_unless_xattr&quot;</span><span class="p">,</span> <span class="s2">&quot;requires_zlib&quot;</span><span class="p">,</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>    <span class="s2">&quot;anticipate_failure&quot;</span><span class="p">,</span> <span class="s2">&quot;load_package_tests&quot;</span><span class="p">,</span> <span class="s2">&quot;detect_api_mismatch&quot;</span><span class="p">,</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>    <span class="s2">&quot;check__all__&quot;</span><span class="p">,</span> <span class="s2">&quot;skip_unless_bind_unix_socket&quot;</span><span class="p">,</span> <span class="s2">&quot;skip_if_buggy_ucrt_strfptime&quot;</span><span class="p">,</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>    <span class="s2">&quot;ignore_warnings&quot;</span><span class="p">,</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>    <span class="c1"># sys</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>    <span class="s2">&quot;is_jython&quot;</span><span class="p">,</span> <span class="s2">&quot;is_android&quot;</span><span class="p">,</span> <span class="s2">&quot;check_impl_detail&quot;</span><span class="p">,</span> <span class="s2">&quot;unix_shell&quot;</span><span class="p">,</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>    <span class="s2">&quot;setswitchinterval&quot;</span><span class="p">,</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>    <span class="c1"># network</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>    <span class="s2">&quot;HOST&quot;</span><span class="p">,</span> <span class="s2">&quot;IPV6_ENABLED&quot;</span><span class="p">,</span> <span class="s2">&quot;find_unused_port&quot;</span><span class="p">,</span> <span class="s2">&quot;bind_port&quot;</span><span class="p">,</span> <span class="s2">&quot;open_urlresource&quot;</span><span class="p">,</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>    <span class="s2">&quot;bind_unix_socket&quot;</span><span class="p">,</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>    <span class="c1"># processes</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>    <span class="s1">&#39;temp_umask&#39;</span><span class="p">,</span> <span class="s2">&quot;reap_children&quot;</span><span class="p">,</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>    <span class="c1"># logging</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>    <span class="s2">&quot;TestHandler&quot;</span><span class="p">,</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>    <span class="c1"># threads</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>    <span class="s2">&quot;threading_setup&quot;</span><span class="p">,</span> <span class="s2">&quot;threading_cleanup&quot;</span><span class="p">,</span> <span class="s2">&quot;reap_threads&quot;</span><span class="p">,</span> <span class="s2">&quot;start_threads&quot;</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>    <span class="c1"># miscellaneous</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>    <span class="s2">&quot;check_warnings&quot;</span><span class="p">,</span> <span class="s2">&quot;check_no_resource_warning&quot;</span><span class="p">,</span> <span class="s2">&quot;check_no_warnings&quot;</span><span class="p">,</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>    <span class="s2">&quot;EnvironmentVarGuard&quot;</span><span class="p">,</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>    <span class="s2">&quot;run_with_locale&quot;</span><span class="p">,</span> <span class="s2">&quot;swap_item&quot;</span><span class="p">,</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>    <span class="s2">&quot;swap_attr&quot;</span><span class="p">,</span> <span class="s2">&quot;Matcher&quot;</span><span class="p">,</span> <span class="s2">&quot;set_memlimit&quot;</span><span class="p">,</span> <span class="s2">&quot;SuppressCrashReport&quot;</span><span class="p">,</span> <span class="s2">&quot;sortdict&quot;</span><span class="p">,</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>    <span class="s2">&quot;run_with_tz&quot;</span><span class="p">,</span> <span class="s2">&quot;PGO&quot;</span><span class="p">,</span> <span class="s2">&quot;missing_compiler_executable&quot;</span><span class="p">,</span> <span class="s2">&quot;fd_count&quot;</span><span class="p">,</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>    <span class="s2">&quot;ALWAYS_EQ&quot;</span><span class="p">,</span> <span class="s2">&quot;LARGEST&quot;</span><span class="p">,</span> <span class="s2">&quot;SMALLEST&quot;</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>    <span class="p">]</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>    <span class="sd">&quot;&quot;&quot;Base class for regression test exceptions.&quot;&quot;&quot;</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="k">class</span> <span class="nc">TestFailed</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>    <span class="sd">&quot;&quot;&quot;Test failed.&quot;&quot;&quot;</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="k">class</span> <span class="nc">TestDidNotRun</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>    <span class="sd">&quot;&quot;&quot;Test did not run any subtests.&quot;&quot;&quot;</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="k">class</span> <span class="nc">ResourceDenied</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">):</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>    <span class="sd">&quot;&quot;&quot;Test skipped because it requested a disallowed resource.</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">    This is raised when a test calls requires() for a resource that</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">    has not be enabled.  It is used to distinguish between expected</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">    and unexpected skips.</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="k">def</span> <span class="nf">_ignore_deprecated_imports</span><span class="p">(</span><span class="n">ignore</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a>    <span class="sd">&quot;&quot;&quot;Context manager to suppress package and module deprecation</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">    warnings when importing them.</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">    If ignore is False, this context manager has no effect.</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>    <span class="k">if</span> <span class="n">ignore</span><span class="p">:</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="s2">&quot;.+ (module|package)&quot;</span><span class="p">,</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a>                                    <span class="ne">DeprecationWarning</span><span class="p">)</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a>            <span class="k">yield</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a>        <span class="k">yield</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="k">def</span> <span class="nf">ignore_warnings</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a>    <span class="sd">&quot;&quot;&quot;Decorator to suppress deprecation warnings.</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">    Use of context managers to hide warnings make diffs</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">    more noisy and tools like &#39;git blame&#39; less useful.</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a>        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a>                <span class="k">return</span> <span class="n">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="k">def</span> <span class="nf">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">deprecated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">required_on</span><span class="o">=</span><span class="p">()):</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>    <span class="sd">&quot;&quot;&quot;Import and return the module to be tested, raising SkipTest if</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">    it is not available.</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">    If deprecated is True, any module or package deprecation messages</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="sd">    will be suppressed. If a module is required on a platform but optional for</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">    others, set required_on to an iterable of platform prefixes which will be</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">    compared against sys.platform.</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a>    <span class="k">with</span> <span class="n">_ignore_deprecated_imports</span><span class="p">(</span><span class="n">deprecated</span><span class="p">):</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a>            <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a>        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">required_on</span><span class="p">)):</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>                <span class="k">raise</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="k">def</span> <span class="nf">_save_and_remove_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">):</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>    <span class="sd">&quot;&quot;&quot;Helper function to save and remove a module from sys.modules</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">    Raise ImportError if the module can&#39;t be imported.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>    <span class="c1"># try to import the module and raise an error if it can&#39;t be imported</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>        <span class="nb">__import__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>    <span class="k">for</span> <span class="n">modname</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">):</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>        <span class="k">if</span> <span class="n">modname</span> <span class="o">==</span> <span class="n">name</span> <span class="ow">or</span> <span class="n">modname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">):</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>            <span class="n">orig_modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="k">def</span> <span class="nf">_save_and_block_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">):</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>    <span class="sd">&quot;&quot;&quot;Helper function to save and block a module in sys.modules</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">    Return True if the module was in sys.modules, False otherwise.</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>    <span class="n">saved</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>        <span class="n">orig_modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>        <span class="n">saved</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>    <span class="k">return</span> <span class="n">saved</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="k">def</span> <span class="nf">anticipate_failure</span><span class="p">(</span><span class="n">condition</span><span class="p">):</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>    <span class="sd">&quot;&quot;&quot;Decorator to mark a test that is known to be broken in some cases</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">       Any use of this decorator should have a comment identifying the</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">       associated tracker issue.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>    <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">expectedFailure</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>    <span class="k">return</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="k">def</span> <span class="nf">load_package_tests</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">standard_tests</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>    <span class="sd">&quot;&quot;&quot;Generic load_tests implementation for simple test packages.</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a><span class="sd">    Most packages can implement load_tests using this function as follows:</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a><span class="sd">       def load_tests(*args):</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a><span class="sd">           return load_package_tests(os.path.dirname(__file__), *args)</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>    <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>        <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;test*&quot;</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>    <span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>              <span class="c1"># Lib</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>              <span class="c1"># test</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>                      <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>   <span class="c1"># support</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>    <span class="n">package_tests</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span><span class="n">start_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">,</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>                                    <span class="n">top_level_dir</span><span class="o">=</span><span class="n">top_dir</span><span class="p">,</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>                                    <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">)</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>    <span class="n">standard_tests</span><span class="o">.</span><span class="n">addTests</span><span class="p">(</span><span class="n">package_tests</span><span class="p">)</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>    <span class="k">return</span> <span class="n">standard_tests</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a><span class="k">def</span> <span class="nf">import_fresh_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="p">(),</span> <span class="n">blocked</span><span class="o">=</span><span class="p">(),</span> <span class="n">deprecated</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>    <span class="sd">&quot;&quot;&quot;Import and return a module, deliberately bypassing sys.modules.</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a><span class="sd">    This function imports and returns a fresh copy of the named Python module</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a><span class="sd">    by removing the named module from sys.modules before doing the import.</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a><span class="sd">    Note that unlike reload, the original module is not affected by</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a><span class="sd">    this operation.</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a><span class="sd">    *fresh* is an iterable of additional module names that are also removed</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a><span class="sd">    from the sys.modules cache before doing the import.</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a><span class="sd">    *blocked* is an iterable of module names that are replaced with None</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a><span class="sd">    in the module cache during the import to ensure that attempts to import</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a><span class="sd">    them raise ImportError.</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="sd">    The named module and any modules named in the *fresh* and *blocked*</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="sd">    parameters are saved before starting the import and then reinserted into</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="sd">    sys.modules when the fresh import is complete.</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">    Module and package deprecation messages are suppressed during this import</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">    if *deprecated* is True.</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">    This function will raise ImportError if the named module cannot be</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">    imported.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>    <span class="c1"># NOTE: test_heapq, test_json and test_warnings include extra sanity checks</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>    <span class="c1"># to make sure that this utility function is working as expected</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>    <span class="k">with</span> <span class="n">_ignore_deprecated_imports</span><span class="p">(</span><span class="n">deprecated</span><span class="p">):</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>        <span class="c1"># Keep track of modules saved for later restoration as well</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="c1"># as those which just need a blocking entry removed</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="n">orig_modules</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>        <span class="n">names_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>        <span class="n">_save_and_remove_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">)</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>            <span class="k">for</span> <span class="n">fresh_name</span> <span class="ow">in</span> <span class="n">fresh</span><span class="p">:</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>                <span class="n">_save_and_remove_module</span><span class="p">(</span><span class="n">fresh_name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">)</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>            <span class="k">for</span> <span class="n">blocked_name</span> <span class="ow">in</span> <span class="n">blocked</span><span class="p">:</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">_save_and_block_module</span><span class="p">(</span><span class="n">blocked_name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">):</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>                    <span class="n">names_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blocked_name</span><span class="p">)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>            <span class="n">fresh_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>            <span class="n">fresh_module</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>            <span class="k">for</span> <span class="n">orig_name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">orig_modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">orig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>            <span class="k">for</span> <span class="n">name_to_remove</span> <span class="ow">in</span> <span class="n">names_to_remove</span><span class="p">:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>                <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name_to_remove</span><span class="p">]</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>        <span class="k">return</span> <span class="n">fresh_module</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a><span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>    <span class="sd">&quot;&quot;&quot;Get an attribute, raising SkipTest if AttributeError is raised.&quot;&quot;&quot;</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>        <span class="n">attribute</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;object </span><span class="si">%r</span><span class="s2"> has no attribute </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>        <span class="k">return</span> <span class="n">attribute</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a><span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span>              <span class="c1"># Flag set to 0 by regrtest.py</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a><span class="n">use_resources</span> <span class="o">=</span> <span class="kc">None</span>     <span class="c1"># Flag set to [] by regrtest.py</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a><span class="n">max_memuse</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c1"># Disable bigmem tests (they will still be run with</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>                         <span class="c1"># small sizes, to make sure they work.)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="n">real_max_memuse</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="n">junit_xml_list</span> <span class="o">=</span> <span class="kc">None</span>    <span class="c1"># list of testsuite XML elements</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="n">failfast</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="c1"># _original_stdout is meant to hold stdout at the time regrtest began.</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a><span class="c1"># This may be &quot;the real&quot; stdout, or IDLE&#39;s emulation of stdout, or whatever.</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a><span class="c1"># The point is to have some flavor of stdout the user can actually see.</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="n">_original_stdout</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a><span class="k">def</span> <span class="nf">record_original_stdout</span><span class="p">(</span><span class="n">stdout</span><span class="p">):</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>    <span class="k">global</span> <span class="n">_original_stdout</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>    <span class="n">_original_stdout</span> <span class="o">=</span> <span class="n">stdout</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="k">def</span> <span class="nf">get_original_stdout</span><span class="p">():</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>    <span class="k">return</span> <span class="n">_original_stdout</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="k">def</span> <span class="nf">unload</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>        <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>        <span class="k">pass</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="k">def</span> <span class="nf">_force_run</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">err</span><span class="p">))</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;re-run </span><span class="si">%s%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">args</span><span class="p">))</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span><span class="p">)</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;win&quot;</span><span class="p">):</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>    <span class="k">def</span> <span class="nf">_waitfor</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">pathname</span><span class="p">,</span> <span class="n">waitall</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>        <span class="c1"># Perform the operation</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>        <span class="n">func</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>        <span class="c1"># Now setup the wait loop</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>        <span class="k">if</span> <span class="n">waitall</span><span class="p">:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>            <span class="n">dirname</span> <span class="o">=</span> <span class="n">pathname</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>            <span class="n">dirname</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>            <span class="n">dirname</span> <span class="o">=</span> <span class="n">dirname</span> <span class="ow">or</span> <span class="s1">&#39;.&#39;</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>        <span class="c1"># Check for `pathname` to be removed from the filesystem.</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>        <span class="c1"># The exponential backoff of the timeout amounts to a total</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>        <span class="c1"># of ~1 second after which the deletion is probably an error</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        <span class="c1"># anyway.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>        <span class="c1"># Testing on an i7@4.3GHz shows that usually only 1 iteration is</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>        <span class="c1"># required when contention occurs.</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>        <span class="n">timeout</span> <span class="o">=</span> <span class="mf">0.001</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>        <span class="k">while</span> <span class="n">timeout</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>            <span class="c1"># Note we are only testing for the existence of the file(s) in</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>            <span class="c1"># the contents of the directory regardless of any security or</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>            <span class="c1"># access rights.  If we have made it this far, we have sufficient</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>            <span class="c1"># permissions to do that much using Python&#39;s equivalent of the</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>            <span class="c1"># Windows API FindFirstFile.</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>            <span class="c1"># Other Windows APIs can fail or give incorrect results when</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>            <span class="c1"># dealing with files that are pending deletion.</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>            <span class="n">L</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">L</span> <span class="k">if</span> <span class="n">waitall</span> <span class="k">else</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">L</span><span class="p">):</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                <span class="k">return</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>            <span class="c1"># Increase the timeout and try again</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>            <span class="n">timeout</span> <span class="o">*=</span> <span class="mi">2</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;tests may fail, delete still pending for &#39;</span> <span class="o">+</span> <span class="n">pathname</span><span class="p">,</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>                      <span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>    <span class="k">def</span> <span class="nf">_unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>        <span class="n">_waitfor</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>    <span class="k">def</span> <span class="nf">_rmdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>        <span class="n">_waitfor</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>    <span class="k">def</span> <span class="nf">_rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>        <span class="k">def</span> <span class="nf">_rmtree_inner</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_force_run</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                <span class="n">fullname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>                    <span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;support.rmtree(): os.lstat(</span><span class="si">%r</span><span class="s2">) failed with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">exc</span><span class="p">),</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>                          <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>                    <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>                    <span class="n">_waitfor</span><span class="p">(</span><span class="n">_rmtree_inner</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">waitall</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>                    <span class="n">_force_run</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>                    <span class="n">_force_run</span><span class="p">(</span><span class="n">fullname</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>        <span class="n">_waitfor</span><span class="p">(</span><span class="n">_rmtree_inner</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">waitall</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>        <span class="n">_waitfor</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">_force_run</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">,</span> <span class="n">p</span><span class="p">),</span> <span class="n">path</span><span class="p">)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>    <span class="k">def</span> <span class="nf">_longpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>            <span class="kn">import</span> <span class="nn">ctypes</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>            <span class="c1"># No ctypes means we can&#39;t expands paths.</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>            <span class="k">pass</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>            <span class="n">buffer</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">create_unicode_buffer</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>            <span class="n">length</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetLongPathNameW</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>                                                             <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>            <span class="k">if</span> <span class="n">length</span><span class="p">:</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>                <span class="k">return</span> <span class="n">buffer</span><span class="p">[:</span><span class="n">length</span><span class="p">]</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>        <span class="k">return</span> <span class="n">path</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="k">else</span><span class="p">:</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>    <span class="n">_unlink</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>    <span class="n">_rmdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>    <span class="k">def</span> <span class="nf">_rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>            <span class="k">return</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>            <span class="k">pass</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>        <span class="k">def</span> <span class="nf">_rmtree_inner</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_force_run</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>                <span class="n">fullname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>                    <span class="n">mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span><span class="o">.</span><span class="n">st_mode</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>                    <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>                <span class="k">if</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>                    <span class="n">_rmtree_inner</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>                    <span class="n">_force_run</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>                    <span class="n">_force_run</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>        <span class="n">_rmtree_inner</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>    <span class="k">def</span> <span class="nf">_longpath</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>        <span class="k">return</span> <span class="n">path</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>        <span class="n">_unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>    <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">NotADirectoryError</span><span class="p">):</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        <span class="k">pass</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a><span class="k">def</span> <span class="nf">rmdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">):</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>        <span class="n">_rmdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">)</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>        <span class="k">pass</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="k">def</span> <span class="nf">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>        <span class="n">_rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>        <span class="k">pass</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="k">def</span> <span class="nf">make_legacy_pyc</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>    <span class="sd">&quot;&quot;&quot;Move a PEP 3147/488 pyc file to its legacy pyc location.</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">    :param source: The file system path to the source file.  The source file</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">        does not need to exist, however the PEP 3147/488 pyc file must exist.</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a><span class="sd">    :return: The file system path to the legacy pyc file.</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a>    <span class="n">pyc_file</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">cache_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a>    <span class="n">up_one</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>    <span class="n">legacy_pyc</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">up_one</span><span class="p">,</span> <span class="n">source</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">pyc_file</span><span class="p">,</span> <span class="n">legacy_pyc</span><span class="p">)</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a>    <span class="k">return</span> <span class="n">legacy_pyc</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="n">modname</span><span class="p">):</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a>    <span class="sd">&quot;&quot;&quot;&#39;Forget&#39; a module was ever imported.</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">    This removes the module from sys.modules and deletes any PEP 3147/488 or</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">    legacy .pyc files.</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a>    <span class="n">unload</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a>    <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a>        <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">modname</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a>        <span class="c1"># It doesn&#39;t matter if they exist or not, unlink all possible</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a>        <span class="c1"># combinations of PEP 3147/488 and legacy pyc files.</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a>        <span class="n">unlink</span><span class="p">(</span><span class="n">source</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a>        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a>            <span class="n">unlink</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">cache_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">optimization</span><span class="o">=</span><span class="n">opt</span><span class="p">))</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="c1"># Check whether a gui is actually available</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="k">def</span> <span class="nf">_is_gui_available</span><span class="p">():</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">_is_gui_available</span><span class="p">,</span> <span class="s1">&#39;result&#39;</span><span class="p">):</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a>        <span class="k">return</span> <span class="n">_is_gui_available</span><span class="o">.</span><span class="n">result</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a>    <span class="n">reason</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a>    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">):</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>        <span class="c1"># if Python is running as a service (such as the buildbot service),</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>        <span class="c1"># gui interaction may be disallowed</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>        <span class="kn">import</span> <span class="nn">ctypes</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>        <span class="kn">import</span> <span class="nn">ctypes.wintypes</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>        <span class="n">UOI_FLAGS</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>        <span class="n">WSF_VISIBLE</span> <span class="o">=</span> <span class="mh">0x0001</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>        <span class="k">class</span> <span class="nc">USEROBJECTFLAGS</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">Structure</span><span class="p">):</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>            <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;fInherit&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span><span class="p">),</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>                        <span class="p">(</span><span class="s2">&quot;fReserved&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">BOOL</span><span class="p">),</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>                        <span class="p">(</span><span class="s2">&quot;dwFlags&quot;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">)]</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>        <span class="n">dll</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">windll</span><span class="o">.</span><span class="n">user32</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>        <span class="n">h</span> <span class="o">=</span> <span class="n">dll</span><span class="o">.</span><span class="n">GetProcessWindowStation</span><span class="p">()</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">h</span><span class="p">:</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>            <span class="k">raise</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">WinError</span><span class="p">()</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>        <span class="n">uof</span> <span class="o">=</span> <span class="n">USEROBJECTFLAGS</span><span class="p">()</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="n">needed</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">wintypes</span><span class="o">.</span><span class="n">DWORD</span><span class="p">()</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>        <span class="n">res</span> <span class="o">=</span> <span class="n">dll</span><span class="o">.</span><span class="n">GetUserObjectInformationW</span><span class="p">(</span><span class="n">h</span><span class="p">,</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>            <span class="n">UOI_FLAGS</span><span class="p">,</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>            <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">uof</span><span class="p">),</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>            <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="n">uof</span><span class="p">),</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>            <span class="n">ctypes</span><span class="o">.</span><span class="n">byref</span><span class="p">(</span><span class="n">needed</span><span class="p">))</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>            <span class="k">raise</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">WinError</span><span class="p">()</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">uof</span><span class="o">.</span><span class="n">dwFlags</span> <span class="o">&amp;</span> <span class="n">WSF_VISIBLE</span><span class="p">):</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;gui not available (WSF_VISIBLE flag not set)&quot;</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>        <span class="c1"># The Aqua Tk implementations on OS X can abort the process if</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>        <span class="c1"># being called in an environment where a window server connection</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>        <span class="c1"># cannot be made, for instance when invoked by a buildbot or ssh</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="c1"># process not running under the same user id as the current console</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>        <span class="c1"># user.  To avoid that, raise an exception if the window manager</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="c1"># connection is not available.</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>        <span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">cdll</span><span class="p">,</span> <span class="n">c_int</span><span class="p">,</span> <span class="n">pointer</span><span class="p">,</span> <span class="n">Structure</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>        <span class="kn">from</span> <span class="nn">ctypes.util</span> <span class="kn">import</span> <span class="n">find_library</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>        <span class="n">app_services</span> <span class="o">=</span> <span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">find_library</span><span class="p">(</span><span class="s2">&quot;ApplicationServices&quot;</span><span class="p">))</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>        <span class="k">if</span> <span class="n">app_services</span><span class="o">.</span><span class="n">CGMainDisplayID</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>            <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;gui tests cannot run without OS X window manager&quot;</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>            <span class="k">class</span> <span class="nc">ProcessSerialNumber</span><span class="p">(</span><span class="n">Structure</span><span class="p">):</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;highLongOfPSN&quot;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">),</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>                            <span class="p">(</span><span class="s2">&quot;lowLongOfPSN&quot;</span><span class="p">,</span> <span class="n">c_int</span><span class="p">)]</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>            <span class="n">psn</span> <span class="o">=</span> <span class="n">ProcessSerialNumber</span><span class="p">()</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>            <span class="n">psn_p</span> <span class="o">=</span> <span class="n">pointer</span><span class="p">(</span><span class="n">psn</span><span class="p">)</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>            <span class="k">if</span> <span class="p">(</span>  <span class="p">(</span><span class="n">app_services</span><span class="o">.</span><span class="n">GetCurrentProcess</span><span class="p">(</span><span class="n">psn_p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>                  <span class="p">(</span><span class="n">app_services</span><span class="o">.</span><span class="n">SetFrontProcess</span><span class="p">(</span><span class="n">psn_p</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">):</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>                <span class="n">reason</span> <span class="o">=</span> <span class="s2">&quot;cannot run without OS X gui process&quot;</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>    <span class="c1"># check on every platform whether tkinter can actually do anything</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">reason</span><span class="p">:</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>            <span class="kn">from</span> <span class="nn">tkinter</span> <span class="kn">import</span> <span class="n">Tk</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>            <span class="n">root</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">()</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>            <span class="n">root</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>            <span class="n">root</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>            <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>            <span class="n">err_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">err_string</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                <span class="n">err_string</span> <span class="o">=</span> <span class="n">err_string</span><span class="p">[:</span><span class="mi">50</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; [...]&#39;</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>            <span class="n">reason</span> <span class="o">=</span> <span class="s1">&#39;Tk unavailable due to </span><span class="si">{}</span><span class="s1">: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>                                                           <span class="n">err_string</span><span class="p">)</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>    <span class="n">_is_gui_available</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">reason</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>    <span class="n">_is_gui_available</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">reason</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>    <span class="k">return</span> <span class="n">_is_gui_available</span><span class="o">.</span><span class="n">result</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a><span class="k">def</span> <span class="nf">is_resource_enabled</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>    <span class="sd">&quot;&quot;&quot;Test whether a resource is enabled.</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a><span class="sd">    Known resources are set by regrtest.py.  If not running under regrtest.py,</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a><span class="sd">    all resources are assumed enabled unless use_resources has been set.</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>    <span class="k">return</span> <span class="n">use_resources</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">use_resources</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a><span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>    <span class="sd">&quot;&quot;&quot;Raise ResourceDenied if the specified resource is not available.&quot;&quot;&quot;</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_resource_enabled</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Use of the </span><span class="si">%r</span><span class="s2"> resource not enabled&quot;</span> <span class="o">%</span> <span class="n">resource</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>        <span class="k">raise</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>    <span class="k">if</span> <span class="n">resource</span> <span class="o">==</span> <span class="s1">&#39;gui&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_gui_available</span><span class="p">():</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>        <span class="k">raise</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="n">_is_gui_available</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="k">def</span> <span class="nf">_requires_unix_version</span><span class="p">(</span><span class="n">sysname</span><span class="p">,</span> <span class="n">min_version</span><span class="p">):</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is `sysname` and the version is less</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">    than `min_version`.</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">    For example, @_requires_unix_version(&#39;FreeBSD&#39;, (7, 2)) raises SkipTest if</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">    the FreeBSD version is less than 7.2.</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>    <span class="kn">import</span> <span class="nn">platform</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>    <span class="n">min_version_txt</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">min_version</span><span class="p">))</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>    <span class="n">version_txt</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="n">sysname</span><span class="p">:</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>            <span class="n">version</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">version_txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>            <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>            <span class="n">skip</span> <span class="o">=</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="n">min_version</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>        <span class="n">skip</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>    <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>        <span class="n">skip</span><span class="p">,</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sysname</span><span class="si">}</span><span class="s2"> version </span><span class="si">{</span><span class="n">min_version_txt</span><span class="si">}</span><span class="s2"> or higher required, not &quot;</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">version_txt</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>    <span class="p">)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="k">def</span> <span class="nf">requires_freebsd_version</span><span class="p">(</span><span class="o">*</span><span class="n">min_version</span><span class="p">):</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is FreeBSD and the FreeBSD version is</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="sd">    less than `min_version`.</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="sd">    For example, @requires_freebsd_version(7, 2) raises SkipTest if the FreeBSD</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a><span class="sd">    version is less than 7.2.</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>    <span class="k">return</span> <span class="n">_requires_unix_version</span><span class="p">(</span><span class="s1">&#39;FreeBSD&#39;</span><span class="p">,</span> <span class="n">min_version</span><span class="p">)</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="k">def</span> <span class="nf">requires_linux_version</span><span class="p">(</span><span class="o">*</span><span class="n">min_version</span><span class="p">):</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is Linux and the Linux version is</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a><span class="sd">    less than `min_version`.</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">    For example, @requires_linux_version(2, 6, 32) raises SkipTest if the Linux</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">    version is less than 2.6.32.</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>    <span class="k">return</span> <span class="n">_requires_unix_version</span><span class="p">(</span><span class="s1">&#39;Linux&#39;</span><span class="p">,</span> <span class="n">min_version</span><span class="p">)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="k">def</span> <span class="nf">requires_mac_ver</span><span class="p">(</span><span class="o">*</span><span class="n">min_version</span><span class="p">):</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is Mac OS X and the OS X</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="sd">    version if less than min_version.</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a><span class="sd">    For example, @requires_mac_ver(10, 5) raises SkipTest if the OS X version</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a><span class="sd">    is lesser than 10.5.</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>                <span class="n">version_txt</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">mac_ver</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>                    <span class="n">version</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">version_txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                    <span class="k">pass</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>                    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="n">min_version</span><span class="p">:</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>                        <span class="n">min_version_txt</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">min_version</span><span class="p">))</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>                        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>                            <span class="s2">&quot;Mac OS X </span><span class="si">%s</span><span class="s2"> or higher required, not </span><span class="si">%s</span><span class="s2">&quot;</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>                            <span class="o">%</span> <span class="p">(</span><span class="n">min_version_txt</span><span class="p">,</span> <span class="n">version_txt</span><span class="p">))</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>        <span class="n">wrapper</span><span class="o">.</span><span class="n">min_version</span> <span class="o">=</span> <span class="n">min_version</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="k">def</span> <span class="nf">requires_hashdigest</span><span class="p">(</span><span class="n">digestname</span><span class="p">,</span> <span class="n">openssl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if a hashing algorithm is not available</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">    The hashing algorithm could be missing or blocked by a strict crypto</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">    policy.</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">    If &#39;openssl&#39; is True, then the decorator checks that OpenSSL provides</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">    the algorithm. Otherwise the check falls back to built-in</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">    implementations.</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">    ValueError: [digital envelope routines: EVP_DigestInit_ex] disabled for FIPS</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="sd">    ValueError: unsupported hash type md4</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>                <span class="k">if</span> <span class="n">openssl</span> <span class="ow">and</span> <span class="n">_hashlib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>                    <span class="n">_hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digestname</span><span class="p">)</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>                    <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digestname</span><span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                    <span class="sa">f</span><span class="s2">&quot;hash digest &#39;</span><span class="si">{</span><span class="n">digestname</span><span class="si">}</span><span class="s2">&#39; is not available.&quot;</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                <span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="n">HOST</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="n">HOSTv4</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="n">HOSTv6</span> <span class="o">=</span> <span class="s2">&quot;::1&quot;</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="k">def</span> <span class="nf">find_unused_port</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socktype</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>    <span class="sd">&quot;&quot;&quot;Returns an unused port that should be suitable for binding.  This is</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">    achieved by creating a temporary socket with the same family and type as</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">    the &#39;sock&#39; parameter (default is AF_INET, SOCK_STREAM), and binding it to</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a><span class="sd">    the specified host address (defaults to 0.0.0.0) with the port set to 0,</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">    eliciting an unused ephemeral port from the OS.  The temporary socket is</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="sd">    then closed and deleted, and the ephemeral port is returned.</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a><span class="sd">    Either this method or bind_port() should be used for any tests where a</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">    server socket needs to be bound to a particular port for the duration of</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="sd">    the test.  Which one to use depends on whether the calling code is creating</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">    a python socket, or if an unused port needs to be provided in a constructor</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">    or passed to an external program (i.e. the -accept argument to openssl&#39;s</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a><span class="sd">    s_server mode).  Always prefer bind_port() over find_unused_port() where</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a><span class="sd">    possible.  Hard coded ports should *NEVER* be used.  As soon as a server</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a><span class="sd">    socket is bound to a hard coded port, the ability to run multiple instances</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a><span class="sd">    of the test simultaneously on the same host is compromised, which makes the</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a><span class="sd">    test a ticking time bomb in a buildbot environment. On Unix buildbots, this</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a><span class="sd">    may simply manifest as a failed test, which can be recovered from without</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a><span class="sd">    intervention in most cases, but on Windows, the entire python process can</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a><span class="sd">    completely and utterly wedge, requiring someone to log in to the buildbot</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="sd">    and manually kill the affected process.</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a><span class="sd">    (This is easy to reproduce on Windows, unfortunately, and can be traced to</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a><span class="sd">    the SO_REUSEADDR socket option having different semantics on Windows versus</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="sd">    Unix/Linux.  On Unix, you can&#39;t have two AF_INET SOCK_STREAM sockets bind,</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a><span class="sd">    listen and then accept connections on identical host/ports.  An EADDRINUSE</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">    OSError will be raised at some point (depending on the platform and</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">    the order bind and listen were called on each socket).</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="sd">    However, on Windows, if SO_REUSEADDR is set on the sockets, no EADDRINUSE</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="sd">    will ever be raised when attempting to bind two identical host/ports. When</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">    accept() is called on each socket, the second caller&#39;s process will steal</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">    the port from the first caller, leaving them both in an awkwardly wedged</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">    state where they&#39;ll no longer respond to any signals or graceful kills, and</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">    must be forcibly killed via OpenProcess()/TerminateProcess().</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a><span class="sd">    The solution on Windows is to use the SO_EXCLUSIVEADDRUSE socket option</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a><span class="sd">    instead of SO_REUSEADDR, which effectively affords the same semantics as</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a><span class="sd">    SO_REUSEADDR on Unix.  Given the propensity of Unix developers in the Open</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="sd">    Source world compared to Windows ones, this is a common mistake.  A quick</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">    look over OpenSSL&#39;s 0.9.8g source shows that they use SO_REUSEADDR when</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="sd">    openssl.exe is called with the &#39;s_server&#39; option, for example. See</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">    http://bugs.python.org/issue2550 for more info.  The following site also</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">    has a very thorough description about the implications of both REUSEADDR</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">    and EXCLUSIVEADDRUSE on Windows:</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">    http://msdn2.microsoft.com/en-us/library/ms740621(VS.85).aspx)</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a><span class="sd">    XXX: although this approach is a vast improvement on previous attempts to</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">    elicit unused ports, it rests heavily on the assumption that the ephemeral</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="sd">    port returned to us by the OS won&#39;t immediately be dished back out to some</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">    other process when we close and delete our temporary socket but before our</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">    calling code has a chance to bind the returned port.  We can deal with this</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">    issue if/when we come across it.</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a>    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">socktype</span><span class="p">)</span> <span class="k">as</span> <span class="n">tempsock</span><span class="p">:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a>        <span class="n">port</span> <span class="o">=</span> <span class="n">bind_port</span><span class="p">(</span><span class="n">tempsock</span><span class="p">)</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a>    <span class="k">del</span> <span class="n">tempsock</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>    <span class="k">return</span> <span class="n">port</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a><span class="k">def</span> <span class="nf">bind_port</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">):</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>    <span class="sd">&quot;&quot;&quot;Bind the socket to a free port and return the port number.  Relies on</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">    ephemeral ports in order to ensure we are using an unbound port.  This is</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">    important as many tests may be running simultaneously, especially in a</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">    buildbot environment.  This method raises an exception if the sock.family</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">    is AF_INET and sock.type is SOCK_STREAM, *and* the socket has SO_REUSEADDR</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">    or SO_REUSEPORT set on it.  Tests should *never* set these socket options</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">    for TCP/IP sockets.  The only case for setting these options is testing</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">    multicasting via multiple UDP sockets.</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">    Additionally, if the SO_EXCLUSIVEADDRUSE socket option is available (i.e.</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">    on Windows), it will be set on the socket.  This will prevent anyone else</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">    from bind()&#39;ing to our host/port for the duration of the test.</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>    <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span> <span class="ow">and</span> <span class="n">sock</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">:</span>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;SO_REUSEADDR&#39;</span><span class="p">):</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>            <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>                <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s2">&quot;tests should never set the SO_REUSEADDR &quot;</span>   \
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>                                 <span class="s2">&quot;socket option on TCP/IP sockets!&quot;</span><span class="p">)</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;SO_REUSEPORT&#39;</span><span class="p">):</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>                <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEPORT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                    <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s2">&quot;tests should never set the SO_REUSEPORT &quot;</span>   \
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>                                     <span class="s2">&quot;socket option on TCP/IP sockets!&quot;</span><span class="p">)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                <span class="c1"># Python&#39;s socket module was compiled using modern headers</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>                <span class="c1"># thus defining SO_REUSEPORT but this process is running</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                <span class="c1"># under an older kernel that does not support SO_REUSEPORT.</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                <span class="k">pass</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;SO_EXCLUSIVEADDRUSE&#39;</span><span class="p">):</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>            <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_EXCLUSIVEADDRUSE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>    <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>    <span class="n">port</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>    <span class="k">return</span> <span class="n">port</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a><span class="k">def</span> <span class="nf">bind_unix_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>    <span class="sd">&quot;&quot;&quot;Bind a unix socket, raising SkipTest if PermissionError is raised.&quot;&quot;&quot;</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>    <span class="k">assert</span> <span class="n">sock</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>        <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s1">&#39;cannot bind AF_UNIX sockets&#39;</span><span class="p">)</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="k">def</span> <span class="nf">_is_ipv6_enabled</span><span class="p">():</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>    <span class="sd">&quot;&quot;&quot;Check whether IPv6 is enabled on this host.&quot;&quot;&quot;</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>    <span class="k">if</span> <span class="n">socket</span><span class="o">.</span><span class="n">has_ipv6</span><span class="p">:</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>        <span class="n">sock</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>            <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET6</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>            <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">HOSTv6</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>            <span class="k">pass</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>            <span class="k">if</span> <span class="n">sock</span><span class="p">:</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>                <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>    <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="n">IPV6_ENABLED</span> <span class="o">=</span> <span class="n">_is_ipv6_enabled</span><span class="p">()</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="k">def</span> <span class="nf">system_must_validate_cert</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>    <span class="sd">&quot;&quot;&quot;Skip the test on TLS certificate validation failures.&quot;&quot;&quot;</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>    <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>            <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>            <span class="k">if</span> <span class="s2">&quot;CERTIFICATE_VERIFY_FAILED&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;system does not contain &quot;</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>                                        <span class="s2">&quot;necessary certificates&quot;</span><span class="p">)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>            <span class="k">raise</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>    <span class="k">return</span> <span class="n">dec</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="c1"># A constant likely larger than the underlying OS pipe buffer size, to</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="c1"># make writes blocking.</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a><span class="c1"># Windows limit seems to be around 512 B, and many Unix kernels have a</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a><span class="c1"># 64 KiB pipe buffer size or 16 * PAGE_SIZE: take a few megs to be sure.</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a><span class="c1"># (see issue #17835 for a discussion of this number).</span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a><span class="n">PIPE_MAX_SIZE</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a><span class="c1"># A constant likely larger than the underlying OS socket buffer size, to make</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="c1"># writes blocking.</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a><span class="c1"># The socket buffer sizes can usually be tuned system-wide (e.g. through sysctl</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a><span class="c1"># on Linux), or on a per-socket basis (SO_SNDBUF/SO_RCVBUF). See issue #18643</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a><span class="c1"># for a discussion of this number).</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="n">SOCK_MAX_SIZE</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="c1"># decorator for skipping tests on non-IEEE 754 platforms</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a><span class="n">requires_IEEE_754</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>    <span class="nb">float</span><span class="o">.</span><span class="n">__getformat__</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;IEEE&quot;</span><span class="p">),</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>    <span class="s2">&quot;test requires IEEE 754 doubles&quot;</span><span class="p">)</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a><span class="n">requires_zlib</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">zlib</span><span class="p">,</span> <span class="s1">&#39;requires zlib&#39;</span><span class="p">)</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a><span class="n">requires_gzip</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">gzip</span><span class="p">,</span> <span class="s1">&#39;requires gzip&#39;</span><span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a><span class="n">requires_bz2</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">bz2</span><span class="p">,</span> <span class="s1">&#39;requires bz2&#39;</span><span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a><span class="n">requires_lzma</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">lzma</span><span class="p">,</span> <span class="s1">&#39;requires lzma&#39;</span><span class="p">)</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="n">is_jython</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;java&#39;</span><span class="p">)</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="n">is_android</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;getandroidapilevel&#39;</span><span class="p">)</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>    <span class="n">unix_shell</span> <span class="o">=</span> <span class="s1">&#39;/system/bin/sh&#39;</span> <span class="k">if</span> <span class="n">is_android</span> <span class="k">else</span> <span class="s1">&#39;/bin/sh&#39;</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="k">else</span><span class="p">:</span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>    <span class="n">unix_shell</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a><span class="c1"># Filename used for testing</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;java&#39;</span><span class="p">:</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>    <span class="c1"># Jython disallows @ in module names</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>    <span class="n">TESTFN</span> <span class="o">=</span> <span class="s1">&#39;$test&#39;</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="k">else</span><span class="p">:</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>    <span class="n">TESTFN</span> <span class="o">=</span> <span class="s1">&#39;@test&#39;</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="c1"># Disambiguate TESTFN for parallel testing, while letting it remain a valid</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="c1"># module name.</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="n">TESTFN</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">_tmp&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="c1"># Define the URL of a dedicated HTTP server for the network tests.</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="c1"># The URL must use clear-text HTTP: no redirection to encrypted HTTPS.</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="n">TEST_HTTP_URL</span> <span class="o">=</span> <span class="s2">&quot;http://www.pythontest.net&quot;</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="c1"># FS_NONASCII: non-ASCII character encodable by os.fsencode(),</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="c1"># or None if there is no such character.</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="n">FS_NONASCII</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="k">for</span> <span class="n">character</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>    <span class="c1"># First try printable and common characters to have a readable filename.</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>    <span class="c1"># For each character, the encoding list are just example of encodings able</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>    <span class="c1"># to encode the character (the list is not exhaustive).</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>    <span class="c1"># U+00E6 (Latin Small Letter Ae): cp1252, iso-8859-1</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>    <span class="s1">&#39;</span><span class="se">\u00E6</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>    <span class="c1"># U+0130 (Latin Capital Letter I With Dot Above): cp1254, iso8859_3</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>    <span class="s1">&#39;</span><span class="se">\u0130</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>    <span class="c1"># U+0141 (Latin Capital Letter L With Stroke): cp1250, cp1257</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>    <span class="s1">&#39;</span><span class="se">\u0141</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>    <span class="c1"># U+03C6 (Greek Small Letter Phi): cp1253</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>    <span class="s1">&#39;</span><span class="se">\u03C6</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>    <span class="c1"># U+041A (Cyrillic Capital Letter Ka): cp1251</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>    <span class="s1">&#39;</span><span class="se">\u041A</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>    <span class="c1"># U+05D0 (Hebrew Letter Alef): Encodable to cp424</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>    <span class="s1">&#39;</span><span class="se">\u05D0</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>    <span class="c1"># U+060C (Arabic Comma): cp864, cp1006, iso8859_6, mac_arabic</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>    <span class="s1">&#39;</span><span class="se">\u060C</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>    <span class="c1"># U+062A (Arabic Letter Teh): cp720</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>    <span class="s1">&#39;</span><span class="se">\u062A</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>    <span class="c1"># U+0E01 (Thai Character Ko Kai): cp874</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>    <span class="s1">&#39;</span><span class="se">\u0E01</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>    <span class="c1"># Then try more &quot;special&quot; characters. &quot;special&quot; because they may be</span>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>    <span class="c1"># interpreted or displayed differently depending on the exact locale</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>    <span class="c1"># encoding and the font.</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a>    <span class="c1"># U+00A0 (No-Break Space)</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a>    <span class="s1">&#39;</span><span class="se">\u00A0</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a>    <span class="c1"># U+20AC (Euro Sign)</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a>    <span class="s1">&#39;</span><span class="se">\u20AC</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="p">):</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a>        <span class="c1"># If Python is set up to use the legacy &#39;mbcs&#39; in Windows,</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>        <span class="c1"># &#39;replace&#39; error mode is used, and encode() returns b&#39;?&#39;</span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a>        <span class="c1"># for characters missing in the ANSI codepage</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">fsdecode</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">character</span><span class="p">))</span> <span class="o">!=</span> <span class="n">character</span><span class="p">:</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a>            <span class="k">raise</span> <span class="ne">UnicodeError</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a>    <span class="k">except</span> <span class="ne">UnicodeError</span><span class="p">:</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a>        <span class="k">pass</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a>        <span class="n">FS_NONASCII</span> <span class="o">=</span> <span class="n">character</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>        <span class="k">break</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="c1"># TESTFN_UNICODE is a non-ascii filename</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="n">TESTFN_UNICODE</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s2">&quot;-</span><span class="se">\xe0\xf2\u0258\u0141\u011f</span><span class="s2">&quot;</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>    <span class="c1"># In Mac OS X&#39;s VFS API file names are, by definition, canonically</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>    <span class="c1"># decomposed Unicode, encoded using UTF-8. See QA1173:</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>    <span class="c1"># http://developer.apple.com/mac/library/qa/qa2001/qa1173.html</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>    <span class="kn">import</span> <span class="nn">unicodedata</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>    <span class="n">TESTFN_UNICODE</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFD&#39;</span><span class="p">,</span> <span class="n">TESTFN_UNICODE</span><span class="p">)</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="n">TESTFN_ENCODING</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">()</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="c1"># TESTFN_UNENCODABLE is a filename (str type) that should *not* be able to be</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="c1"># encoded by the filesystem encoding (in strict mode). It can be None if we</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="c1"># cannot generate such filename.</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="n">TESTFN_UNENCODABLE</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;nt&#39;</span><span class="p">:</span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>    <span class="c1"># skip win32s (0) or Windows 9x/ME (1)</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">getwindowsversion</span><span class="p">()</span><span class="o">.</span><span class="n">platform</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>        <span class="c1"># Different kinds of characters from various languages to minimize the</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>        <span class="c1"># probability that the whole name is encodable to MBCS (issue #9819)</span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="n">TESTFN_UNENCODABLE</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s2">&quot;-</span><span class="se">\u5171\u0141\u2661\u0363\uDC80</span><span class="s2">&quot;</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>            <span class="n">TESTFN_UNENCODABLE</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">TESTFN_ENCODING</span><span class="p">)</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>            <span class="k">pass</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: The filename </span><span class="si">%r</span><span class="s1"> CAN be encoded by the filesystem encoding (</span><span class="si">%s</span><span class="s1">). &#39;</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>                  <span class="s1">&#39;Unicode filename tests may not be effective&#39;</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>                  <span class="o">%</span> <span class="p">(</span><span class="n">TESTFN_UNENCODABLE</span><span class="p">,</span> <span class="n">TESTFN_ENCODING</span><span class="p">))</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>            <span class="n">TESTFN_UNENCODABLE</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a><span class="c1"># Mac OS X denies unencodable filenames (invalid utf-8)</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a><span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>        <span class="c1"># ascii and utf-8 cannot encode the byte 0xff</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>        <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">TESTFN_ENCODING</span><span class="p">)</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>        <span class="c1"># 0xff will be encoded using the surrogate character u+DCFF</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="n">TESTFN_UNENCODABLE</span> <span class="o">=</span> <span class="n">TESTFN</span> \
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>            <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;-</span><span class="se">\xff</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">TESTFN_ENCODING</span><span class="p">,</span> <span class="s1">&#39;surrogateescape&#39;</span><span class="p">)</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="c1"># File system encoding (eg. ISO-8859-* encodings) can encode</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        <span class="c1"># the byte 0xff. Skip some unicode filename tests.</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>        <span class="k">pass</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a><span class="c1"># TESTFN_UNDECODABLE is a filename (bytes type) that should *not* be able to be</span>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a><span class="c1"># decoded from the filesystem encoding (in strict mode). It can be None if we</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a><span class="c1"># cannot generate such filename (ex: the latin1 encoding can decode any byte</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a><span class="c1"># sequence). On UNIX, TESTFN_UNDECODABLE can be decoded by os.fsdecode() thanks</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a><span class="c1"># to the surrogateescape error handler (PEP 383), but not from the filesystem</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a><span class="c1"># encoding in strict mode.</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="n">TESTFN_UNDECODABLE</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>    <span class="c1"># b&#39;\xff&#39; is not decodable by os.fsdecode() with code page 932. Windows</span>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>    <span class="c1"># accepts it to create a file or a directory, or don&#39;t accept to enter to</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>    <span class="c1"># such directory (when the bytes name is used). So test b&#39;\xe7&#39; first: it is</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>    <span class="c1"># not decodable from cp932.</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>    <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xe7</span><span class="s1">w</span><span class="se">\xf0</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>    <span class="c1"># undecodable from ASCII, UTF-8</span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>    <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xff</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>    <span class="c1"># undecodable from iso8859-3, iso8859-6, iso8859-7, cp424, iso8859-8, cp856</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>    <span class="c1"># and cp857</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>    <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xae\xd5</span><span class="s1">&#39;</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>    <span class="c1"># undecodable from UTF-8 (UNIX and Mac OS X)</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>    <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xed\xb2\x80</span><span class="s1">&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xed\xb4\x80</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>    <span class="c1"># undecodable from shift_jis, cp869, cp874, cp932, cp1250, cp1251, cp1252,</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>    <span class="c1"># cp1253, cp1254, cp1255, cp1257, cp1258</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>    <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x81\x98</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="p">):</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>        <span class="n">name</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">TESTFN_ENCODING</span><span class="p">)</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>    <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>        <span class="n">TESTFN_UNDECODABLE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fsencode</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">)</span> <span class="o">+</span> <span class="n">name</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>        <span class="k">break</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="k">if</span> <span class="n">FS_NONASCII</span><span class="p">:</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>    <span class="n">TESTFN_NONASCII</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">FS_NONASCII</span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="k">else</span><span class="p">:</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>    <span class="n">TESTFN_NONASCII</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="c1"># Save the initial cwd</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="n">SAVEDCWD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="c1"># Set by libregrtest/main.py so we can skip tests that are not</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="c1"># useful for PGO</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="n">PGO</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="c1"># Set by libregrtest/main.py if we are running the extended (time consuming)</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="c1"># PGO task.  If this is True, PGO is also True.</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="n">PGO_EXTENDED</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a><span class="k">def</span> <span class="nf">temp_dir</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>    <span class="sd">&quot;&quot;&quot;Return a context manager that creates a temporary directory.</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a><span class="sd">    Arguments:</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a><span class="sd">      path: the directory to create temporarily.  If omitted or None,</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a><span class="sd">        defaults to creating a temporary directory using tempfile.mkdtemp.</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a><span class="sd">      quiet: if False (the default), the context manager raises an exception</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="sd">        on error.  Otherwise, if the path is specified and cannot be</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="sd">        created, only a warning is issued.</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>    <span class="n">dir_created</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a>    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>        <span class="n">dir_created</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a>            <span class="n">dir_created</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a>        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a>                <span class="k">raise</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tests may fail, unable to create &#39;</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a>                          <span class="sa">f</span><span class="s1">&#39;temporary directory </span><span class="si">{</span><span class="n">path</span><span class="si">!r}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a>                          <span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a>    <span class="k">if</span> <span class="n">dir_created</span><span class="p">:</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a>        <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>        <span class="k">yield</span> <span class="n">path</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a>        <span class="c1"># In case the process forks, let only the parent remove the</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>        <span class="c1"># directory. The child has a different process id. (bpo-30028)</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a>        <span class="k">if</span> <span class="n">dir_created</span> <span class="ow">and</span> <span class="n">pid</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">():</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>            <span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a><span class="k">def</span> <span class="nf">change_cwd</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>    <span class="sd">&quot;&quot;&quot;Return a context manager that changes the current working directory.</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a><span class="sd">    Arguments:</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">      path: the directory to use as the temporary current working directory.</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">      quiet: if False (the default), the context manager raises an exception</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">        on error.  Otherwise, it issues only a warning and keeps the current</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a><span class="sd">        working directory the same.</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>    <span class="n">saved_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>            <span class="k">raise</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tests may fail, unable to change the current working &#39;</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>                      <span class="sa">f</span><span class="s1">&#39;directory to </span><span class="si">{</span><span class="n">path</span><span class="si">!r}</span><span class="s1">: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>                      <span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>        <span class="k">yield</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">saved_dir</span><span class="p">)</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a><span class="k">def</span> <span class="nf">temp_cwd</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tempcwd&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a><span class="sd">    Context manager that temporarily creates and changes the CWD.</span>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a><span class="sd">    The function temporarily changes the current working directory</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="sd">    after creating a temporary directory in the current directory with</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a><span class="sd">    name *name*.  If *name* is None, the temporary directory is</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a><span class="sd">    created using tempfile.mkdtemp.</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a><span class="sd">    If *quiet* is False (default) and it is not possible to</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="sd">    create or change the CWD, an error is raised.  If *quiet* is True,</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">    only a warning is raised and the original CWD is used.</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>    <span class="k">with</span> <span class="n">temp_dir</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_path</span><span class="p">:</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>        <span class="k">with</span> <span class="n">change_cwd</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span> <span class="k">as</span> <span class="n">cwd_dir</span><span class="p">:</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>            <span class="k">yield</span> <span class="n">cwd_dir</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;umask&quot;</span><span class="p">):</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>    <span class="k">def</span> <span class="nf">temp_umask</span><span class="p">(</span><span class="n">umask</span><span class="p">):</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>        <span class="sd">&quot;&quot;&quot;Context manager that temporarily sets the process umask.&quot;&quot;&quot;</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>        <span class="n">oldmask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">umask</span><span class="p">)</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>            <span class="k">yield</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">oldmask</span><span class="p">)</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a><span class="c1"># TEST_HOME_DIR refers to the top level directory of the &quot;test&quot; package</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a><span class="c1"># that contains Python&#39;s regression test suite</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a><span class="n">TEST_SUPPORT_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="n">TEST_HOME_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">TEST_SUPPORT_DIR</span><span class="p">)</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="c1"># TEST_DATA_DIR is used as a target download location for remote resources</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="n">TEST_DATA_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEST_HOME_DIR</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a><span class="k">def</span> <span class="nf">findfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>    <span class="sd">&quot;&quot;&quot;Try to find a file on sys.path or in the test directory.  If it is not</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="sd">    found the argument passed to the function is returned (this does not</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="sd">    necessarily signal failure; could still be the legitimate path).</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a><span class="sd">    Setting *subdir* indicates a relative path to use to find the file</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">    rather than looking directly in the path directories.</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>        <span class="k">return</span> <span class="n">filename</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>    <span class="k">if</span> <span class="n">subdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>    <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">TEST_HOME_DIR</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>    <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span> <span class="k">return</span> <span class="n">fn</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>    <span class="k">return</span> <span class="n">filename</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a><span class="k">def</span> <span class="nf">create_empty_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>    <span class="sd">&quot;&quot;&quot;Create an empty file. If the file already exists, truncate it.&quot;&quot;&quot;</span>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>    <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_TRUNC</span><span class="p">)</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="k">def</span> <span class="nf">sortdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>    <span class="s2">&quot;Like repr(dict), but in sorted order.&quot;</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>    <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>    <span class="n">reprpairs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pair</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>    <span class="n">withcommas</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reprpairs</span><span class="p">)</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>    <span class="k">return</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">withcommas</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="k">def</span> <span class="nf">make_bad_fd</span><span class="p">():</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">    Create an invalid file descriptor by opening and closing a file and return</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">    its fd.</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>    <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>        <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        <span class="n">unlink</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">)</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="k">def</span> <span class="nf">check_syntax_error</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">errtext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>    <span class="k">with</span> <span class="n">testcase</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="n">errtext</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>        <span class="nb">compile</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="s1">&#39;&lt;test string&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>    <span class="n">err</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">exception</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>    <span class="k">if</span> <span class="n">lineno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a>        <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>        <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="k">def</span> <span class="nf">check_syntax_warning</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">errtext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>    <span class="c1"># Test also that a warning is emitted only once.</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">warns</span><span class="p">:</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">)</span>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>        <span class="nb">compile</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="s1">&#39;&lt;testcase&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">warns</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">warns</span><span class="p">)</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>    <span class="n">warn</span><span class="p">,</span> <span class="o">=</span> <span class="n">warns</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">),</span> <span class="n">warn</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>    <span class="k">if</span> <span class="n">errtext</span><span class="p">:</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>        <span class="n">testcase</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">message</span><span class="p">),</span> <span class="n">errtext</span><span class="p">)</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;&lt;testcase&gt;&#39;</span><span class="p">)</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>    <span class="k">if</span> <span class="n">lineno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>        <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>    <span class="c1"># SyntaxWarning should be converted to SyntaxError when raised,</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>    <span class="c1"># since the latter contains more information and provides better</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>    <span class="c1"># error report.</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">warns</span><span class="p">:</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">)</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>        <span class="n">check_syntax_error</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">errtext</span><span class="p">,</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>                           <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>    <span class="c1"># No warnings are leaked when a SyntaxError is raised.</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">warns</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a><span class="k">def</span> <span class="nf">open_urlresource</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>    <span class="kn">import</span> <span class="nn">urllib.request</span><span class="o">,</span> <span class="nn">urllib.parse</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>    <span class="n">check</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;check&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># &#39;/&#39;: it&#39;s URL!</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEST_DATA_DIR</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>    <span class="k">def</span> <span class="nf">check_valid_file</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>        <span class="k">if</span> <span class="n">check</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>            <span class="k">return</span> <span class="n">f</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>        <span class="k">elif</span> <span class="n">check</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>            <span class="k">return</span> <span class="n">f</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">check_valid_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>            <span class="k">return</span> <span class="n">f</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="n">unlink</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>    <span class="c1"># Verify the requirement before downloading the file</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>    <span class="n">requires</span><span class="p">(</span><span class="s1">&#39;urlfetch&#39;</span><span class="p">)</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">fetching </span><span class="si">%s</span><span class="s1"> ...&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">get_original_stdout</span><span class="p">())</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>    <span class="n">opener</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">build_opener</span><span class="p">()</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>    <span class="k">if</span> <span class="n">gzip</span><span class="p">:</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>        <span class="n">opener</span><span class="o">.</span><span class="n">addheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;gzip&#39;</span><span class="p">))</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>    <span class="n">f</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>    <span class="k">if</span> <span class="n">gzip</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Encoding&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;gzip&#39;</span><span class="p">:</span>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>            <span class="k">while</span> <span class="n">s</span><span class="p">:</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>    <span class="n">f</span> <span class="o">=</span> <span class="n">check_valid_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>        <span class="k">return</span> <span class="n">f</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>    <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s1">&#39;invalid resource </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a><span class="k">class</span> <span class="nc">WarningsRecorder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>    <span class="sd">&quot;&quot;&quot;Convenience wrapper for the warnings list returned on</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">       entry to the warnings.catch_warnings() context manager.</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warnings_list</span><span class="p">):</span>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span> <span class="o">=</span> <span class="n">warnings_list</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="p">:</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a>            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">attr</span><span class="p">)</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">warnings</span><span class="o">.</span><span class="n">WarningMessage</span><span class="o">.</span><span class="n">_WARNING_DETAILS</span><span class="p">:</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>            <span class="k">return</span> <span class="kc">None</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> has no attribute </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>    <span class="nd">@property</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>    <span class="k">def</span> <span class="nf">warnings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_last</span><span class="p">:]</span>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_last</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warnings</span><span class="p">)</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="k">def</span> <span class="nf">_filterwarnings</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>    <span class="sd">&quot;&quot;&quot;Catch the warnings, then check if all the expected</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a><span class="sd">    warnings have been raised and re-raise unexpected warnings.</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a><span class="sd">    If &#39;quiet&#39; is True, only re-raise the unexpected warnings.</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>    <span class="c1"># Clear the warning registry of the calling module</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a>    <span class="c1"># in order to re-raise the warnings.</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>    <span class="n">frame</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>    <span class="n">registry</span> <span class="o">=</span> <span class="n">frame</span><span class="o">.</span><span class="n">f_globals</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__warningregistry__&#39;</span><span class="p">)</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>    <span class="k">if</span> <span class="n">registry</span><span class="p">:</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>        <span class="n">registry</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">w</span><span class="p">:</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>        <span class="c1"># Set filter &quot;always&quot; to record all warnings.  Because</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        <span class="c1"># test_warnings swap the module, we need to look up in</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>        <span class="c1"># the sys.modules dictionary.</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;always&quot;</span><span class="p">)</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>        <span class="k">yield</span> <span class="n">WarningsRecorder</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>    <span class="c1"># Filter the recorded warnings</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>    <span class="n">reraise</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>    <span class="k">for</span> <span class="n">msg</span><span class="p">,</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>        <span class="n">seen</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">reraise</span><span class="p">[:]:</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>            <span class="n">warning</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">message</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>            <span class="c1"># Filter out the matching messages</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>            <span class="k">if</span> <span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">warning</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span> <span class="ow">and</span>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>                <span class="nb">issubclass</span><span class="p">(</span><span class="n">warning</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">cat</span><span class="p">)):</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>                <span class="n">seen</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>                <span class="n">reraise</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">seen</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quiet</span><span class="p">:</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>            <span class="c1"># This filter caught nothing</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>            <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">msg</span><span class="p">,</span> <span class="n">cat</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>    <span class="k">if</span> <span class="n">reraise</span><span class="p">:</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;unhandled warning </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">reraise</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;filter (</span><span class="si">%r</span><span class="s2">, </span><span class="si">%s</span><span class="s2">) did not catch any warning&quot;</span> <span class="o">%</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>                             <span class="n">missing</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a><span class="k">def</span> <span class="nf">check_warnings</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>    <span class="sd">&quot;&quot;&quot;Context manager to silence warnings.</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a><span class="sd">    Accept 2-tuples as positional arguments:</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a><span class="sd">        (&quot;message regexp&quot;, WarningCategory)</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a><span class="sd">    Optional argument:</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a><span class="sd">     - if &#39;quiet&#39; is True, it does not fail if a filter catches nothing</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a><span class="sd">        (default True without argument,</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a><span class="sd">         default False if some filters are defined)</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a><span class="sd">    Without argument, it defaults to:</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a><span class="sd">        check_warnings((&quot;&quot;, Warning), quiet=True)</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>    <span class="n">quiet</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quiet&#39;</span><span class="p">)</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">),)</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>        <span class="c1"># Preserve backward compatibility</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>        <span class="k">if</span> <span class="n">quiet</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>            <span class="n">quiet</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>    <span class="k">return</span> <span class="n">_filterwarnings</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">quiet</span><span class="p">)</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a><span class="k">def</span> <span class="nf">check_no_warnings</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">Warning</span><span class="p">,</span> <span class="n">force_gc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>    <span class="sd">&quot;&quot;&quot;Context manager to check that no warnings are emitted.</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a><span class="sd">    This context manager enables a given warning within its scope</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a><span class="sd">    and checks that no warnings are emitted even with that warning</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a><span class="sd">    enabled.</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a><span class="sd">    If force_gc is True, a garbage collection is attempted before checking</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a><span class="sd">    for warnings. This may help to catch warnings emitted when objects</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a><span class="sd">    are deleted, such as ResourceWarning.</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a><span class="sd">    Other keyword arguments are passed to warnings.filterwarnings().</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">warns</span><span class="p">:</span>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>                                <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>                                <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>        <span class="k">yield</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>        <span class="k">if</span> <span class="n">force_gc</span><span class="p">:</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>            <span class="n">gc_collect</span><span class="p">()</span>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">warns</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a><span class="k">def</span> <span class="nf">check_no_resource_warning</span><span class="p">(</span><span class="n">testcase</span><span class="p">):</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>    <span class="sd">&quot;&quot;&quot;Context manager to check that no ResourceWarning is emitted.</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a><span class="sd">    Usage:</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a><span class="sd">        with check_no_resource_warning(self):</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a><span class="sd">            f = open(...)</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a><span class="sd">            ...</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a><span class="sd">            del f</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a><span class="sd">    You must remove the object which may emit ResourceWarning before</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a><span class="sd">    the end of the context manager.</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>    <span class="k">with</span> <span class="n">check_no_warnings</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">ResourceWarning</span><span class="p">,</span> <span class="n">force_gc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>        <span class="k">yield</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a><span class="k">class</span> <span class="nc">CleanImport</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>    <span class="sd">&quot;&quot;&quot;Context manager to force import to return a new module reference.</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a><span class="sd">    This is useful for testing module-level behaviours, such as</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a><span class="sd">    the emission of a DeprecationWarning on import.</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a><span class="sd">    Use like this:</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a><span class="sd">        with CleanImport(&quot;foo&quot;):</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a><span class="sd">            importlib.import_module(&quot;foo&quot;) # new reference</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">module_names</span><span class="p">):</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_modules</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>        <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">module_names</span><span class="p">:</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>            <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>                <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>                <span class="c1"># It is possible that module_name is just an alias for</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>                <span class="c1"># another module (e.g. stub for modules renamed in 3.x).</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>                <span class="c1"># In that case, we also need delete the real module to clear</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>                <span class="c1"># the import cache.</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>                <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="n">module_name</span><span class="p">:</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a>                    <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>                <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_modules</span><span class="p">)</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a><span class="k">class</span> <span class="nc">EnvironmentVarGuard</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>    <span class="sd">&quot;&quot;&quot;Class to help protect the environment variable properly.  Can be used as</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a><span class="sd">    a context manager.&quot;&quot;&quot;</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">):</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>        <span class="c1"># Remember the initial value on the first access</span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a>        <span class="k">if</span> <span class="n">envvar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">:</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">envvar</span><span class="p">)</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">):</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>        <span class="c1"># Remember the initial value on the first access</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>        <span class="k">if</span> <span class="n">envvar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">:</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">envvar</span><span class="p">)</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>        <span class="k">if</span> <span class="n">envvar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">:</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">)</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">)</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a>        <span class="bp">self</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a>    <span class="k">def</span> <span class="nf">unset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">):</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a>        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a>            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">:</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="k">class</span> <span class="nc">DirsOnSysPath</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a>    <span class="sd">&quot;&quot;&quot;Context manager to temporarily add directories to sys.path.</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="sd">    This makes a copy of sys.path, appends any directories given</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a><span class="sd">    as positional arguments, then reverts sys.path to the copied</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a><span class="sd">    settings when the context ends.</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a><span class="sd">    Note that *all* sys.path modifications in the body of the</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a><span class="sd">    context manager, including replacement of the object,</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a><span class="sd">    will be reverted at the end of the block.</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">paths</span><span class="p">):</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_value</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[:]</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_object</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_object</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_value</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a><span class="k">class</span> <span class="nc">TransientResource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>    <span class="sd">&quot;&quot;&quot;Raise ResourceDenied if an exception is raised while the context manager</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a><span class="sd">    is in effect that matches the specified exception and attributes.&quot;&quot;&quot;</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exc</span> <span class="o">=</span> <span class="n">exc</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>        <span class="sd">&quot;&quot;&quot;If type_ is a subclass of self.exc and value has attributes matching</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a><span class="sd">        self.attrs, raise ResourceDenied.  Otherwise let the exception</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a><span class="sd">        propagate (if any).&quot;&quot;&quot;</span>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>        <span class="k">if</span> <span class="n">type_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attr_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>                    <span class="k">break</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">attr_value</span><span class="p">:</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>                    <span class="k">break</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>                <span class="k">raise</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="s2">&quot;an optional resource is not available&quot;</span><span class="p">)</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a><span class="c1"># Context managers that raise ResourceDenied when various issues</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a><span class="c1"># with the Internet connection manifest themselves as exceptions.</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a><span class="c1"># XXX deprecate these and use transient_internet() instead</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a><span class="n">time_out</span> <span class="o">=</span> <span class="n">TransientResource</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">errno</span><span class="o">=</span><span class="n">errno</span><span class="o">.</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a><span class="n">socket_peer_reset</span> <span class="o">=</span> <span class="n">TransientResource</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">errno</span><span class="o">=</span><span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">)</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a><span class="n">ioerror_peer_reset</span> <span class="o">=</span> <span class="n">TransientResource</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="n">errno</span><span class="o">=</span><span class="n">errno</span><span class="o">.</span><span class="n">ECONNRESET</span><span class="p">)</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a><span class="k">def</span> <span class="nf">get_socket_conn_refused_errs</span><span class="p">():</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a><span class="sd">    Get the different socket error numbers (&#39;errno&#39;) which can be received</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a><span class="sd">    when a connection is refused.</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>    <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">errno</span><span class="o">.</span><span class="n">ECONNREFUSED</span><span class="p">]</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="s1">&#39;ENETUNREACH&#39;</span><span class="p">):</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>        <span class="c1"># On Solaris, ENETUNREACH is returned sometimes instead of ECONNREFUSED</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENETUNREACH</span><span class="p">)</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="s1">&#39;EADDRNOTAVAIL&#39;</span><span class="p">):</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>        <span class="c1"># bpo-31910: socket.create_connection() fails randomly</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>        <span class="c1"># with EADDRNOTAVAIL on Travis CI</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EADDRNOTAVAIL</span><span class="p">)</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="s1">&#39;EHOSTUNREACH&#39;</span><span class="p">):</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>        <span class="c1"># bpo-37583: The destination host cannot be reached</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EHOSTUNREACH</span><span class="p">)</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">IPV6_ENABLED</span><span class="p">:</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>        <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EAFNOSUPPORT</span><span class="p">)</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>    <span class="k">return</span> <span class="n">errors</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a><span class="k">def</span> <span class="nf">transient_internet</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">errnos</span><span class="o">=</span><span class="p">()):</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>    <span class="sd">&quot;&quot;&quot;Return a context manager that raises ResourceDenied when various issues</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a><span class="sd">    with the Internet connection manifest themselves as exceptions.&quot;&quot;&quot;</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>    <span class="n">default_errnos</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>        <span class="p">(</span><span class="s1">&#39;ECONNREFUSED&#39;</span><span class="p">,</span> <span class="mi">111</span><span class="p">),</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>        <span class="p">(</span><span class="s1">&#39;ECONNRESET&#39;</span><span class="p">,</span> <span class="mi">104</span><span class="p">),</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>        <span class="p">(</span><span class="s1">&#39;EHOSTUNREACH&#39;</span><span class="p">,</span> <span class="mi">113</span><span class="p">),</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>        <span class="p">(</span><span class="s1">&#39;ENETUNREACH&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">),</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>        <span class="p">(</span><span class="s1">&#39;ETIMEDOUT&#39;</span><span class="p">,</span> <span class="mi">110</span><span class="p">),</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>        <span class="c1"># socket.create_connection() fails randomly with</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>        <span class="c1"># EADDRNOTAVAIL on Travis CI.</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>        <span class="p">(</span><span class="s1">&#39;EADDRNOTAVAIL&#39;</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>    <span class="p">]</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>    <span class="n">default_gai_errnos</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>        <span class="p">(</span><span class="s1">&#39;EAI_AGAIN&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">),</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>        <span class="p">(</span><span class="s1">&#39;EAI_FAIL&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>        <span class="p">(</span><span class="s1">&#39;EAI_NONAME&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>        <span class="p">(</span><span class="s1">&#39;EAI_NODATA&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">),</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>        <span class="c1"># Encountered when trying to resolve IPv6-only hostnames</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>        <span class="p">(</span><span class="s1">&#39;WSANO_DATA&#39;</span><span class="p">,</span> <span class="mi">11004</span><span class="p">),</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>    <span class="p">]</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>    <span class="n">denied</span> <span class="o">=</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="s2">&quot;Resource </span><span class="si">%r</span><span class="s2"> is not available&quot;</span> <span class="o">%</span> <span class="n">resource_name</span><span class="p">)</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>    <span class="n">captured_errnos</span> <span class="o">=</span> <span class="n">errnos</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>    <span class="n">gai_errnos</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">captured_errnos</span><span class="p">:</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>        <span class="n">captured_errnos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>                           <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="ow">in</span> <span class="n">default_errnos</span><span class="p">]</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>        <span class="n">gai_errnos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>                      <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="ow">in</span> <span class="n">default_gai_errnos</span><span class="p">]</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>    <span class="k">def</span> <span class="nf">filter_error</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s1">&#39;errno&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">gai_errnos</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">)</span> <span class="ow">and</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>             <span class="mi">500</span> <span class="o">&lt;=</span> <span class="n">err</span><span class="o">.</span><span class="n">code</span> <span class="o">&lt;=</span> <span class="mi">599</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">)</span> <span class="ow">and</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>                 <span class="p">((</span><span class="s2">&quot;ConnectionRefusedError&quot;</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>                  <span class="p">(</span><span class="s2">&quot;TimeoutError&quot;</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>                  <span class="p">(</span><span class="s2">&quot;EOFError&quot;</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">reason</span><span class="p">)))</span> <span class="ow">or</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>            <span class="n">n</span> <span class="ow">in</span> <span class="n">captured_errnos</span><span class="p">):</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">denied</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>            <span class="k">raise</span> <span class="n">denied</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>    <span class="n">old_timeout</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getdefaulttimeout</span><span class="p">()</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>            <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>        <span class="k">yield</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>    <span class="k">except</span> <span class="n">nntplib</span><span class="o">.</span><span class="n">NNTPTemporaryError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">denied</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>        <span class="k">raise</span> <span class="n">denied</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>        <span class="c1"># urllib can wrap original socket errors multiple times (!), we must</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>        <span class="c1"># unwrap to get at the original error.</span>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="ne">OSError</span><span class="p">):</span>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>                <span class="n">err</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>            <span class="c1"># The error can also be wrapped as args[1]:</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>            <span class="c1">#    except socket.error as msg:</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>            <span class="c1">#        raise OSError(&#39;socket error&#39;, msg).with_traceback(sys.exc_info()[2])</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="ne">OSError</span><span class="p">):</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>                <span class="n">err</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>                <span class="k">break</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>        <span class="n">filter_error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>        <span class="k">raise</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>    <span class="c1"># XXX should we catch generic exceptions and look for their</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>    <span class="c1"># __cause__ or __context__?</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="n">old_timeout</span><span class="p">)</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a><span class="k">def</span> <span class="nf">captured_output</span><span class="p">(</span><span class="n">stream_name</span><span class="p">):</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>    <span class="sd">&quot;&quot;&quot;Return a context manager used by captured_stdout/stdin/stderr</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a><span class="sd">    that temporarily replaces the sys stream *stream_name* with a StringIO.&quot;&quot;&quot;</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>    <span class="kn">import</span> <span class="nn">io</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>    <span class="n">orig_stdout</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>    <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">())</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>        <span class="k">yield</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">)</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">orig_stdout</span><span class="p">)</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a><span class="k">def</span> <span class="nf">captured_stdout</span><span class="p">():</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>    <span class="sd">&quot;&quot;&quot;Capture the output of sys.stdout:</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a><span class="sd">       with captured_stdout() as stdout:</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a><span class="sd">           print(&quot;hello&quot;)</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a><span class="sd">       self.assertEqual(stdout.getvalue(), &quot;hello\\n&quot;)</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>    <span class="k">return</span> <span class="n">captured_output</span><span class="p">(</span><span class="s2">&quot;stdout&quot;</span><span class="p">)</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a><span class="k">def</span> <span class="nf">captured_stderr</span><span class="p">():</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>    <span class="sd">&quot;&quot;&quot;Capture the output of sys.stderr:</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a><span class="sd">       with captured_stderr() as stderr:</span>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a><span class="sd">           print(&quot;hello&quot;, file=sys.stderr)</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a><span class="sd">       self.assertEqual(stderr.getvalue(), &quot;hello\\n&quot;)</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>    <span class="k">return</span> <span class="n">captured_output</span><span class="p">(</span><span class="s2">&quot;stderr&quot;</span><span class="p">)</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a><span class="k">def</span> <span class="nf">captured_stdin</span><span class="p">():</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>    <span class="sd">&quot;&quot;&quot;Capture the input to sys.stdin:</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a><span class="sd">       with captured_stdin() as stdin:</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a><span class="sd">           stdin.write(&#39;hello\\n&#39;)</span>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a><span class="sd">           stdin.seek(0)</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a><span class="sd">           # call test code that consumes from sys.stdin</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a><span class="sd">           captured = input()</span>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a><span class="sd">       self.assertEqual(captured, &quot;hello&quot;)</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>    <span class="k">return</span> <span class="n">captured_output</span><span class="p">(</span><span class="s2">&quot;stdin&quot;</span><span class="p">)</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a><span class="k">def</span> <span class="nf">gc_collect</span><span class="p">():</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>    <span class="sd">&quot;&quot;&quot;Force as many objects as possible to be collected.</span>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a><span class="sd">    In non-CPython implementations of Python, this is needed because timely</span>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a><span class="sd">    deallocation is not guaranteed by the garbage collector.  (Even in CPython</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a><span class="sd">    this can be the case in case of reference cycles.)  This means that __del__</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a><span class="sd">    methods may be called later than expected and weakrefs may remain alive for</span>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a><span class="sd">    longer than expected.  This function tries its best to force all garbage</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a><span class="sd">    objects to disappear.</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>    <span class="k">if</span> <span class="n">is_jython</span><span class="p">:</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a><span class="k">def</span> <span class="nf">disable_gc</span><span class="p">():</span>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>    <span class="n">have_gc</span> <span class="o">=</span> <span class="n">gc</span><span class="o">.</span><span class="n">isenabled</span><span class="p">()</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>    <span class="n">gc</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>        <span class="k">yield</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>        <span class="k">if</span> <span class="n">have_gc</span><span class="p">:</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>            <span class="n">gc</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a><span class="k">def</span> <span class="nf">python_is_optimized</span><span class="p">():</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>    <span class="sd">&quot;&quot;&quot;Find if Python was built with optimizations.&quot;&quot;&quot;</span>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>    <span class="n">cflags</span> <span class="o">=</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">get_config_var</span><span class="p">(</span><span class="s1">&#39;PY_CFLAGS&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>    <span class="n">final_opt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>    <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="n">cflags</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>        <span class="k">if</span> <span class="n">opt</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;-O&#39;</span><span class="p">):</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>            <span class="n">final_opt</span> <span class="o">=</span> <span class="n">opt</span>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>    <span class="k">return</span> <span class="n">final_opt</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;-O0&#39;</span><span class="p">,</span> <span class="s1">&#39;-Og&#39;</span><span class="p">)</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a><span class="n">_header</span> <span class="o">=</span> <span class="s1">&#39;nP&#39;</span>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a><span class="n">_align</span> <span class="o">=</span> <span class="s1">&#39;0n&#39;</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a><span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s2">&quot;getobjects&quot;</span><span class="p">):</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>    <span class="n">_header</span> <span class="o">=</span> <span class="s1">&#39;2P&#39;</span> <span class="o">+</span> <span class="n">_header</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>    <span class="n">_align</span> <span class="o">=</span> <span class="s1">&#39;0P&#39;</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a><span class="n">_vheader</span> <span class="o">=</span> <span class="n">_header</span> <span class="o">+</span> <span class="s1">&#39;n&#39;</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a><span class="k">def</span> <span class="nf">calcobjsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">):</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">_header</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">+</span> <span class="n">_align</span><span class="p">)</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a><span class="k">def</span> <span class="nf">calcvobjsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">):</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>    <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">_vheader</span> <span class="o">+</span> <span class="n">fmt</span> <span class="o">+</span> <span class="n">_align</span><span class="p">)</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a><span class="n">_TPFLAGS_HAVE_GC</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">14</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a><span class="n">_TPFLAGS_HEAPTYPE</span> <span class="o">=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">9</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a><span class="k">def</span> <span class="nf">check_sizeof</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>    <span class="kn">import</span> <span class="nn">_testcapi</span>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">getsizeof</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>    <span class="c1"># add GC header size</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>    <span class="k">if</span> <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">__flags__</span> <span class="o">&amp;</span> <span class="n">_TPFLAGS_HEAPTYPE</span><span class="p">)</span> <span class="ow">or</span>\
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>        <span class="p">((</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">)</span><span class="o">.</span><span class="n">__flags__</span> <span class="o">&amp;</span> <span class="n">_TPFLAGS_HAVE_GC</span><span class="p">))):</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>        <span class="n">size</span> <span class="o">+=</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">SIZEOF_PYGC_HEAD</span>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;wrong size for </span><span class="si">%s</span><span class="s1">: got </span><span class="si">%d</span><span class="s1">, expected </span><span class="si">%d</span><span class="s1">&#39;</span> \
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>            <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">o</span><span class="p">),</span> <span class="n">result</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>    <span class="n">test</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a><span class="c1">#=======================================================================</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a><span class="c1"># Decorator for running a function in a different locale, correctly resetting</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a><span class="c1"># it afterwards.</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a><span class="k">def</span> <span class="nf">run_with_locale</span><span class="p">(</span><span class="n">catstr</span><span class="p">,</span> <span class="o">*</span><span class="n">locales</span><span class="p">):</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>                <span class="kn">import</span> <span class="nn">locale</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>                <span class="n">category</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="n">catstr</span><span class="p">)</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>                <span class="n">orig_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>                <span class="c1"># if the test author gives us an invalid category string</span>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>                <span class="k">raise</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>                <span class="c1"># cannot retrieve original locale, so do nothing</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>                <span class="n">locale</span> <span class="o">=</span> <span class="n">orig_locale</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>                <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locales</span><span class="p">:</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>                        <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>                        <span class="k">break</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>                        <span class="k">pass</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>            <span class="c1"># now run the function, resetting the locale on exceptions</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>                <span class="k">if</span> <span class="n">locale</span> <span class="ow">and</span> <span class="n">orig_locale</span><span class="p">:</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>                    <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">orig_locale</span><span class="p">)</span>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>        <span class="n">inner</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="L-1760"><a href="#L-1760"><span class="linenos">1760</span></a>        <span class="n">inner</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span id="L-1761"><a href="#L-1761"><span class="linenos">1761</span></a>        <span class="k">return</span> <span class="n">inner</span>
</span><span id="L-1762"><a href="#L-1762"><span class="linenos">1762</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="L-1763"><a href="#L-1763"><span class="linenos">1763</span></a>
</span><span id="L-1764"><a href="#L-1764"><span class="linenos">1764</span></a><span class="c1">#=======================================================================</span>
</span><span id="L-1765"><a href="#L-1765"><span class="linenos">1765</span></a><span class="c1"># Decorator for running a function in a specific timezone, correctly</span>
</span><span id="L-1766"><a href="#L-1766"><span class="linenos">1766</span></a><span class="c1"># resetting it afterwards.</span>
</span><span id="L-1767"><a href="#L-1767"><span class="linenos">1767</span></a>
</span><span id="L-1768"><a href="#L-1768"><span class="linenos">1768</span></a><span class="k">def</span> <span class="nf">run_with_tz</span><span class="p">(</span><span class="n">tz</span><span class="p">):</span>
</span><span id="L-1769"><a href="#L-1769"><span class="linenos">1769</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="L-1770"><a href="#L-1770"><span class="linenos">1770</span></a>        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
</span><span id="L-1771"><a href="#L-1771"><span class="linenos">1771</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1772"><a href="#L-1772"><span class="linenos">1772</span></a>                <span class="n">tzset</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">tzset</span>
</span><span id="L-1773"><a href="#L-1773"><span class="linenos">1773</span></a>            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="L-1774"><a href="#L-1774"><span class="linenos">1774</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;tzset required&quot;</span><span class="p">)</span>
</span><span id="L-1775"><a href="#L-1775"><span class="linenos">1775</span></a>            <span class="k">if</span> <span class="s1">&#39;TZ&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
</span><span id="L-1776"><a href="#L-1776"><span class="linenos">1776</span></a>                <span class="n">orig_tz</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TZ&#39;</span><span class="p">]</span>
</span><span id="L-1777"><a href="#L-1777"><span class="linenos">1777</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1778"><a href="#L-1778"><span class="linenos">1778</span></a>                <span class="n">orig_tz</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1779"><a href="#L-1779"><span class="linenos">1779</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tz</span>
</span><span id="L-1780"><a href="#L-1780"><span class="linenos">1780</span></a>            <span class="n">tzset</span><span class="p">()</span>
</span><span id="L-1781"><a href="#L-1781"><span class="linenos">1781</span></a>
</span><span id="L-1782"><a href="#L-1782"><span class="linenos">1782</span></a>            <span class="c1"># now run the function, resetting the tz on exceptions</span>
</span><span id="L-1783"><a href="#L-1783"><span class="linenos">1783</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1784"><a href="#L-1784"><span class="linenos">1784</span></a>                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</span><span id="L-1785"><a href="#L-1785"><span class="linenos">1785</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1786"><a href="#L-1786"><span class="linenos">1786</span></a>                <span class="k">if</span> <span class="n">orig_tz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1787"><a href="#L-1787"><span class="linenos">1787</span></a>                    <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TZ&#39;</span><span class="p">]</span>
</span><span id="L-1788"><a href="#L-1788"><span class="linenos">1788</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1789"><a href="#L-1789"><span class="linenos">1789</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_tz</span>
</span><span id="L-1790"><a href="#L-1790"><span class="linenos">1790</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">tzset</span><span class="p">()</span>
</span><span id="L-1791"><a href="#L-1791"><span class="linenos">1791</span></a>
</span><span id="L-1792"><a href="#L-1792"><span class="linenos">1792</span></a>        <span class="n">inner</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="L-1793"><a href="#L-1793"><span class="linenos">1793</span></a>        <span class="n">inner</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span id="L-1794"><a href="#L-1794"><span class="linenos">1794</span></a>        <span class="k">return</span> <span class="n">inner</span>
</span><span id="L-1795"><a href="#L-1795"><span class="linenos">1795</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="L-1796"><a href="#L-1796"><span class="linenos">1796</span></a>
</span><span id="L-1797"><a href="#L-1797"><span class="linenos">1797</span></a><span class="c1">#=======================================================================</span>
</span><span id="L-1798"><a href="#L-1798"><span class="linenos">1798</span></a><span class="c1"># Big-memory-test support. Separate from &#39;resources&#39; because memory use</span>
</span><span id="L-1799"><a href="#L-1799"><span class="linenos">1799</span></a><span class="c1"># should be configurable.</span>
</span><span id="L-1800"><a href="#L-1800"><span class="linenos">1800</span></a>
</span><span id="L-1801"><a href="#L-1801"><span class="linenos">1801</span></a><span class="c1"># Some handy shorthands. Note that these are used for byte-limits as well</span>
</span><span id="L-1802"><a href="#L-1802"><span class="linenos">1802</span></a><span class="c1"># as size-limits, in the various bigmem tests</span>
</span><span id="L-1803"><a href="#L-1803"><span class="linenos">1803</span></a><span class="n">_1M</span> <span class="o">=</span> <span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span>
</span><span id="L-1804"><a href="#L-1804"><span class="linenos">1804</span></a><span class="n">_1G</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">_1M</span>
</span><span id="L-1805"><a href="#L-1805"><span class="linenos">1805</span></a><span class="n">_2G</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">_1G</span>
</span><span id="L-1806"><a href="#L-1806"><span class="linenos">1806</span></a><span class="n">_4G</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">_1G</span>
</span><span id="L-1807"><a href="#L-1807"><span class="linenos">1807</span></a>
</span><span id="L-1808"><a href="#L-1808"><span class="linenos">1808</span></a><span class="n">MAX_Py_ssize_t</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span>
</span><span id="L-1809"><a href="#L-1809"><span class="linenos">1809</span></a>
</span><span id="L-1810"><a href="#L-1810"><span class="linenos">1810</span></a><span class="k">def</span> <span class="nf">set_memlimit</span><span class="p">(</span><span class="n">limit</span><span class="p">):</span>
</span><span id="L-1811"><a href="#L-1811"><span class="linenos">1811</span></a>    <span class="k">global</span> <span class="n">max_memuse</span>
</span><span id="L-1812"><a href="#L-1812"><span class="linenos">1812</span></a>    <span class="k">global</span> <span class="n">real_max_memuse</span>
</span><span id="L-1813"><a href="#L-1813"><span class="linenos">1813</span></a>    <span class="n">sizes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1814"><a href="#L-1814"><span class="linenos">1814</span></a>        <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
</span><span id="L-1815"><a href="#L-1815"><span class="linenos">1815</span></a>        <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">_1M</span><span class="p">,</span>
</span><span id="L-1816"><a href="#L-1816"><span class="linenos">1816</span></a>        <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="n">_1G</span><span class="p">,</span>
</span><span id="L-1817"><a href="#L-1817"><span class="linenos">1817</span></a>        <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">*</span><span class="n">_1G</span><span class="p">,</span>
</span><span id="L-1818"><a href="#L-1818"><span class="linenos">1818</span></a>    <span class="p">}</span>
</span><span id="L-1819"><a href="#L-1819"><span class="linenos">1819</span></a>    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+(\.\d+)?) (K|M|G|T)b?$&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span>
</span><span id="L-1820"><a href="#L-1820"><span class="linenos">1820</span></a>                 <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
</span><span id="L-1821"><a href="#L-1821"><span class="linenos">1821</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1822"><a href="#L-1822"><span class="linenos">1822</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid memory limit </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">limit</span><span class="p">,))</span>
</span><span id="L-1823"><a href="#L-1823"><span class="linenos">1823</span></a>    <span class="n">memlimit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">sizes</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
</span><span id="L-1824"><a href="#L-1824"><span class="linenos">1824</span></a>    <span class="n">real_max_memuse</span> <span class="o">=</span> <span class="n">memlimit</span>
</span><span id="L-1825"><a href="#L-1825"><span class="linenos">1825</span></a>    <span class="k">if</span> <span class="n">memlimit</span> <span class="o">&gt;</span> <span class="n">MAX_Py_ssize_t</span><span class="p">:</span>
</span><span id="L-1826"><a href="#L-1826"><span class="linenos">1826</span></a>        <span class="n">memlimit</span> <span class="o">=</span> <span class="n">MAX_Py_ssize_t</span>
</span><span id="L-1827"><a href="#L-1827"><span class="linenos">1827</span></a>    <span class="k">if</span> <span class="n">memlimit</span> <span class="o">&lt;</span> <span class="n">_2G</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1828"><a href="#L-1828"><span class="linenos">1828</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Memory limit </span><span class="si">%r</span><span class="s1"> too low to be useful&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">limit</span><span class="p">,))</span>
</span><span id="L-1829"><a href="#L-1829"><span class="linenos">1829</span></a>    <span class="n">max_memuse</span> <span class="o">=</span> <span class="n">memlimit</span>
</span><span id="L-1830"><a href="#L-1830"><span class="linenos">1830</span></a>
</span><span id="L-1831"><a href="#L-1831"><span class="linenos">1831</span></a><span class="k">class</span> <span class="nc">_MemoryWatchdog</span><span class="p">:</span>
</span><span id="L-1832"><a href="#L-1832"><span class="linenos">1832</span></a>    <span class="sd">&quot;&quot;&quot;An object which periodically watches the process&#39; memory consumption</span>
</span><span id="L-1833"><a href="#L-1833"><span class="linenos">1833</span></a><span class="sd">    and prints it out.</span>
</span><span id="L-1834"><a href="#L-1834"><span class="linenos">1834</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1835"><a href="#L-1835"><span class="linenos">1835</span></a>
</span><span id="L-1836"><a href="#L-1836"><span class="linenos">1836</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1837"><a href="#L-1837"><span class="linenos">1837</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">procfile</span> <span class="o">=</span> <span class="s1">&#39;/proc/</span><span class="si">{pid}</span><span class="s1">/statm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
</span><span id="L-1838"><a href="#L-1838"><span class="linenos">1838</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1839"><a href="#L-1839"><span class="linenos">1839</span></a>
</span><span id="L-1840"><a href="#L-1840"><span class="linenos">1840</span></a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1841"><a href="#L-1841"><span class="linenos">1841</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1842"><a href="#L-1842"><span class="linenos">1842</span></a>            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">procfile</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
</span><span id="L-1843"><a href="#L-1843"><span class="linenos">1843</span></a>        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-1844"><a href="#L-1844"><span class="linenos">1844</span></a>            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;/proc not available for stats: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
</span><span id="L-1845"><a href="#L-1845"><span class="linenos">1845</span></a>                          <span class="ne">RuntimeWarning</span><span class="p">)</span>
</span><span id="L-1846"><a href="#L-1846"><span class="linenos">1846</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
</span><span id="L-1847"><a href="#L-1847"><span class="linenos">1847</span></a>            <span class="k">return</span>
</span><span id="L-1848"><a href="#L-1848"><span class="linenos">1848</span></a>
</span><span id="L-1849"><a href="#L-1849"><span class="linenos">1849</span></a>        <span class="k">with</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-1850"><a href="#L-1850"><span class="linenos">1850</span></a>            <span class="n">watchdog_script</span> <span class="o">=</span> <span class="n">findfile</span><span class="p">(</span><span class="s2">&quot;memory_watchdog.py&quot;</span><span class="p">)</span>
</span><span id="L-1851"><a href="#L-1851"><span class="linenos">1851</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mem_watchdog</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">watchdog_script</span><span class="p">],</span>
</span><span id="L-1852"><a href="#L-1852"><span class="linenos">1852</span></a>                                                 <span class="n">stdin</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
</span><span id="L-1853"><a href="#L-1853"><span class="linenos">1853</span></a>                                                 <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">DEVNULL</span><span class="p">)</span>
</span><span id="L-1854"><a href="#L-1854"><span class="linenos">1854</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1855"><a href="#L-1855"><span class="linenos">1855</span></a>
</span><span id="L-1856"><a href="#L-1856"><span class="linenos">1856</span></a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1857"><a href="#L-1857"><span class="linenos">1857</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
</span><span id="L-1858"><a href="#L-1858"><span class="linenos">1858</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mem_watchdog</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
</span><span id="L-1859"><a href="#L-1859"><span class="linenos">1859</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mem_watchdog</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</span><span id="L-1860"><a href="#L-1860"><span class="linenos">1860</span></a>
</span><span id="L-1861"><a href="#L-1861"><span class="linenos">1861</span></a>
</span><span id="L-1862"><a href="#L-1862"><span class="linenos">1862</span></a><span class="k">def</span> <span class="nf">bigmemtest</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">memuse</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1863"><a href="#L-1863"><span class="linenos">1863</span></a>    <span class="sd">&quot;&quot;&quot;Decorator for bigmem tests.</span>
</span><span id="L-1864"><a href="#L-1864"><span class="linenos">1864</span></a>
</span><span id="L-1865"><a href="#L-1865"><span class="linenos">1865</span></a><span class="sd">    &#39;size&#39; is a requested size for the test (in arbitrary, test-interpreted</span>
</span><span id="L-1866"><a href="#L-1866"><span class="linenos">1866</span></a><span class="sd">    units.) &#39;memuse&#39; is the number of bytes per unit for the test, or a good</span>
</span><span id="L-1867"><a href="#L-1867"><span class="linenos">1867</span></a><span class="sd">    estimate of it. For example, a test that needs two byte buffers, of 4 GiB</span>
</span><span id="L-1868"><a href="#L-1868"><span class="linenos">1868</span></a><span class="sd">    each, could be decorated with @bigmemtest(size=_4G, memuse=2).</span>
</span><span id="L-1869"><a href="#L-1869"><span class="linenos">1869</span></a>
</span><span id="L-1870"><a href="#L-1870"><span class="linenos">1870</span></a><span class="sd">    The &#39;size&#39; argument is normally passed to the decorated test method as an</span>
</span><span id="L-1871"><a href="#L-1871"><span class="linenos">1871</span></a><span class="sd">    extra argument. If &#39;dry_run&#39; is true, the value passed to the test method</span>
</span><span id="L-1872"><a href="#L-1872"><span class="linenos">1872</span></a><span class="sd">    may be less than the requested value. If &#39;dry_run&#39; is false, it means the</span>
</span><span id="L-1873"><a href="#L-1873"><span class="linenos">1873</span></a><span class="sd">    test doesn&#39;t support dummy runs when -M is not specified.</span>
</span><span id="L-1874"><a href="#L-1874"><span class="linenos">1874</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1875"><a href="#L-1875"><span class="linenos">1875</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="L-1876"><a href="#L-1876"><span class="linenos">1876</span></a>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1877"><a href="#L-1877"><span class="linenos">1877</span></a>            <span class="n">size</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-1878"><a href="#L-1878"><span class="linenos">1878</span></a>            <span class="n">memuse</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">memuse</span>
</span><span id="L-1879"><a href="#L-1879"><span class="linenos">1879</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">real_max_memuse</span><span class="p">:</span>
</span><span id="L-1880"><a href="#L-1880"><span class="linenos">1880</span></a>                <span class="n">maxsize</span> <span class="o">=</span> <span class="mi">5147</span>
</span><span id="L-1881"><a href="#L-1881"><span class="linenos">1881</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1882"><a href="#L-1882"><span class="linenos">1882</span></a>                <span class="n">maxsize</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="L-1883"><a href="#L-1883"><span class="linenos">1883</span></a>
</span><span id="L-1884"><a href="#L-1884"><span class="linenos">1884</span></a>            <span class="k">if</span> <span class="p">((</span><span class="n">real_max_memuse</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">)</span>
</span><span id="L-1885"><a href="#L-1885"><span class="linenos">1885</span></a>                <span class="ow">and</span> <span class="n">real_max_memuse</span> <span class="o">&lt;</span> <span class="n">maxsize</span> <span class="o">*</span> <span class="n">memuse</span><span class="p">):</span>
</span><span id="L-1886"><a href="#L-1886"><span class="linenos">1886</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
</span><span id="L-1887"><a href="#L-1887"><span class="linenos">1887</span></a>                    <span class="s2">&quot;not enough memory: </span><span class="si">%.1f</span><span class="s2">G minimum needed&quot;</span>
</span><span id="L-1888"><a href="#L-1888"><span class="linenos">1888</span></a>                    <span class="o">%</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">memuse</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)))</span>
</span><span id="L-1889"><a href="#L-1889"><span class="linenos">1889</span></a>
</span><span id="L-1890"><a href="#L-1890"><span class="linenos">1890</span></a>            <span class="k">if</span> <span class="n">real_max_memuse</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-1891"><a href="#L-1891"><span class="linenos">1891</span></a>                <span class="nb">print</span><span class="p">()</span>
</span><span id="L-1892"><a href="#L-1892"><span class="linenos">1892</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ... expected peak memory use: </span><span class="si">{peak:.1f}</span><span class="s2">G&quot;</span>
</span><span id="L-1893"><a href="#L-1893"><span class="linenos">1893</span></a>                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak</span><span class="o">=</span><span class="n">size</span> <span class="o">*</span> <span class="n">memuse</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)))</span>
</span><span id="L-1894"><a href="#L-1894"><span class="linenos">1894</span></a>                <span class="n">watchdog</span> <span class="o">=</span> <span class="n">_MemoryWatchdog</span><span class="p">()</span>
</span><span id="L-1895"><a href="#L-1895"><span class="linenos">1895</span></a>                <span class="n">watchdog</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-1896"><a href="#L-1896"><span class="linenos">1896</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1897"><a href="#L-1897"><span class="linenos">1897</span></a>                <span class="n">watchdog</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1898"><a href="#L-1898"><span class="linenos">1898</span></a>
</span><span id="L-1899"><a href="#L-1899"><span class="linenos">1899</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1900"><a href="#L-1900"><span class="linenos">1900</span></a>                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">)</span>
</span><span id="L-1901"><a href="#L-1901"><span class="linenos">1901</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1902"><a href="#L-1902"><span class="linenos">1902</span></a>                <span class="k">if</span> <span class="n">watchdog</span><span class="p">:</span>
</span><span id="L-1903"><a href="#L-1903"><span class="linenos">1903</span></a>                    <span class="n">watchdog</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="L-1904"><a href="#L-1904"><span class="linenos">1904</span></a>
</span><span id="L-1905"><a href="#L-1905"><span class="linenos">1905</span></a>        <span class="n">wrapper</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="L-1906"><a href="#L-1906"><span class="linenos">1906</span></a>        <span class="n">wrapper</span><span class="o">.</span><span class="n">memuse</span> <span class="o">=</span> <span class="n">memuse</span>
</span><span id="L-1907"><a href="#L-1907"><span class="linenos">1907</span></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="L-1908"><a href="#L-1908"><span class="linenos">1908</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="L-1909"><a href="#L-1909"><span class="linenos">1909</span></a>
</span><span id="L-1910"><a href="#L-1910"><span class="linenos">1910</span></a><span class="k">def</span> <span class="nf">bigaddrspacetest</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="L-1911"><a href="#L-1911"><span class="linenos">1911</span></a>    <span class="sd">&quot;&quot;&quot;Decorator for tests that fill the address space.&quot;&quot;&quot;</span>
</span><span id="L-1912"><a href="#L-1912"><span class="linenos">1912</span></a>    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1913"><a href="#L-1913"><span class="linenos">1913</span></a>        <span class="k">if</span> <span class="n">max_memuse</span> <span class="o">&lt;</span> <span class="n">MAX_Py_ssize_t</span><span class="p">:</span>
</span><span id="L-1914"><a href="#L-1914"><span class="linenos">1914</span></a>            <span class="k">if</span> <span class="n">MAX_Py_ssize_t</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">63</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">max_memuse</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">:</span>
</span><span id="L-1915"><a href="#L-1915"><span class="linenos">1915</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
</span><span id="L-1916"><a href="#L-1916"><span class="linenos">1916</span></a>                    <span class="s2">&quot;not enough memory: try a 32-bit build instead&quot;</span><span class="p">)</span>
</span><span id="L-1917"><a href="#L-1917"><span class="linenos">1917</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1918"><a href="#L-1918"><span class="linenos">1918</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
</span><span id="L-1919"><a href="#L-1919"><span class="linenos">1919</span></a>                    <span class="s2">&quot;not enough memory: </span><span class="si">%.1f</span><span class="s2">G minimum needed&quot;</span>
</span><span id="L-1920"><a href="#L-1920"><span class="linenos">1920</span></a>                    <span class="o">%</span> <span class="p">(</span><span class="n">MAX_Py_ssize_t</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)))</span>
</span><span id="L-1921"><a href="#L-1921"><span class="linenos">1921</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1922"><a href="#L-1922"><span class="linenos">1922</span></a>            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="L-1923"><a href="#L-1923"><span class="linenos">1923</span></a>    <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="L-1924"><a href="#L-1924"><span class="linenos">1924</span></a>
</span><span id="L-1925"><a href="#L-1925"><span class="linenos">1925</span></a><span class="c1">#=======================================================================</span>
</span><span id="L-1926"><a href="#L-1926"><span class="linenos">1926</span></a><span class="c1"># unittest integration.</span>
</span><span id="L-1927"><a href="#L-1927"><span class="linenos">1927</span></a>
</span><span id="L-1928"><a href="#L-1928"><span class="linenos">1928</span></a><span class="k">class</span> <span class="nc">BasicTestRunner</span><span class="p">:</span>
</span><span id="L-1929"><a href="#L-1929"><span class="linenos">1929</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
</span><span id="L-1930"><a href="#L-1930"><span class="linenos">1930</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestResult</span><span class="p">()</span>
</span><span id="L-1931"><a href="#L-1931"><span class="linenos">1931</span></a>        <span class="n">test</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="L-1932"><a href="#L-1932"><span class="linenos">1932</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-1933"><a href="#L-1933"><span class="linenos">1933</span></a>
</span><span id="L-1934"><a href="#L-1934"><span class="linenos">1934</span></a><span class="k">def</span> <span class="nf">_id</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="L-1935"><a href="#L-1935"><span class="linenos">1935</span></a>    <span class="k">return</span> <span class="n">obj</span>
</span><span id="L-1936"><a href="#L-1936"><span class="linenos">1936</span></a>
</span><span id="L-1937"><a href="#L-1937"><span class="linenos">1937</span></a><span class="k">def</span> <span class="nf">requires_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
</span><span id="L-1938"><a href="#L-1938"><span class="linenos">1938</span></a>    <span class="k">if</span> <span class="n">resource</span> <span class="o">==</span> <span class="s1">&#39;gui&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_gui_available</span><span class="p">():</span>
</span><span id="L-1939"><a href="#L-1939"><span class="linenos">1939</span></a>        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">_is_gui_available</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
</span><span id="L-1940"><a href="#L-1940"><span class="linenos">1940</span></a>    <span class="k">if</span> <span class="n">is_resource_enabled</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
</span><span id="L-1941"><a href="#L-1941"><span class="linenos">1941</span></a>        <span class="k">return</span> <span class="n">_id</span>
</span><span id="L-1942"><a href="#L-1942"><span class="linenos">1942</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1943"><a href="#L-1943"><span class="linenos">1943</span></a>        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;resource </span><span class="si">{0!r}</span><span class="s2"> is not enabled&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resource</span><span class="p">))</span>
</span><span id="L-1944"><a href="#L-1944"><span class="linenos">1944</span></a>
</span><span id="L-1945"><a href="#L-1945"><span class="linenos">1945</span></a><span class="k">def</span> <span class="nf">cpython_only</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="L-1946"><a href="#L-1946"><span class="linenos">1946</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1947"><a href="#L-1947"><span class="linenos">1947</span></a><span class="sd">    Decorator for tests only applicable on CPython.</span>
</span><span id="L-1948"><a href="#L-1948"><span class="linenos">1948</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1949"><a href="#L-1949"><span class="linenos">1949</span></a>    <span class="k">return</span> <span class="n">impl_detail</span><span class="p">(</span><span class="n">cpython</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span><span id="L-1950"><a href="#L-1950"><span class="linenos">1950</span></a>
</span><span id="L-1951"><a href="#L-1951"><span class="linenos">1951</span></a><span class="k">def</span> <span class="nf">impl_detail</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">guards</span><span class="p">):</span>
</span><span id="L-1952"><a href="#L-1952"><span class="linenos">1952</span></a>    <span class="k">if</span> <span class="n">check_impl_detail</span><span class="p">(</span><span class="o">**</span><span class="n">guards</span><span class="p">):</span>
</span><span id="L-1953"><a href="#L-1953"><span class="linenos">1953</span></a>        <span class="k">return</span> <span class="n">_id</span>
</span><span id="L-1954"><a href="#L-1954"><span class="linenos">1954</span></a>    <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1955"><a href="#L-1955"><span class="linenos">1955</span></a>        <span class="n">guardnames</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">_parse_guards</span><span class="p">(</span><span class="n">guards</span><span class="p">)</span>
</span><span id="L-1956"><a href="#L-1956"><span class="linenos">1956</span></a>        <span class="k">if</span> <span class="n">default</span><span class="p">:</span>
</span><span id="L-1957"><a href="#L-1957"><span class="linenos">1957</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;implementation detail not available on </span><span class="si">{0}</span><span class="s2">&quot;</span>
</span><span id="L-1958"><a href="#L-1958"><span class="linenos">1958</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1959"><a href="#L-1959"><span class="linenos">1959</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;implementation detail specific to </span><span class="si">{0}</span><span class="s2">&quot;</span>
</span><span id="L-1960"><a href="#L-1960"><span class="linenos">1960</span></a>        <span class="n">guardnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">guardnames</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-1961"><a href="#L-1961"><span class="linenos">1961</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">guardnames</span><span class="p">))</span>
</span><span id="L-1962"><a href="#L-1962"><span class="linenos">1962</span></a>    <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-1963"><a href="#L-1963"><span class="linenos">1963</span></a>
</span><span id="L-1964"><a href="#L-1964"><span class="linenos">1964</span></a><span class="k">def</span> <span class="nf">_parse_guards</span><span class="p">(</span><span class="n">guards</span><span class="p">):</span>
</span><span id="L-1965"><a href="#L-1965"><span class="linenos">1965</span></a>    <span class="c1"># Returns a tuple ({platform_name: run_me}, default_value)</span>
</span><span id="L-1966"><a href="#L-1966"><span class="linenos">1966</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">guards</span><span class="p">:</span>
</span><span id="L-1967"><a href="#L-1967"><span class="linenos">1967</span></a>        <span class="k">return</span> <span class="p">({</span><span class="s1">&#39;cpython&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="L-1968"><a href="#L-1968"><span class="linenos">1968</span></a>    <span class="n">is_true</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">guards</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1969"><a href="#L-1969"><span class="linenos">1969</span></a>    <span class="k">assert</span> <span class="nb">list</span><span class="p">(</span><span class="n">guards</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">==</span> <span class="p">[</span><span class="n">is_true</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">guards</span><span class="p">)</span>   <span class="c1"># all True or all False</span>
</span><span id="L-1970"><a href="#L-1970"><span class="linenos">1970</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">guards</span><span class="p">,</span> <span class="ow">not</span> <span class="n">is_true</span><span class="p">)</span>
</span><span id="L-1971"><a href="#L-1971"><span class="linenos">1971</span></a>
</span><span id="L-1972"><a href="#L-1972"><span class="linenos">1972</span></a><span class="c1"># Use the following check to guard CPython&#39;s implementation-specific tests --</span>
</span><span id="L-1973"><a href="#L-1973"><span class="linenos">1973</span></a><span class="c1"># or to run them only on the implementation(s) guarded by the arguments.</span>
</span><span id="L-1974"><a href="#L-1974"><span class="linenos">1974</span></a><span class="k">def</span> <span class="nf">check_impl_detail</span><span class="p">(</span><span class="o">**</span><span class="n">guards</span><span class="p">):</span>
</span><span id="L-1975"><a href="#L-1975"><span class="linenos">1975</span></a>    <span class="sd">&quot;&quot;&quot;This function returns True or False depending on the host platform.</span>
</span><span id="L-1976"><a href="#L-1976"><span class="linenos">1976</span></a><span class="sd">       Examples:</span>
</span><span id="L-1977"><a href="#L-1977"><span class="linenos">1977</span></a><span class="sd">          if check_impl_detail():               # only on CPython (default)</span>
</span><span id="L-1978"><a href="#L-1978"><span class="linenos">1978</span></a><span class="sd">          if check_impl_detail(jython=True):    # only on Jython</span>
</span><span id="L-1979"><a href="#L-1979"><span class="linenos">1979</span></a><span class="sd">          if check_impl_detail(cpython=False):  # everywhere except on CPython</span>
</span><span id="L-1980"><a href="#L-1980"><span class="linenos">1980</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1981"><a href="#L-1981"><span class="linenos">1981</span></a>    <span class="n">guards</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">_parse_guards</span><span class="p">(</span><span class="n">guards</span><span class="p">)</span>
</span><span id="L-1982"><a href="#L-1982"><span class="linenos">1982</span></a>    <span class="k">return</span> <span class="n">guards</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">python_implementation</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>
</span><span id="L-1983"><a href="#L-1983"><span class="linenos">1983</span></a>
</span><span id="L-1984"><a href="#L-1984"><span class="linenos">1984</span></a>
</span><span id="L-1985"><a href="#L-1985"><span class="linenos">1985</span></a><span class="k">def</span> <span class="nf">no_tracing</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="L-1986"><a href="#L-1986"><span class="linenos">1986</span></a>    <span class="sd">&quot;&quot;&quot;Decorator to temporarily turn off tracing for the duration of a test.&quot;&quot;&quot;</span>
</span><span id="L-1987"><a href="#L-1987"><span class="linenos">1987</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;gettrace&#39;</span><span class="p">):</span>
</span><span id="L-1988"><a href="#L-1988"><span class="linenos">1988</span></a>        <span class="k">return</span> <span class="n">func</span>
</span><span id="L-1989"><a href="#L-1989"><span class="linenos">1989</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1990"><a href="#L-1990"><span class="linenos">1990</span></a>        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="L-1991"><a href="#L-1991"><span class="linenos">1991</span></a>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-1992"><a href="#L-1992"><span class="linenos">1992</span></a>            <span class="n">original_trace</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">gettrace</span><span class="p">()</span>
</span><span id="L-1993"><a href="#L-1993"><span class="linenos">1993</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-1994"><a href="#L-1994"><span class="linenos">1994</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-1995"><a href="#L-1995"><span class="linenos">1995</span></a>                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="L-1996"><a href="#L-1996"><span class="linenos">1996</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="L-1997"><a href="#L-1997"><span class="linenos">1997</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">settrace</span><span class="p">(</span><span class="n">original_trace</span><span class="p">)</span>
</span><span id="L-1998"><a href="#L-1998"><span class="linenos">1998</span></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="L-1999"><a href="#L-1999"><span class="linenos">1999</span></a>
</span><span id="L-2000"><a href="#L-2000"><span class="linenos">2000</span></a>
</span><span id="L-2001"><a href="#L-2001"><span class="linenos">2001</span></a><span class="k">def</span> <span class="nf">refcount_test</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="L-2002"><a href="#L-2002"><span class="linenos">2002</span></a>    <span class="sd">&quot;&quot;&quot;Decorator for tests which involve reference counting.</span>
</span><span id="L-2003"><a href="#L-2003"><span class="linenos">2003</span></a>
</span><span id="L-2004"><a href="#L-2004"><span class="linenos">2004</span></a><span class="sd">    To start, the decorator does not run the test if is not run by CPython.</span>
</span><span id="L-2005"><a href="#L-2005"><span class="linenos">2005</span></a><span class="sd">    After that, any trace function is unset during the test to prevent</span>
</span><span id="L-2006"><a href="#L-2006"><span class="linenos">2006</span></a><span class="sd">    unexpected refcounts caused by the trace function.</span>
</span><span id="L-2007"><a href="#L-2007"><span class="linenos">2007</span></a>
</span><span id="L-2008"><a href="#L-2008"><span class="linenos">2008</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2009"><a href="#L-2009"><span class="linenos">2009</span></a>    <span class="k">return</span> <span class="n">no_tracing</span><span class="p">(</span><span class="n">cpython_only</span><span class="p">(</span><span class="n">test</span><span class="p">))</span>
</span><span id="L-2010"><a href="#L-2010"><span class="linenos">2010</span></a>
</span><span id="L-2011"><a href="#L-2011"><span class="linenos">2011</span></a>
</span><span id="L-2012"><a href="#L-2012"><span class="linenos">2012</span></a><span class="k">def</span> <span class="nf">_filter_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="n">pred</span><span class="p">):</span>
</span><span id="L-2013"><a href="#L-2013"><span class="linenos">2013</span></a>    <span class="sd">&quot;&quot;&quot;Recursively filter test cases in a suite based on a predicate.&quot;&quot;&quot;</span>
</span><span id="L-2014"><a href="#L-2014"><span class="linenos">2014</span></a>    <span class="n">newtests</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2015"><a href="#L-2015"><span class="linenos">2015</span></a>    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">suite</span><span class="o">.</span><span class="n">_tests</span><span class="p">:</span>
</span><span id="L-2016"><a href="#L-2016"><span class="linenos">2016</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">):</span>
</span><span id="L-2017"><a href="#L-2017"><span class="linenos">2017</span></a>            <span class="n">_filter_suite</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">pred</span><span class="p">)</span>
</span><span id="L-2018"><a href="#L-2018"><span class="linenos">2018</span></a>            <span class="n">newtests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</span><span id="L-2019"><a href="#L-2019"><span class="linenos">2019</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2020"><a href="#L-2020"><span class="linenos">2020</span></a>            <span class="k">if</span> <span class="n">pred</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="L-2021"><a href="#L-2021"><span class="linenos">2021</span></a>                <span class="n">newtests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</span><span id="L-2022"><a href="#L-2022"><span class="linenos">2022</span></a>    <span class="n">suite</span><span class="o">.</span><span class="n">_tests</span> <span class="o">=</span> <span class="n">newtests</span>
</span><span id="L-2023"><a href="#L-2023"><span class="linenos">2023</span></a>
</span><span id="L-2024"><a href="#L-2024"><span class="linenos">2024</span></a><span class="k">def</span> <span class="nf">_run_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">):</span>
</span><span id="L-2025"><a href="#L-2025"><span class="linenos">2025</span></a>    <span class="sd">&quot;&quot;&quot;Run tests from a unittest.TestSuite-derived class.&quot;&quot;&quot;</span>
</span><span id="L-2026"><a href="#L-2026"><span class="linenos">2026</span></a>    <span class="n">runner</span> <span class="o">=</span> <span class="n">get_test_runner</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
</span><span id="L-2027"><a href="#L-2027"><span class="linenos">2027</span></a>                             <span class="n">verbosity</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
</span><span id="L-2028"><a href="#L-2028"><span class="linenos">2028</span></a>                             <span class="n">capture_output</span><span class="o">=</span><span class="p">(</span><span class="n">junit_xml_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">))</span>
</span><span id="L-2029"><a href="#L-2029"><span class="linenos">2029</span></a>
</span><span id="L-2030"><a href="#L-2030"><span class="linenos">2030</span></a>    <span class="n">result</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
</span><span id="L-2031"><a href="#L-2031"><span class="linenos">2031</span></a>
</span><span id="L-2032"><a href="#L-2032"><span class="linenos">2032</span></a>    <span class="k">if</span> <span class="n">junit_xml_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2033"><a href="#L-2033"><span class="linenos">2033</span></a>        <span class="n">junit_xml_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">get_xml_element</span><span class="p">())</span>
</span><span id="L-2034"><a href="#L-2034"><span class="linenos">2034</span></a>
</span><span id="L-2035"><a href="#L-2035"><span class="linenos">2035</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">testsRun</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">skipped</span><span class="p">:</span>
</span><span id="L-2036"><a href="#L-2036"><span class="linenos">2036</span></a>        <span class="k">raise</span> <span class="n">TestDidNotRun</span>
</span><span id="L-2037"><a href="#L-2037"><span class="linenos">2037</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">wasSuccessful</span><span class="p">():</span>
</span><span id="L-2038"><a href="#L-2038"><span class="linenos">2038</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="p">:</span>
</span><span id="L-2039"><a href="#L-2039"><span class="linenos">2039</span></a>            <span class="n">err</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2040"><a href="#L-2040"><span class="linenos">2040</span></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
</span><span id="L-2041"><a href="#L-2041"><span class="linenos">2041</span></a>            <span class="n">err</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2042"><a href="#L-2042"><span class="linenos">2042</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2043"><a href="#L-2043"><span class="linenos">2043</span></a>            <span class="n">err</span> <span class="o">=</span> <span class="s2">&quot;multiple errors occurred&quot;</span>
</span><span id="L-2044"><a href="#L-2044"><span class="linenos">2044</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span> <span class="n">err</span> <span class="o">+=</span> <span class="s2">&quot;; run in verbose mode for details&quot;</span>
</span><span id="L-2045"><a href="#L-2045"><span class="linenos">2045</span></a>        <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span id="L-2046"><a href="#L-2046"><span class="linenos">2046</span></a>
</span><span id="L-2047"><a href="#L-2047"><span class="linenos">2047</span></a>
</span><span id="L-2048"><a href="#L-2048"><span class="linenos">2048</span></a><span class="c1"># By default, don&#39;t filter tests</span>
</span><span id="L-2049"><a href="#L-2049"><span class="linenos">2049</span></a><span class="n">_match_test_func</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2050"><a href="#L-2050"><span class="linenos">2050</span></a>
</span><span id="L-2051"><a href="#L-2051"><span class="linenos">2051</span></a><span class="n">_accept_test_patterns</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2052"><a href="#L-2052"><span class="linenos">2052</span></a><span class="n">_ignore_test_patterns</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2053"><a href="#L-2053"><span class="linenos">2053</span></a>
</span><span id="L-2054"><a href="#L-2054"><span class="linenos">2054</span></a>
</span><span id="L-2055"><a href="#L-2055"><span class="linenos">2055</span></a><span class="k">def</span> <span class="nf">match_test</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="L-2056"><a href="#L-2056"><span class="linenos">2056</span></a>    <span class="c1"># Function used by support.run_unittest() and regrtest --list-cases</span>
</span><span id="L-2057"><a href="#L-2057"><span class="linenos">2057</span></a>    <span class="k">if</span> <span class="n">_match_test_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2058"><a href="#L-2058"><span class="linenos">2058</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-2059"><a href="#L-2059"><span class="linenos">2059</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2060"><a href="#L-2060"><span class="linenos">2060</span></a>        <span class="k">return</span> <span class="n">_match_test_func</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">id</span><span class="p">())</span>
</span><span id="L-2061"><a href="#L-2061"><span class="linenos">2061</span></a>
</span><span id="L-2062"><a href="#L-2062"><span class="linenos">2062</span></a>
</span><span id="L-2063"><a href="#L-2063"><span class="linenos">2063</span></a><span class="k">def</span> <span class="nf">_is_full_match_test</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
</span><span id="L-2064"><a href="#L-2064"><span class="linenos">2064</span></a>    <span class="c1"># If a pattern contains at least one dot, it&#39;s considered</span>
</span><span id="L-2065"><a href="#L-2065"><span class="linenos">2065</span></a>    <span class="c1"># as a full test identifier.</span>
</span><span id="L-2066"><a href="#L-2066"><span class="linenos">2066</span></a>    <span class="c1"># Example: &#39;test.test_os.FileTests.test_access&#39;.</span>
</span><span id="L-2067"><a href="#L-2067"><span class="linenos">2067</span></a>    <span class="c1">#</span>
</span><span id="L-2068"><a href="#L-2068"><span class="linenos">2068</span></a>    <span class="c1"># ignore patterns which contain fnmatch patterns: &#39;*&#39;, &#39;?&#39;, &#39;[...]&#39;</span>
</span><span id="L-2069"><a href="#L-2069"><span class="linenos">2069</span></a>    <span class="c1"># or &#39;[!...]&#39;. For example, ignore &#39;test_access*&#39;.</span>
</span><span id="L-2070"><a href="#L-2070"><span class="linenos">2070</span></a>    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">pattern</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[?*\[\]]&#39;</span><span class="p">,</span> <span class="n">pattern</span><span class="p">))</span>
</span><span id="L-2071"><a href="#L-2071"><span class="linenos">2071</span></a>
</span><span id="L-2072"><a href="#L-2072"><span class="linenos">2072</span></a>
</span><span id="L-2073"><a href="#L-2073"><span class="linenos">2073</span></a><span class="k">def</span> <span class="nf">set_match_tests</span><span class="p">(</span><span class="n">accept_patterns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignore_patterns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-2074"><a href="#L-2074"><span class="linenos">2074</span></a>    <span class="k">global</span> <span class="n">_match_test_func</span><span class="p">,</span> <span class="n">_accept_test_patterns</span><span class="p">,</span> <span class="n">_ignore_test_patterns</span>
</span><span id="L-2075"><a href="#L-2075"><span class="linenos">2075</span></a>
</span><span id="L-2076"><a href="#L-2076"><span class="linenos">2076</span></a>
</span><span id="L-2077"><a href="#L-2077"><span class="linenos">2077</span></a>    <span class="k">if</span> <span class="n">accept_patterns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2078"><a href="#L-2078"><span class="linenos">2078</span></a>        <span class="n">accept_patterns</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="L-2079"><a href="#L-2079"><span class="linenos">2079</span></a>    <span class="k">if</span> <span class="n">ignore_patterns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2080"><a href="#L-2080"><span class="linenos">2080</span></a>        <span class="n">ignore_patterns</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="L-2081"><a href="#L-2081"><span class="linenos">2081</span></a>
</span><span id="L-2082"><a href="#L-2082"><span class="linenos">2082</span></a>    <span class="n">accept_func</span> <span class="o">=</span> <span class="n">ignore_func</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2083"><a href="#L-2083"><span class="linenos">2083</span></a>
</span><span id="L-2084"><a href="#L-2084"><span class="linenos">2084</span></a>    <span class="k">if</span> <span class="n">accept_patterns</span> <span class="o">!=</span> <span class="n">_accept_test_patterns</span><span class="p">:</span>
</span><span id="L-2085"><a href="#L-2085"><span class="linenos">2085</span></a>        <span class="n">accept_patterns</span><span class="p">,</span> <span class="n">accept_func</span> <span class="o">=</span> <span class="n">_compile_match_function</span><span class="p">(</span><span class="n">accept_patterns</span><span class="p">)</span>
</span><span id="L-2086"><a href="#L-2086"><span class="linenos">2086</span></a>    <span class="k">if</span> <span class="n">ignore_patterns</span> <span class="o">!=</span> <span class="n">_ignore_test_patterns</span><span class="p">:</span>
</span><span id="L-2087"><a href="#L-2087"><span class="linenos">2087</span></a>        <span class="n">ignore_patterns</span><span class="p">,</span> <span class="n">ignore_func</span> <span class="o">=</span> <span class="n">_compile_match_function</span><span class="p">(</span><span class="n">ignore_patterns</span><span class="p">)</span>
</span><span id="L-2088"><a href="#L-2088"><span class="linenos">2088</span></a>
</span><span id="L-2089"><a href="#L-2089"><span class="linenos">2089</span></a>    <span class="c1"># Create a copy since patterns can be mutable and so modified later</span>
</span><span id="L-2090"><a href="#L-2090"><span class="linenos">2090</span></a>    <span class="n">_accept_test_patterns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">accept_patterns</span><span class="p">)</span>
</span><span id="L-2091"><a href="#L-2091"><span class="linenos">2091</span></a>    <span class="n">_ignore_test_patterns</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ignore_patterns</span><span class="p">)</span>
</span><span id="L-2092"><a href="#L-2092"><span class="linenos">2092</span></a>
</span><span id="L-2093"><a href="#L-2093"><span class="linenos">2093</span></a>    <span class="k">if</span> <span class="n">accept_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ignore_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2094"><a href="#L-2094"><span class="linenos">2094</span></a>        <span class="k">def</span> <span class="nf">match_function</span><span class="p">(</span><span class="n">test_id</span><span class="p">):</span>
</span><span id="L-2095"><a href="#L-2095"><span class="linenos">2095</span></a>            <span class="n">accept</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2096"><a href="#L-2096"><span class="linenos">2096</span></a>            <span class="n">ignore</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2097"><a href="#L-2097"><span class="linenos">2097</span></a>            <span class="k">if</span> <span class="n">accept_func</span><span class="p">:</span>
</span><span id="L-2098"><a href="#L-2098"><span class="linenos">2098</span></a>                <span class="n">accept</span> <span class="o">=</span> <span class="n">accept_func</span><span class="p">(</span><span class="n">test_id</span><span class="p">)</span>
</span><span id="L-2099"><a href="#L-2099"><span class="linenos">2099</span></a>            <span class="k">if</span> <span class="n">ignore_func</span><span class="p">:</span>
</span><span id="L-2100"><a href="#L-2100"><span class="linenos">2100</span></a>                <span class="n">ignore</span> <span class="o">=</span> <span class="n">ignore_func</span><span class="p">(</span><span class="n">test_id</span><span class="p">)</span>
</span><span id="L-2101"><a href="#L-2101"><span class="linenos">2101</span></a>            <span class="k">return</span> <span class="n">accept</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore</span>
</span><span id="L-2102"><a href="#L-2102"><span class="linenos">2102</span></a>
</span><span id="L-2103"><a href="#L-2103"><span class="linenos">2103</span></a>        <span class="n">_match_test_func</span> <span class="o">=</span> <span class="n">match_function</span>
</span><span id="L-2104"><a href="#L-2104"><span class="linenos">2104</span></a>
</span><span id="L-2105"><a href="#L-2105"><span class="linenos">2105</span></a>
</span><span id="L-2106"><a href="#L-2106"><span class="linenos">2106</span></a><span class="k">def</span> <span class="nf">_compile_match_function</span><span class="p">(</span><span class="n">patterns</span><span class="p">):</span>
</span><span id="L-2107"><a href="#L-2107"><span class="linenos">2107</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">patterns</span><span class="p">:</span>
</span><span id="L-2108"><a href="#L-2108"><span class="linenos">2108</span></a>        <span class="n">func</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2109"><a href="#L-2109"><span class="linenos">2109</span></a>        <span class="c1"># set_match_tests(None) behaves as set_match_tests(())</span>
</span><span id="L-2110"><a href="#L-2110"><span class="linenos">2110</span></a>        <span class="n">patterns</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="L-2111"><a href="#L-2111"><span class="linenos">2111</span></a>    <span class="k">elif</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_is_full_match_test</span><span class="p">,</span> <span class="n">patterns</span><span class="p">)):</span>
</span><span id="L-2112"><a href="#L-2112"><span class="linenos">2112</span></a>        <span class="c1"># Simple case: all patterns are full test identifier.</span>
</span><span id="L-2113"><a href="#L-2113"><span class="linenos">2113</span></a>        <span class="c1"># The test.bisect_cmd utility only uses such full test identifiers.</span>
</span><span id="L-2114"><a href="#L-2114"><span class="linenos">2114</span></a>        <span class="n">func</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span><span class="o">.</span><span class="fm">__contains__</span>
</span><span id="L-2115"><a href="#L-2115"><span class="linenos">2115</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2116"><a href="#L-2116"><span class="linenos">2116</span></a>        <span class="n">regex</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">fnmatch</span><span class="o">.</span><span class="n">translate</span><span class="p">,</span> <span class="n">patterns</span><span class="p">))</span>
</span><span id="L-2117"><a href="#L-2117"><span class="linenos">2117</span></a>        <span class="c1"># The search *is* case sensitive on purpose:</span>
</span><span id="L-2118"><a href="#L-2118"><span class="linenos">2118</span></a>        <span class="c1"># don&#39;t use flags=re.IGNORECASE</span>
</span><span id="L-2119"><a href="#L-2119"><span class="linenos">2119</span></a>        <span class="n">regex_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">match</span>
</span><span id="L-2120"><a href="#L-2120"><span class="linenos">2120</span></a>
</span><span id="L-2121"><a href="#L-2121"><span class="linenos">2121</span></a>        <span class="k">def</span> <span class="nf">match_test_regex</span><span class="p">(</span><span class="n">test_id</span><span class="p">):</span>
</span><span id="L-2122"><a href="#L-2122"><span class="linenos">2122</span></a>            <span class="k">if</span> <span class="n">regex_match</span><span class="p">(</span><span class="n">test_id</span><span class="p">):</span>
</span><span id="L-2123"><a href="#L-2123"><span class="linenos">2123</span></a>                <span class="c1"># The regex matches the whole identifier, for example</span>
</span><span id="L-2124"><a href="#L-2124"><span class="linenos">2124</span></a>                <span class="c1"># &#39;test.test_os.FileTests.test_access&#39;.</span>
</span><span id="L-2125"><a href="#L-2125"><span class="linenos">2125</span></a>                <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-2126"><a href="#L-2126"><span class="linenos">2126</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2127"><a href="#L-2127"><span class="linenos">2127</span></a>                <span class="c1"># Try to match parts of the test identifier.</span>
</span><span id="L-2128"><a href="#L-2128"><span class="linenos">2128</span></a>                <span class="c1"># For example, split &#39;test.test_os.FileTests.test_access&#39;</span>
</span><span id="L-2129"><a href="#L-2129"><span class="linenos">2129</span></a>                <span class="c1"># into: &#39;test&#39;, &#39;test_os&#39;, &#39;FileTests&#39; and &#39;test_access&#39;.</span>
</span><span id="L-2130"><a href="#L-2130"><span class="linenos">2130</span></a>                <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">regex_match</span><span class="p">,</span> <span class="n">test_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)))</span>
</span><span id="L-2131"><a href="#L-2131"><span class="linenos">2131</span></a>
</span><span id="L-2132"><a href="#L-2132"><span class="linenos">2132</span></a>        <span class="n">func</span> <span class="o">=</span> <span class="n">match_test_regex</span>
</span><span id="L-2133"><a href="#L-2133"><span class="linenos">2133</span></a>
</span><span id="L-2134"><a href="#L-2134"><span class="linenos">2134</span></a>    <span class="k">return</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">func</span>
</span><span id="L-2135"><a href="#L-2135"><span class="linenos">2135</span></a>
</span><span id="L-2136"><a href="#L-2136"><span class="linenos">2136</span></a>
</span><span id="L-2137"><a href="#L-2137"><span class="linenos">2137</span></a><span class="k">def</span> <span class="nf">run_unittest</span><span class="p">(</span><span class="o">*</span><span class="n">classes</span><span class="p">):</span>
</span><span id="L-2138"><a href="#L-2138"><span class="linenos">2138</span></a>    <span class="sd">&quot;&quot;&quot;Run tests from unittest.TestCase-derived classes.&quot;&quot;&quot;</span>
</span><span id="L-2139"><a href="#L-2139"><span class="linenos">2139</span></a>    <span class="n">valid_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">)</span>
</span><span id="L-2140"><a href="#L-2140"><span class="linenos">2140</span></a>    <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">()</span>
</span><span id="L-2141"><a href="#L-2141"><span class="linenos">2141</span></a>    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="L-2142"><a href="#L-2142"><span class="linenos">2142</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-2143"><a href="#L-2143"><span class="linenos">2143</span></a>            <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
</span><span id="L-2144"><a href="#L-2144"><span class="linenos">2144</span></a>                <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">findTestCases</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="bp">cls</span><span class="p">]))</span>
</span><span id="L-2145"><a href="#L-2145"><span class="linenos">2145</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2146"><a href="#L-2146"><span class="linenos">2146</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;str arguments must be keys in sys.modules&quot;</span><span class="p">)</span>
</span><span id="L-2147"><a href="#L-2147"><span class="linenos">2147</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">valid_types</span><span class="p">):</span>
</span><span id="L-2148"><a href="#L-2148"><span class="linenos">2148</span></a>            <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="L-2149"><a href="#L-2149"><span class="linenos">2149</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2150"><a href="#L-2150"><span class="linenos">2150</span></a>            <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">makeSuite</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span>
</span><span id="L-2151"><a href="#L-2151"><span class="linenos">2151</span></a>    <span class="n">_filter_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="n">match_test</span><span class="p">)</span>
</span><span id="L-2152"><a href="#L-2152"><span class="linenos">2152</span></a>    <span class="n">_run_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
</span><span id="L-2153"><a href="#L-2153"><span class="linenos">2153</span></a>
</span><span id="L-2154"><a href="#L-2154"><span class="linenos">2154</span></a><span class="c1">#=======================================================================</span>
</span><span id="L-2155"><a href="#L-2155"><span class="linenos">2155</span></a><span class="c1"># Check for the presence of docstrings.</span>
</span><span id="L-2156"><a href="#L-2156"><span class="linenos">2156</span></a>
</span><span id="L-2157"><a href="#L-2157"><span class="linenos">2157</span></a><span class="c1"># Rather than trying to enumerate all the cases where docstrings may be</span>
</span><span id="L-2158"><a href="#L-2158"><span class="linenos">2158</span></a><span class="c1"># disabled, we just check for that directly</span>
</span><span id="L-2159"><a href="#L-2159"><span class="linenos">2159</span></a>
</span><span id="L-2160"><a href="#L-2160"><span class="linenos">2160</span></a><span class="k">def</span> <span class="nf">_check_docstrings</span><span class="p">():</span>
</span><span id="L-2161"><a href="#L-2161"><span class="linenos">2161</span></a>    <span class="sd">&quot;&quot;&quot;Just used to check if docstrings are enabled&quot;&quot;&quot;</span>
</span><span id="L-2162"><a href="#L-2162"><span class="linenos">2162</span></a>
</span><span id="L-2163"><a href="#L-2163"><span class="linenos">2163</span></a><span class="n">MISSING_C_DOCSTRINGS</span> <span class="o">=</span> <span class="p">(</span><span class="n">check_impl_detail</span><span class="p">()</span> <span class="ow">and</span>
</span><span id="L-2164"><a href="#L-2164"><span class="linenos">2164</span></a>                        <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">!=</span> <span class="s1">&#39;win32&#39;</span> <span class="ow">and</span>
</span><span id="L-2165"><a href="#L-2165"><span class="linenos">2165</span></a>                        <span class="ow">not</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">get_config_var</span><span class="p">(</span><span class="s1">&#39;WITH_DOC_STRINGS&#39;</span><span class="p">))</span>
</span><span id="L-2166"><a href="#L-2166"><span class="linenos">2166</span></a>
</span><span id="L-2167"><a href="#L-2167"><span class="linenos">2167</span></a><span class="n">HAVE_DOCSTRINGS</span> <span class="o">=</span> <span class="p">(</span><span class="n">_check_docstrings</span><span class="o">.</span><span class="vm">__doc__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
</span><span id="L-2168"><a href="#L-2168"><span class="linenos">2168</span></a>                   <span class="ow">not</span> <span class="n">MISSING_C_DOCSTRINGS</span><span class="p">)</span>
</span><span id="L-2169"><a href="#L-2169"><span class="linenos">2169</span></a>
</span><span id="L-2170"><a href="#L-2170"><span class="linenos">2170</span></a><span class="n">requires_docstrings</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipUnless</span><span class="p">(</span><span class="n">HAVE_DOCSTRINGS</span><span class="p">,</span>
</span><span id="L-2171"><a href="#L-2171"><span class="linenos">2171</span></a>                                          <span class="s2">&quot;test requires docstrings&quot;</span><span class="p">)</span>
</span><span id="L-2172"><a href="#L-2172"><span class="linenos">2172</span></a>
</span><span id="L-2173"><a href="#L-2173"><span class="linenos">2173</span></a>
</span><span id="L-2174"><a href="#L-2174"><span class="linenos">2174</span></a><span class="c1">#=======================================================================</span>
</span><span id="L-2175"><a href="#L-2175"><span class="linenos">2175</span></a><span class="c1"># doctest driver.</span>
</span><span id="L-2176"><a href="#L-2176"><span class="linenos">2176</span></a>
</span><span id="L-2177"><a href="#L-2177"><span class="linenos">2177</span></a><span class="k">def</span> <span class="nf">run_doctest</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-2178"><a href="#L-2178"><span class="linenos">2178</span></a>    <span class="sd">&quot;&quot;&quot;Run doctest on the given module.  Return (#failures, #tests).</span>
</span><span id="L-2179"><a href="#L-2179"><span class="linenos">2179</span></a>
</span><span id="L-2180"><a href="#L-2180"><span class="linenos">2180</span></a><span class="sd">    If optional argument verbosity is not specified (or is None), pass</span>
</span><span id="L-2181"><a href="#L-2181"><span class="linenos">2181</span></a><span class="sd">    support&#39;s belief about verbosity on to doctest.  Else doctest&#39;s</span>
</span><span id="L-2182"><a href="#L-2182"><span class="linenos">2182</span></a><span class="sd">    usual behavior is used (it searches sys.argv for -v).</span>
</span><span id="L-2183"><a href="#L-2183"><span class="linenos">2183</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2184"><a href="#L-2184"><span class="linenos">2184</span></a>
</span><span id="L-2185"><a href="#L-2185"><span class="linenos">2185</span></a>    <span class="kn">import</span> <span class="nn">doctest</span>
</span><span id="L-2186"><a href="#L-2186"><span class="linenos">2186</span></a>
</span><span id="L-2187"><a href="#L-2187"><span class="linenos">2187</span></a>    <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2188"><a href="#L-2188"><span class="linenos">2188</span></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="L-2189"><a href="#L-2189"><span class="linenos">2189</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2190"><a href="#L-2190"><span class="linenos">2190</span></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2191"><a href="#L-2191"><span class="linenos">2191</span></a>
</span><span id="L-2192"><a href="#L-2192"><span class="linenos">2192</span></a>    <span class="n">f</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="n">optionflags</span><span class="p">)</span>
</span><span id="L-2193"><a href="#L-2193"><span class="linenos">2193</span></a>    <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-2194"><a href="#L-2194"><span class="linenos">2194</span></a>        <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> doctests failed&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</span><span id="L-2195"><a href="#L-2195"><span class="linenos">2195</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2196"><a href="#L-2196"><span class="linenos">2196</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;doctest (</span><span class="si">%s</span><span class="s1">) ... </span><span class="si">%d</span><span class="s1"> tests with zero failures&#39;</span> <span class="o">%</span>
</span><span id="L-2197"><a href="#L-2197"><span class="linenos">2197</span></a>              <span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</span><span id="L-2198"><a href="#L-2198"><span class="linenos">2198</span></a>    <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span>
</span><span id="L-2199"><a href="#L-2199"><span class="linenos">2199</span></a>
</span><span id="L-2200"><a href="#L-2200"><span class="linenos">2200</span></a>
</span><span id="L-2201"><a href="#L-2201"><span class="linenos">2201</span></a><span class="c1">#=======================================================================</span>
</span><span id="L-2202"><a href="#L-2202"><span class="linenos">2202</span></a><span class="c1"># Support for saving and restoring the imported modules.</span>
</span><span id="L-2203"><a href="#L-2203"><span class="linenos">2203</span></a>
</span><span id="L-2204"><a href="#L-2204"><span class="linenos">2204</span></a><span class="k">def</span> <span class="nf">print_warning</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
</span><span id="L-2205"><a href="#L-2205"><span class="linenos">2205</span></a>    <span class="c1"># bpo-39983: Print into sys.__stderr__ to display the warning even</span>
</span><span id="L-2206"><a href="#L-2206"><span class="linenos">2206</span></a>    <span class="c1"># when sys.stderr is captured temporarily by a test</span>
</span><span id="L-2207"><a href="#L-2207"><span class="linenos">2207</span></a>    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span><span id="L-2208"><a href="#L-2208"><span class="linenos">2208</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning -- </span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2209"><a href="#L-2209"><span class="linenos">2209</span></a>
</span><span id="L-2210"><a href="#L-2210"><span class="linenos">2210</span></a><span class="k">def</span> <span class="nf">modules_setup</span><span class="p">():</span>
</span><span id="L-2211"><a href="#L-2211"><span class="linenos">2211</span></a>    <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
</span><span id="L-2212"><a href="#L-2212"><span class="linenos">2212</span></a>
</span><span id="L-2213"><a href="#L-2213"><span class="linenos">2213</span></a><span class="k">def</span> <span class="nf">modules_cleanup</span><span class="p">(</span><span class="n">oldmodules</span><span class="p">):</span>
</span><span id="L-2214"><a href="#L-2214"><span class="linenos">2214</span></a>    <span class="c1"># Encoders/decoders are registered permanently within the internal</span>
</span><span id="L-2215"><a href="#L-2215"><span class="linenos">2215</span></a>    <span class="c1"># codec cache. If we destroy the corresponding modules their</span>
</span><span id="L-2216"><a href="#L-2216"><span class="linenos">2216</span></a>    <span class="c1"># globals will be set to None which will trip up the cached functions.</span>
</span><span id="L-2217"><a href="#L-2217"><span class="linenos">2217</span></a>    <span class="n">encodings</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-2218"><a href="#L-2218"><span class="linenos">2218</span></a>                 <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;encodings.&#39;</span><span class="p">)]</span>
</span><span id="L-2219"><a href="#L-2219"><span class="linenos">2219</span></a>    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-2220"><a href="#L-2220"><span class="linenos">2220</span></a>    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">encodings</span><span class="p">)</span>
</span><span id="L-2221"><a href="#L-2221"><span class="linenos">2221</span></a>    <span class="c1"># XXX: This kind of problem can affect more than just encodings. In particular</span>
</span><span id="L-2222"><a href="#L-2222"><span class="linenos">2222</span></a>    <span class="c1"># extension modules (such as _ssl) don&#39;t cope with reloading properly.</span>
</span><span id="L-2223"><a href="#L-2223"><span class="linenos">2223</span></a>    <span class="c1"># Really, test modules should be cleaning out the test specific modules they</span>
</span><span id="L-2224"><a href="#L-2224"><span class="linenos">2224</span></a>    <span class="c1"># know they added (ala test_runpy) rather than relying on this function (as</span>
</span><span id="L-2225"><a href="#L-2225"><span class="linenos">2225</span></a>    <span class="c1"># test_importhooks and test_pkg do currently).</span>
</span><span id="L-2226"><a href="#L-2226"><span class="linenos">2226</span></a>    <span class="c1"># Implicitly imported *real* modules should be left alone (see issue 10556).</span>
</span><span id="L-2227"><a href="#L-2227"><span class="linenos">2227</span></a>    <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">oldmodules</span><span class="p">)</span>
</span><span id="L-2228"><a href="#L-2228"><span class="linenos">2228</span></a>
</span><span id="L-2229"><a href="#L-2229"><span class="linenos">2229</span></a><span class="c1">#=======================================================================</span>
</span><span id="L-2230"><a href="#L-2230"><span class="linenos">2230</span></a><span class="c1"># Threading support to prevent reporting refleaks when running regrtest.py -R</span>
</span><span id="L-2231"><a href="#L-2231"><span class="linenos">2231</span></a>
</span><span id="L-2232"><a href="#L-2232"><span class="linenos">2232</span></a><span class="c1"># Flag used by saved_test_environment of test.libregrtest.save_env,</span>
</span><span id="L-2233"><a href="#L-2233"><span class="linenos">2233</span></a><span class="c1"># to check if a test modified the environment. The flag should be set to False</span>
</span><span id="L-2234"><a href="#L-2234"><span class="linenos">2234</span></a><span class="c1"># before running a new test.</span>
</span><span id="L-2235"><a href="#L-2235"><span class="linenos">2235</span></a><span class="c1">#</span>
</span><span id="L-2236"><a href="#L-2236"><span class="linenos">2236</span></a><span class="c1"># For example, threading_cleanup() sets the flag is the function fails</span>
</span><span id="L-2237"><a href="#L-2237"><span class="linenos">2237</span></a><span class="c1"># to cleanup threads.</span>
</span><span id="L-2238"><a href="#L-2238"><span class="linenos">2238</span></a><span class="n">environment_altered</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2239"><a href="#L-2239"><span class="linenos">2239</span></a>
</span><span id="L-2240"><a href="#L-2240"><span class="linenos">2240</span></a><span class="c1"># NOTE: we use thread._count() rather than threading.enumerate() (or the</span>
</span><span id="L-2241"><a href="#L-2241"><span class="linenos">2241</span></a><span class="c1"># moral equivalent thereof) because a threading.Thread object is still alive</span>
</span><span id="L-2242"><a href="#L-2242"><span class="linenos">2242</span></a><span class="c1"># until its __bootstrap() method has returned, even after it has been</span>
</span><span id="L-2243"><a href="#L-2243"><span class="linenos">2243</span></a><span class="c1"># unregistered from the threading module.</span>
</span><span id="L-2244"><a href="#L-2244"><span class="linenos">2244</span></a><span class="c1"># thread._count(), on the other hand, only gets decremented *after* the</span>
</span><span id="L-2245"><a href="#L-2245"><span class="linenos">2245</span></a><span class="c1"># __bootstrap() method has returned, which gives us reliable reference counts</span>
</span><span id="L-2246"><a href="#L-2246"><span class="linenos">2246</span></a><span class="c1"># at the end of a test run.</span>
</span><span id="L-2247"><a href="#L-2247"><span class="linenos">2247</span></a>
</span><span id="L-2248"><a href="#L-2248"><span class="linenos">2248</span></a><span class="k">def</span> <span class="nf">threading_setup</span><span class="p">():</span>
</span><span id="L-2249"><a href="#L-2249"><span class="linenos">2249</span></a>    <span class="k">return</span> <span class="n">_thread</span><span class="o">.</span><span class="n">_count</span><span class="p">(),</span> <span class="n">threading</span><span class="o">.</span><span class="n">_dangling</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-2250"><a href="#L-2250"><span class="linenos">2250</span></a>
</span><span id="L-2251"><a href="#L-2251"><span class="linenos">2251</span></a><span class="k">def</span> <span class="nf">threading_cleanup</span><span class="p">(</span><span class="o">*</span><span class="n">original_values</span><span class="p">):</span>
</span><span id="L-2252"><a href="#L-2252"><span class="linenos">2252</span></a>    <span class="k">global</span> <span class="n">environment_altered</span>
</span><span id="L-2253"><a href="#L-2253"><span class="linenos">2253</span></a>
</span><span id="L-2254"><a href="#L-2254"><span class="linenos">2254</span></a>    <span class="n">_MAX_COUNT</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="L-2255"><a href="#L-2255"><span class="linenos">2255</span></a>
</span><span id="L-2256"><a href="#L-2256"><span class="linenos">2256</span></a>    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_MAX_COUNT</span><span class="p">):</span>
</span><span id="L-2257"><a href="#L-2257"><span class="linenos">2257</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">_thread</span><span class="o">.</span><span class="n">_count</span><span class="p">(),</span> <span class="n">threading</span><span class="o">.</span><span class="n">_dangling</span>
</span><span id="L-2258"><a href="#L-2258"><span class="linenos">2258</span></a>        <span class="k">if</span> <span class="n">values</span> <span class="o">==</span> <span class="n">original_values</span><span class="p">:</span>
</span><span id="L-2259"><a href="#L-2259"><span class="linenos">2259</span></a>            <span class="k">break</span>
</span><span id="L-2260"><a href="#L-2260"><span class="linenos">2260</span></a>
</span><span id="L-2261"><a href="#L-2261"><span class="linenos">2261</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span>
</span><span id="L-2262"><a href="#L-2262"><span class="linenos">2262</span></a>            <span class="c1"># Display a warning at the first iteration</span>
</span><span id="L-2263"><a href="#L-2263"><span class="linenos">2263</span></a>            <span class="n">environment_altered</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2264"><a href="#L-2264"><span class="linenos">2264</span></a>            <span class="n">dangling_threads</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-2265"><a href="#L-2265"><span class="linenos">2265</span></a>            <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;threading_cleanup() failed to cleanup &quot;</span>
</span><span id="L-2266"><a href="#L-2266"><span class="linenos">2266</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">original_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> threads &quot;</span>
</span><span id="L-2267"><a href="#L-2267"><span class="linenos">2267</span></a>                          <span class="sa">f</span><span class="s2">&quot;(count: </span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="L-2268"><a href="#L-2268"><span class="linenos">2268</span></a>                          <span class="sa">f</span><span class="s2">&quot;dangling: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dangling_threads</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-2269"><a href="#L-2269"><span class="linenos">2269</span></a>            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">dangling_threads</span><span class="p">:</span>
</span><span id="L-2270"><a href="#L-2270"><span class="linenos">2270</span></a>                <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dangling thread: </span><span class="si">{</span><span class="n">thread</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2271"><a href="#L-2271"><span class="linenos">2271</span></a>
</span><span id="L-2272"><a href="#L-2272"><span class="linenos">2272</span></a>            <span class="c1"># Don&#39;t hold references to threads</span>
</span><span id="L-2273"><a href="#L-2273"><span class="linenos">2273</span></a>            <span class="n">dangling_threads</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2274"><a href="#L-2274"><span class="linenos">2274</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2275"><a href="#L-2275"><span class="linenos">2275</span></a>
</span><span id="L-2276"><a href="#L-2276"><span class="linenos">2276</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="L-2277"><a href="#L-2277"><span class="linenos">2277</span></a>        <span class="n">gc_collect</span><span class="p">()</span>
</span><span id="L-2278"><a href="#L-2278"><span class="linenos">2278</span></a>
</span><span id="L-2279"><a href="#L-2279"><span class="linenos">2279</span></a>
</span><span id="L-2280"><a href="#L-2280"><span class="linenos">2280</span></a><span class="k">def</span> <span class="nf">reap_threads</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="L-2281"><a href="#L-2281"><span class="linenos">2281</span></a>    <span class="sd">&quot;&quot;&quot;Use this function when threads are being used.  This will</span>
</span><span id="L-2282"><a href="#L-2282"><span class="linenos">2282</span></a><span class="sd">    ensure that the threads are cleaned up even when the test fails.</span>
</span><span id="L-2283"><a href="#L-2283"><span class="linenos">2283</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2284"><a href="#L-2284"><span class="linenos">2284</span></a>    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="L-2285"><a href="#L-2285"><span class="linenos">2285</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="L-2286"><a href="#L-2286"><span class="linenos">2286</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="n">threading_setup</span><span class="p">()</span>
</span><span id="L-2287"><a href="#L-2287"><span class="linenos">2287</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2288"><a href="#L-2288"><span class="linenos">2288</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span id="L-2289"><a href="#L-2289"><span class="linenos">2289</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-2290"><a href="#L-2290"><span class="linenos">2290</span></a>            <span class="n">threading_cleanup</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
</span><span id="L-2291"><a href="#L-2291"><span class="linenos">2291</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span><span id="L-2292"><a href="#L-2292"><span class="linenos">2292</span></a>
</span><span id="L-2293"><a href="#L-2293"><span class="linenos">2293</span></a>
</span><span id="L-2294"><a href="#L-2294"><span class="linenos">2294</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-2295"><a href="#L-2295"><span class="linenos">2295</span></a><span class="k">def</span> <span class="nf">wait_threads_exit</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">60.0</span><span class="p">):</span>
</span><span id="L-2296"><a href="#L-2296"><span class="linenos">2296</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2297"><a href="#L-2297"><span class="linenos">2297</span></a><span class="sd">    bpo-31234: Context manager to wait until all threads created in the with</span>
</span><span id="L-2298"><a href="#L-2298"><span class="linenos">2298</span></a><span class="sd">    statement exit.</span>
</span><span id="L-2299"><a href="#L-2299"><span class="linenos">2299</span></a>
</span><span id="L-2300"><a href="#L-2300"><span class="linenos">2300</span></a><span class="sd">    Use _thread.count() to check if threads exited. Indirectly, wait until</span>
</span><span id="L-2301"><a href="#L-2301"><span class="linenos">2301</span></a><span class="sd">    threads exit the internal t_bootstrap() C function of the _thread module.</span>
</span><span id="L-2302"><a href="#L-2302"><span class="linenos">2302</span></a>
</span><span id="L-2303"><a href="#L-2303"><span class="linenos">2303</span></a><span class="sd">    threading_setup() and threading_cleanup() are designed to emit a warning</span>
</span><span id="L-2304"><a href="#L-2304"><span class="linenos">2304</span></a><span class="sd">    if a test leaves running threads in the background. This context manager</span>
</span><span id="L-2305"><a href="#L-2305"><span class="linenos">2305</span></a><span class="sd">    is designed to cleanup threads started by the _thread.start_new_thread()</span>
</span><span id="L-2306"><a href="#L-2306"><span class="linenos">2306</span></a><span class="sd">    which doesn&#39;t allow to wait for thread exit, whereas thread.Thread has a</span>
</span><span id="L-2307"><a href="#L-2307"><span class="linenos">2307</span></a><span class="sd">    join() method.</span>
</span><span id="L-2308"><a href="#L-2308"><span class="linenos">2308</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2309"><a href="#L-2309"><span class="linenos">2309</span></a>    <span class="n">old_count</span> <span class="o">=</span> <span class="n">_thread</span><span class="o">.</span><span class="n">_count</span><span class="p">()</span>
</span><span id="L-2310"><a href="#L-2310"><span class="linenos">2310</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-2311"><a href="#L-2311"><span class="linenos">2311</span></a>        <span class="k">yield</span>
</span><span id="L-2312"><a href="#L-2312"><span class="linenos">2312</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-2313"><a href="#L-2313"><span class="linenos">2313</span></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</span><span id="L-2314"><a href="#L-2314"><span class="linenos">2314</span></a>        <span class="n">deadline</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">timeout</span>
</span><span id="L-2315"><a href="#L-2315"><span class="linenos">2315</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-2316"><a href="#L-2316"><span class="linenos">2316</span></a>            <span class="n">count</span> <span class="o">=</span> <span class="n">_thread</span><span class="o">.</span><span class="n">_count</span><span class="p">()</span>
</span><span id="L-2317"><a href="#L-2317"><span class="linenos">2317</span></a>            <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;=</span> <span class="n">old_count</span><span class="p">:</span>
</span><span id="L-2318"><a href="#L-2318"><span class="linenos">2318</span></a>                <span class="k">break</span>
</span><span id="L-2319"><a href="#L-2319"><span class="linenos">2319</span></a>            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">deadline</span><span class="p">:</span>
</span><span id="L-2320"><a href="#L-2320"><span class="linenos">2320</span></a>                <span class="n">dt</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
</span><span id="L-2321"><a href="#L-2321"><span class="linenos">2321</span></a>                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;wait_threads() failed to cleanup </span><span class="si">{</span><span class="n">count</span> <span class="o">-</span> <span class="n">old_count</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="L-2322"><a href="#L-2322"><span class="linenos">2322</span></a>                       <span class="sa">f</span><span class="s2">&quot;threads after </span><span class="si">{</span><span class="n">dt</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds &quot;</span>
</span><span id="L-2323"><a href="#L-2323"><span class="linenos">2323</span></a>                       <span class="sa">f</span><span class="s2">&quot;(count: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">, old count: </span><span class="si">{</span><span class="n">old_count</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="L-2324"><a href="#L-2324"><span class="linenos">2324</span></a>                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2325"><a href="#L-2325"><span class="linenos">2325</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.010</span><span class="p">)</span>
</span><span id="L-2326"><a href="#L-2326"><span class="linenos">2326</span></a>            <span class="n">gc_collect</span><span class="p">()</span>
</span><span id="L-2327"><a href="#L-2327"><span class="linenos">2327</span></a>
</span><span id="L-2328"><a href="#L-2328"><span class="linenos">2328</span></a>
</span><span id="L-2329"><a href="#L-2329"><span class="linenos">2329</span></a><span class="k">def</span> <span class="nf">join_thread</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">):</span>
</span><span id="L-2330"><a href="#L-2330"><span class="linenos">2330</span></a>    <span class="sd">&quot;&quot;&quot;Join a thread. Raise an AssertionError if the thread is still alive</span>
</span><span id="L-2331"><a href="#L-2331"><span class="linenos">2331</span></a><span class="sd">    after timeout seconds.</span>
</span><span id="L-2332"><a href="#L-2332"><span class="linenos">2332</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2333"><a href="#L-2333"><span class="linenos">2333</span></a>    <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="L-2334"><a href="#L-2334"><span class="linenos">2334</span></a>    <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
</span><span id="L-2335"><a href="#L-2335"><span class="linenos">2335</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;failed to join the thread in </span><span class="si">{</span><span class="n">timeout</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
</span><span id="L-2336"><a href="#L-2336"><span class="linenos">2336</span></a>        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="L-2337"><a href="#L-2337"><span class="linenos">2337</span></a>
</span><span id="L-2338"><a href="#L-2338"><span class="linenos">2338</span></a>
</span><span id="L-2339"><a href="#L-2339"><span class="linenos">2339</span></a><span class="k">def</span> <span class="nf">reap_children</span><span class="p">():</span>
</span><span id="L-2340"><a href="#L-2340"><span class="linenos">2340</span></a>    <span class="sd">&quot;&quot;&quot;Use this function at the end of test_main() whenever sub-processes</span>
</span><span id="L-2341"><a href="#L-2341"><span class="linenos">2341</span></a><span class="sd">    are started.  This will help ensure that no extra children (zombies)</span>
</span><span id="L-2342"><a href="#L-2342"><span class="linenos">2342</span></a><span class="sd">    stick around to hog resources and create problems when looking</span>
</span><span id="L-2343"><a href="#L-2343"><span class="linenos">2343</span></a><span class="sd">    for refleaks.</span>
</span><span id="L-2344"><a href="#L-2344"><span class="linenos">2344</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2345"><a href="#L-2345"><span class="linenos">2345</span></a>    <span class="k">global</span> <span class="n">environment_altered</span>
</span><span id="L-2346"><a href="#L-2346"><span class="linenos">2346</span></a>
</span><span id="L-2347"><a href="#L-2347"><span class="linenos">2347</span></a>    <span class="c1"># Need os.waitpid(-1, os.WNOHANG): Windows is not supported</span>
</span><span id="L-2348"><a href="#L-2348"><span class="linenos">2348</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;waitpid&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;WNOHANG&#39;</span><span class="p">)):</span>
</span><span id="L-2349"><a href="#L-2349"><span class="linenos">2349</span></a>        <span class="k">return</span>
</span><span id="L-2350"><a href="#L-2350"><span class="linenos">2350</span></a>
</span><span id="L-2351"><a href="#L-2351"><span class="linenos">2351</span></a>    <span class="c1"># Reap all our dead child processes so we don&#39;t leave zombies around.</span>
</span><span id="L-2352"><a href="#L-2352"><span class="linenos">2352</span></a>    <span class="c1"># These hog resources and might be causing some of the buildbots to die.</span>
</span><span id="L-2353"><a href="#L-2353"><span class="linenos">2353</span></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-2354"><a href="#L-2354"><span class="linenos">2354</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2355"><a href="#L-2355"><span class="linenos">2355</span></a>            <span class="c1"># Read the exit status of any child process which already completed</span>
</span><span id="L-2356"><a href="#L-2356"><span class="linenos">2356</span></a>            <span class="n">pid</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">WNOHANG</span><span class="p">)</span>
</span><span id="L-2357"><a href="#L-2357"><span class="linenos">2357</span></a>        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="L-2358"><a href="#L-2358"><span class="linenos">2358</span></a>            <span class="k">break</span>
</span><span id="L-2359"><a href="#L-2359"><span class="linenos">2359</span></a>
</span><span id="L-2360"><a href="#L-2360"><span class="linenos">2360</span></a>        <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-2361"><a href="#L-2361"><span class="linenos">2361</span></a>            <span class="k">break</span>
</span><span id="L-2362"><a href="#L-2362"><span class="linenos">2362</span></a>
</span><span id="L-2363"><a href="#L-2363"><span class="linenos">2363</span></a>        <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reap_children() reaped child process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-2364"><a href="#L-2364"><span class="linenos">2364</span></a>        <span class="n">environment_altered</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2365"><a href="#L-2365"><span class="linenos">2365</span></a>
</span><span id="L-2366"><a href="#L-2366"><span class="linenos">2366</span></a>
</span><span id="L-2367"><a href="#L-2367"><span class="linenos">2367</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-2368"><a href="#L-2368"><span class="linenos">2368</span></a><span class="k">def</span> <span class="nf">start_threads</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">unlock</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-2369"><a href="#L-2369"><span class="linenos">2369</span></a>    <span class="n">threads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
</span><span id="L-2370"><a href="#L-2370"><span class="linenos">2370</span></a>    <span class="n">started</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2371"><a href="#L-2371"><span class="linenos">2371</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-2372"><a href="#L-2372"><span class="linenos">2372</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2373"><a href="#L-2373"><span class="linenos">2373</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
</span><span id="L-2374"><a href="#L-2374"><span class="linenos">2374</span></a>                <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="L-2375"><a href="#L-2375"><span class="linenos">2375</span></a>                <span class="n">started</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span id="L-2376"><a href="#L-2376"><span class="linenos">2376</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="L-2377"><a href="#L-2377"><span class="linenos">2377</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2378"><a href="#L-2378"><span class="linenos">2378</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can&#39;t start </span><span class="si">%d</span><span class="s2"> threads, only </span><span class="si">%d</span><span class="s2"> threads started&quot;</span> <span class="o">%</span>
</span><span id="L-2379"><a href="#L-2379"><span class="linenos">2379</span></a>                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">started</span><span class="p">)))</span>
</span><span id="L-2380"><a href="#L-2380"><span class="linenos">2380</span></a>            <span class="k">raise</span>
</span><span id="L-2381"><a href="#L-2381"><span class="linenos">2381</span></a>        <span class="k">yield</span>
</span><span id="L-2382"><a href="#L-2382"><span class="linenos">2382</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-2383"><a href="#L-2383"><span class="linenos">2383</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2384"><a href="#L-2384"><span class="linenos">2384</span></a>            <span class="k">if</span> <span class="n">unlock</span><span class="p">:</span>
</span><span id="L-2385"><a href="#L-2385"><span class="linenos">2385</span></a>                <span class="n">unlock</span><span class="p">()</span>
</span><span id="L-2386"><a href="#L-2386"><span class="linenos">2386</span></a>            <span class="n">endtime</span> <span class="o">=</span> <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</span><span id="L-2387"><a href="#L-2387"><span class="linenos">2387</span></a>            <span class="k">for</span> <span class="n">timeout</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
</span><span id="L-2388"><a href="#L-2388"><span class="linenos">2388</span></a>                <span class="n">endtime</span> <span class="o">+=</span> <span class="mi">60</span>
</span><span id="L-2389"><a href="#L-2389"><span class="linenos">2389</span></a>                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">started</span><span class="p">:</span>
</span><span id="L-2390"><a href="#L-2390"><span class="linenos">2390</span></a>                    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">(),</span> <span class="mf">0.01</span><span class="p">))</span>
</span><span id="L-2391"><a href="#L-2391"><span class="linenos">2391</span></a>                <span class="n">started</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">started</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()]</span>
</span><span id="L-2392"><a href="#L-2392"><span class="linenos">2392</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">started</span><span class="p">:</span>
</span><span id="L-2393"><a href="#L-2393"><span class="linenos">2393</span></a>                    <span class="k">break</span>
</span><span id="L-2394"><a href="#L-2394"><span class="linenos">2394</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2395"><a href="#L-2395"><span class="linenos">2395</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unable to join </span><span class="si">%d</span><span class="s1"> threads during a period of &#39;</span>
</span><span id="L-2396"><a href="#L-2396"><span class="linenos">2396</span></a>                          <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> minutes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">started</span><span class="p">),</span> <span class="n">timeout</span><span class="p">))</span>
</span><span id="L-2397"><a href="#L-2397"><span class="linenos">2397</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-2398"><a href="#L-2398"><span class="linenos">2398</span></a>            <span class="n">started</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">started</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()]</span>
</span><span id="L-2399"><a href="#L-2399"><span class="linenos">2399</span></a>            <span class="k">if</span> <span class="n">started</span><span class="p">:</span>
</span><span id="L-2400"><a href="#L-2400"><span class="linenos">2400</span></a>                <span class="n">faulthandler</span><span class="o">.</span><span class="n">dump_traceback</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</span><span id="L-2401"><a href="#L-2401"><span class="linenos">2401</span></a>                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Unable to join </span><span class="si">%d</span><span class="s1"> threads&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">started</span><span class="p">))</span>
</span><span id="L-2402"><a href="#L-2402"><span class="linenos">2402</span></a>
</span><span id="L-2403"><a href="#L-2403"><span class="linenos">2403</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-2404"><a href="#L-2404"><span class="linenos">2404</span></a><span class="k">def</span> <span class="nf">swap_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span><span class="p">):</span>
</span><span id="L-2405"><a href="#L-2405"><span class="linenos">2405</span></a>    <span class="sd">&quot;&quot;&quot;Temporary swap out an attribute with a new object.</span>
</span><span id="L-2406"><a href="#L-2406"><span class="linenos">2406</span></a>
</span><span id="L-2407"><a href="#L-2407"><span class="linenos">2407</span></a><span class="sd">    Usage:</span>
</span><span id="L-2408"><a href="#L-2408"><span class="linenos">2408</span></a><span class="sd">        with swap_attr(obj, &quot;attr&quot;, 5):</span>
</span><span id="L-2409"><a href="#L-2409"><span class="linenos">2409</span></a><span class="sd">            ...</span>
</span><span id="L-2410"><a href="#L-2410"><span class="linenos">2410</span></a>
</span><span id="L-2411"><a href="#L-2411"><span class="linenos">2411</span></a><span class="sd">        This will set obj.attr to 5 for the duration of the with: block,</span>
</span><span id="L-2412"><a href="#L-2412"><span class="linenos">2412</span></a><span class="sd">        restoring the old value at the end of the block. If `attr` doesn&#39;t</span>
</span><span id="L-2413"><a href="#L-2413"><span class="linenos">2413</span></a><span class="sd">        exist on `obj`, it will be created and then deleted at the end of the</span>
</span><span id="L-2414"><a href="#L-2414"><span class="linenos">2414</span></a><span class="sd">        block.</span>
</span><span id="L-2415"><a href="#L-2415"><span class="linenos">2415</span></a>
</span><span id="L-2416"><a href="#L-2416"><span class="linenos">2416</span></a><span class="sd">        The old value (or None if it doesn&#39;t exist) will be assigned to the</span>
</span><span id="L-2417"><a href="#L-2417"><span class="linenos">2417</span></a><span class="sd">        target of the &quot;as&quot; clause, if there is one.</span>
</span><span id="L-2418"><a href="#L-2418"><span class="linenos">2418</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2419"><a href="#L-2419"><span class="linenos">2419</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
</span><span id="L-2420"><a href="#L-2420"><span class="linenos">2420</span></a>        <span class="n">real_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span><span id="L-2421"><a href="#L-2421"><span class="linenos">2421</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
</span><span id="L-2422"><a href="#L-2422"><span class="linenos">2422</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2423"><a href="#L-2423"><span class="linenos">2423</span></a>            <span class="k">yield</span> <span class="n">real_val</span>
</span><span id="L-2424"><a href="#L-2424"><span class="linenos">2424</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-2425"><a href="#L-2425"><span class="linenos">2425</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">real_val</span><span class="p">)</span>
</span><span id="L-2426"><a href="#L-2426"><span class="linenos">2426</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2427"><a href="#L-2427"><span class="linenos">2427</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
</span><span id="L-2428"><a href="#L-2428"><span class="linenos">2428</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2429"><a href="#L-2429"><span class="linenos">2429</span></a>            <span class="k">yield</span>
</span><span id="L-2430"><a href="#L-2430"><span class="linenos">2430</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-2431"><a href="#L-2431"><span class="linenos">2431</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
</span><span id="L-2432"><a href="#L-2432"><span class="linenos">2432</span></a>                <span class="nb">delattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span><span id="L-2433"><a href="#L-2433"><span class="linenos">2433</span></a>
</span><span id="L-2434"><a href="#L-2434"><span class="linenos">2434</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-2435"><a href="#L-2435"><span class="linenos">2435</span></a><span class="k">def</span> <span class="nf">swap_item</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">new_val</span><span class="p">):</span>
</span><span id="L-2436"><a href="#L-2436"><span class="linenos">2436</span></a>    <span class="sd">&quot;&quot;&quot;Temporary swap out an item with a new object.</span>
</span><span id="L-2437"><a href="#L-2437"><span class="linenos">2437</span></a>
</span><span id="L-2438"><a href="#L-2438"><span class="linenos">2438</span></a><span class="sd">    Usage:</span>
</span><span id="L-2439"><a href="#L-2439"><span class="linenos">2439</span></a><span class="sd">        with swap_item(obj, &quot;item&quot;, 5):</span>
</span><span id="L-2440"><a href="#L-2440"><span class="linenos">2440</span></a><span class="sd">            ...</span>
</span><span id="L-2441"><a href="#L-2441"><span class="linenos">2441</span></a>
</span><span id="L-2442"><a href="#L-2442"><span class="linenos">2442</span></a><span class="sd">        This will set obj[&quot;item&quot;] to 5 for the duration of the with: block,</span>
</span><span id="L-2443"><a href="#L-2443"><span class="linenos">2443</span></a><span class="sd">        restoring the old value at the end of the block. If `item` doesn&#39;t</span>
</span><span id="L-2444"><a href="#L-2444"><span class="linenos">2444</span></a><span class="sd">        exist on `obj`, it will be created and then deleted at the end of the</span>
</span><span id="L-2445"><a href="#L-2445"><span class="linenos">2445</span></a><span class="sd">        block.</span>
</span><span id="L-2446"><a href="#L-2446"><span class="linenos">2446</span></a>
</span><span id="L-2447"><a href="#L-2447"><span class="linenos">2447</span></a><span class="sd">        The old value (or None if it doesn&#39;t exist) will be assigned to the</span>
</span><span id="L-2448"><a href="#L-2448"><span class="linenos">2448</span></a><span class="sd">        target of the &quot;as&quot; clause, if there is one.</span>
</span><span id="L-2449"><a href="#L-2449"><span class="linenos">2449</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2450"><a href="#L-2450"><span class="linenos">2450</span></a>    <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
</span><span id="L-2451"><a href="#L-2451"><span class="linenos">2451</span></a>        <span class="n">real_val</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
</span><span id="L-2452"><a href="#L-2452"><span class="linenos">2452</span></a>        <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
</span><span id="L-2453"><a href="#L-2453"><span class="linenos">2453</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2454"><a href="#L-2454"><span class="linenos">2454</span></a>            <span class="k">yield</span> <span class="n">real_val</span>
</span><span id="L-2455"><a href="#L-2455"><span class="linenos">2455</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-2456"><a href="#L-2456"><span class="linenos">2456</span></a>            <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_val</span>
</span><span id="L-2457"><a href="#L-2457"><span class="linenos">2457</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2458"><a href="#L-2458"><span class="linenos">2458</span></a>        <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
</span><span id="L-2459"><a href="#L-2459"><span class="linenos">2459</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2460"><a href="#L-2460"><span class="linenos">2460</span></a>            <span class="k">yield</span>
</span><span id="L-2461"><a href="#L-2461"><span class="linenos">2461</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-2462"><a href="#L-2462"><span class="linenos">2462</span></a>            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
</span><span id="L-2463"><a href="#L-2463"><span class="linenos">2463</span></a>                <span class="k">del</span> <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
</span><span id="L-2464"><a href="#L-2464"><span class="linenos">2464</span></a>
</span><span id="L-2465"><a href="#L-2465"><span class="linenos">2465</span></a><span class="k">def</span> <span class="nf">strip_python_stderr</span><span class="p">(</span><span class="n">stderr</span><span class="p">):</span>
</span><span id="L-2466"><a href="#L-2466"><span class="linenos">2466</span></a>    <span class="sd">&quot;&quot;&quot;Strip the stderr of a Python process from potential debug output</span>
</span><span id="L-2467"><a href="#L-2467"><span class="linenos">2467</span></a><span class="sd">    emitted by the interpreter.</span>
</span><span id="L-2468"><a href="#L-2468"><span class="linenos">2468</span></a>
</span><span id="L-2469"><a href="#L-2469"><span class="linenos">2469</span></a><span class="sd">    This will typically be run on the result of the communicate() method</span>
</span><span id="L-2470"><a href="#L-2470"><span class="linenos">2470</span></a><span class="sd">    of a subprocess.Popen object.</span>
</span><span id="L-2471"><a href="#L-2471"><span class="linenos">2471</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2472"><a href="#L-2472"><span class="linenos">2472</span></a>    <span class="n">stderr</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">br</span><span class="s2">&quot;\[\d+ refs, \d+ blocks\]\r?\n?&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span><span id="L-2473"><a href="#L-2473"><span class="linenos">2473</span></a>    <span class="k">return</span> <span class="n">stderr</span>
</span><span id="L-2474"><a href="#L-2474"><span class="linenos">2474</span></a>
</span><span id="L-2475"><a href="#L-2475"><span class="linenos">2475</span></a><span class="n">requires_type_collecting</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;getcounts&#39;</span><span class="p">),</span>
</span><span id="L-2476"><a href="#L-2476"><span class="linenos">2476</span></a>                        <span class="s1">&#39;types are immortal if COUNT_ALLOCS is defined&#39;</span><span class="p">)</span>
</span><span id="L-2477"><a href="#L-2477"><span class="linenos">2477</span></a>
</span><span id="L-2478"><a href="#L-2478"><span class="linenos">2478</span></a><span class="k">def</span> <span class="nf">args_from_interpreter_flags</span><span class="p">():</span>
</span><span id="L-2479"><a href="#L-2479"><span class="linenos">2479</span></a>    <span class="sd">&quot;&quot;&quot;Return a list of command-line arguments reproducing the current</span>
</span><span id="L-2480"><a href="#L-2480"><span class="linenos">2480</span></a><span class="sd">    settings in sys.flags and sys.warnoptions.&quot;&quot;&quot;</span>
</span><span id="L-2481"><a href="#L-2481"><span class="linenos">2481</span></a>    <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">_args_from_interpreter_flags</span><span class="p">()</span>
</span><span id="L-2482"><a href="#L-2482"><span class="linenos">2482</span></a>
</span><span id="L-2483"><a href="#L-2483"><span class="linenos">2483</span></a><span class="k">def</span> <span class="nf">optim_args_from_interpreter_flags</span><span class="p">():</span>
</span><span id="L-2484"><a href="#L-2484"><span class="linenos">2484</span></a>    <span class="sd">&quot;&quot;&quot;Return a list of command-line arguments reproducing the current</span>
</span><span id="L-2485"><a href="#L-2485"><span class="linenos">2485</span></a><span class="sd">    optimization settings in sys.flags.&quot;&quot;&quot;</span>
</span><span id="L-2486"><a href="#L-2486"><span class="linenos">2486</span></a>    <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">_optim_args_from_interpreter_flags</span><span class="p">()</span>
</span><span id="L-2487"><a href="#L-2487"><span class="linenos">2487</span></a>
</span><span id="L-2488"><a href="#L-2488"><span class="linenos">2488</span></a><span class="c1">#============================================================</span>
</span><span id="L-2489"><a href="#L-2489"><span class="linenos">2489</span></a><span class="c1"># Support for assertions about logging.</span>
</span><span id="L-2490"><a href="#L-2490"><span class="linenos">2490</span></a><span class="c1">#============================================================</span>
</span><span id="L-2491"><a href="#L-2491"><span class="linenos">2491</span></a>
</span><span id="L-2492"><a href="#L-2492"><span class="linenos">2492</span></a><span class="k">class</span> <span class="nc">TestHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">BufferingHandler</span><span class="p">):</span>
</span><span id="L-2493"><a href="#L-2493"><span class="linenos">2493</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matcher</span><span class="p">):</span>
</span><span id="L-2494"><a href="#L-2494"><span class="linenos">2494</span></a>        <span class="c1"># BufferingHandler takes a &quot;capacity&quot; argument</span>
</span><span id="L-2495"><a href="#L-2495"><span class="linenos">2495</span></a>        <span class="c1"># so as to know when to flush. As we&#39;re overriding</span>
</span><span id="L-2496"><a href="#L-2496"><span class="linenos">2496</span></a>        <span class="c1"># shouldFlush anyway, we can set a capacity of zero.</span>
</span><span id="L-2497"><a href="#L-2497"><span class="linenos">2497</span></a>        <span class="c1"># You can call flush() manually to clear out the</span>
</span><span id="L-2498"><a href="#L-2498"><span class="linenos">2498</span></a>        <span class="c1"># buffer.</span>
</span><span id="L-2499"><a href="#L-2499"><span class="linenos">2499</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">BufferingHandler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-2500"><a href="#L-2500"><span class="linenos">2500</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span> <span class="o">=</span> <span class="n">matcher</span>
</span><span id="L-2501"><a href="#L-2501"><span class="linenos">2501</span></a>
</span><span id="L-2502"><a href="#L-2502"><span class="linenos">2502</span></a>    <span class="k">def</span> <span class="nf">shouldFlush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2503"><a href="#L-2503"><span class="linenos">2503</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-2504"><a href="#L-2504"><span class="linenos">2504</span></a>
</span><span id="L-2505"><a href="#L-2505"><span class="linenos">2505</span></a>    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
</span><span id="L-2506"><a href="#L-2506"><span class="linenos">2506</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span id="L-2507"><a href="#L-2507"><span class="linenos">2507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="L-2508"><a href="#L-2508"><span class="linenos">2508</span></a>
</span><span id="L-2509"><a href="#L-2509"><span class="linenos">2509</span></a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-2510"><a href="#L-2510"><span class="linenos">2510</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2511"><a href="#L-2511"><span class="linenos">2511</span></a><span class="sd">        Look for a saved dict whose keys/values match the supplied arguments.</span>
</span><span id="L-2512"><a href="#L-2512"><span class="linenos">2512</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2513"><a href="#L-2513"><span class="linenos">2513</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2514"><a href="#L-2514"><span class="linenos">2514</span></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
</span><span id="L-2515"><a href="#L-2515"><span class="linenos">2515</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-2516"><a href="#L-2516"><span class="linenos">2516</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2517"><a href="#L-2517"><span class="linenos">2517</span></a>                <span class="k">break</span>
</span><span id="L-2518"><a href="#L-2518"><span class="linenos">2518</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-2519"><a href="#L-2519"><span class="linenos">2519</span></a>
</span><span id="L-2520"><a href="#L-2520"><span class="linenos">2520</span></a><span class="k">class</span> <span class="nc">Matcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="L-2521"><a href="#L-2521"><span class="linenos">2521</span></a>
</span><span id="L-2522"><a href="#L-2522"><span class="linenos">2522</span></a>    <span class="n">_partial_matches</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;msg&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">)</span>
</span><span id="L-2523"><a href="#L-2523"><span class="linenos">2523</span></a>
</span><span id="L-2524"><a href="#L-2524"><span class="linenos">2524</span></a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="L-2525"><a href="#L-2525"><span class="linenos">2525</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2526"><a href="#L-2526"><span class="linenos">2526</span></a><span class="sd">        Try to match a single dict with the supplied arguments.</span>
</span><span id="L-2527"><a href="#L-2527"><span class="linenos">2527</span></a>
</span><span id="L-2528"><a href="#L-2528"><span class="linenos">2528</span></a><span class="sd">        Keys whose values are strings and which are in self._partial_matches</span>
</span><span id="L-2529"><a href="#L-2529"><span class="linenos">2529</span></a><span class="sd">        will be checked for partial (i.e. substring) matches. You can extend</span>
</span><span id="L-2530"><a href="#L-2530"><span class="linenos">2530</span></a><span class="sd">        this scheme to (for example) do regular expression matching, etc.</span>
</span><span id="L-2531"><a href="#L-2531"><span class="linenos">2531</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2532"><a href="#L-2532"><span class="linenos">2532</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2533"><a href="#L-2533"><span class="linenos">2533</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="L-2534"><a href="#L-2534"><span class="linenos">2534</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-2535"><a href="#L-2535"><span class="linenos">2535</span></a>            <span class="n">dv</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span id="L-2536"><a href="#L-2536"><span class="linenos">2536</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_value</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span id="L-2537"><a href="#L-2537"><span class="linenos">2537</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2538"><a href="#L-2538"><span class="linenos">2538</span></a>                <span class="k">break</span>
</span><span id="L-2539"><a href="#L-2539"><span class="linenos">2539</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-2540"><a href="#L-2540"><span class="linenos">2540</span></a>
</span><span id="L-2541"><a href="#L-2541"><span class="linenos">2541</span></a>    <span class="k">def</span> <span class="nf">match_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span id="L-2542"><a href="#L-2542"><span class="linenos">2542</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2543"><a href="#L-2543"><span class="linenos">2543</span></a><span class="sd">        Try to match a single stored value (dv) with a supplied value (v).</span>
</span><span id="L-2544"><a href="#L-2544"><span class="linenos">2544</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2545"><a href="#L-2545"><span class="linenos">2545</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv</span><span class="p">):</span>
</span><span id="L-2546"><a href="#L-2546"><span class="linenos">2546</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2547"><a href="#L-2547"><span class="linenos">2547</span></a>        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_matches</span><span class="p">:</span>
</span><span id="L-2548"><a href="#L-2548"><span class="linenos">2548</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">dv</span><span class="p">)</span>
</span><span id="L-2549"><a href="#L-2549"><span class="linenos">2549</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2550"><a href="#L-2550"><span class="linenos">2550</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
</span><span id="L-2551"><a href="#L-2551"><span class="linenos">2551</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="L-2552"><a href="#L-2552"><span class="linenos">2552</span></a>
</span><span id="L-2553"><a href="#L-2553"><span class="linenos">2553</span></a>
</span><span id="L-2554"><a href="#L-2554"><span class="linenos">2554</span></a><span class="n">_can_symlink</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2555"><a href="#L-2555"><span class="linenos">2555</span></a><span class="k">def</span> <span class="nf">can_symlink</span><span class="p">():</span>
</span><span id="L-2556"><a href="#L-2556"><span class="linenos">2556</span></a>    <span class="k">global</span> <span class="n">_can_symlink</span>
</span><span id="L-2557"><a href="#L-2557"><span class="linenos">2557</span></a>    <span class="k">if</span> <span class="n">_can_symlink</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2558"><a href="#L-2558"><span class="linenos">2558</span></a>        <span class="k">return</span> <span class="n">_can_symlink</span>
</span><span id="L-2559"><a href="#L-2559"><span class="linenos">2559</span></a>    <span class="n">symlink_path</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s2">&quot;can_symlink&quot;</span>
</span><span id="L-2560"><a href="#L-2560"><span class="linenos">2560</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-2561"><a href="#L-2561"><span class="linenos">2561</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">symlink_path</span><span class="p">)</span>
</span><span id="L-2562"><a href="#L-2562"><span class="linenos">2562</span></a>        <span class="n">can</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2563"><a href="#L-2563"><span class="linenos">2563</span></a>    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
</span><span id="L-2564"><a href="#L-2564"><span class="linenos">2564</span></a>        <span class="n">can</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2565"><a href="#L-2565"><span class="linenos">2565</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2566"><a href="#L-2566"><span class="linenos">2566</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">symlink_path</span><span class="p">)</span>
</span><span id="L-2567"><a href="#L-2567"><span class="linenos">2567</span></a>    <span class="n">_can_symlink</span> <span class="o">=</span> <span class="n">can</span>
</span><span id="L-2568"><a href="#L-2568"><span class="linenos">2568</span></a>    <span class="k">return</span> <span class="n">can</span>
</span><span id="L-2569"><a href="#L-2569"><span class="linenos">2569</span></a>
</span><span id="L-2570"><a href="#L-2570"><span class="linenos">2570</span></a><span class="k">def</span> <span class="nf">skip_unless_symlink</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="L-2571"><a href="#L-2571"><span class="linenos">2571</span></a>    <span class="sd">&quot;&quot;&quot;Skip decorator for tests that require functional symlink&quot;&quot;&quot;</span>
</span><span id="L-2572"><a href="#L-2572"><span class="linenos">2572</span></a>    <span class="n">ok</span> <span class="o">=</span> <span class="n">can_symlink</span><span class="p">()</span>
</span><span id="L-2573"><a href="#L-2573"><span class="linenos">2573</span></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Requires functional symlink implementation&quot;</span>
</span><span id="L-2574"><a href="#L-2574"><span class="linenos">2574</span></a>    <span class="k">return</span> <span class="n">test</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span><span id="L-2575"><a href="#L-2575"><span class="linenos">2575</span></a>
</span><span id="L-2576"><a href="#L-2576"><span class="linenos">2576</span></a><span class="n">_buggy_ucrt</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2577"><a href="#L-2577"><span class="linenos">2577</span></a><span class="k">def</span> <span class="nf">skip_if_buggy_ucrt_strfptime</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="L-2578"><a href="#L-2578"><span class="linenos">2578</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2579"><a href="#L-2579"><span class="linenos">2579</span></a><span class="sd">    Skip decorator for tests that use buggy strptime/strftime</span>
</span><span id="L-2580"><a href="#L-2580"><span class="linenos">2580</span></a>
</span><span id="L-2581"><a href="#L-2581"><span class="linenos">2581</span></a><span class="sd">    If the UCRT bugs are present time.localtime().tm_zone will be</span>
</span><span id="L-2582"><a href="#L-2582"><span class="linenos">2582</span></a><span class="sd">    an empty string, otherwise we assume the UCRT bugs are fixed</span>
</span><span id="L-2583"><a href="#L-2583"><span class="linenos">2583</span></a>
</span><span id="L-2584"><a href="#L-2584"><span class="linenos">2584</span></a><span class="sd">    See bpo-37552 [Windows] strptime/strftime return invalid</span>
</span><span id="L-2585"><a href="#L-2585"><span class="linenos">2585</span></a><span class="sd">    results with UCRT version 17763.615</span>
</span><span id="L-2586"><a href="#L-2586"><span class="linenos">2586</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2587"><a href="#L-2587"><span class="linenos">2587</span></a>    <span class="k">global</span> <span class="n">_buggy_ucrt</span>
</span><span id="L-2588"><a href="#L-2588"><span class="linenos">2588</span></a>    <span class="k">if</span> <span class="n">_buggy_ucrt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2589"><a href="#L-2589"><span class="linenos">2589</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span> <span class="ow">and</span>
</span><span id="L-2590"><a href="#L-2590"><span class="linenos">2590</span></a>                <span class="n">locale</span><span class="o">.</span><span class="n">getdefaultlocale</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">==</span> <span class="s1">&#39;cp65001&#39;</span> <span class="ow">and</span>
</span><span id="L-2591"><a href="#L-2591"><span class="linenos">2591</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span><span class="o">.</span><span class="n">tm_zone</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
</span><span id="L-2592"><a href="#L-2592"><span class="linenos">2592</span></a>            <span class="n">_buggy_ucrt</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2593"><a href="#L-2593"><span class="linenos">2593</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2594"><a href="#L-2594"><span class="linenos">2594</span></a>            <span class="n">_buggy_ucrt</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2595"><a href="#L-2595"><span class="linenos">2595</span></a>    <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;buggy MSVC UCRT strptime/strftime&quot;</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span> <span class="k">if</span> <span class="n">_buggy_ucrt</span> <span class="k">else</span> <span class="n">test</span>
</span><span id="L-2596"><a href="#L-2596"><span class="linenos">2596</span></a>
</span><span id="L-2597"><a href="#L-2597"><span class="linenos">2597</span></a><span class="k">class</span> <span class="nc">PythonSymlink</span><span class="p">:</span>
</span><span id="L-2598"><a href="#L-2598"><span class="linenos">2598</span></a>    <span class="sd">&quot;&quot;&quot;Creates a symlink for the current Python executable&quot;&quot;&quot;</span>
</span><span id="L-2599"><a href="#L-2599"><span class="linenos">2599</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-2600"><a href="#L-2600"><span class="linenos">2600</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">link</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">)</span>
</span><span id="L-2601"><a href="#L-2601"><span class="linenos">2601</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_linked</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2602"><a href="#L-2602"><span class="linenos">2602</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">real</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">)</span>
</span><span id="L-2603"><a href="#L-2603"><span class="linenos">2603</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_also_link</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-2604"><a href="#L-2604"><span class="linenos">2604</span></a>
</span><span id="L-2605"><a href="#L-2605"><span class="linenos">2605</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2606"><a href="#L-2606"><span class="linenos">2606</span></a>
</span><span id="L-2607"><a href="#L-2607"><span class="linenos">2607</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_platform_specific</span><span class="p">()</span>
</span><span id="L-2608"><a href="#L-2608"><span class="linenos">2608</span></a>
</span><span id="L-2609"><a href="#L-2609"><span class="linenos">2609</span></a>    <span class="k">def</span> <span class="nf">_platform_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2610"><a href="#L-2610"><span class="linenos">2610</span></a>        <span class="k">pass</span>
</span><span id="L-2611"><a href="#L-2611"><span class="linenos">2611</span></a>
</span><span id="L-2612"><a href="#L-2612"><span class="linenos">2612</span></a>    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span><span class="p">:</span>
</span><span id="L-2613"><a href="#L-2613"><span class="linenos">2613</span></a>        <span class="k">def</span> <span class="nf">_platform_specific</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2614"><a href="#L-2614"><span class="linenos">2614</span></a>            <span class="kn">import</span> <span class="nn">_winapi</span>
</span><span id="L-2615"><a href="#L-2615"><span class="linenos">2615</span></a>
</span><span id="L-2616"><a href="#L-2616"><span class="linenos">2616</span></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">lexists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real</span><span class="p">):</span>
</span><span id="L-2617"><a href="#L-2617"><span class="linenos">2617</span></a>                <span class="c1"># App symlink appears to not exist, but we want the</span>
</span><span id="L-2618"><a href="#L-2618"><span class="linenos">2618</span></a>                <span class="c1"># real executable here anyway</span>
</span><span id="L-2619"><a href="#L-2619"><span class="linenos">2619</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">real</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">GetModuleFileName</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-2620"><a href="#L-2620"><span class="linenos">2620</span></a>
</span><span id="L-2621"><a href="#L-2621"><span class="linenos">2621</span></a>            <span class="n">dll</span> <span class="o">=</span> <span class="n">_winapi</span><span class="o">.</span><span class="n">GetModuleFileName</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">dllhandle</span><span class="p">)</span>
</span><span id="L-2622"><a href="#L-2622"><span class="linenos">2622</span></a>            <span class="n">src_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dll</span><span class="p">)</span>
</span><span id="L-2623"><a href="#L-2623"><span class="linenos">2623</span></a>            <span class="n">dest_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>
</span><span id="L-2624"><a href="#L-2624"><span class="linenos">2624</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_also_link</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
</span><span id="L-2625"><a href="#L-2625"><span class="linenos">2625</span></a>                <span class="n">dll</span><span class="p">,</span>
</span><span id="L-2626"><a href="#L-2626"><span class="linenos">2626</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dll</span><span class="p">))</span>
</span><span id="L-2627"><a href="#L-2627"><span class="linenos">2627</span></a>            <span class="p">))</span>
</span><span id="L-2628"><a href="#L-2628"><span class="linenos">2628</span></a>            <span class="k">for</span> <span class="n">runtime</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">src_dir</span><span class="p">),</span> <span class="s2">&quot;vcruntime*.dll&quot;</span><span class="p">)):</span>
</span><span id="L-2629"><a href="#L-2629"><span class="linenos">2629</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_also_link</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
</span><span id="L-2630"><a href="#L-2630"><span class="linenos">2630</span></a>                    <span class="n">runtime</span><span class="p">,</span>
</span><span id="L-2631"><a href="#L-2631"><span class="linenos">2631</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">runtime</span><span class="p">))</span>
</span><span id="L-2632"><a href="#L-2632"><span class="linenos">2632</span></a>                <span class="p">))</span>
</span><span id="L-2633"><a href="#L-2633"><span class="linenos">2633</span></a>
</span><span id="L-2634"><a href="#L-2634"><span class="linenos">2634</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">upper</span><span class="p">():</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">}</span>
</span><span id="L-2635"><a href="#L-2635"><span class="linenos">2635</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s2">&quot;PYTHONHOME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
</span><span id="L-2636"><a href="#L-2636"><span class="linenos">2636</span></a>            <span class="k">if</span> <span class="n">sysconfig</span><span class="o">.</span><span class="n">is_python_build</span><span class="p">(</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-2637"><a href="#L-2637"><span class="linenos">2637</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">[</span><span class="s2">&quot;PYTHONPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="vm">__file__</span><span class="p">)</span>
</span><span id="L-2638"><a href="#L-2638"><span class="linenos">2638</span></a>
</span><span id="L-2639"><a href="#L-2639"><span class="linenos">2639</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2640"><a href="#L-2640"><span class="linenos">2640</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>
</span><span id="L-2641"><a href="#L-2641"><span class="linenos">2641</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_linked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">)</span>
</span><span id="L-2642"><a href="#L-2642"><span class="linenos">2642</span></a>        <span class="k">for</span> <span class="n">real</span><span class="p">,</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_also_link</span><span class="p">:</span>
</span><span id="L-2643"><a href="#L-2643"><span class="linenos">2643</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
</span><span id="L-2644"><a href="#L-2644"><span class="linenos">2644</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_linked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
</span><span id="L-2645"><a href="#L-2645"><span class="linenos">2645</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-2646"><a href="#L-2646"><span class="linenos">2646</span></a>
</span><span id="L-2647"><a href="#L-2647"><span class="linenos">2647</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
</span><span id="L-2648"><a href="#L-2648"><span class="linenos">2648</span></a>        <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linked</span><span class="p">:</span>
</span><span id="L-2649"><a href="#L-2649"><span class="linenos">2649</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-2650"><a href="#L-2650"><span class="linenos">2650</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">link</span><span class="p">)</span>
</span><span id="L-2651"><a href="#L-2651"><span class="linenos">2651</span></a>            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span id="L-2652"><a href="#L-2652"><span class="linenos">2652</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2653"><a href="#L-2653"><span class="linenos">2653</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;failed to clean up </span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ex</span><span class="p">))</span>
</span><span id="L-2654"><a href="#L-2654"><span class="linenos">2654</span></a>
</span><span id="L-2655"><a href="#L-2655"><span class="linenos">2655</span></a>    <span class="k">def</span> <span class="nf">_call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">python</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">returncode</span><span class="p">):</span>
</span><span id="L-2656"><a href="#L-2656"><span class="linenos">2656</span></a>        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="n">python</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">]</span>
</span><span id="L-2657"><a href="#L-2657"><span class="linenos">2657</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="L-2658"><a href="#L-2658"><span class="linenos">2658</span></a>                             <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
</span><span id="L-2659"><a href="#L-2659"><span class="linenos">2659</span></a>        <span class="n">r</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</span><span id="L-2660"><a href="#L-2660"><span class="linenos">2660</span></a>        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="n">returncode</span><span class="p">:</span>
</span><span id="L-2661"><a href="#L-2661"><span class="linenos">2661</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2662"><a href="#L-2662"><span class="linenos">2662</span></a>                <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</span><span id="L-2663"><a href="#L-2663"><span class="linenos">2663</span></a>                <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</span><span id="L-2664"><a href="#L-2664"><span class="linenos">2664</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
</span><span id="L-2665"><a href="#L-2665"><span class="linenos">2665</span></a>                <span class="s1">&#39;unexpected return code: </span><span class="si">{0}</span><span class="s1"> (0x</span><span class="si">{0:08X}</span><span class="s1">)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
</span><span id="L-2666"><a href="#L-2666"><span class="linenos">2666</span></a>        <span class="k">return</span> <span class="n">r</span>
</span><span id="L-2667"><a href="#L-2667"><span class="linenos">2667</span></a>
</span><span id="L-2668"><a href="#L-2668"><span class="linenos">2668</span></a>    <span class="k">def</span> <span class="nf">call_real</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-2669"><a href="#L-2669"><span class="linenos">2669</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">returncode</span><span class="p">)</span>
</span><span id="L-2670"><a href="#L-2670"><span class="linenos">2670</span></a>
</span><span id="L-2671"><a href="#L-2671"><span class="linenos">2671</span></a>    <span class="k">def</span> <span class="nf">call_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">returncode</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="L-2672"><a href="#L-2672"><span class="linenos">2672</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="p">,</span> <span class="n">returncode</span><span class="p">)</span>
</span><span id="L-2673"><a href="#L-2673"><span class="linenos">2673</span></a>
</span><span id="L-2674"><a href="#L-2674"><span class="linenos">2674</span></a>
</span><span id="L-2675"><a href="#L-2675"><span class="linenos">2675</span></a><span class="n">_can_xattr</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2676"><a href="#L-2676"><span class="linenos">2676</span></a><span class="k">def</span> <span class="nf">can_xattr</span><span class="p">():</span>
</span><span id="L-2677"><a href="#L-2677"><span class="linenos">2677</span></a>    <span class="k">global</span> <span class="n">_can_xattr</span>
</span><span id="L-2678"><a href="#L-2678"><span class="linenos">2678</span></a>    <span class="k">if</span> <span class="n">_can_xattr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2679"><a href="#L-2679"><span class="linenos">2679</span></a>        <span class="k">return</span> <span class="n">_can_xattr</span>
</span><span id="L-2680"><a href="#L-2680"><span class="linenos">2680</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s2">&quot;setxattr&quot;</span><span class="p">):</span>
</span><span id="L-2681"><a href="#L-2681"><span class="linenos">2681</span></a>        <span class="n">can</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2682"><a href="#L-2682"><span class="linenos">2682</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2683"><a href="#L-2683"><span class="linenos">2683</span></a>        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
</span><span id="L-2684"><a href="#L-2684"><span class="linenos">2684</span></a>        <span class="n">tmp_fp</span><span class="p">,</span> <span class="n">tmp_name</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">)</span>
</span><span id="L-2685"><a href="#L-2685"><span class="linenos">2685</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2686"><a href="#L-2686"><span class="linenos">2686</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
</span><span id="L-2687"><a href="#L-2687"><span class="linenos">2687</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-2688"><a href="#L-2688"><span class="linenos">2688</span></a>                    <span class="c1"># TESTFN &amp; tempfile may use different file systems with</span>
</span><span id="L-2689"><a href="#L-2689"><span class="linenos">2689</span></a>                    <span class="c1"># different capabilities</span>
</span><span id="L-2690"><a href="#L-2690"><span class="linenos">2690</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">setxattr</span><span class="p">(</span><span class="n">tmp_fp</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;user.test&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-2691"><a href="#L-2691"><span class="linenos">2691</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">setxattr</span><span class="p">(</span><span class="n">tmp_name</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;trusted.foo&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;42&quot;</span><span class="p">)</span>
</span><span id="L-2692"><a href="#L-2692"><span class="linenos">2692</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">setxattr</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="sa">b</span><span class="s2">&quot;user.test&quot;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</span><span id="L-2693"><a href="#L-2693"><span class="linenos">2693</span></a>                    <span class="c1"># Kernels &lt; 2.6.39 don&#39;t respect setxattr flags.</span>
</span><span id="L-2694"><a href="#L-2694"><span class="linenos">2694</span></a>                    <span class="n">kernel_version</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="L-2695"><a href="#L-2695"><span class="linenos">2695</span></a>                    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;2.6.(\d{1,2})&quot;</span><span class="p">,</span> <span class="n">kernel_version</span><span class="p">)</span>
</span><span id="L-2696"><a href="#L-2696"><span class="linenos">2696</span></a>                    <span class="n">can</span> <span class="o">=</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">39</span>
</span><span id="L-2697"><a href="#L-2697"><span class="linenos">2697</span></a>                <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="L-2698"><a href="#L-2698"><span class="linenos">2698</span></a>                    <span class="n">can</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2699"><a href="#L-2699"><span class="linenos">2699</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="L-2700"><a href="#L-2700"><span class="linenos">2700</span></a>            <span class="n">unlink</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">)</span>
</span><span id="L-2701"><a href="#L-2701"><span class="linenos">2701</span></a>            <span class="n">unlink</span><span class="p">(</span><span class="n">tmp_name</span><span class="p">)</span>
</span><span id="L-2702"><a href="#L-2702"><span class="linenos">2702</span></a>            <span class="n">rmdir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>
</span><span id="L-2703"><a href="#L-2703"><span class="linenos">2703</span></a>    <span class="n">_can_xattr</span> <span class="o">=</span> <span class="n">can</span>
</span><span id="L-2704"><a href="#L-2704"><span class="linenos">2704</span></a>    <span class="k">return</span> <span class="n">can</span>
</span><span id="L-2705"><a href="#L-2705"><span class="linenos">2705</span></a>
</span><span id="L-2706"><a href="#L-2706"><span class="linenos">2706</span></a><span class="k">def</span> <span class="nf">skip_unless_xattr</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="L-2707"><a href="#L-2707"><span class="linenos">2707</span></a>    <span class="sd">&quot;&quot;&quot;Skip decorator for tests that require functional extended attributes&quot;&quot;&quot;</span>
</span><span id="L-2708"><a href="#L-2708"><span class="linenos">2708</span></a>    <span class="n">ok</span> <span class="o">=</span> <span class="n">can_xattr</span><span class="p">()</span>
</span><span id="L-2709"><a href="#L-2709"><span class="linenos">2709</span></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;no non-broken extended attribute support&quot;</span>
</span><span id="L-2710"><a href="#L-2710"><span class="linenos">2710</span></a>    <span class="k">return</span> <span class="n">test</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span><span id="L-2711"><a href="#L-2711"><span class="linenos">2711</span></a>
</span><span id="L-2712"><a href="#L-2712"><span class="linenos">2712</span></a><span class="k">def</span> <span class="nf">skip_if_pgo_task</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="L-2713"><a href="#L-2713"><span class="linenos">2713</span></a>    <span class="sd">&quot;&quot;&quot;Skip decorator for tests not run in (non-extended) PGO task&quot;&quot;&quot;</span>
</span><span id="L-2714"><a href="#L-2714"><span class="linenos">2714</span></a>    <span class="n">ok</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">PGO</span> <span class="ow">or</span> <span class="n">PGO_EXTENDED</span>
</span><span id="L-2715"><a href="#L-2715"><span class="linenos">2715</span></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not run for (non-extended) PGO task&quot;</span>
</span><span id="L-2716"><a href="#L-2716"><span class="linenos">2716</span></a>    <span class="k">return</span> <span class="n">test</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span><span id="L-2717"><a href="#L-2717"><span class="linenos">2717</span></a>
</span><span id="L-2718"><a href="#L-2718"><span class="linenos">2718</span></a><span class="n">_bind_nix_socket_error</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2719"><a href="#L-2719"><span class="linenos">2719</span></a><span class="k">def</span> <span class="nf">skip_unless_bind_unix_socket</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="L-2720"><a href="#L-2720"><span class="linenos">2720</span></a>    <span class="sd">&quot;&quot;&quot;Decorator for tests requiring a functional bind() for unix sockets.&quot;&quot;&quot;</span>
</span><span id="L-2721"><a href="#L-2721"><span class="linenos">2721</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;AF_UNIX&#39;</span><span class="p">):</span>
</span><span id="L-2722"><a href="#L-2722"><span class="linenos">2722</span></a>        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;No UNIX Sockets&#39;</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span><span id="L-2723"><a href="#L-2723"><span class="linenos">2723</span></a>    <span class="k">global</span> <span class="n">_bind_nix_socket_error</span>
</span><span id="L-2724"><a href="#L-2724"><span class="linenos">2724</span></a>    <span class="k">if</span> <span class="n">_bind_nix_socket_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2725"><a href="#L-2725"><span class="linenos">2725</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s2">&quot;can_bind_unix_socket&quot;</span>
</span><span id="L-2726"><a href="#L-2726"><span class="linenos">2726</span></a>        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
</span><span id="L-2727"><a href="#L-2727"><span class="linenos">2727</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-2728"><a href="#L-2728"><span class="linenos">2728</span></a>                <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-2729"><a href="#L-2729"><span class="linenos">2729</span></a>                <span class="n">_bind_nix_socket_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2730"><a href="#L-2730"><span class="linenos">2730</span></a>            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-2731"><a href="#L-2731"><span class="linenos">2731</span></a>                <span class="n">_bind_nix_socket_error</span> <span class="o">=</span> <span class="n">e</span>
</span><span id="L-2732"><a href="#L-2732"><span class="linenos">2732</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="L-2733"><a href="#L-2733"><span class="linenos">2733</span></a>                <span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="L-2734"><a href="#L-2734"><span class="linenos">2734</span></a>    <span class="k">if</span> <span class="n">_bind_nix_socket_error</span><span class="p">:</span>
</span><span id="L-2735"><a href="#L-2735"><span class="linenos">2735</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Requires a functional unix bind(): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_bind_nix_socket_error</span>
</span><span id="L-2736"><a href="#L-2736"><span class="linenos">2736</span></a>        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span><span id="L-2737"><a href="#L-2737"><span class="linenos">2737</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2738"><a href="#L-2738"><span class="linenos">2738</span></a>        <span class="k">return</span> <span class="n">test</span>
</span><span id="L-2739"><a href="#L-2739"><span class="linenos">2739</span></a>
</span><span id="L-2740"><a href="#L-2740"><span class="linenos">2740</span></a>
</span><span id="L-2741"><a href="#L-2741"><span class="linenos">2741</span></a><span class="k">def</span> <span class="nf">fs_is_case_insensitive</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
</span><span id="L-2742"><a href="#L-2742"><span class="linenos">2742</span></a>    <span class="sd">&quot;&quot;&quot;Detects if the file system for the specified directory is case-insensitive.&quot;&quot;&quot;</span>
</span><span id="L-2743"><a href="#L-2743"><span class="linenos">2743</span></a>    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">directory</span><span class="p">)</span> <span class="k">as</span> <span class="n">base</span><span class="p">:</span>
</span><span id="L-2744"><a href="#L-2744"><span class="linenos">2744</span></a>        <span class="n">base_path</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">name</span>
</span><span id="L-2745"><a href="#L-2745"><span class="linenos">2745</span></a>        <span class="n">case_path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="L-2746"><a href="#L-2746"><span class="linenos">2746</span></a>        <span class="k">if</span> <span class="n">case_path</span> <span class="o">==</span> <span class="n">base_path</span><span class="p">:</span>
</span><span id="L-2747"><a href="#L-2747"><span class="linenos">2747</span></a>            <span class="n">case_path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="L-2748"><a href="#L-2748"><span class="linenos">2748</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-2749"><a href="#L-2749"><span class="linenos">2749</span></a>            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">case_path</span><span class="p">)</span>
</span><span id="L-2750"><a href="#L-2750"><span class="linenos">2750</span></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="L-2751"><a href="#L-2751"><span class="linenos">2751</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-2752"><a href="#L-2752"><span class="linenos">2752</span></a>
</span><span id="L-2753"><a href="#L-2753"><span class="linenos">2753</span></a>
</span><span id="L-2754"><a href="#L-2754"><span class="linenos">2754</span></a><span class="k">def</span> <span class="nf">detect_api_mismatch</span><span class="p">(</span><span class="n">ref_api</span><span class="p">,</span> <span class="n">other_api</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="p">()):</span>
</span><span id="L-2755"><a href="#L-2755"><span class="linenos">2755</span></a>    <span class="sd">&quot;&quot;&quot;Returns the set of items in ref_api not in other_api, except for a</span>
</span><span id="L-2756"><a href="#L-2756"><span class="linenos">2756</span></a><span class="sd">    defined list of items to be ignored in this check.</span>
</span><span id="L-2757"><a href="#L-2757"><span class="linenos">2757</span></a>
</span><span id="L-2758"><a href="#L-2758"><span class="linenos">2758</span></a><span class="sd">    By default this skips private attributes beginning with &#39;_&#39; but</span>
</span><span id="L-2759"><a href="#L-2759"><span class="linenos">2759</span></a><span class="sd">    includes all magic methods, i.e. those starting and ending in &#39;__&#39;.</span>
</span><span id="L-2760"><a href="#L-2760"><span class="linenos">2760</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2761"><a href="#L-2761"><span class="linenos">2761</span></a>    <span class="n">missing_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">ref_api</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">other_api</span><span class="p">))</span>
</span><span id="L-2762"><a href="#L-2762"><span class="linenos">2762</span></a>    <span class="k">if</span> <span class="n">ignore</span><span class="p">:</span>
</span><span id="L-2763"><a href="#L-2763"><span class="linenos">2763</span></a>        <span class="n">missing_items</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ignore</span><span class="p">)</span>
</span><span id="L-2764"><a href="#L-2764"><span class="linenos">2764</span></a>    <span class="n">missing_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing_items</span>
</span><span id="L-2765"><a href="#L-2765"><span class="linenos">2765</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">))</span>
</span><span id="L-2766"><a href="#L-2766"><span class="linenos">2766</span></a>    <span class="k">return</span> <span class="n">missing_items</span>
</span><span id="L-2767"><a href="#L-2767"><span class="linenos">2767</span></a>
</span><span id="L-2768"><a href="#L-2768"><span class="linenos">2768</span></a>
</span><span id="L-2769"><a href="#L-2769"><span class="linenos">2769</span></a><span class="k">def</span> <span class="nf">check__all__</span><span class="p">(</span><span class="n">test_case</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">name_of_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">(),</span>
</span><span id="L-2770"><a href="#L-2770"><span class="linenos">2770</span></a>                 <span class="n">blacklist</span><span class="o">=</span><span class="p">()):</span>
</span><span id="L-2771"><a href="#L-2771"><span class="linenos">2771</span></a>    <span class="sd">&quot;&quot;&quot;Assert that the __all__ variable of &#39;module&#39; contains all public names.</span>
</span><span id="L-2772"><a href="#L-2772"><span class="linenos">2772</span></a>
</span><span id="L-2773"><a href="#L-2773"><span class="linenos">2773</span></a><span class="sd">    The module&#39;s public names (its API) are detected automatically based on</span>
</span><span id="L-2774"><a href="#L-2774"><span class="linenos">2774</span></a><span class="sd">    whether they match the public name convention and were defined in</span>
</span><span id="L-2775"><a href="#L-2775"><span class="linenos">2775</span></a><span class="sd">    &#39;module&#39;.</span>
</span><span id="L-2776"><a href="#L-2776"><span class="linenos">2776</span></a>
</span><span id="L-2777"><a href="#L-2777"><span class="linenos">2777</span></a><span class="sd">    The &#39;name_of_module&#39; argument can specify (as a string or tuple thereof)</span>
</span><span id="L-2778"><a href="#L-2778"><span class="linenos">2778</span></a><span class="sd">    what module(s) an API could be defined in in order to be detected as a</span>
</span><span id="L-2779"><a href="#L-2779"><span class="linenos">2779</span></a><span class="sd">    public API. One case for this is when &#39;module&#39; imports part of its public</span>
</span><span id="L-2780"><a href="#L-2780"><span class="linenos">2780</span></a><span class="sd">    API from other modules, possibly a C backend (like &#39;csv&#39; and its &#39;_csv&#39;).</span>
</span><span id="L-2781"><a href="#L-2781"><span class="linenos">2781</span></a>
</span><span id="L-2782"><a href="#L-2782"><span class="linenos">2782</span></a><span class="sd">    The &#39;extra&#39; argument can be a set of names that wouldn&#39;t otherwise be</span>
</span><span id="L-2783"><a href="#L-2783"><span class="linenos">2783</span></a><span class="sd">    automatically detected as &quot;public&quot;, like objects without a proper</span>
</span><span id="L-2784"><a href="#L-2784"><span class="linenos">2784</span></a><span class="sd">    &#39;__module__&#39; attribute. If provided, it will be added to the</span>
</span><span id="L-2785"><a href="#L-2785"><span class="linenos">2785</span></a><span class="sd">    automatically detected ones.</span>
</span><span id="L-2786"><a href="#L-2786"><span class="linenos">2786</span></a>
</span><span id="L-2787"><a href="#L-2787"><span class="linenos">2787</span></a><span class="sd">    The &#39;blacklist&#39; argument can be a set of names that must not be treated</span>
</span><span id="L-2788"><a href="#L-2788"><span class="linenos">2788</span></a><span class="sd">    as part of the public API even though their names indicate otherwise.</span>
</span><span id="L-2789"><a href="#L-2789"><span class="linenos">2789</span></a>
</span><span id="L-2790"><a href="#L-2790"><span class="linenos">2790</span></a><span class="sd">    Usage:</span>
</span><span id="L-2791"><a href="#L-2791"><span class="linenos">2791</span></a><span class="sd">        import bar</span>
</span><span id="L-2792"><a href="#L-2792"><span class="linenos">2792</span></a><span class="sd">        import foo</span>
</span><span id="L-2793"><a href="#L-2793"><span class="linenos">2793</span></a><span class="sd">        import unittest</span>
</span><span id="L-2794"><a href="#L-2794"><span class="linenos">2794</span></a><span class="sd">        from test import support</span>
</span><span id="L-2795"><a href="#L-2795"><span class="linenos">2795</span></a>
</span><span id="L-2796"><a href="#L-2796"><span class="linenos">2796</span></a><span class="sd">        class MiscTestCase(unittest.TestCase):</span>
</span><span id="L-2797"><a href="#L-2797"><span class="linenos">2797</span></a><span class="sd">            def test__all__(self):</span>
</span><span id="L-2798"><a href="#L-2798"><span class="linenos">2798</span></a><span class="sd">                support.check__all__(self, foo)</span>
</span><span id="L-2799"><a href="#L-2799"><span class="linenos">2799</span></a>
</span><span id="L-2800"><a href="#L-2800"><span class="linenos">2800</span></a><span class="sd">        class OtherTestCase(unittest.TestCase):</span>
</span><span id="L-2801"><a href="#L-2801"><span class="linenos">2801</span></a><span class="sd">            def test__all__(self):</span>
</span><span id="L-2802"><a href="#L-2802"><span class="linenos">2802</span></a><span class="sd">                extra = {&#39;BAR_CONST&#39;, &#39;FOO_CONST&#39;}</span>
</span><span id="L-2803"><a href="#L-2803"><span class="linenos">2803</span></a><span class="sd">                blacklist = {&#39;baz&#39;}  # Undocumented name.</span>
</span><span id="L-2804"><a href="#L-2804"><span class="linenos">2804</span></a><span class="sd">                # bar imports part of its API from _bar.</span>
</span><span id="L-2805"><a href="#L-2805"><span class="linenos">2805</span></a><span class="sd">                support.check__all__(self, bar, (&#39;bar&#39;, &#39;_bar&#39;),</span>
</span><span id="L-2806"><a href="#L-2806"><span class="linenos">2806</span></a><span class="sd">                                     extra=extra, blacklist=blacklist)</span>
</span><span id="L-2807"><a href="#L-2807"><span class="linenos">2807</span></a>
</span><span id="L-2808"><a href="#L-2808"><span class="linenos">2808</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2809"><a href="#L-2809"><span class="linenos">2809</span></a>
</span><span id="L-2810"><a href="#L-2810"><span class="linenos">2810</span></a>    <span class="k">if</span> <span class="n">name_of_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2811"><a href="#L-2811"><span class="linenos">2811</span></a>        <span class="n">name_of_module</span> <span class="o">=</span> <span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">)</span>
</span><span id="L-2812"><a href="#L-2812"><span class="linenos">2812</span></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_of_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-2813"><a href="#L-2813"><span class="linenos">2813</span></a>        <span class="n">name_of_module</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_of_module</span><span class="p">,</span> <span class="p">)</span>
</span><span id="L-2814"><a href="#L-2814"><span class="linenos">2814</span></a>
</span><span id="L-2815"><a href="#L-2815"><span class="linenos">2815</span></a>    <span class="n">expected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
</span><span id="L-2816"><a href="#L-2816"><span class="linenos">2816</span></a>
</span><span id="L-2817"><a href="#L-2817"><span class="linenos">2817</span></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
</span><span id="L-2818"><a href="#L-2818"><span class="linenos">2818</span></a>        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">:</span>
</span><span id="L-2819"><a href="#L-2819"><span class="linenos">2819</span></a>            <span class="k">continue</span>
</span><span id="L-2820"><a href="#L-2820"><span class="linenos">2820</span></a>        <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-2821"><a href="#L-2821"><span class="linenos">2821</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">name_of_module</span> <span class="ow">or</span>
</span><span id="L-2822"><a href="#L-2822"><span class="linenos">2822</span></a>                <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">)</span> <span class="ow">and</span>
</span><span id="L-2823"><a href="#L-2823"><span class="linenos">2823</span></a>                 <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">))):</span>
</span><span id="L-2824"><a href="#L-2824"><span class="linenos">2824</span></a>            <span class="n">expected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-2825"><a href="#L-2825"><span class="linenos">2825</span></a>    <span class="n">test_case</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">__all__</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</span><span id="L-2826"><a href="#L-2826"><span class="linenos">2826</span></a>
</span><span id="L-2827"><a href="#L-2827"><span class="linenos">2827</span></a>
</span><span id="L-2828"><a href="#L-2828"><span class="linenos">2828</span></a><span class="k">def</span> <span class="nf">suppress_msvcrt_asserts</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="L-2829"><a href="#L-2829"><span class="linenos">2829</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-2830"><a href="#L-2830"><span class="linenos">2830</span></a>        <span class="kn">import</span> <span class="nn">msvcrt</span>
</span><span id="L-2831"><a href="#L-2831"><span class="linenos">2831</span></a>    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-2832"><a href="#L-2832"><span class="linenos">2832</span></a>        <span class="k">return</span>
</span><span id="L-2833"><a href="#L-2833"><span class="linenos">2833</span></a>
</span><span id="L-2834"><a href="#L-2834"><span class="linenos">2834</span></a>    <span class="n">msvcrt</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_FAILCRITICALERRORS</span>
</span><span id="L-2835"><a href="#L-2835"><span class="linenos">2835</span></a>                        <span class="o">|</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_NOALIGNMENTFAULTEXCEPT</span>
</span><span id="L-2836"><a href="#L-2836"><span class="linenos">2836</span></a>                        <span class="o">|</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_NOGPFAULTERRORBOX</span>
</span><span id="L-2837"><a href="#L-2837"><span class="linenos">2837</span></a>                        <span class="o">|</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_NOOPENFILEERRORBOX</span><span class="p">)</span>
</span><span id="L-2838"><a href="#L-2838"><span class="linenos">2838</span></a>
</span><span id="L-2839"><a href="#L-2839"><span class="linenos">2839</span></a>    <span class="c1"># CrtSetReportMode() is only available in debug build</span>
</span><span id="L-2840"><a href="#L-2840"><span class="linenos">2840</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msvcrt</span><span class="p">,</span> <span class="s1">&#39;CrtSetReportMode&#39;</span><span class="p">):</span>
</span><span id="L-2841"><a href="#L-2841"><span class="linenos">2841</span></a>        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_WARN</span><span class="p">,</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ERROR</span><span class="p">,</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ASSERT</span><span class="p">]:</span>
</span><span id="L-2842"><a href="#L-2842"><span class="linenos">2842</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="L-2843"><a href="#L-2843"><span class="linenos">2843</span></a>                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRTDBG_MODE_FILE</span><span class="p">)</span>
</span><span id="L-2844"><a href="#L-2844"><span class="linenos">2844</span></a>                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportFile</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRTDBG_FILE_STDERR</span><span class="p">)</span>
</span><span id="L-2845"><a href="#L-2845"><span class="linenos">2845</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-2846"><a href="#L-2846"><span class="linenos">2846</span></a>                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-2847"><a href="#L-2847"><span class="linenos">2847</span></a>
</span><span id="L-2848"><a href="#L-2848"><span class="linenos">2848</span></a>
</span><span id="L-2849"><a href="#L-2849"><span class="linenos">2849</span></a><span class="k">class</span> <span class="nc">SuppressCrashReport</span><span class="p">:</span>
</span><span id="L-2850"><a href="#L-2850"><span class="linenos">2850</span></a>    <span class="sd">&quot;&quot;&quot;Try to prevent a crash report from popping up.</span>
</span><span id="L-2851"><a href="#L-2851"><span class="linenos">2851</span></a>
</span><span id="L-2852"><a href="#L-2852"><span class="linenos">2852</span></a><span class="sd">    On Windows, don&#39;t display the Windows Error Reporting dialog.  On UNIX,</span>
</span><span id="L-2853"><a href="#L-2853"><span class="linenos">2853</span></a><span class="sd">    disable the creation of coredump file.</span>
</span><span id="L-2854"><a href="#L-2854"><span class="linenos">2854</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2855"><a href="#L-2855"><span class="linenos">2855</span></a>    <span class="n">old_value</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2856"><a href="#L-2856"><span class="linenos">2856</span></a>    <span class="n">old_modes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-2857"><a href="#L-2857"><span class="linenos">2857</span></a>
</span><span id="L-2858"><a href="#L-2858"><span class="linenos">2858</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2859"><a href="#L-2859"><span class="linenos">2859</span></a>        <span class="sd">&quot;&quot;&quot;On Windows, disable Windows Error Reporting dialogs using</span>
</span><span id="L-2860"><a href="#L-2860"><span class="linenos">2860</span></a><span class="sd">        SetErrorMode() and CrtSetReportMode().</span>
</span><span id="L-2861"><a href="#L-2861"><span class="linenos">2861</span></a>
</span><span id="L-2862"><a href="#L-2862"><span class="linenos">2862</span></a><span class="sd">        On UNIX, try to save the previous core file size limit, then set</span>
</span><span id="L-2863"><a href="#L-2863"><span class="linenos">2863</span></a><span class="sd">        soft limit to 0.</span>
</span><span id="L-2864"><a href="#L-2864"><span class="linenos">2864</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-2865"><a href="#L-2865"><span class="linenos">2865</span></a>        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">):</span>
</span><span id="L-2866"><a href="#L-2866"><span class="linenos">2866</span></a>            <span class="c1"># see http://msdn.microsoft.com/en-us/library/windows/desktop/ms680621.aspx</span>
</span><span id="L-2867"><a href="#L-2867"><span class="linenos">2867</span></a>            <span class="c1"># GetErrorMode is not available on Windows XP and Windows Server 2003,</span>
</span><span id="L-2868"><a href="#L-2868"><span class="linenos">2868</span></a>            <span class="c1"># but SetErrorMode returns the previous value, so we can use that</span>
</span><span id="L-2869"><a href="#L-2869"><span class="linenos">2869</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-2870"><a href="#L-2870"><span class="linenos">2870</span></a>                <span class="kn">import</span> <span class="nn">msvcrt</span>
</span><span id="L-2871"><a href="#L-2871"><span class="linenos">2871</span></a>            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-2872"><a href="#L-2872"><span class="linenos">2872</span></a>                <span class="k">return</span>
</span><span id="L-2873"><a href="#L-2873"><span class="linenos">2873</span></a>
</span><span id="L-2874"><a href="#L-2874"><span class="linenos">2874</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_NOGPFAULTERRORBOX</span><span class="p">)</span>
</span><span id="L-2875"><a href="#L-2875"><span class="linenos">2875</span></a>
</span><span id="L-2876"><a href="#L-2876"><span class="linenos">2876</span></a>            <span class="n">msvcrt</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">|</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_NOGPFAULTERRORBOX</span><span class="p">)</span>
</span><span id="L-2877"><a href="#L-2877"><span class="linenos">2877</span></a>
</span><span id="L-2878"><a href="#L-2878"><span class="linenos">2878</span></a>            <span class="c1"># bpo-23314: Suppress assert dialogs in debug builds.</span>
</span><span id="L-2879"><a href="#L-2879"><span class="linenos">2879</span></a>            <span class="c1"># CrtSetReportMode() is only available in debug build.</span>
</span><span id="L-2880"><a href="#L-2880"><span class="linenos">2880</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msvcrt</span><span class="p">,</span> <span class="s1">&#39;CrtSetReportMode&#39;</span><span class="p">):</span>
</span><span id="L-2881"><a href="#L-2881"><span class="linenos">2881</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">old_modes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-2882"><a href="#L-2882"><span class="linenos">2882</span></a>                <span class="k">for</span> <span class="n">report_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_WARN</span><span class="p">,</span>
</span><span id="L-2883"><a href="#L-2883"><span class="linenos">2883</span></a>                                    <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ERROR</span><span class="p">,</span>
</span><span id="L-2884"><a href="#L-2884"><span class="linenos">2884</span></a>                                    <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ASSERT</span><span class="p">]:</span>
</span><span id="L-2885"><a href="#L-2885"><span class="linenos">2885</span></a>                    <span class="n">old_mode</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span>
</span><span id="L-2886"><a href="#L-2886"><span class="linenos">2886</span></a>                            <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRTDBG_MODE_FILE</span><span class="p">)</span>
</span><span id="L-2887"><a href="#L-2887"><span class="linenos">2887</span></a>                    <span class="n">old_file</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportFile</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span>
</span><span id="L-2888"><a href="#L-2888"><span class="linenos">2888</span></a>                            <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRTDBG_FILE_STDERR</span><span class="p">)</span>
</span><span id="L-2889"><a href="#L-2889"><span class="linenos">2889</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">old_modes</span><span class="p">[</span><span class="n">report_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_mode</span><span class="p">,</span> <span class="n">old_file</span>
</span><span id="L-2890"><a href="#L-2890"><span class="linenos">2890</span></a>
</span><span id="L-2891"><a href="#L-2891"><span class="linenos">2891</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2892"><a href="#L-2892"><span class="linenos">2892</span></a>            <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2893"><a href="#L-2893"><span class="linenos">2893</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-2894"><a href="#L-2894"><span class="linenos">2894</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">)</span>
</span><span id="L-2895"><a href="#L-2895"><span class="linenos">2895</span></a>                    <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">,</span>
</span><span id="L-2896"><a href="#L-2896"><span class="linenos">2896</span></a>                                       <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="L-2897"><a href="#L-2897"><span class="linenos">2897</span></a>                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
</span><span id="L-2898"><a href="#L-2898"><span class="linenos">2898</span></a>                    <span class="k">pass</span>
</span><span id="L-2899"><a href="#L-2899"><span class="linenos">2899</span></a>
</span><span id="L-2900"><a href="#L-2900"><span class="linenos">2900</span></a>            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
</span><span id="L-2901"><a href="#L-2901"><span class="linenos">2901</span></a>                <span class="c1"># Check if the &#39;Crash Reporter&#39; on OSX was configured</span>
</span><span id="L-2902"><a href="#L-2902"><span class="linenos">2902</span></a>                <span class="c1"># in &#39;Developer&#39; mode and warn that it will get triggered</span>
</span><span id="L-2903"><a href="#L-2903"><span class="linenos">2903</span></a>                <span class="c1"># when it is.</span>
</span><span id="L-2904"><a href="#L-2904"><span class="linenos">2904</span></a>                <span class="c1">#</span>
</span><span id="L-2905"><a href="#L-2905"><span class="linenos">2905</span></a>                <span class="c1"># This assumes that this context manager is used in tests</span>
</span><span id="L-2906"><a href="#L-2906"><span class="linenos">2906</span></a>                <span class="c1"># that might trigger the next manager.</span>
</span><span id="L-2907"><a href="#L-2907"><span class="linenos">2907</span></a>                <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/usr/bin/defaults&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span>
</span><span id="L-2908"><a href="#L-2908"><span class="linenos">2908</span></a>                       <span class="s1">&#39;com.apple.CrashReporter&#39;</span><span class="p">,</span> <span class="s1">&#39;DialogType&#39;</span><span class="p">]</span>
</span><span id="L-2909"><a href="#L-2909"><span class="linenos">2909</span></a>                <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
</span><span id="L-2910"><a href="#L-2910"><span class="linenos">2910</span></a>                                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="L-2911"><a href="#L-2911"><span class="linenos">2911</span></a>                                        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span><span id="L-2912"><a href="#L-2912"><span class="linenos">2912</span></a>                <span class="k">with</span> <span class="n">proc</span><span class="p">:</span>
</span><span id="L-2913"><a href="#L-2913"><span class="linenos">2913</span></a>                    <span class="n">stdout</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-2914"><a href="#L-2914"><span class="linenos">2914</span></a>                <span class="k">if</span> <span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;developer&#39;</span><span class="p">:</span>
</span><span id="L-2915"><a href="#L-2915"><span class="linenos">2915</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;this test triggers the Crash Reporter, &quot;</span>
</span><span id="L-2916"><a href="#L-2916"><span class="linenos">2916</span></a>                          <span class="s2">&quot;that is intentional&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-2917"><a href="#L-2917"><span class="linenos">2917</span></a>
</span><span id="L-2918"><a href="#L-2918"><span class="linenos">2918</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-2919"><a href="#L-2919"><span class="linenos">2919</span></a>
</span><span id="L-2920"><a href="#L-2920"><span class="linenos">2920</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
</span><span id="L-2921"><a href="#L-2921"><span class="linenos">2921</span></a>        <span class="sd">&quot;&quot;&quot;Restore Windows ErrorMode or core file behavior to initial value.&quot;&quot;&quot;</span>
</span><span id="L-2922"><a href="#L-2922"><span class="linenos">2922</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2923"><a href="#L-2923"><span class="linenos">2923</span></a>            <span class="k">return</span>
</span><span id="L-2924"><a href="#L-2924"><span class="linenos">2924</span></a>
</span><span id="L-2925"><a href="#L-2925"><span class="linenos">2925</span></a>        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">):</span>
</span><span id="L-2926"><a href="#L-2926"><span class="linenos">2926</span></a>            <span class="kn">import</span> <span class="nn">msvcrt</span>
</span><span id="L-2927"><a href="#L-2927"><span class="linenos">2927</span></a>            <span class="n">msvcrt</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_value</span><span class="p">)</span>
</span><span id="L-2928"><a href="#L-2928"><span class="linenos">2928</span></a>
</span><span id="L-2929"><a href="#L-2929"><span class="linenos">2929</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_modes</span><span class="p">:</span>
</span><span id="L-2930"><a href="#L-2930"><span class="linenos">2930</span></a>                <span class="k">for</span> <span class="n">report_type</span><span class="p">,</span> <span class="p">(</span><span class="n">old_mode</span><span class="p">,</span> <span class="n">old_file</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-2931"><a href="#L-2931"><span class="linenos">2931</span></a>                    <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span> <span class="n">old_mode</span><span class="p">)</span>
</span><span id="L-2932"><a href="#L-2932"><span class="linenos">2932</span></a>                    <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportFile</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span> <span class="n">old_file</span><span class="p">)</span>
</span><span id="L-2933"><a href="#L-2933"><span class="linenos">2933</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2934"><a href="#L-2934"><span class="linenos">2934</span></a>            <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-2935"><a href="#L-2935"><span class="linenos">2935</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="L-2936"><a href="#L-2936"><span class="linenos">2936</span></a>                    <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span><span class="p">)</span>
</span><span id="L-2937"><a href="#L-2937"><span class="linenos">2937</span></a>                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
</span><span id="L-2938"><a href="#L-2938"><span class="linenos">2938</span></a>                    <span class="k">pass</span>
</span><span id="L-2939"><a href="#L-2939"><span class="linenos">2939</span></a>
</span><span id="L-2940"><a href="#L-2940"><span class="linenos">2940</span></a>
</span><span id="L-2941"><a href="#L-2941"><span class="linenos">2941</span></a><span class="k">def</span> <span class="nf">patch</span><span class="p">(</span><span class="n">test_instance</span><span class="p">,</span> <span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">):</span>
</span><span id="L-2942"><a href="#L-2942"><span class="linenos">2942</span></a>    <span class="sd">&quot;&quot;&quot;Override &#39;object_to_patch&#39;.&#39;attr_name&#39; with &#39;new_value&#39;.</span>
</span><span id="L-2943"><a href="#L-2943"><span class="linenos">2943</span></a>
</span><span id="L-2944"><a href="#L-2944"><span class="linenos">2944</span></a><span class="sd">    Also, add a cleanup procedure to &#39;test_instance&#39; to restore</span>
</span><span id="L-2945"><a href="#L-2945"><span class="linenos">2945</span></a><span class="sd">    &#39;object_to_patch&#39; value for &#39;attr_name&#39;.</span>
</span><span id="L-2946"><a href="#L-2946"><span class="linenos">2946</span></a><span class="sd">    The &#39;attr_name&#39; should be a valid attribute for &#39;object_to_patch&#39;.</span>
</span><span id="L-2947"><a href="#L-2947"><span class="linenos">2947</span></a>
</span><span id="L-2948"><a href="#L-2948"><span class="linenos">2948</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2949"><a href="#L-2949"><span class="linenos">2949</span></a>    <span class="c1"># check that &#39;attr_name&#39; is a real attribute for &#39;object_to_patch&#39;</span>
</span><span id="L-2950"><a href="#L-2950"><span class="linenos">2950</span></a>    <span class="c1"># will raise AttributeError if it does not exist</span>
</span><span id="L-2951"><a href="#L-2951"><span class="linenos">2951</span></a>    <span class="nb">getattr</span><span class="p">(</span><span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
</span><span id="L-2952"><a href="#L-2952"><span class="linenos">2952</span></a>
</span><span id="L-2953"><a href="#L-2953"><span class="linenos">2953</span></a>    <span class="c1"># keep a copy of the old value</span>
</span><span id="L-2954"><a href="#L-2954"><span class="linenos">2954</span></a>    <span class="n">attr_is_local</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-2955"><a href="#L-2955"><span class="linenos">2955</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-2956"><a href="#L-2956"><span class="linenos">2956</span></a>        <span class="n">old_value</span> <span class="o">=</span> <span class="n">object_to_patch</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">attr_name</span><span class="p">]</span>
</span><span id="L-2957"><a href="#L-2957"><span class="linenos">2957</span></a>    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
</span><span id="L-2958"><a href="#L-2958"><span class="linenos">2958</span></a>        <span class="n">old_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-2959"><a href="#L-2959"><span class="linenos">2959</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2960"><a href="#L-2960"><span class="linenos">2960</span></a>        <span class="n">attr_is_local</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-2961"><a href="#L-2961"><span class="linenos">2961</span></a>
</span><span id="L-2962"><a href="#L-2962"><span class="linenos">2962</span></a>    <span class="c1"># restore the value when the test is done</span>
</span><span id="L-2963"><a href="#L-2963"><span class="linenos">2963</span></a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">():</span>
</span><span id="L-2964"><a href="#L-2964"><span class="linenos">2964</span></a>        <span class="k">if</span> <span class="n">attr_is_local</span><span class="p">:</span>
</span><span id="L-2965"><a href="#L-2965"><span class="linenos">2965</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">old_value</span><span class="p">)</span>
</span><span id="L-2966"><a href="#L-2966"><span class="linenos">2966</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-2967"><a href="#L-2967"><span class="linenos">2967</span></a>            <span class="nb">delattr</span><span class="p">(</span><span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
</span><span id="L-2968"><a href="#L-2968"><span class="linenos">2968</span></a>
</span><span id="L-2969"><a href="#L-2969"><span class="linenos">2969</span></a>    <span class="n">test_instance</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">cleanup</span><span class="p">)</span>
</span><span id="L-2970"><a href="#L-2970"><span class="linenos">2970</span></a>
</span><span id="L-2971"><a href="#L-2971"><span class="linenos">2971</span></a>    <span class="c1"># actually override the attribute</span>
</span><span id="L-2972"><a href="#L-2972"><span class="linenos">2972</span></a>    <span class="nb">setattr</span><span class="p">(</span><span class="n">object_to_patch</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">)</span>
</span><span id="L-2973"><a href="#L-2973"><span class="linenos">2973</span></a>
</span><span id="L-2974"><a href="#L-2974"><span class="linenos">2974</span></a>
</span><span id="L-2975"><a href="#L-2975"><span class="linenos">2975</span></a><span class="k">def</span> <span class="nf">run_in_subinterp</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
</span><span id="L-2976"><a href="#L-2976"><span class="linenos">2976</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-2977"><a href="#L-2977"><span class="linenos">2977</span></a><span class="sd">    Run code in a subinterpreter. Raise unittest.SkipTest if the tracemalloc</span>
</span><span id="L-2978"><a href="#L-2978"><span class="linenos">2978</span></a><span class="sd">    module is enabled.</span>
</span><span id="L-2979"><a href="#L-2979"><span class="linenos">2979</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-2980"><a href="#L-2980"><span class="linenos">2980</span></a>    <span class="c1"># Issue #10915, #15751: PyGILState_*() functions don&#39;t work with</span>
</span><span id="L-2981"><a href="#L-2981"><span class="linenos">2981</span></a>    <span class="c1"># sub-interpreters, the tracemalloc module uses these functions internally</span>
</span><span id="L-2982"><a href="#L-2982"><span class="linenos">2982</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-2983"><a href="#L-2983"><span class="linenos">2983</span></a>        <span class="kn">import</span> <span class="nn">tracemalloc</span>
</span><span id="L-2984"><a href="#L-2984"><span class="linenos">2984</span></a>    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="L-2985"><a href="#L-2985"><span class="linenos">2985</span></a>        <span class="k">pass</span>
</span><span id="L-2986"><a href="#L-2986"><span class="linenos">2986</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-2987"><a href="#L-2987"><span class="linenos">2987</span></a>        <span class="k">if</span> <span class="n">tracemalloc</span><span class="o">.</span><span class="n">is_tracing</span><span class="p">():</span>
</span><span id="L-2988"><a href="#L-2988"><span class="linenos">2988</span></a>            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;run_in_subinterp() cannot be used &quot;</span>
</span><span id="L-2989"><a href="#L-2989"><span class="linenos">2989</span></a>                                     <span class="s2">&quot;if tracemalloc module is tracing &quot;</span>
</span><span id="L-2990"><a href="#L-2990"><span class="linenos">2990</span></a>                                     <span class="s2">&quot;memory allocations&quot;</span><span class="p">)</span>
</span><span id="L-2991"><a href="#L-2991"><span class="linenos">2991</span></a>    <span class="kn">import</span> <span class="nn">_testcapi</span>
</span><span id="L-2992"><a href="#L-2992"><span class="linenos">2992</span></a>    <span class="k">return</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">run_in_subinterp</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
</span><span id="L-2993"><a href="#L-2993"><span class="linenos">2993</span></a>
</span><span id="L-2994"><a href="#L-2994"><span class="linenos">2994</span></a>
</span><span id="L-2995"><a href="#L-2995"><span class="linenos">2995</span></a><span class="k">def</span> <span class="nf">check_free_after_iterating</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="nb">iter</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">()):</span>
</span><span id="L-2996"><a href="#L-2996"><span class="linenos">2996</span></a>    <span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="L-2997"><a href="#L-2997"><span class="linenos">2997</span></a>        <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-2998"><a href="#L-2998"><span class="linenos">2998</span></a>            <span class="k">nonlocal</span> <span class="n">done</span>
</span><span id="L-2999"><a href="#L-2999"><span class="linenos">2999</span></a>            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-3000"><a href="#L-3000"><span class="linenos">3000</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-3001"><a href="#L-3001"><span class="linenos">3001</span></a>                <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</span><span id="L-3002"><a href="#L-3002"><span class="linenos">3002</span></a>            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
</span><span id="L-3003"><a href="#L-3003"><span class="linenos">3003</span></a>                <span class="k">pass</span>
</span><span id="L-3004"><a href="#L-3004"><span class="linenos">3004</span></a>
</span><span id="L-3005"><a href="#L-3005"><span class="linenos">3005</span></a>    <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-3006"><a href="#L-3006"><span class="linenos">3006</span></a>    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
</span><span id="L-3007"><a href="#L-3007"><span class="linenos">3007</span></a>    <span class="c1"># Issue 26494: Shouldn&#39;t crash</span>
</span><span id="L-3008"><a href="#L-3008"><span class="linenos">3008</span></a>    <span class="n">test</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">StopIteration</span><span class="p">,</span> <span class="nb">next</span><span class="p">,</span> <span class="n">it</span><span class="p">)</span>
</span><span id="L-3009"><a href="#L-3009"><span class="linenos">3009</span></a>    <span class="c1"># The sequence should be deallocated just after the end of iterating</span>
</span><span id="L-3010"><a href="#L-3010"><span class="linenos">3010</span></a>    <span class="n">gc_collect</span><span class="p">()</span>
</span><span id="L-3011"><a href="#L-3011"><span class="linenos">3011</span></a>    <span class="n">test</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
</span><span id="L-3012"><a href="#L-3012"><span class="linenos">3012</span></a>
</span><span id="L-3013"><a href="#L-3013"><span class="linenos">3013</span></a>
</span><span id="L-3014"><a href="#L-3014"><span class="linenos">3014</span></a><span class="k">def</span> <span class="nf">missing_compiler_executable</span><span class="p">(</span><span class="n">cmd_names</span><span class="o">=</span><span class="p">[]):</span>
</span><span id="L-3015"><a href="#L-3015"><span class="linenos">3015</span></a>    <span class="sd">&quot;&quot;&quot;Check if the compiler components used to build the interpreter exist.</span>
</span><span id="L-3016"><a href="#L-3016"><span class="linenos">3016</span></a>
</span><span id="L-3017"><a href="#L-3017"><span class="linenos">3017</span></a><span class="sd">    Check for the existence of the compiler executables whose names are listed</span>
</span><span id="L-3018"><a href="#L-3018"><span class="linenos">3018</span></a><span class="sd">    in &#39;cmd_names&#39; or all the compiler executables when &#39;cmd_names&#39; is empty</span>
</span><span id="L-3019"><a href="#L-3019"><span class="linenos">3019</span></a><span class="sd">    and return the first missing executable or None when none is found</span>
</span><span id="L-3020"><a href="#L-3020"><span class="linenos">3020</span></a><span class="sd">    missing.</span>
</span><span id="L-3021"><a href="#L-3021"><span class="linenos">3021</span></a>
</span><span id="L-3022"><a href="#L-3022"><span class="linenos">3022</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3023"><a href="#L-3023"><span class="linenos">3023</span></a>    <span class="kn">from</span> <span class="nn">distutils</span> <span class="kn">import</span> <span class="n">ccompiler</span><span class="p">,</span> <span class="n">sysconfig</span><span class="p">,</span> <span class="n">spawn</span>
</span><span id="L-3024"><a href="#L-3024"><span class="linenos">3024</span></a>    <span class="n">compiler</span> <span class="o">=</span> <span class="n">ccompiler</span><span class="o">.</span><span class="n">new_compiler</span><span class="p">()</span>
</span><span id="L-3025"><a href="#L-3025"><span class="linenos">3025</span></a>    <span class="n">sysconfig</span><span class="o">.</span><span class="n">customize_compiler</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
</span><span id="L-3026"><a href="#L-3026"><span class="linenos">3026</span></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">compiler</span><span class="o">.</span><span class="n">executables</span><span class="p">:</span>
</span><span id="L-3027"><a href="#L-3027"><span class="linenos">3027</span></a>        <span class="k">if</span> <span class="n">cmd_names</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd_names</span><span class="p">:</span>
</span><span id="L-3028"><a href="#L-3028"><span class="linenos">3028</span></a>            <span class="k">continue</span>
</span><span id="L-3029"><a href="#L-3029"><span class="linenos">3029</span></a>        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="L-3030"><a href="#L-3030"><span class="linenos">3030</span></a>        <span class="k">if</span> <span class="n">cmd_names</span><span class="p">:</span>
</span><span id="L-3031"><a href="#L-3031"><span class="linenos">3031</span></a>            <span class="k">assert</span> <span class="n">cmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
</span><span id="L-3032"><a href="#L-3032"><span class="linenos">3032</span></a>                    <span class="s2">&quot;the &#39;</span><span class="si">%s</span><span class="s2">&#39; executable is not configured&quot;</span> <span class="o">%</span> <span class="n">name</span>
</span><span id="L-3033"><a href="#L-3033"><span class="linenos">3033</span></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
</span><span id="L-3034"><a href="#L-3034"><span class="linenos">3034</span></a>            <span class="k">continue</span>
</span><span id="L-3035"><a href="#L-3035"><span class="linenos">3035</span></a>        <span class="k">if</span> <span class="n">spawn</span><span class="o">.</span><span class="n">find_executable</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3036"><a href="#L-3036"><span class="linenos">3036</span></a>            <span class="k">return</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-3037"><a href="#L-3037"><span class="linenos">3037</span></a>
</span><span id="L-3038"><a href="#L-3038"><span class="linenos">3038</span></a>
</span><span id="L-3039"><a href="#L-3039"><span class="linenos">3039</span></a><span class="n">_is_android_emulator</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3040"><a href="#L-3040"><span class="linenos">3040</span></a><span class="k">def</span> <span class="nf">setswitchinterval</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
</span><span id="L-3041"><a href="#L-3041"><span class="linenos">3041</span></a>    <span class="c1"># Setting a very low gil interval on the Android emulator causes python</span>
</span><span id="L-3042"><a href="#L-3042"><span class="linenos">3042</span></a>    <span class="c1"># to hang (issue #26939).</span>
</span><span id="L-3043"><a href="#L-3043"><span class="linenos">3043</span></a>    <span class="n">minimum_interval</span> <span class="o">=</span> <span class="mf">1e-5</span>
</span><span id="L-3044"><a href="#L-3044"><span class="linenos">3044</span></a>    <span class="k">if</span> <span class="n">is_android</span> <span class="ow">and</span> <span class="n">interval</span> <span class="o">&lt;</span> <span class="n">minimum_interval</span><span class="p">:</span>
</span><span id="L-3045"><a href="#L-3045"><span class="linenos">3045</span></a>        <span class="k">global</span> <span class="n">_is_android_emulator</span>
</span><span id="L-3046"><a href="#L-3046"><span class="linenos">3046</span></a>        <span class="k">if</span> <span class="n">_is_android_emulator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3047"><a href="#L-3047"><span class="linenos">3047</span></a>            <span class="n">_is_android_emulator</span> <span class="o">=</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
</span><span id="L-3048"><a href="#L-3048"><span class="linenos">3048</span></a>                               <span class="p">[</span><span class="s1">&#39;getprop&#39;</span><span class="p">,</span> <span class="s1">&#39;ro.kernel.qemu&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span><span id="L-3049"><a href="#L-3049"><span class="linenos">3049</span></a>        <span class="k">if</span> <span class="n">_is_android_emulator</span><span class="p">:</span>
</span><span id="L-3050"><a href="#L-3050"><span class="linenos">3050</span></a>            <span class="n">interval</span> <span class="o">=</span> <span class="n">minimum_interval</span>
</span><span id="L-3051"><a href="#L-3051"><span class="linenos">3051</span></a>    <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">setswitchinterval</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
</span><span id="L-3052"><a href="#L-3052"><span class="linenos">3052</span></a>
</span><span id="L-3053"><a href="#L-3053"><span class="linenos">3053</span></a>
</span><span id="L-3054"><a href="#L-3054"><span class="linenos">3054</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-3055"><a href="#L-3055"><span class="linenos">3055</span></a><span class="k">def</span> <span class="nf">disable_faulthandler</span><span class="p">():</span>
</span><span id="L-3056"><a href="#L-3056"><span class="linenos">3056</span></a>    <span class="c1"># use sys.__stderr__ instead of sys.stderr, since regrtest replaces</span>
</span><span id="L-3057"><a href="#L-3057"><span class="linenos">3057</span></a>    <span class="c1"># sys.stderr with a StringIO which has no file descriptor when a test</span>
</span><span id="L-3058"><a href="#L-3058"><span class="linenos">3058</span></a>    <span class="c1"># is run with -W/--verbose3.</span>
</span><span id="L-3059"><a href="#L-3059"><span class="linenos">3059</span></a>    <span class="n">fd</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stderr__</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
</span><span id="L-3060"><a href="#L-3060"><span class="linenos">3060</span></a>
</span><span id="L-3061"><a href="#L-3061"><span class="linenos">3061</span></a>    <span class="n">is_enabled</span> <span class="o">=</span> <span class="n">faulthandler</span><span class="o">.</span><span class="n">is_enabled</span><span class="p">()</span>
</span><span id="L-3062"><a href="#L-3062"><span class="linenos">3062</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-3063"><a href="#L-3063"><span class="linenos">3063</span></a>        <span class="n">faulthandler</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
</span><span id="L-3064"><a href="#L-3064"><span class="linenos">3064</span></a>        <span class="k">yield</span>
</span><span id="L-3065"><a href="#L-3065"><span class="linenos">3065</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-3066"><a href="#L-3066"><span class="linenos">3066</span></a>        <span class="k">if</span> <span class="n">is_enabled</span><span class="p">:</span>
</span><span id="L-3067"><a href="#L-3067"><span class="linenos">3067</span></a>            <span class="n">faulthandler</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">fd</span><span class="p">,</span> <span class="n">all_threads</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-3068"><a href="#L-3068"><span class="linenos">3068</span></a>
</span><span id="L-3069"><a href="#L-3069"><span class="linenos">3069</span></a>
</span><span id="L-3070"><a href="#L-3070"><span class="linenos">3070</span></a><span class="k">def</span> <span class="nf">fd_count</span><span class="p">():</span>
</span><span id="L-3071"><a href="#L-3071"><span class="linenos">3071</span></a>    <span class="sd">&quot;&quot;&quot;Count the number of open file descriptors.</span>
</span><span id="L-3072"><a href="#L-3072"><span class="linenos">3072</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3073"><a href="#L-3073"><span class="linenos">3073</span></a>    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;freebsd&#39;</span><span class="p">)):</span>
</span><span id="L-3074"><a href="#L-3074"><span class="linenos">3074</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-3075"><a href="#L-3075"><span class="linenos">3075</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;/proc/self/fd&quot;</span><span class="p">)</span>
</span><span id="L-3076"><a href="#L-3076"><span class="linenos">3076</span></a>            <span class="c1"># Subtract one because listdir() internally opens a file</span>
</span><span id="L-3077"><a href="#L-3077"><span class="linenos">3077</span></a>            <span class="c1"># descriptor to list the content of the /proc/self/fd/ directory.</span>
</span><span id="L-3078"><a href="#L-3078"><span class="linenos">3078</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-3079"><a href="#L-3079"><span class="linenos">3079</span></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="L-3080"><a href="#L-3080"><span class="linenos">3080</span></a>            <span class="k">pass</span>
</span><span id="L-3081"><a href="#L-3081"><span class="linenos">3081</span></a>
</span><span id="L-3082"><a href="#L-3082"><span class="linenos">3082</span></a>    <span class="n">MAXFD</span> <span class="o">=</span> <span class="mi">256</span>
</span><span id="L-3083"><a href="#L-3083"><span class="linenos">3083</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;sysconf&#39;</span><span class="p">):</span>
</span><span id="L-3084"><a href="#L-3084"><span class="linenos">3084</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-3085"><a href="#L-3085"><span class="linenos">3085</span></a>            <span class="n">MAXFD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s2">&quot;SC_OPEN_MAX&quot;</span><span class="p">)</span>
</span><span id="L-3086"><a href="#L-3086"><span class="linenos">3086</span></a>        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="L-3087"><a href="#L-3087"><span class="linenos">3087</span></a>            <span class="k">pass</span>
</span><span id="L-3088"><a href="#L-3088"><span class="linenos">3088</span></a>
</span><span id="L-3089"><a href="#L-3089"><span class="linenos">3089</span></a>    <span class="n">old_modes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3090"><a href="#L-3090"><span class="linenos">3090</span></a>    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
</span><span id="L-3091"><a href="#L-3091"><span class="linenos">3091</span></a>        <span class="c1"># bpo-25306, bpo-31009: Call CrtSetReportMode() to not kill the process</span>
</span><span id="L-3092"><a href="#L-3092"><span class="linenos">3092</span></a>        <span class="c1"># on invalid file descriptor if Python is compiled in debug mode</span>
</span><span id="L-3093"><a href="#L-3093"><span class="linenos">3093</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-3094"><a href="#L-3094"><span class="linenos">3094</span></a>            <span class="kn">import</span> <span class="nn">msvcrt</span>
</span><span id="L-3095"><a href="#L-3095"><span class="linenos">3095</span></a>            <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span>
</span><span id="L-3096"><a href="#L-3096"><span class="linenos">3096</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
</span><span id="L-3097"><a href="#L-3097"><span class="linenos">3097</span></a>            <span class="c1"># no msvcrt or a release build</span>
</span><span id="L-3098"><a href="#L-3098"><span class="linenos">3098</span></a>            <span class="k">pass</span>
</span><span id="L-3099"><a href="#L-3099"><span class="linenos">3099</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3100"><a href="#L-3100"><span class="linenos">3100</span></a>            <span class="n">old_modes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-3101"><a href="#L-3101"><span class="linenos">3101</span></a>            <span class="k">for</span> <span class="n">report_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_WARN</span><span class="p">,</span>
</span><span id="L-3102"><a href="#L-3102"><span class="linenos">3102</span></a>                                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ERROR</span><span class="p">,</span>
</span><span id="L-3103"><a href="#L-3103"><span class="linenos">3103</span></a>                                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ASSERT</span><span class="p">):</span>
</span><span id="L-3104"><a href="#L-3104"><span class="linenos">3104</span></a>                <span class="n">old_modes</span><span class="p">[</span><span class="n">report_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-3105"><a href="#L-3105"><span class="linenos">3105</span></a>
</span><span id="L-3106"><a href="#L-3106"><span class="linenos">3106</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-3107"><a href="#L-3107"><span class="linenos">3107</span></a>        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-3108"><a href="#L-3108"><span class="linenos">3108</span></a>        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAXFD</span><span class="p">):</span>
</span><span id="L-3109"><a href="#L-3109"><span class="linenos">3109</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-3110"><a href="#L-3110"><span class="linenos">3110</span></a>                <span class="c1"># Prefer dup() over fstat(). fstat() can require input/output</span>
</span><span id="L-3111"><a href="#L-3111"><span class="linenos">3111</span></a>                <span class="c1"># whereas dup() doesn&#39;t.</span>
</span><span id="L-3112"><a href="#L-3112"><span class="linenos">3112</span></a>                <span class="n">fd2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</span><span id="L-3113"><a href="#L-3113"><span class="linenos">3113</span></a>            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="L-3114"><a href="#L-3114"><span class="linenos">3114</span></a>                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">:</span>
</span><span id="L-3115"><a href="#L-3115"><span class="linenos">3115</span></a>                    <span class="k">raise</span>
</span><span id="L-3116"><a href="#L-3116"><span class="linenos">3116</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-3117"><a href="#L-3117"><span class="linenos">3117</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd2</span><span class="p">)</span>
</span><span id="L-3118"><a href="#L-3118"><span class="linenos">3118</span></a>                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-3119"><a href="#L-3119"><span class="linenos">3119</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-3120"><a href="#L-3120"><span class="linenos">3120</span></a>        <span class="k">if</span> <span class="n">old_modes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3121"><a href="#L-3121"><span class="linenos">3121</span></a>            <span class="k">for</span> <span class="n">report_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_WARN</span><span class="p">,</span>
</span><span id="L-3122"><a href="#L-3122"><span class="linenos">3122</span></a>                                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ERROR</span><span class="p">,</span>
</span><span id="L-3123"><a href="#L-3123"><span class="linenos">3123</span></a>                                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ASSERT</span><span class="p">):</span>
</span><span id="L-3124"><a href="#L-3124"><span class="linenos">3124</span></a>                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span> <span class="n">old_modes</span><span class="p">[</span><span class="n">report_type</span><span class="p">])</span>
</span><span id="L-3125"><a href="#L-3125"><span class="linenos">3125</span></a>
</span><span id="L-3126"><a href="#L-3126"><span class="linenos">3126</span></a>    <span class="k">return</span> <span class="n">count</span>
</span><span id="L-3127"><a href="#L-3127"><span class="linenos">3127</span></a>
</span><span id="L-3128"><a href="#L-3128"><span class="linenos">3128</span></a>
</span><span id="L-3129"><a href="#L-3129"><span class="linenos">3129</span></a><span class="k">class</span> <span class="nc">SaveSignals</span><span class="p">:</span>
</span><span id="L-3130"><a href="#L-3130"><span class="linenos">3130</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3131"><a href="#L-3131"><span class="linenos">3131</span></a><span class="sd">    Save and restore signal handlers.</span>
</span><span id="L-3132"><a href="#L-3132"><span class="linenos">3132</span></a>
</span><span id="L-3133"><a href="#L-3133"><span class="linenos">3133</span></a><span class="sd">    This class is only able to save/restore signal handlers registered</span>
</span><span id="L-3134"><a href="#L-3134"><span class="linenos">3134</span></a><span class="sd">    by the Python signal module: see bpo-13285 for &quot;external&quot; signal</span>
</span><span id="L-3135"><a href="#L-3135"><span class="linenos">3135</span></a><span class="sd">    handlers.</span>
</span><span id="L-3136"><a href="#L-3136"><span class="linenos">3136</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3137"><a href="#L-3137"><span class="linenos">3137</span></a>
</span><span id="L-3138"><a href="#L-3138"><span class="linenos">3138</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-3139"><a href="#L-3139"><span class="linenos">3139</span></a>        <span class="kn">import</span> <span class="nn">signal</span>
</span><span id="L-3140"><a href="#L-3140"><span class="linenos">3140</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">signal</span>
</span><span id="L-3141"><a href="#L-3141"><span class="linenos">3141</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">signals</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">valid_signals</span><span class="p">()</span>
</span><span id="L-3142"><a href="#L-3142"><span class="linenos">3142</span></a>        <span class="c1"># SIGKILL and SIGSTOP signals cannot be ignored nor caught</span>
</span><span id="L-3143"><a href="#L-3143"><span class="linenos">3143</span></a>        <span class="k">for</span> <span class="n">signame</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SIGKILL&#39;</span><span class="p">,</span> <span class="s1">&#39;SIGSTOP&#39;</span><span class="p">):</span>
</span><span id="L-3144"><a href="#L-3144"><span class="linenos">3144</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="L-3145"><a href="#L-3145"><span class="linenos">3145</span></a>                <span class="n">signum</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">signame</span><span class="p">)</span>
</span><span id="L-3146"><a href="#L-3146"><span class="linenos">3146</span></a>            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="L-3147"><a href="#L-3147"><span class="linenos">3147</span></a>                <span class="k">continue</span>
</span><span id="L-3148"><a href="#L-3148"><span class="linenos">3148</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">signum</span><span class="p">)</span>
</span><span id="L-3149"><a href="#L-3149"><span class="linenos">3149</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-3150"><a href="#L-3150"><span class="linenos">3150</span></a>
</span><span id="L-3151"><a href="#L-3151"><span class="linenos">3151</span></a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-3152"><a href="#L-3152"><span class="linenos">3152</span></a>        <span class="k">for</span> <span class="n">signum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="p">:</span>
</span><span id="L-3153"><a href="#L-3153"><span class="linenos">3153</span></a>            <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">signum</span><span class="p">)</span>
</span><span id="L-3154"><a href="#L-3154"><span class="linenos">3154</span></a>            <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-3155"><a href="#L-3155"><span class="linenos">3155</span></a>                <span class="c1"># getsignal() returns None if a signal handler was not</span>
</span><span id="L-3156"><a href="#L-3156"><span class="linenos">3156</span></a>                <span class="c1"># registered by the Python signal module,</span>
</span><span id="L-3157"><a href="#L-3157"><span class="linenos">3157</span></a>                <span class="c1"># and the handler is not SIG_DFL nor SIG_IGN.</span>
</span><span id="L-3158"><a href="#L-3158"><span class="linenos">3158</span></a>                <span class="c1">#</span>
</span><span id="L-3159"><a href="#L-3159"><span class="linenos">3159</span></a>                <span class="c1"># Ignore the signal: we cannot restore the handler.</span>
</span><span id="L-3160"><a href="#L-3160"><span class="linenos">3160</span></a>                <span class="k">continue</span>
</span><span id="L-3161"><a href="#L-3161"><span class="linenos">3161</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">signum</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
</span><span id="L-3162"><a href="#L-3162"><span class="linenos">3162</span></a>
</span><span id="L-3163"><a href="#L-3163"><span class="linenos">3163</span></a>    <span class="k">def</span> <span class="nf">restore</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-3164"><a href="#L-3164"><span class="linenos">3164</span></a>        <span class="k">for</span> <span class="n">signum</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-3165"><a href="#L-3165"><span class="linenos">3165</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
</span><span id="L-3166"><a href="#L-3166"><span class="linenos">3166</span></a>
</span><span id="L-3167"><a href="#L-3167"><span class="linenos">3167</span></a>
</span><span id="L-3168"><a href="#L-3168"><span class="linenos">3168</span></a><span class="k">def</span> <span class="nf">with_pymalloc</span><span class="p">():</span>
</span><span id="L-3169"><a href="#L-3169"><span class="linenos">3169</span></a>    <span class="kn">import</span> <span class="nn">_testcapi</span>
</span><span id="L-3170"><a href="#L-3170"><span class="linenos">3170</span></a>    <span class="k">return</span> <span class="n">_testcapi</span><span class="o">.</span><span class="n">WITH_PYMALLOC</span>
</span><span id="L-3171"><a href="#L-3171"><span class="linenos">3171</span></a>
</span><span id="L-3172"><a href="#L-3172"><span class="linenos">3172</span></a>
</span><span id="L-3173"><a href="#L-3173"><span class="linenos">3173</span></a><span class="k">class</span> <span class="nc">FakePath</span><span class="p">:</span>
</span><span id="L-3174"><a href="#L-3174"><span class="linenos">3174</span></a>    <span class="sd">&quot;&quot;&quot;Simple implementing of the path protocol.</span>
</span><span id="L-3175"><a href="#L-3175"><span class="linenos">3175</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3176"><a href="#L-3176"><span class="linenos">3176</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
</span><span id="L-3177"><a href="#L-3177"><span class="linenos">3177</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</span><span id="L-3178"><a href="#L-3178"><span class="linenos">3178</span></a>
</span><span id="L-3179"><a href="#L-3179"><span class="linenos">3179</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-3180"><a href="#L-3180"><span class="linenos">3180</span></a>        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;FakePath </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">!r}</span><span class="s1">&gt;&#39;</span>
</span><span id="L-3181"><a href="#L-3181"><span class="linenos">3181</span></a>
</span><span id="L-3182"><a href="#L-3182"><span class="linenos">3182</span></a>    <span class="k">def</span> <span class="nf">__fspath__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-3183"><a href="#L-3183"><span class="linenos">3183</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="L-3184"><a href="#L-3184"><span class="linenos">3184</span></a>            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span>
</span><span id="L-3185"><a href="#L-3185"><span class="linenos">3185</span></a>                <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">)):</span>
</span><span id="L-3186"><a href="#L-3186"><span class="linenos">3186</span></a>            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
</span><span id="L-3187"><a href="#L-3187"><span class="linenos">3187</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-3188"><a href="#L-3188"><span class="linenos">3188</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span>
</span><span id="L-3189"><a href="#L-3189"><span class="linenos">3189</span></a>
</span><span id="L-3190"><a href="#L-3190"><span class="linenos">3190</span></a>
</span><span id="L-3191"><a href="#L-3191"><span class="linenos">3191</span></a><span class="k">class</span> <span class="nc">_ALWAYS_EQ</span><span class="p">:</span>
</span><span id="L-3192"><a href="#L-3192"><span class="linenos">3192</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3193"><a href="#L-3193"><span class="linenos">3193</span></a><span class="sd">    Object that is equal to anything.</span>
</span><span id="L-3194"><a href="#L-3194"><span class="linenos">3194</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3195"><a href="#L-3195"><span class="linenos">3195</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-3196"><a href="#L-3196"><span class="linenos">3196</span></a>        <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-3197"><a href="#L-3197"><span class="linenos">3197</span></a>    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-3198"><a href="#L-3198"><span class="linenos">3198</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-3199"><a href="#L-3199"><span class="linenos">3199</span></a>
</span><span id="L-3200"><a href="#L-3200"><span class="linenos">3200</span></a><span class="n">ALWAYS_EQ</span> <span class="o">=</span> <span class="n">_ALWAYS_EQ</span><span class="p">()</span>
</span><span id="L-3201"><a href="#L-3201"><span class="linenos">3201</span></a>
</span><span id="L-3202"><a href="#L-3202"><span class="linenos">3202</span></a><span class="nd">@functools</span><span class="o">.</span><span class="n">total_ordering</span>
</span><span id="L-3203"><a href="#L-3203"><span class="linenos">3203</span></a><span class="k">class</span> <span class="nc">_LARGEST</span><span class="p">:</span>
</span><span id="L-3204"><a href="#L-3204"><span class="linenos">3204</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3205"><a href="#L-3205"><span class="linenos">3205</span></a><span class="sd">    Object that is greater than anything (except itself).</span>
</span><span id="L-3206"><a href="#L-3206"><span class="linenos">3206</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3207"><a href="#L-3207"><span class="linenos">3207</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-3208"><a href="#L-3208"><span class="linenos">3208</span></a>        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_LARGEST</span><span class="p">)</span>
</span><span id="L-3209"><a href="#L-3209"><span class="linenos">3209</span></a>    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-3210"><a href="#L-3210"><span class="linenos">3210</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-3211"><a href="#L-3211"><span class="linenos">3211</span></a>
</span><span id="L-3212"><a href="#L-3212"><span class="linenos">3212</span></a><span class="n">LARGEST</span> <span class="o">=</span> <span class="n">_LARGEST</span><span class="p">()</span>
</span><span id="L-3213"><a href="#L-3213"><span class="linenos">3213</span></a>
</span><span id="L-3214"><a href="#L-3214"><span class="linenos">3214</span></a><span class="nd">@functools</span><span class="o">.</span><span class="n">total_ordering</span>
</span><span id="L-3215"><a href="#L-3215"><span class="linenos">3215</span></a><span class="k">class</span> <span class="nc">_SMALLEST</span><span class="p">:</span>
</span><span id="L-3216"><a href="#L-3216"><span class="linenos">3216</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3217"><a href="#L-3217"><span class="linenos">3217</span></a><span class="sd">    Object that is less than anything (except itself).</span>
</span><span id="L-3218"><a href="#L-3218"><span class="linenos">3218</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3219"><a href="#L-3219"><span class="linenos">3219</span></a>    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-3220"><a href="#L-3220"><span class="linenos">3220</span></a>        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">_SMALLEST</span><span class="p">)</span>
</span><span id="L-3221"><a href="#L-3221"><span class="linenos">3221</span></a>    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
</span><span id="L-3222"><a href="#L-3222"><span class="linenos">3222</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-3223"><a href="#L-3223"><span class="linenos">3223</span></a>
</span><span id="L-3224"><a href="#L-3224"><span class="linenos">3224</span></a><span class="n">SMALLEST</span> <span class="o">=</span> <span class="n">_SMALLEST</span><span class="p">()</span>
</span><span id="L-3225"><a href="#L-3225"><span class="linenos">3225</span></a>
</span><span id="L-3226"><a href="#L-3226"><span class="linenos">3226</span></a><span class="k">def</span> <span class="nf">maybe_get_event_loop_policy</span><span class="p">():</span>
</span><span id="L-3227"><a href="#L-3227"><span class="linenos">3227</span></a>    <span class="sd">&quot;&quot;&quot;Return the global event loop policy if one is set, else return None.&quot;&quot;&quot;</span>
</span><span id="L-3228"><a href="#L-3228"><span class="linenos">3228</span></a>    <span class="k">return</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">_event_loop_policy</span>
</span><span id="L-3229"><a href="#L-3229"><span class="linenos">3229</span></a>
</span><span id="L-3230"><a href="#L-3230"><span class="linenos">3230</span></a><span class="c1"># Helpers for testing hashing.</span>
</span><span id="L-3231"><a href="#L-3231"><span class="linenos">3231</span></a><span class="n">NHASHBITS</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">hash_info</span><span class="o">.</span><span class="n">width</span> <span class="c1"># number of bits in hash() result</span>
</span><span id="L-3232"><a href="#L-3232"><span class="linenos">3232</span></a><span class="k">assert</span> <span class="n">NHASHBITS</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</span><span id="L-3233"><a href="#L-3233"><span class="linenos">3233</span></a>
</span><span id="L-3234"><a href="#L-3234"><span class="linenos">3234</span></a><span class="c1"># Return mean and sdev of number of collisions when tossing nballs balls</span>
</span><span id="L-3235"><a href="#L-3235"><span class="linenos">3235</span></a><span class="c1"># uniformly at random into nbins bins.  By definition, the number of</span>
</span><span id="L-3236"><a href="#L-3236"><span class="linenos">3236</span></a><span class="c1"># collisions is the number of balls minus the number of occupied bins at</span>
</span><span id="L-3237"><a href="#L-3237"><span class="linenos">3237</span></a><span class="c1"># the end.</span>
</span><span id="L-3238"><a href="#L-3238"><span class="linenos">3238</span></a><span class="k">def</span> <span class="nf">collision_stats</span><span class="p">(</span><span class="n">nbins</span><span class="p">,</span> <span class="n">nballs</span><span class="p">):</span>
</span><span id="L-3239"><a href="#L-3239"><span class="linenos">3239</span></a>    <span class="n">n</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">nbins</span><span class="p">,</span> <span class="n">nballs</span>
</span><span id="L-3240"><a href="#L-3240"><span class="linenos">3240</span></a>    <span class="c1"># prob a bin empty after k trials = (1 - 1/n)**k</span>
</span><span id="L-3241"><a href="#L-3241"><span class="linenos">3241</span></a>    <span class="c1"># mean # empty is then n * (1 - 1/n)**k</span>
</span><span id="L-3242"><a href="#L-3242"><span class="linenos">3242</span></a>    <span class="c1"># so mean # occupied is n - n * (1 - 1/n)**k</span>
</span><span id="L-3243"><a href="#L-3243"><span class="linenos">3243</span></a>    <span class="c1"># so collisions = k - (n - n*(1 - 1/n)**k)</span>
</span><span id="L-3244"><a href="#L-3244"><span class="linenos">3244</span></a>    <span class="c1">#</span>
</span><span id="L-3245"><a href="#L-3245"><span class="linenos">3245</span></a>    <span class="c1"># For the variance:</span>
</span><span id="L-3246"><a href="#L-3246"><span class="linenos">3246</span></a>    <span class="c1"># n*(n-1)*(1-2/n)**k + meanempty - meanempty**2 =</span>
</span><span id="L-3247"><a href="#L-3247"><span class="linenos">3247</span></a>    <span class="c1"># n*(n-1)*(1-2/n)**k + meanempty * (1 - meanempty)</span>
</span><span id="L-3248"><a href="#L-3248"><span class="linenos">3248</span></a>    <span class="c1">#</span>
</span><span id="L-3249"><a href="#L-3249"><span class="linenos">3249</span></a>    <span class="c1"># Massive cancellation occurs, and, e.g., for a 64-bit hash code</span>
</span><span id="L-3250"><a href="#L-3250"><span class="linenos">3250</span></a>    <span class="c1"># 1-1/2**64 rounds uselessly to 1.0.  Rather than make heroic (and</span>
</span><span id="L-3251"><a href="#L-3251"><span class="linenos">3251</span></a>    <span class="c1"># error-prone) efforts to rework the naive formulas to avoid those,</span>
</span><span id="L-3252"><a href="#L-3252"><span class="linenos">3252</span></a>    <span class="c1"># we use the `decimal` module to get plenty of extra precision.</span>
</span><span id="L-3253"><a href="#L-3253"><span class="linenos">3253</span></a>    <span class="c1">#</span>
</span><span id="L-3254"><a href="#L-3254"><span class="linenos">3254</span></a>    <span class="c1"># Note:  the exact values are straightforward to compute with</span>
</span><span id="L-3255"><a href="#L-3255"><span class="linenos">3255</span></a>    <span class="c1"># rationals, but in context that&#39;s unbearably slow, requiring</span>
</span><span id="L-3256"><a href="#L-3256"><span class="linenos">3256</span></a>    <span class="c1"># multi-million bit arithmetic.</span>
</span><span id="L-3257"><a href="#L-3257"><span class="linenos">3257</span></a>    <span class="kn">import</span> <span class="nn">decimal</span>
</span><span id="L-3258"><a href="#L-3258"><span class="linenos">3258</span></a>    <span class="k">with</span> <span class="n">decimal</span><span class="o">.</span><span class="n">localcontext</span><span class="p">()</span> <span class="k">as</span> <span class="n">ctx</span><span class="p">:</span>
</span><span id="L-3259"><a href="#L-3259"><span class="linenos">3259</span></a>        <span class="n">bits</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span>  <span class="c1"># bits in n**2</span>
</span><span id="L-3260"><a href="#L-3260"><span class="linenos">3260</span></a>        <span class="c1"># At least that many bits will likely cancel out.</span>
</span><span id="L-3261"><a href="#L-3261"><span class="linenos">3261</span></a>        <span class="c1"># Use that many decimal digits instead.</span>
</span><span id="L-3262"><a href="#L-3262"><span class="linenos">3262</span></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">prec</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</span><span id="L-3263"><a href="#L-3263"><span class="linenos">3263</span></a>        <span class="n">dn</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span id="L-3264"><a href="#L-3264"><span class="linenos">3264</span></a>        <span class="n">p1empty</span> <span class="o">=</span> <span class="p">((</span><span class="n">dn</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">dn</span><span class="p">)</span> <span class="o">**</span> <span class="n">k</span>
</span><span id="L-3265"><a href="#L-3265"><span class="linenos">3265</span></a>        <span class="n">meanempty</span> <span class="o">=</span> <span class="n">n</span> <span class="o">*</span> <span class="n">p1empty</span>
</span><span id="L-3266"><a href="#L-3266"><span class="linenos">3266</span></a>        <span class="n">occupied</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">meanempty</span>
</span><span id="L-3267"><a href="#L-3267"><span class="linenos">3267</span></a>        <span class="n">collisions</span> <span class="o">=</span> <span class="n">k</span> <span class="o">-</span> <span class="n">occupied</span>
</span><span id="L-3268"><a href="#L-3268"><span class="linenos">3268</span></a>        <span class="n">var</span> <span class="o">=</span> <span class="n">dn</span><span class="o">*</span><span class="p">(</span><span class="n">dn</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">dn</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">dn</span><span class="p">)</span><span class="o">**</span><span class="n">k</span> <span class="o">+</span> <span class="n">meanempty</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">meanempty</span><span class="p">)</span>
</span><span id="L-3269"><a href="#L-3269"><span class="linenos">3269</span></a>        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">collisions</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">sqrt</span><span class="p">())</span>
</span><span id="L-3270"><a href="#L-3270"><span class="linenos">3270</span></a>
</span><span id="L-3271"><a href="#L-3271"><span class="linenos">3271</span></a>
</span><span id="L-3272"><a href="#L-3272"><span class="linenos">3272</span></a><span class="k">class</span> <span class="nc">catch_unraisable_exception</span><span class="p">:</span>
</span><span id="L-3273"><a href="#L-3273"><span class="linenos">3273</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3274"><a href="#L-3274"><span class="linenos">3274</span></a><span class="sd">    Context manager catching unraisable exception using sys.unraisablehook.</span>
</span><span id="L-3275"><a href="#L-3275"><span class="linenos">3275</span></a>
</span><span id="L-3276"><a href="#L-3276"><span class="linenos">3276</span></a><span class="sd">    Storing the exception value (cm.unraisable.exc_value) creates a reference</span>
</span><span id="L-3277"><a href="#L-3277"><span class="linenos">3277</span></a><span class="sd">    cycle. The reference cycle is broken explicitly when the context manager</span>
</span><span id="L-3278"><a href="#L-3278"><span class="linenos">3278</span></a><span class="sd">    exits.</span>
</span><span id="L-3279"><a href="#L-3279"><span class="linenos">3279</span></a>
</span><span id="L-3280"><a href="#L-3280"><span class="linenos">3280</span></a><span class="sd">    Storing the object (cm.unraisable.object) can resurrect it if it is set to</span>
</span><span id="L-3281"><a href="#L-3281"><span class="linenos">3281</span></a><span class="sd">    an object which is being finalized. Exiting the context manager clears the</span>
</span><span id="L-3282"><a href="#L-3282"><span class="linenos">3282</span></a><span class="sd">    stored object.</span>
</span><span id="L-3283"><a href="#L-3283"><span class="linenos">3283</span></a>
</span><span id="L-3284"><a href="#L-3284"><span class="linenos">3284</span></a><span class="sd">    Usage:</span>
</span><span id="L-3285"><a href="#L-3285"><span class="linenos">3285</span></a>
</span><span id="L-3286"><a href="#L-3286"><span class="linenos">3286</span></a><span class="sd">        with support.catch_unraisable_exception() as cm:</span>
</span><span id="L-3287"><a href="#L-3287"><span class="linenos">3287</span></a><span class="sd">            # code creating an &quot;unraisable exception&quot;</span>
</span><span id="L-3288"><a href="#L-3288"><span class="linenos">3288</span></a><span class="sd">            ...</span>
</span><span id="L-3289"><a href="#L-3289"><span class="linenos">3289</span></a>
</span><span id="L-3290"><a href="#L-3290"><span class="linenos">3290</span></a><span class="sd">            # check the unraisable exception: use cm.unraisable</span>
</span><span id="L-3291"><a href="#L-3291"><span class="linenos">3291</span></a><span class="sd">            ...</span>
</span><span id="L-3292"><a href="#L-3292"><span class="linenos">3292</span></a>
</span><span id="L-3293"><a href="#L-3293"><span class="linenos">3293</span></a><span class="sd">        # cm.unraisable attribute no longer exists at this point</span>
</span><span id="L-3294"><a href="#L-3294"><span class="linenos">3294</span></a><span class="sd">        # (to break a reference cycle)</span>
</span><span id="L-3295"><a href="#L-3295"><span class="linenos">3295</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3296"><a href="#L-3296"><span class="linenos">3296</span></a>
</span><span id="L-3297"><a href="#L-3297"><span class="linenos">3297</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-3298"><a href="#L-3298"><span class="linenos">3298</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unraisable</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3299"><a href="#L-3299"><span class="linenos">3299</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_old_hook</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3300"><a href="#L-3300"><span class="linenos">3300</span></a>
</span><span id="L-3301"><a href="#L-3301"><span class="linenos">3301</span></a>    <span class="k">def</span> <span class="nf">_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unraisable</span><span class="p">):</span>
</span><span id="L-3302"><a href="#L-3302"><span class="linenos">3302</span></a>        <span class="c1"># Storing unraisable.object can resurrect an object which is being</span>
</span><span id="L-3303"><a href="#L-3303"><span class="linenos">3303</span></a>        <span class="c1"># finalized. Storing unraisable.exc_value creates a reference cycle.</span>
</span><span id="L-3304"><a href="#L-3304"><span class="linenos">3304</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">unraisable</span> <span class="o">=</span> <span class="n">unraisable</span>
</span><span id="L-3305"><a href="#L-3305"><span class="linenos">3305</span></a>
</span><span id="L-3306"><a href="#L-3306"><span class="linenos">3306</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-3307"><a href="#L-3307"><span class="linenos">3307</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_old_hook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">unraisablehook</span>
</span><span id="L-3308"><a href="#L-3308"><span class="linenos">3308</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">unraisablehook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook</span>
</span><span id="L-3309"><a href="#L-3309"><span class="linenos">3309</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-3310"><a href="#L-3310"><span class="linenos">3310</span></a>
</span><span id="L-3311"><a href="#L-3311"><span class="linenos">3311</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_info</span><span class="p">):</span>
</span><span id="L-3312"><a href="#L-3312"><span class="linenos">3312</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">unraisablehook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_old_hook</span>
</span><span id="L-3313"><a href="#L-3313"><span class="linenos">3313</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">unraisable</span>
</span><span id="L-3314"><a href="#L-3314"><span class="linenos">3314</span></a>
</span><span id="L-3315"><a href="#L-3315"><span class="linenos">3315</span></a>
</span><span id="L-3316"><a href="#L-3316"><span class="linenos">3316</span></a><span class="k">class</span> <span class="nc">catch_threading_exception</span><span class="p">:</span>
</span><span id="L-3317"><a href="#L-3317"><span class="linenos">3317</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3318"><a href="#L-3318"><span class="linenos">3318</span></a><span class="sd">    Context manager catching threading.Thread exception using</span>
</span><span id="L-3319"><a href="#L-3319"><span class="linenos">3319</span></a><span class="sd">    threading.excepthook.</span>
</span><span id="L-3320"><a href="#L-3320"><span class="linenos">3320</span></a>
</span><span id="L-3321"><a href="#L-3321"><span class="linenos">3321</span></a><span class="sd">    Attributes set when an exception is catched:</span>
</span><span id="L-3322"><a href="#L-3322"><span class="linenos">3322</span></a>
</span><span id="L-3323"><a href="#L-3323"><span class="linenos">3323</span></a><span class="sd">    * exc_type</span>
</span><span id="L-3324"><a href="#L-3324"><span class="linenos">3324</span></a><span class="sd">    * exc_value</span>
</span><span id="L-3325"><a href="#L-3325"><span class="linenos">3325</span></a><span class="sd">    * exc_traceback</span>
</span><span id="L-3326"><a href="#L-3326"><span class="linenos">3326</span></a><span class="sd">    * thread</span>
</span><span id="L-3327"><a href="#L-3327"><span class="linenos">3327</span></a>
</span><span id="L-3328"><a href="#L-3328"><span class="linenos">3328</span></a><span class="sd">    See threading.excepthook() documentation for these attributes.</span>
</span><span id="L-3329"><a href="#L-3329"><span class="linenos">3329</span></a>
</span><span id="L-3330"><a href="#L-3330"><span class="linenos">3330</span></a><span class="sd">    These attributes are deleted at the context manager exit.</span>
</span><span id="L-3331"><a href="#L-3331"><span class="linenos">3331</span></a>
</span><span id="L-3332"><a href="#L-3332"><span class="linenos">3332</span></a><span class="sd">    Usage:</span>
</span><span id="L-3333"><a href="#L-3333"><span class="linenos">3333</span></a>
</span><span id="L-3334"><a href="#L-3334"><span class="linenos">3334</span></a><span class="sd">        with support.catch_threading_exception() as cm:</span>
</span><span id="L-3335"><a href="#L-3335"><span class="linenos">3335</span></a><span class="sd">            # code spawning a thread which raises an exception</span>
</span><span id="L-3336"><a href="#L-3336"><span class="linenos">3336</span></a><span class="sd">            ...</span>
</span><span id="L-3337"><a href="#L-3337"><span class="linenos">3337</span></a>
</span><span id="L-3338"><a href="#L-3338"><span class="linenos">3338</span></a><span class="sd">            # check the thread exception, use cm attributes:</span>
</span><span id="L-3339"><a href="#L-3339"><span class="linenos">3339</span></a><span class="sd">            # exc_type, exc_value, exc_traceback, thread</span>
</span><span id="L-3340"><a href="#L-3340"><span class="linenos">3340</span></a><span class="sd">            ...</span>
</span><span id="L-3341"><a href="#L-3341"><span class="linenos">3341</span></a>
</span><span id="L-3342"><a href="#L-3342"><span class="linenos">3342</span></a><span class="sd">        # exc_type, exc_value, exc_traceback, thread attributes of cm no longer</span>
</span><span id="L-3343"><a href="#L-3343"><span class="linenos">3343</span></a><span class="sd">        # exists at this point</span>
</span><span id="L-3344"><a href="#L-3344"><span class="linenos">3344</span></a><span class="sd">        # (to avoid reference cycles)</span>
</span><span id="L-3345"><a href="#L-3345"><span class="linenos">3345</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3346"><a href="#L-3346"><span class="linenos">3346</span></a>
</span><span id="L-3347"><a href="#L-3347"><span class="linenos">3347</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-3348"><a href="#L-3348"><span class="linenos">3348</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exc_type</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3349"><a href="#L-3349"><span class="linenos">3349</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exc_value</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3350"><a href="#L-3350"><span class="linenos">3350</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exc_traceback</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3351"><a href="#L-3351"><span class="linenos">3351</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3352"><a href="#L-3352"><span class="linenos">3352</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_old_hook</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-3353"><a href="#L-3353"><span class="linenos">3353</span></a>
</span><span id="L-3354"><a href="#L-3354"><span class="linenos">3354</span></a>    <span class="k">def</span> <span class="nf">_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
</span><span id="L-3355"><a href="#L-3355"><span class="linenos">3355</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exc_type</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">exc_type</span>
</span><span id="L-3356"><a href="#L-3356"><span class="linenos">3356</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exc_value</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">exc_value</span>
</span><span id="L-3357"><a href="#L-3357"><span class="linenos">3357</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">exc_traceback</span>
</span><span id="L-3358"><a href="#L-3358"><span class="linenos">3358</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">thread</span>
</span><span id="L-3359"><a href="#L-3359"><span class="linenos">3359</span></a>
</span><span id="L-3360"><a href="#L-3360"><span class="linenos">3360</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-3361"><a href="#L-3361"><span class="linenos">3361</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_old_hook</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">excepthook</span>
</span><span id="L-3362"><a href="#L-3362"><span class="linenos">3362</span></a>        <span class="n">threading</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hook</span>
</span><span id="L-3363"><a href="#L-3363"><span class="linenos">3363</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="L-3364"><a href="#L-3364"><span class="linenos">3364</span></a>
</span><span id="L-3365"><a href="#L-3365"><span class="linenos">3365</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exc_info</span><span class="p">):</span>
</span><span id="L-3366"><a href="#L-3366"><span class="linenos">3366</span></a>        <span class="n">threading</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_old_hook</span>
</span><span id="L-3367"><a href="#L-3367"><span class="linenos">3367</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc_type</span>
</span><span id="L-3368"><a href="#L-3368"><span class="linenos">3368</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc_value</span>
</span><span id="L-3369"><a href="#L-3369"><span class="linenos">3369</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">exc_traceback</span>
</span><span id="L-3370"><a href="#L-3370"><span class="linenos">3370</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">thread</span>
</span><span id="L-3371"><a href="#L-3371"><span class="linenos">3371</span></a>
</span><span id="L-3372"><a href="#L-3372"><span class="linenos">3372</span></a>
</span><span id="L-3373"><a href="#L-3373"><span class="linenos">3373</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="L-3374"><a href="#L-3374"><span class="linenos">3374</span></a><span class="k">def</span> <span class="nf">save_restore_warnings_filters</span><span class="p">():</span>
</span><span id="L-3375"><a href="#L-3375"><span class="linenos">3375</span></a>    <span class="n">old_filters</span> <span class="o">=</span> <span class="n">warnings</span><span class="o">.</span><span class="n">filters</span><span class="p">[:]</span>
</span><span id="L-3376"><a href="#L-3376"><span class="linenos">3376</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="L-3377"><a href="#L-3377"><span class="linenos">3377</span></a>        <span class="k">yield</span>
</span><span id="L-3378"><a href="#L-3378"><span class="linenos">3378</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="L-3379"><a href="#L-3379"><span class="linenos">3379</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">filters</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">old_filters</span>
</span><span id="L-3380"><a href="#L-3380"><span class="linenos">3380</span></a>
</span><span id="L-3381"><a href="#L-3381"><span class="linenos">3381</span></a>
</span><span id="L-3382"><a href="#L-3382"><span class="linenos">3382</span></a><span class="k">def</span> <span class="nf">skip_if_broken_multiprocessing_synchronize</span><span class="p">():</span>
</span><span id="L-3383"><a href="#L-3383"><span class="linenos">3383</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-3384"><a href="#L-3384"><span class="linenos">3384</span></a><span class="sd">    Skip tests if the multiprocessing.synchronize module is missing, if there</span>
</span><span id="L-3385"><a href="#L-3385"><span class="linenos">3385</span></a><span class="sd">    is no available semaphore implementation, or if creating a lock raises an</span>
</span><span id="L-3386"><a href="#L-3386"><span class="linenos">3386</span></a><span class="sd">    OSError (on Linux only).</span>
</span><span id="L-3387"><a href="#L-3387"><span class="linenos">3387</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-3388"><a href="#L-3388"><span class="linenos">3388</span></a>
</span><span id="L-3389"><a href="#L-3389"><span class="linenos">3389</span></a>    <span class="c1"># Skip tests if the _multiprocessing extension is missing.</span>
</span><span id="L-3390"><a href="#L-3390"><span class="linenos">3390</span></a>    <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;_multiprocessing&#39;</span><span class="p">)</span>
</span><span id="L-3391"><a href="#L-3391"><span class="linenos">3391</span></a>
</span><span id="L-3392"><a href="#L-3392"><span class="linenos">3392</span></a>    <span class="c1"># Skip tests if there is no available semaphore implementation:</span>
</span><span id="L-3393"><a href="#L-3393"><span class="linenos">3393</span></a>    <span class="c1"># multiprocessing.synchronize requires _multiprocessing.SemLock.</span>
</span><span id="L-3394"><a href="#L-3394"><span class="linenos">3394</span></a>    <span class="n">synchronize</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;multiprocessing.synchronize&#39;</span><span class="p">)</span>
</span><span id="L-3395"><a href="#L-3395"><span class="linenos">3395</span></a>
</span><span id="L-3396"><a href="#L-3396"><span class="linenos">3396</span></a>    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;linux&quot;</span><span class="p">:</span>
</span><span id="L-3397"><a href="#L-3397"><span class="linenos">3397</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-3398"><a href="#L-3398"><span class="linenos">3398</span></a>            <span class="c1"># bpo-38377: On Linux, creating a semaphore fails with OSError</span>
</span><span id="L-3399"><a href="#L-3399"><span class="linenos">3399</span></a>            <span class="c1"># if the current user does not have the permission to create</span>
</span><span id="L-3400"><a href="#L-3400"><span class="linenos">3400</span></a>            <span class="c1"># a file in /dev/shm/ directory.</span>
</span><span id="L-3401"><a href="#L-3401"><span class="linenos">3401</span></a>            <span class="n">synchronize</span><span class="o">.</span><span class="n">Lock</span><span class="p">(</span><span class="n">ctx</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</span><span id="L-3402"><a href="#L-3402"><span class="linenos">3402</span></a>        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
</span><span id="L-3403"><a href="#L-3403"><span class="linenos">3403</span></a>            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;broken multiprocessing SemLock: </span><span class="si">{</span><span class="n">exc</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            </section>
                <section id="PIPE_MAX_SIZE">
                    <div class="attr variable">
            <span class="name">PIPE_MAX_SIZE</span><span class="default_value"> = 4194305</span>

        
    </div>
    <a class="headerlink" href="#PIPE_MAX_SIZE"></a>
    
    

                </section>
                <section id="verbose">
                    <div class="attr variable">
            <span class="name">verbose</span><span class="default_value"> = 1</span>

        
    </div>
    <a class="headerlink" href="#verbose"></a>
    
    

                </section>
                <section id="max_memuse">
                    <div class="attr variable">
            <span class="name">max_memuse</span><span class="default_value"> = 0</span>

        
    </div>
    <a class="headerlink" href="#max_memuse"></a>
    
    

                </section>
                <section id="use_resources">
                    <div class="attr variable">
            <span class="name">use_resources</span><span class="default_value"> = None</span>

        
    </div>
    <a class="headerlink" href="#use_resources"></a>
    
    

                </section>
                <section id="failfast">
                    <div class="attr variable">
            <span class="name">failfast</span><span class="default_value"> = False</span>

        
    </div>
    <a class="headerlink" href="#failfast"></a>
    
    

                </section>
                <section id="Error">
                            <input id="Error-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Error</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="Error-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Error"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Error-126"><a href="#Error-126"><span class="linenos">126</span></a><span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="Error-127"><a href="#Error-127"><span class="linenos">127</span></a>    <span class="sd">&quot;&quot;&quot;Base class for regression test exceptions.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Base class for regression test exceptions.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="Error.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="Error.with_traceback" class="function">with_traceback</dd>
                <dd id="Error.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="TestFailed">
                            <input id="TestFailed-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TestFailed</span><wbr>(<span class="base"><a href="#Error">Error</a></span>):

                <label class="view-source-button" for="TestFailed-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TestFailed"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TestFailed-129"><a href="#TestFailed-129"><span class="linenos">129</span></a><span class="k">class</span> <span class="nc">TestFailed</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
</span><span id="TestFailed-130"><a href="#TestFailed-130"><span class="linenos">130</span></a>    <span class="sd">&quot;&quot;&quot;Test failed.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Test failed.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="TestFailed.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="TestFailed.with_traceback" class="function">with_traceback</dd>
                <dd id="TestFailed.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="TestDidNotRun">
                            <input id="TestDidNotRun-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TestDidNotRun</span><wbr>(<span class="base"><a href="#Error">Error</a></span>):

                <label class="view-source-button" for="TestDidNotRun-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TestDidNotRun"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TestDidNotRun-132"><a href="#TestDidNotRun-132"><span class="linenos">132</span></a><span class="k">class</span> <span class="nc">TestDidNotRun</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
</span><span id="TestDidNotRun-133"><a href="#TestDidNotRun-133"><span class="linenos">133</span></a>    <span class="sd">&quot;&quot;&quot;Test did not run any subtests.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Test did not run any subtests.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="TestDidNotRun.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="TestDidNotRun.with_traceback" class="function">with_traceback</dd>
                <dd id="TestDidNotRun.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ResourceDenied">
                            <input id="ResourceDenied-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ResourceDenied</span><wbr>(<span class="base">unittest.case.SkipTest</span>):

                <label class="view-source-button" for="ResourceDenied-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ResourceDenied"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ResourceDenied-135"><a href="#ResourceDenied-135"><span class="linenos">135</span></a><span class="k">class</span> <span class="nc">ResourceDenied</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">):</span>
</span><span id="ResourceDenied-136"><a href="#ResourceDenied-136"><span class="linenos">136</span></a>    <span class="sd">&quot;&quot;&quot;Test skipped because it requested a disallowed resource.</span>
</span><span id="ResourceDenied-137"><a href="#ResourceDenied-137"><span class="linenos">137</span></a>
</span><span id="ResourceDenied-138"><a href="#ResourceDenied-138"><span class="linenos">138</span></a><span class="sd">    This is raised when a test calls requires() for a resource that</span>
</span><span id="ResourceDenied-139"><a href="#ResourceDenied-139"><span class="linenos">139</span></a><span class="sd">    has not be enabled.  It is used to distinguish between expected</span>
</span><span id="ResourceDenied-140"><a href="#ResourceDenied-140"><span class="linenos">140</span></a><span class="sd">    and unexpected skips.</span>
</span><span id="ResourceDenied-141"><a href="#ResourceDenied-141"><span class="linenos">141</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Test skipped because it requested a disallowed resource.</p>

<p>This is raised when a test calls requires() for a resource that
has not be enabled.  It is used to distinguish between expected
and unexpected skips.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>builtins.Exception</dt>
                                <dd id="ResourceDenied.__init__" class="function">Exception</dd>

            </div>
            <div><dt>builtins.BaseException</dt>
                                <dd id="ResourceDenied.with_traceback" class="function">with_traceback</dd>
                <dd id="ResourceDenied.args" class="variable">args</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="import_module">
                            <input id="import_module-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_module</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">name</span>, </span><span class="param"><span class="n">deprecated</span><span class="o">=</span><span class="kc">False</span>, </span><span class="param"><span class="o">*</span>, </span><span class="param"><span class="n">required_on</span><span class="o">=</span><span class="p">()</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="import_module-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#import_module"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="import_module-175"><a href="#import_module-175"><span class="linenos">175</span></a><span class="k">def</span> <span class="nf">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">deprecated</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">required_on</span><span class="o">=</span><span class="p">()):</span>
</span><span id="import_module-176"><a href="#import_module-176"><span class="linenos">176</span></a>    <span class="sd">&quot;&quot;&quot;Import and return the module to be tested, raising SkipTest if</span>
</span><span id="import_module-177"><a href="#import_module-177"><span class="linenos">177</span></a><span class="sd">    it is not available.</span>
</span><span id="import_module-178"><a href="#import_module-178"><span class="linenos">178</span></a>
</span><span id="import_module-179"><a href="#import_module-179"><span class="linenos">179</span></a><span class="sd">    If deprecated is True, any module or package deprecation messages</span>
</span><span id="import_module-180"><a href="#import_module-180"><span class="linenos">180</span></a><span class="sd">    will be suppressed. If a module is required on a platform but optional for</span>
</span><span id="import_module-181"><a href="#import_module-181"><span class="linenos">181</span></a><span class="sd">    others, set required_on to an iterable of platform prefixes which will be</span>
</span><span id="import_module-182"><a href="#import_module-182"><span class="linenos">182</span></a><span class="sd">    compared against sys.platform.</span>
</span><span id="import_module-183"><a href="#import_module-183"><span class="linenos">183</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="import_module-184"><a href="#import_module-184"><span class="linenos">184</span></a>    <span class="k">with</span> <span class="n">_ignore_deprecated_imports</span><span class="p">(</span><span class="n">deprecated</span><span class="p">):</span>
</span><span id="import_module-185"><a href="#import_module-185"><span class="linenos">185</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="import_module-186"><a href="#import_module-186"><span class="linenos">186</span></a>            <span class="k">return</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="import_module-187"><a href="#import_module-187"><span class="linenos">187</span></a>        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
</span><span id="import_module-188"><a href="#import_module-188"><span class="linenos">188</span></a>            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">required_on</span><span class="p">)):</span>
</span><span id="import_module-189"><a href="#import_module-189"><span class="linenos">189</span></a>                <span class="k">raise</span>
</span><span id="import_module-190"><a href="#import_module-190"><span class="linenos">190</span></a>            <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Import and return the module to be tested, raising SkipTest if
it is not available.</p>

<p>If deprecated is True, any module or package deprecation messages
will be suppressed. If a module is required on a platform but optional for
others, set required_on to an iterable of platform prefixes which will be
compared against sys.platform.</p>
</div>


                </section>
                <section id="import_fresh_module">
                            <input id="import_fresh_module-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">import_fresh_module</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">name</span>, </span><span class="param"><span class="n">fresh</span><span class="o">=</span><span class="p">()</span>, </span><span class="param"><span class="n">blocked</span><span class="o">=</span><span class="p">()</span>, </span><span class="param"><span class="n">deprecated</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="import_fresh_module-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#import_fresh_module"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="import_fresh_module-251"><a href="#import_fresh_module-251"><span class="linenos">251</span></a><span class="k">def</span> <span class="nf">import_fresh_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fresh</span><span class="o">=</span><span class="p">(),</span> <span class="n">blocked</span><span class="o">=</span><span class="p">(),</span> <span class="n">deprecated</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="import_fresh_module-252"><a href="#import_fresh_module-252"><span class="linenos">252</span></a>    <span class="sd">&quot;&quot;&quot;Import and return a module, deliberately bypassing sys.modules.</span>
</span><span id="import_fresh_module-253"><a href="#import_fresh_module-253"><span class="linenos">253</span></a>
</span><span id="import_fresh_module-254"><a href="#import_fresh_module-254"><span class="linenos">254</span></a><span class="sd">    This function imports and returns a fresh copy of the named Python module</span>
</span><span id="import_fresh_module-255"><a href="#import_fresh_module-255"><span class="linenos">255</span></a><span class="sd">    by removing the named module from sys.modules before doing the import.</span>
</span><span id="import_fresh_module-256"><a href="#import_fresh_module-256"><span class="linenos">256</span></a><span class="sd">    Note that unlike reload, the original module is not affected by</span>
</span><span id="import_fresh_module-257"><a href="#import_fresh_module-257"><span class="linenos">257</span></a><span class="sd">    this operation.</span>
</span><span id="import_fresh_module-258"><a href="#import_fresh_module-258"><span class="linenos">258</span></a>
</span><span id="import_fresh_module-259"><a href="#import_fresh_module-259"><span class="linenos">259</span></a><span class="sd">    *fresh* is an iterable of additional module names that are also removed</span>
</span><span id="import_fresh_module-260"><a href="#import_fresh_module-260"><span class="linenos">260</span></a><span class="sd">    from the sys.modules cache before doing the import.</span>
</span><span id="import_fresh_module-261"><a href="#import_fresh_module-261"><span class="linenos">261</span></a>
</span><span id="import_fresh_module-262"><a href="#import_fresh_module-262"><span class="linenos">262</span></a><span class="sd">    *blocked* is an iterable of module names that are replaced with None</span>
</span><span id="import_fresh_module-263"><a href="#import_fresh_module-263"><span class="linenos">263</span></a><span class="sd">    in the module cache during the import to ensure that attempts to import</span>
</span><span id="import_fresh_module-264"><a href="#import_fresh_module-264"><span class="linenos">264</span></a><span class="sd">    them raise ImportError.</span>
</span><span id="import_fresh_module-265"><a href="#import_fresh_module-265"><span class="linenos">265</span></a>
</span><span id="import_fresh_module-266"><a href="#import_fresh_module-266"><span class="linenos">266</span></a><span class="sd">    The named module and any modules named in the *fresh* and *blocked*</span>
</span><span id="import_fresh_module-267"><a href="#import_fresh_module-267"><span class="linenos">267</span></a><span class="sd">    parameters are saved before starting the import and then reinserted into</span>
</span><span id="import_fresh_module-268"><a href="#import_fresh_module-268"><span class="linenos">268</span></a><span class="sd">    sys.modules when the fresh import is complete.</span>
</span><span id="import_fresh_module-269"><a href="#import_fresh_module-269"><span class="linenos">269</span></a>
</span><span id="import_fresh_module-270"><a href="#import_fresh_module-270"><span class="linenos">270</span></a><span class="sd">    Module and package deprecation messages are suppressed during this import</span>
</span><span id="import_fresh_module-271"><a href="#import_fresh_module-271"><span class="linenos">271</span></a><span class="sd">    if *deprecated* is True.</span>
</span><span id="import_fresh_module-272"><a href="#import_fresh_module-272"><span class="linenos">272</span></a>
</span><span id="import_fresh_module-273"><a href="#import_fresh_module-273"><span class="linenos">273</span></a><span class="sd">    This function will raise ImportError if the named module cannot be</span>
</span><span id="import_fresh_module-274"><a href="#import_fresh_module-274"><span class="linenos">274</span></a><span class="sd">    imported.</span>
</span><span id="import_fresh_module-275"><a href="#import_fresh_module-275"><span class="linenos">275</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="import_fresh_module-276"><a href="#import_fresh_module-276"><span class="linenos">276</span></a>    <span class="c1"># NOTE: test_heapq, test_json and test_warnings include extra sanity checks</span>
</span><span id="import_fresh_module-277"><a href="#import_fresh_module-277"><span class="linenos">277</span></a>    <span class="c1"># to make sure that this utility function is working as expected</span>
</span><span id="import_fresh_module-278"><a href="#import_fresh_module-278"><span class="linenos">278</span></a>    <span class="k">with</span> <span class="n">_ignore_deprecated_imports</span><span class="p">(</span><span class="n">deprecated</span><span class="p">):</span>
</span><span id="import_fresh_module-279"><a href="#import_fresh_module-279"><span class="linenos">279</span></a>        <span class="c1"># Keep track of modules saved for later restoration as well</span>
</span><span id="import_fresh_module-280"><a href="#import_fresh_module-280"><span class="linenos">280</span></a>        <span class="c1"># as those which just need a blocking entry removed</span>
</span><span id="import_fresh_module-281"><a href="#import_fresh_module-281"><span class="linenos">281</span></a>        <span class="n">orig_modules</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="import_fresh_module-282"><a href="#import_fresh_module-282"><span class="linenos">282</span></a>        <span class="n">names_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="import_fresh_module-283"><a href="#import_fresh_module-283"><span class="linenos">283</span></a>        <span class="n">_save_and_remove_module</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">)</span>
</span><span id="import_fresh_module-284"><a href="#import_fresh_module-284"><span class="linenos">284</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="import_fresh_module-285"><a href="#import_fresh_module-285"><span class="linenos">285</span></a>            <span class="k">for</span> <span class="n">fresh_name</span> <span class="ow">in</span> <span class="n">fresh</span><span class="p">:</span>
</span><span id="import_fresh_module-286"><a href="#import_fresh_module-286"><span class="linenos">286</span></a>                <span class="n">_save_and_remove_module</span><span class="p">(</span><span class="n">fresh_name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">)</span>
</span><span id="import_fresh_module-287"><a href="#import_fresh_module-287"><span class="linenos">287</span></a>            <span class="k">for</span> <span class="n">blocked_name</span> <span class="ow">in</span> <span class="n">blocked</span><span class="p">:</span>
</span><span id="import_fresh_module-288"><a href="#import_fresh_module-288"><span class="linenos">288</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">_save_and_block_module</span><span class="p">(</span><span class="n">blocked_name</span><span class="p">,</span> <span class="n">orig_modules</span><span class="p">):</span>
</span><span id="import_fresh_module-289"><a href="#import_fresh_module-289"><span class="linenos">289</span></a>                    <span class="n">names_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">blocked_name</span><span class="p">)</span>
</span><span id="import_fresh_module-290"><a href="#import_fresh_module-290"><span class="linenos">290</span></a>            <span class="n">fresh_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="import_fresh_module-291"><a href="#import_fresh_module-291"><span class="linenos">291</span></a>        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="import_fresh_module-292"><a href="#import_fresh_module-292"><span class="linenos">292</span></a>            <span class="n">fresh_module</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="import_fresh_module-293"><a href="#import_fresh_module-293"><span class="linenos">293</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="import_fresh_module-294"><a href="#import_fresh_module-294"><span class="linenos">294</span></a>            <span class="k">for</span> <span class="n">orig_name</span><span class="p">,</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">orig_modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="import_fresh_module-295"><a href="#import_fresh_module-295"><span class="linenos">295</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">orig_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">module</span>
</span><span id="import_fresh_module-296"><a href="#import_fresh_module-296"><span class="linenos">296</span></a>            <span class="k">for</span> <span class="n">name_to_remove</span> <span class="ow">in</span> <span class="n">names_to_remove</span><span class="p">:</span>
</span><span id="import_fresh_module-297"><a href="#import_fresh_module-297"><span class="linenos">297</span></a>                <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name_to_remove</span><span class="p">]</span>
</span><span id="import_fresh_module-298"><a href="#import_fresh_module-298"><span class="linenos">298</span></a>        <span class="k">return</span> <span class="n">fresh_module</span>
</span></pre></div>


            <div class="docstring"><p>Import and return a module, deliberately bypassing sys.modules.</p>

<p>This function imports and returns a fresh copy of the named Python module
by removing the named module from sys.modules before doing the import.
Note that unlike reload, the original module is not affected by
this operation.</p>

<p><em>fresh</em> is an iterable of additional module names that are also removed
from the sys.modules cache before doing the import.</p>

<p><em>blocked</em> is an iterable of module names that are replaced with None
in the module cache during the import to ensure that attempts to import
them raise ImportError.</p>

<p>The named module and any modules named in the <em>fresh</em> and <em>blocked</em>
parameters are saved before starting the import and then reinserted into
sys.modules when the fresh import is complete.</p>

<p>Module and package deprecation messages are suppressed during this import
if <em>deprecated</em> is True.</p>

<p>This function will raise ImportError if the named module cannot be
imported.</p>
</div>


                </section>
                <section id="CleanImport">
                            <input id="CleanImport-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CleanImport</span>:

                <label class="view-source-button" for="CleanImport-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CleanImport"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CleanImport-1379"><a href="#CleanImport-1379"><span class="linenos">1379</span></a><span class="k">class</span> <span class="nc">CleanImport</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="CleanImport-1380"><a href="#CleanImport-1380"><span class="linenos">1380</span></a>    <span class="sd">&quot;&quot;&quot;Context manager to force import to return a new module reference.</span>
</span><span id="CleanImport-1381"><a href="#CleanImport-1381"><span class="linenos">1381</span></a>
</span><span id="CleanImport-1382"><a href="#CleanImport-1382"><span class="linenos">1382</span></a><span class="sd">    This is useful for testing module-level behaviours, such as</span>
</span><span id="CleanImport-1383"><a href="#CleanImport-1383"><span class="linenos">1383</span></a><span class="sd">    the emission of a DeprecationWarning on import.</span>
</span><span id="CleanImport-1384"><a href="#CleanImport-1384"><span class="linenos">1384</span></a>
</span><span id="CleanImport-1385"><a href="#CleanImport-1385"><span class="linenos">1385</span></a><span class="sd">    Use like this:</span>
</span><span id="CleanImport-1386"><a href="#CleanImport-1386"><span class="linenos">1386</span></a>
</span><span id="CleanImport-1387"><a href="#CleanImport-1387"><span class="linenos">1387</span></a><span class="sd">        with CleanImport(&quot;foo&quot;):</span>
</span><span id="CleanImport-1388"><a href="#CleanImport-1388"><span class="linenos">1388</span></a><span class="sd">            importlib.import_module(&quot;foo&quot;) # new reference</span>
</span><span id="CleanImport-1389"><a href="#CleanImport-1389"><span class="linenos">1389</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="CleanImport-1390"><a href="#CleanImport-1390"><span class="linenos">1390</span></a>
</span><span id="CleanImport-1391"><a href="#CleanImport-1391"><span class="linenos">1391</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">module_names</span><span class="p">):</span>
</span><span id="CleanImport-1392"><a href="#CleanImport-1392"><span class="linenos">1392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_modules</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="CleanImport-1393"><a href="#CleanImport-1393"><span class="linenos">1393</span></a>        <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">module_names</span><span class="p">:</span>
</span><span id="CleanImport-1394"><a href="#CleanImport-1394"><span class="linenos">1394</span></a>            <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
</span><span id="CleanImport-1395"><a href="#CleanImport-1395"><span class="linenos">1395</span></a>                <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
</span><span id="CleanImport-1396"><a href="#CleanImport-1396"><span class="linenos">1396</span></a>                <span class="c1"># It is possible that module_name is just an alias for</span>
</span><span id="CleanImport-1397"><a href="#CleanImport-1397"><span class="linenos">1397</span></a>                <span class="c1"># another module (e.g. stub for modules renamed in 3.x).</span>
</span><span id="CleanImport-1398"><a href="#CleanImport-1398"><span class="linenos">1398</span></a>                <span class="c1"># In that case, we also need delete the real module to clear</span>
</span><span id="CleanImport-1399"><a href="#CleanImport-1399"><span class="linenos">1399</span></a>                <span class="c1"># the import cache.</span>
</span><span id="CleanImport-1400"><a href="#CleanImport-1400"><span class="linenos">1400</span></a>                <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="n">module_name</span><span class="p">:</span>
</span><span id="CleanImport-1401"><a href="#CleanImport-1401"><span class="linenos">1401</span></a>                    <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
</span><span id="CleanImport-1402"><a href="#CleanImport-1402"><span class="linenos">1402</span></a>                <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
</span><span id="CleanImport-1403"><a href="#CleanImport-1403"><span class="linenos">1403</span></a>
</span><span id="CleanImport-1404"><a href="#CleanImport-1404"><span class="linenos">1404</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CleanImport-1405"><a href="#CleanImport-1405"><span class="linenos">1405</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="CleanImport-1406"><a href="#CleanImport-1406"><span class="linenos">1406</span></a>
</span><span id="CleanImport-1407"><a href="#CleanImport-1407"><span class="linenos">1407</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
</span><span id="CleanImport-1408"><a href="#CleanImport-1408"><span class="linenos">1408</span></a>        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">original_modules</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Context manager to force import to return a new module reference.</p>

<p>This is useful for testing module-level behaviours, such as
the emission of a DeprecationWarning on import.</p>

<p>Use like this:</p>

<pre><code>with CleanImport("foo"):
    importlib.import_module("foo") # new reference
</code></pre>
</div>


                            <div id="CleanImport.__init__" class="classattr">
                                        <input id="CleanImport.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">CleanImport</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">module_names</span></span>)</span>

                <label class="view-source-button" for="CleanImport.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CleanImport.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CleanImport.__init__-1391"><a href="#CleanImport.__init__-1391"><span class="linenos">1391</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">module_names</span><span class="p">):</span>
</span><span id="CleanImport.__init__-1392"><a href="#CleanImport.__init__-1392"><span class="linenos">1392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">original_modules</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="CleanImport.__init__-1393"><a href="#CleanImport.__init__-1393"><span class="linenos">1393</span></a>        <span class="k">for</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">module_names</span><span class="p">:</span>
</span><span id="CleanImport.__init__-1394"><a href="#CleanImport.__init__-1394"><span class="linenos">1394</span></a>            <span class="k">if</span> <span class="n">module_name</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
</span><span id="CleanImport.__init__-1395"><a href="#CleanImport.__init__-1395"><span class="linenos">1395</span></a>                <span class="n">module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
</span><span id="CleanImport.__init__-1396"><a href="#CleanImport.__init__-1396"><span class="linenos">1396</span></a>                <span class="c1"># It is possible that module_name is just an alias for</span>
</span><span id="CleanImport.__init__-1397"><a href="#CleanImport.__init__-1397"><span class="linenos">1397</span></a>                <span class="c1"># another module (e.g. stub for modules renamed in 3.x).</span>
</span><span id="CleanImport.__init__-1398"><a href="#CleanImport.__init__-1398"><span class="linenos">1398</span></a>                <span class="c1"># In that case, we also need delete the real module to clear</span>
</span><span id="CleanImport.__init__-1399"><a href="#CleanImport.__init__-1399"><span class="linenos">1399</span></a>                <span class="c1"># the import cache.</span>
</span><span id="CleanImport.__init__-1400"><a href="#CleanImport.__init__-1400"><span class="linenos">1400</span></a>                <span class="k">if</span> <span class="n">module</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">!=</span> <span class="n">module_name</span><span class="p">:</span>
</span><span id="CleanImport.__init__-1401"><a href="#CleanImport.__init__-1401"><span class="linenos">1401</span></a>                    <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span>
</span><span id="CleanImport.__init__-1402"><a href="#CleanImport.__init__-1402"><span class="linenos">1402</span></a>                <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">module_name</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="unload">
                            <input id="unload-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unload</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">name</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unload-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unload"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unload-329"><a href="#unload-329"><span class="linenos">329</span></a><span class="k">def</span> <span class="nf">unload</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span><span id="unload-330"><a href="#unload-330"><span class="linenos">330</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="unload-331"><a href="#unload-331"><span class="linenos">331</span></a>        <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="unload-332"><a href="#unload-332"><span class="linenos">332</span></a>    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span id="unload-333"><a href="#unload-333"><span class="linenos">333</span></a>        <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="forget">
                            <input id="forget-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forget</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">modname</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="forget-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#forget"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="forget-476"><a href="#forget-476"><span class="linenos">476</span></a><span class="k">def</span> <span class="nf">forget</span><span class="p">(</span><span class="n">modname</span><span class="p">):</span>
</span><span id="forget-477"><a href="#forget-477"><span class="linenos">477</span></a>    <span class="sd">&quot;&quot;&quot;&#39;Forget&#39; a module was ever imported.</span>
</span><span id="forget-478"><a href="#forget-478"><span class="linenos">478</span></a>
</span><span id="forget-479"><a href="#forget-479"><span class="linenos">479</span></a><span class="sd">    This removes the module from sys.modules and deletes any PEP 3147/488 or</span>
</span><span id="forget-480"><a href="#forget-480"><span class="linenos">480</span></a><span class="sd">    legacy .pyc files.</span>
</span><span id="forget-481"><a href="#forget-481"><span class="linenos">481</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="forget-482"><a href="#forget-482"><span class="linenos">482</span></a>    <span class="n">unload</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
</span><span id="forget-483"><a href="#forget-483"><span class="linenos">483</span></a>    <span class="k">for</span> <span class="n">dirname</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
</span><span id="forget-484"><a href="#forget-484"><span class="linenos">484</span></a>        <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="n">modname</span> <span class="o">+</span> <span class="s1">&#39;.py&#39;</span><span class="p">)</span>
</span><span id="forget-485"><a href="#forget-485"><span class="linenos">485</span></a>        <span class="c1"># It doesn&#39;t matter if they exist or not, unlink all possible</span>
</span><span id="forget-486"><a href="#forget-486"><span class="linenos">486</span></a>        <span class="c1"># combinations of PEP 3147/488 and legacy pyc files.</span>
</span><span id="forget-487"><a href="#forget-487"><span class="linenos">487</span></a>        <span class="n">unlink</span><span class="p">(</span><span class="n">source</span> <span class="o">+</span> <span class="s1">&#39;c&#39;</span><span class="p">)</span>
</span><span id="forget-488"><a href="#forget-488"><span class="linenos">488</span></a>        <span class="k">for</span> <span class="n">opt</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
</span><span id="forget-489"><a href="#forget-489"><span class="linenos">489</span></a>            <span class="n">unlink</span><span class="p">(</span><span class="n">importlib</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">cache_from_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">optimization</span><span class="o">=</span><span class="n">opt</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>'Forget' a module was ever imported.</p>

<p>This removes the module from sys.modules and deletes any PEP 3147/488 or
legacy .pyc files.</p>
</div>


                </section>
                <section id="record_original_stdout">
                            <input id="record_original_stdout-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">record_original_stdout</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">stdout</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="record_original_stdout-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#record_original_stdout"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="record_original_stdout-322"><a href="#record_original_stdout-322"><span class="linenos">322</span></a><span class="k">def</span> <span class="nf">record_original_stdout</span><span class="p">(</span><span class="n">stdout</span><span class="p">):</span>
</span><span id="record_original_stdout-323"><a href="#record_original_stdout-323"><span class="linenos">323</span></a>    <span class="k">global</span> <span class="n">_original_stdout</span>
</span><span id="record_original_stdout-324"><a href="#record_original_stdout-324"><span class="linenos">324</span></a>    <span class="n">_original_stdout</span> <span class="o">=</span> <span class="n">stdout</span>
</span></pre></div>


    

                </section>
                <section id="get_original_stdout">
                            <input id="get_original_stdout-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_original_stdout</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_original_stdout-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_original_stdout"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_original_stdout-326"><a href="#get_original_stdout-326"><span class="linenos">326</span></a><span class="k">def</span> <span class="nf">get_original_stdout</span><span class="p">():</span>
</span><span id="get_original_stdout-327"><a href="#get_original_stdout-327"><span class="linenos">327</span></a>    <span class="k">return</span> <span class="n">_original_stdout</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
</span></pre></div>


    

                </section>
                <section id="captured_stdout">
                            <input id="captured_stdout-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">captured_stdout</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="captured_stdout-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#captured_stdout"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="captured_stdout-1633"><a href="#captured_stdout-1633"><span class="linenos">1633</span></a><span class="k">def</span> <span class="nf">captured_stdout</span><span class="p">():</span>
</span><span id="captured_stdout-1634"><a href="#captured_stdout-1634"><span class="linenos">1634</span></a>    <span class="sd">&quot;&quot;&quot;Capture the output of sys.stdout:</span>
</span><span id="captured_stdout-1635"><a href="#captured_stdout-1635"><span class="linenos">1635</span></a>
</span><span id="captured_stdout-1636"><a href="#captured_stdout-1636"><span class="linenos">1636</span></a><span class="sd">       with captured_stdout() as stdout:</span>
</span><span id="captured_stdout-1637"><a href="#captured_stdout-1637"><span class="linenos">1637</span></a><span class="sd">           print(&quot;hello&quot;)</span>
</span><span id="captured_stdout-1638"><a href="#captured_stdout-1638"><span class="linenos">1638</span></a><span class="sd">       self.assertEqual(stdout.getvalue(), &quot;hello\\n&quot;)</span>
</span><span id="captured_stdout-1639"><a href="#captured_stdout-1639"><span class="linenos">1639</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="captured_stdout-1640"><a href="#captured_stdout-1640"><span class="linenos">1640</span></a>    <span class="k">return</span> <span class="n">captured_output</span><span class="p">(</span><span class="s2">&quot;stdout&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Capture the output of sys.stdout:</p>

<p>with captured_stdout() as stdout:
    print("hello")
self.assertEqual(stdout.getvalue(), "hello\n")</p>
</div>


                </section>
                <section id="captured_stdin">
                            <input id="captured_stdin-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">captured_stdin</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="captured_stdin-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#captured_stdin"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="captured_stdin-1651"><a href="#captured_stdin-1651"><span class="linenos">1651</span></a><span class="k">def</span> <span class="nf">captured_stdin</span><span class="p">():</span>
</span><span id="captured_stdin-1652"><a href="#captured_stdin-1652"><span class="linenos">1652</span></a>    <span class="sd">&quot;&quot;&quot;Capture the input to sys.stdin:</span>
</span><span id="captured_stdin-1653"><a href="#captured_stdin-1653"><span class="linenos">1653</span></a>
</span><span id="captured_stdin-1654"><a href="#captured_stdin-1654"><span class="linenos">1654</span></a><span class="sd">       with captured_stdin() as stdin:</span>
</span><span id="captured_stdin-1655"><a href="#captured_stdin-1655"><span class="linenos">1655</span></a><span class="sd">           stdin.write(&#39;hello\\n&#39;)</span>
</span><span id="captured_stdin-1656"><a href="#captured_stdin-1656"><span class="linenos">1656</span></a><span class="sd">           stdin.seek(0)</span>
</span><span id="captured_stdin-1657"><a href="#captured_stdin-1657"><span class="linenos">1657</span></a><span class="sd">           # call test code that consumes from sys.stdin</span>
</span><span id="captured_stdin-1658"><a href="#captured_stdin-1658"><span class="linenos">1658</span></a><span class="sd">           captured = input()</span>
</span><span id="captured_stdin-1659"><a href="#captured_stdin-1659"><span class="linenos">1659</span></a><span class="sd">       self.assertEqual(captured, &quot;hello&quot;)</span>
</span><span id="captured_stdin-1660"><a href="#captured_stdin-1660"><span class="linenos">1660</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="captured_stdin-1661"><a href="#captured_stdin-1661"><span class="linenos">1661</span></a>    <span class="k">return</span> <span class="n">captured_output</span><span class="p">(</span><span class="s2">&quot;stdin&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Capture the input to sys.stdin:</p>

<p>with captured_stdin() as stdin:
    stdin.write('hello\n')
    stdin.seek(0)
    # call test code that consumes from sys.stdin
    captured = input()
self.assertEqual(captured, "hello")</p>
</div>


                </section>
                <section id="captured_stderr">
                            <input id="captured_stderr-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">captured_stderr</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="captured_stderr-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#captured_stderr"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="captured_stderr-1642"><a href="#captured_stderr-1642"><span class="linenos">1642</span></a><span class="k">def</span> <span class="nf">captured_stderr</span><span class="p">():</span>
</span><span id="captured_stderr-1643"><a href="#captured_stderr-1643"><span class="linenos">1643</span></a>    <span class="sd">&quot;&quot;&quot;Capture the output of sys.stderr:</span>
</span><span id="captured_stderr-1644"><a href="#captured_stderr-1644"><span class="linenos">1644</span></a>
</span><span id="captured_stderr-1645"><a href="#captured_stderr-1645"><span class="linenos">1645</span></a><span class="sd">       with captured_stderr() as stderr:</span>
</span><span id="captured_stderr-1646"><a href="#captured_stderr-1646"><span class="linenos">1646</span></a><span class="sd">           print(&quot;hello&quot;, file=sys.stderr)</span>
</span><span id="captured_stderr-1647"><a href="#captured_stderr-1647"><span class="linenos">1647</span></a><span class="sd">       self.assertEqual(stderr.getvalue(), &quot;hello\\n&quot;)</span>
</span><span id="captured_stderr-1648"><a href="#captured_stderr-1648"><span class="linenos">1648</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="captured_stderr-1649"><a href="#captured_stderr-1649"><span class="linenos">1649</span></a>    <span class="k">return</span> <span class="n">captured_output</span><span class="p">(</span><span class="s2">&quot;stderr&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Capture the output of sys.stderr:</p>

<p>with captured_stderr() as stderr:
    print("hello", file=sys.stderr)
self.assertEqual(stderr.getvalue(), "hello\n")</p>
</div>


                </section>
                <section id="TESTFN">
                    <div class="attr variable">
            <span class="name">TESTFN</span><span class="default_value"> = &#39;@test_22830_tmp&#39;</span>

        
    </div>
    <a class="headerlink" href="#TESTFN"></a>
    
    

                </section>
                <section id="SAVEDCWD">
                    <div class="attr variable">
            <span class="name">SAVEDCWD</span><span class="default_value"> = &#39;/Users/ryanmertz/Desktop/CSC510/csc510-fall22-hw-g33&#39;</span>

        
    </div>
    <a class="headerlink" href="#SAVEDCWD"></a>
    
    

                </section>
                <section id="unlink">
                            <input id="unlink-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unlink</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filename</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="unlink-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#unlink"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="unlink-445"><a href="#unlink-445"><span class="linenos">445</span></a><span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span><span id="unlink-446"><a href="#unlink-446"><span class="linenos">446</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="unlink-447"><a href="#unlink-447"><span class="linenos">447</span></a>        <span class="n">_unlink</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="unlink-448"><a href="#unlink-448"><span class="linenos">448</span></a>    <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">NotADirectoryError</span><span class="p">):</span>
</span><span id="unlink-449"><a href="#unlink-449"><span class="linenos">449</span></a>        <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="rmtree">
                            <input id="rmtree-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">rmtree</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">path</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="rmtree-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#rmtree"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="rmtree-457"><a href="#rmtree-457"><span class="linenos">457</span></a><span class="k">def</span> <span class="nf">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
</span><span id="rmtree-458"><a href="#rmtree-458"><span class="linenos">458</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="rmtree-459"><a href="#rmtree-459"><span class="linenos">459</span></a>        <span class="n">_rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="rmtree-460"><a href="#rmtree-460"><span class="linenos">460</span></a>    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="rmtree-461"><a href="#rmtree-461"><span class="linenos">461</span></a>        <span class="k">pass</span>
</span></pre></div>


    

                </section>
                <section id="temp_cwd">
                            <input id="temp_cwd-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@contextlib.contextmanager</div>

        <span class="def">def</span>
        <span class="name">temp_cwd</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tempcwd&#39;</span>, </span><span class="param"><span class="n">quiet</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="temp_cwd-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#temp_cwd"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="temp_cwd-1083"><a href="#temp_cwd-1083"><span class="linenos">1083</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="temp_cwd-1084"><a href="#temp_cwd-1084"><span class="linenos">1084</span></a><span class="k">def</span> <span class="nf">temp_cwd</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;tempcwd&#39;</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="temp_cwd-1085"><a href="#temp_cwd-1085"><span class="linenos">1085</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="temp_cwd-1086"><a href="#temp_cwd-1086"><span class="linenos">1086</span></a><span class="sd">    Context manager that temporarily creates and changes the CWD.</span>
</span><span id="temp_cwd-1087"><a href="#temp_cwd-1087"><span class="linenos">1087</span></a>
</span><span id="temp_cwd-1088"><a href="#temp_cwd-1088"><span class="linenos">1088</span></a><span class="sd">    The function temporarily changes the current working directory</span>
</span><span id="temp_cwd-1089"><a href="#temp_cwd-1089"><span class="linenos">1089</span></a><span class="sd">    after creating a temporary directory in the current directory with</span>
</span><span id="temp_cwd-1090"><a href="#temp_cwd-1090"><span class="linenos">1090</span></a><span class="sd">    name *name*.  If *name* is None, the temporary directory is</span>
</span><span id="temp_cwd-1091"><a href="#temp_cwd-1091"><span class="linenos">1091</span></a><span class="sd">    created using tempfile.mkdtemp.</span>
</span><span id="temp_cwd-1092"><a href="#temp_cwd-1092"><span class="linenos">1092</span></a>
</span><span id="temp_cwd-1093"><a href="#temp_cwd-1093"><span class="linenos">1093</span></a><span class="sd">    If *quiet* is False (default) and it is not possible to</span>
</span><span id="temp_cwd-1094"><a href="#temp_cwd-1094"><span class="linenos">1094</span></a><span class="sd">    create or change the CWD, an error is raised.  If *quiet* is True,</span>
</span><span id="temp_cwd-1095"><a href="#temp_cwd-1095"><span class="linenos">1095</span></a><span class="sd">    only a warning is raised and the original CWD is used.</span>
</span><span id="temp_cwd-1096"><a href="#temp_cwd-1096"><span class="linenos">1096</span></a>
</span><span id="temp_cwd-1097"><a href="#temp_cwd-1097"><span class="linenos">1097</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="temp_cwd-1098"><a href="#temp_cwd-1098"><span class="linenos">1098</span></a>    <span class="k">with</span> <span class="n">temp_dir</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span> <span class="k">as</span> <span class="n">temp_path</span><span class="p">:</span>
</span><span id="temp_cwd-1099"><a href="#temp_cwd-1099"><span class="linenos">1099</span></a>        <span class="k">with</span> <span class="n">change_cwd</span><span class="p">(</span><span class="n">temp_path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="n">quiet</span><span class="p">)</span> <span class="k">as</span> <span class="n">cwd_dir</span><span class="p">:</span>
</span><span id="temp_cwd-1100"><a href="#temp_cwd-1100"><span class="linenos">1100</span></a>            <span class="k">yield</span> <span class="n">cwd_dir</span>
</span></pre></div>


            <div class="docstring"><p>Context manager that temporarily creates and changes the CWD.</p>

<p>The function temporarily changes the current working directory
after creating a temporary directory in the current directory with
name <em>name</em>.  If <em>name</em> is None, the temporary directory is
created using tempfile.mkdtemp.</p>

<p>If <em>quiet</em> is False (default) and it is not possible to
create or change the CWD, an error is raised.  If <em>quiet</em> is True,
only a warning is raised and the original CWD is used.</p>
</div>


                </section>
                <section id="findfile">
                            <input id="findfile-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">findfile</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filename</span>, </span><span class="param"><span class="n">subdir</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="findfile-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#findfile"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="findfile-1120"><a href="#findfile-1120"><span class="linenos">1120</span></a><span class="k">def</span> <span class="nf">findfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">subdir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="findfile-1121"><a href="#findfile-1121"><span class="linenos">1121</span></a>    <span class="sd">&quot;&quot;&quot;Try to find a file on sys.path or in the test directory.  If it is not</span>
</span><span id="findfile-1122"><a href="#findfile-1122"><span class="linenos">1122</span></a><span class="sd">    found the argument passed to the function is returned (this does not</span>
</span><span id="findfile-1123"><a href="#findfile-1123"><span class="linenos">1123</span></a><span class="sd">    necessarily signal failure; could still be the legitimate path).</span>
</span><span id="findfile-1124"><a href="#findfile-1124"><span class="linenos">1124</span></a>
</span><span id="findfile-1125"><a href="#findfile-1125"><span class="linenos">1125</span></a><span class="sd">    Setting *subdir* indicates a relative path to use to find the file</span>
</span><span id="findfile-1126"><a href="#findfile-1126"><span class="linenos">1126</span></a><span class="sd">    rather than looking directly in the path directories.</span>
</span><span id="findfile-1127"><a href="#findfile-1127"><span class="linenos">1127</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="findfile-1128"><a href="#findfile-1128"><span class="linenos">1128</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span><span id="findfile-1129"><a href="#findfile-1129"><span class="linenos">1129</span></a>        <span class="k">return</span> <span class="n">filename</span>
</span><span id="findfile-1130"><a href="#findfile-1130"><span class="linenos">1130</span></a>    <span class="k">if</span> <span class="n">subdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="findfile-1131"><a href="#findfile-1131"><span class="linenos">1131</span></a>        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="findfile-1132"><a href="#findfile-1132"><span class="linenos">1132</span></a>    <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">TEST_HOME_DIR</span><span class="p">]</span> <span class="o">+</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span>
</span><span id="findfile-1133"><a href="#findfile-1133"><span class="linenos">1133</span></a>    <span class="k">for</span> <span class="n">dn</span> <span class="ow">in</span> <span class="n">path</span><span class="p">:</span>
</span><span id="findfile-1134"><a href="#findfile-1134"><span class="linenos">1134</span></a>        <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="findfile-1135"><a href="#findfile-1135"><span class="linenos">1135</span></a>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span> <span class="k">return</span> <span class="n">fn</span>
</span><span id="findfile-1136"><a href="#findfile-1136"><span class="linenos">1136</span></a>    <span class="k">return</span> <span class="n">filename</span>
</span></pre></div>


            <div class="docstring"><p>Try to find a file on sys.path or in the test directory.  If it is not
found the argument passed to the function is returned (this does not
necessarily signal failure; could still be the legitimate path).</p>

<p>Setting <em>subdir</em> indicates a relative path to use to find the file
rather than looking directly in the path directories.</p>
</div>


                </section>
                <section id="create_empty_file">
                            <input id="create_empty_file-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_empty_file</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">filename</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="create_empty_file-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_empty_file"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_empty_file-1138"><a href="#create_empty_file-1138"><span class="linenos">1138</span></a><span class="k">def</span> <span class="nf">create_empty_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span><span id="create_empty_file-1139"><a href="#create_empty_file-1139"><span class="linenos">1139</span></a>    <span class="sd">&quot;&quot;&quot;Create an empty file. If the file already exists, truncate it.&quot;&quot;&quot;</span>
</span><span id="create_empty_file-1140"><a href="#create_empty_file-1140"><span class="linenos">1140</span></a>    <span class="n">fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_TRUNC</span><span class="p">)</span>
</span><span id="create_empty_file-1141"><a href="#create_empty_file-1141"><span class="linenos">1141</span></a>    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Create an empty file. If the file already exists, truncate it.</p>
</div>


                </section>
                <section id="can_symlink">
                            <input id="can_symlink-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">can_symlink</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="can_symlink-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#can_symlink"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="can_symlink-2556"><a href="#can_symlink-2556"><span class="linenos">2556</span></a><span class="k">def</span> <span class="nf">can_symlink</span><span class="p">():</span>
</span><span id="can_symlink-2557"><a href="#can_symlink-2557"><span class="linenos">2557</span></a>    <span class="k">global</span> <span class="n">_can_symlink</span>
</span><span id="can_symlink-2558"><a href="#can_symlink-2558"><span class="linenos">2558</span></a>    <span class="k">if</span> <span class="n">_can_symlink</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="can_symlink-2559"><a href="#can_symlink-2559"><span class="linenos">2559</span></a>        <span class="k">return</span> <span class="n">_can_symlink</span>
</span><span id="can_symlink-2560"><a href="#can_symlink-2560"><span class="linenos">2560</span></a>    <span class="n">symlink_path</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s2">&quot;can_symlink&quot;</span>
</span><span id="can_symlink-2561"><a href="#can_symlink-2561"><span class="linenos">2561</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="can_symlink-2562"><a href="#can_symlink-2562"><span class="linenos">2562</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">TESTFN</span><span class="p">,</span> <span class="n">symlink_path</span><span class="p">)</span>
</span><span id="can_symlink-2563"><a href="#can_symlink-2563"><span class="linenos">2563</span></a>        <span class="n">can</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="can_symlink-2564"><a href="#can_symlink-2564"><span class="linenos">2564</span></a>    <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">NotImplementedError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
</span><span id="can_symlink-2565"><a href="#can_symlink-2565"><span class="linenos">2565</span></a>        <span class="n">can</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="can_symlink-2566"><a href="#can_symlink-2566"><span class="linenos">2566</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="can_symlink-2567"><a href="#can_symlink-2567"><span class="linenos">2567</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">symlink_path</span><span class="p">)</span>
</span><span id="can_symlink-2568"><a href="#can_symlink-2568"><span class="linenos">2568</span></a>    <span class="n">_can_symlink</span> <span class="o">=</span> <span class="n">can</span>
</span><span id="can_symlink-2569"><a href="#can_symlink-2569"><span class="linenos">2569</span></a>    <span class="k">return</span> <span class="n">can</span>
</span></pre></div>


    

                </section>
                <section id="fs_is_case_insensitive">
                            <input id="fs_is_case_insensitive-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fs_is_case_insensitive</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">directory</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fs_is_case_insensitive-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fs_is_case_insensitive"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fs_is_case_insensitive-2742"><a href="#fs_is_case_insensitive-2742"><span class="linenos">2742</span></a><span class="k">def</span> <span class="nf">fs_is_case_insensitive</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
</span><span id="fs_is_case_insensitive-2743"><a href="#fs_is_case_insensitive-2743"><span class="linenos">2743</span></a>    <span class="sd">&quot;&quot;&quot;Detects if the file system for the specified directory is case-insensitive.&quot;&quot;&quot;</span>
</span><span id="fs_is_case_insensitive-2744"><a href="#fs_is_case_insensitive-2744"><span class="linenos">2744</span></a>    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">directory</span><span class="p">)</span> <span class="k">as</span> <span class="n">base</span><span class="p">:</span>
</span><span id="fs_is_case_insensitive-2745"><a href="#fs_is_case_insensitive-2745"><span class="linenos">2745</span></a>        <span class="n">base_path</span> <span class="o">=</span> <span class="n">base</span><span class="o">.</span><span class="n">name</span>
</span><span id="fs_is_case_insensitive-2746"><a href="#fs_is_case_insensitive-2746"><span class="linenos">2746</span></a>        <span class="n">case_path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</span><span id="fs_is_case_insensitive-2747"><a href="#fs_is_case_insensitive-2747"><span class="linenos">2747</span></a>        <span class="k">if</span> <span class="n">case_path</span> <span class="o">==</span> <span class="n">base_path</span><span class="p">:</span>
</span><span id="fs_is_case_insensitive-2748"><a href="#fs_is_case_insensitive-2748"><span class="linenos">2748</span></a>            <span class="n">case_path</span> <span class="o">=</span> <span class="n">base_path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="fs_is_case_insensitive-2749"><a href="#fs_is_case_insensitive-2749"><span class="linenos">2749</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="fs_is_case_insensitive-2750"><a href="#fs_is_case_insensitive-2750"><span class="linenos">2750</span></a>            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">samefile</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">case_path</span><span class="p">)</span>
</span><span id="fs_is_case_insensitive-2751"><a href="#fs_is_case_insensitive-2751"><span class="linenos">2751</span></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="fs_is_case_insensitive-2752"><a href="#fs_is_case_insensitive-2752"><span class="linenos">2752</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Detects if the file system for the specified directory is case-insensitive.</p>
</div>


                </section>
                <section id="is_resource_enabled">
                            <input id="is_resource_enabled-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">is_resource_enabled</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">resource</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="is_resource_enabled-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#is_resource_enabled"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="is_resource_enabled-566"><a href="#is_resource_enabled-566"><span class="linenos">566</span></a><span class="k">def</span> <span class="nf">is_resource_enabled</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
</span><span id="is_resource_enabled-567"><a href="#is_resource_enabled-567"><span class="linenos">567</span></a>    <span class="sd">&quot;&quot;&quot;Test whether a resource is enabled.</span>
</span><span id="is_resource_enabled-568"><a href="#is_resource_enabled-568"><span class="linenos">568</span></a>
</span><span id="is_resource_enabled-569"><a href="#is_resource_enabled-569"><span class="linenos">569</span></a><span class="sd">    Known resources are set by regrtest.py.  If not running under regrtest.py,</span>
</span><span id="is_resource_enabled-570"><a href="#is_resource_enabled-570"><span class="linenos">570</span></a><span class="sd">    all resources are assumed enabled unless use_resources has been set.</span>
</span><span id="is_resource_enabled-571"><a href="#is_resource_enabled-571"><span class="linenos">571</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="is_resource_enabled-572"><a href="#is_resource_enabled-572"><span class="linenos">572</span></a>    <span class="k">return</span> <span class="n">use_resources</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">resource</span> <span class="ow">in</span> <span class="n">use_resources</span>
</span></pre></div>


            <div class="docstring"><p>Test whether a resource is enabled.</p>

<p>Known resources are set by regrtest.py.  If not running under regrtest.py,
all resources are assumed enabled unless use_resources has been set.</p>
</div>


                </section>
                <section id="requires">
                            <input id="requires-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requires</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">resource</span>, </span><span class="param"><span class="n">msg</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="requires-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#requires"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="requires-574"><a href="#requires-574"><span class="linenos">574</span></a><span class="k">def</span> <span class="nf">requires</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="requires-575"><a href="#requires-575"><span class="linenos">575</span></a>    <span class="sd">&quot;&quot;&quot;Raise ResourceDenied if the specified resource is not available.&quot;&quot;&quot;</span>
</span><span id="requires-576"><a href="#requires-576"><span class="linenos">576</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_resource_enabled</span><span class="p">(</span><span class="n">resource</span><span class="p">):</span>
</span><span id="requires-577"><a href="#requires-577"><span class="linenos">577</span></a>        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="requires-578"><a href="#requires-578"><span class="linenos">578</span></a>            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Use of the </span><span class="si">%r</span><span class="s2"> resource not enabled&quot;</span> <span class="o">%</span> <span class="n">resource</span>
</span><span id="requires-579"><a href="#requires-579"><span class="linenos">579</span></a>        <span class="k">raise</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span><span id="requires-580"><a href="#requires-580"><span class="linenos">580</span></a>    <span class="k">if</span> <span class="n">resource</span> <span class="o">==</span> <span class="s1">&#39;gui&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_gui_available</span><span class="p">():</span>
</span><span id="requires-581"><a href="#requires-581"><span class="linenos">581</span></a>        <span class="k">raise</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="n">_is_gui_available</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Raise ResourceDenied if the specified resource is not available.</p>
</div>


                </section>
                <section id="requires_freebsd_version">
                            <input id="requires_freebsd_version-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requires_freebsd_version</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">min_version</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="requires_freebsd_version-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#requires_freebsd_version"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="requires_freebsd_version-610"><a href="#requires_freebsd_version-610"><span class="linenos">610</span></a><span class="k">def</span> <span class="nf">requires_freebsd_version</span><span class="p">(</span><span class="o">*</span><span class="n">min_version</span><span class="p">):</span>
</span><span id="requires_freebsd_version-611"><a href="#requires_freebsd_version-611"><span class="linenos">611</span></a>    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is FreeBSD and the FreeBSD version is</span>
</span><span id="requires_freebsd_version-612"><a href="#requires_freebsd_version-612"><span class="linenos">612</span></a><span class="sd">    less than `min_version`.</span>
</span><span id="requires_freebsd_version-613"><a href="#requires_freebsd_version-613"><span class="linenos">613</span></a>
</span><span id="requires_freebsd_version-614"><a href="#requires_freebsd_version-614"><span class="linenos">614</span></a><span class="sd">    For example, @requires_freebsd_version(7, 2) raises SkipTest if the FreeBSD</span>
</span><span id="requires_freebsd_version-615"><a href="#requires_freebsd_version-615"><span class="linenos">615</span></a><span class="sd">    version is less than 7.2.</span>
</span><span id="requires_freebsd_version-616"><a href="#requires_freebsd_version-616"><span class="linenos">616</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="requires_freebsd_version-617"><a href="#requires_freebsd_version-617"><span class="linenos">617</span></a>    <span class="k">return</span> <span class="n">_requires_unix_version</span><span class="p">(</span><span class="s1">&#39;FreeBSD&#39;</span><span class="p">,</span> <span class="n">min_version</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Decorator raising SkipTest if the OS is FreeBSD and the FreeBSD version is
less than <code>min_version</code>.</p>

<p>For example, @requires_freebsd_version(7, 2) raises SkipTest if the FreeBSD
version is less than 7.2.</p>
</div>


                </section>
                <section id="requires_linux_version">
                            <input id="requires_linux_version-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requires_linux_version</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">min_version</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="requires_linux_version-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#requires_linux_version"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="requires_linux_version-619"><a href="#requires_linux_version-619"><span class="linenos">619</span></a><span class="k">def</span> <span class="nf">requires_linux_version</span><span class="p">(</span><span class="o">*</span><span class="n">min_version</span><span class="p">):</span>
</span><span id="requires_linux_version-620"><a href="#requires_linux_version-620"><span class="linenos">620</span></a>    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is Linux and the Linux version is</span>
</span><span id="requires_linux_version-621"><a href="#requires_linux_version-621"><span class="linenos">621</span></a><span class="sd">    less than `min_version`.</span>
</span><span id="requires_linux_version-622"><a href="#requires_linux_version-622"><span class="linenos">622</span></a>
</span><span id="requires_linux_version-623"><a href="#requires_linux_version-623"><span class="linenos">623</span></a><span class="sd">    For example, @requires_linux_version(2, 6, 32) raises SkipTest if the Linux</span>
</span><span id="requires_linux_version-624"><a href="#requires_linux_version-624"><span class="linenos">624</span></a><span class="sd">    version is less than 2.6.32.</span>
</span><span id="requires_linux_version-625"><a href="#requires_linux_version-625"><span class="linenos">625</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="requires_linux_version-626"><a href="#requires_linux_version-626"><span class="linenos">626</span></a>    <span class="k">return</span> <span class="n">_requires_unix_version</span><span class="p">(</span><span class="s1">&#39;Linux&#39;</span><span class="p">,</span> <span class="n">min_version</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Decorator raising SkipTest if the OS is Linux and the Linux version is
less than <code>min_version</code>.</p>

<p>For example, @requires_linux_version(2, 6, 32) raises SkipTest if the Linux
version is less than 2.6.32.</p>
</div>


                </section>
                <section id="requires_mac_ver">
                            <input id="requires_mac_ver-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requires_mac_ver</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">min_version</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="requires_mac_ver-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#requires_mac_ver"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="requires_mac_ver-628"><a href="#requires_mac_ver-628"><span class="linenos">628</span></a><span class="k">def</span> <span class="nf">requires_mac_ver</span><span class="p">(</span><span class="o">*</span><span class="n">min_version</span><span class="p">):</span>
</span><span id="requires_mac_ver-629"><a href="#requires_mac_ver-629"><span class="linenos">629</span></a>    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if the OS is Mac OS X and the OS X</span>
</span><span id="requires_mac_ver-630"><a href="#requires_mac_ver-630"><span class="linenos">630</span></a><span class="sd">    version if less than min_version.</span>
</span><span id="requires_mac_ver-631"><a href="#requires_mac_ver-631"><span class="linenos">631</span></a>
</span><span id="requires_mac_ver-632"><a href="#requires_mac_ver-632"><span class="linenos">632</span></a><span class="sd">    For example, @requires_mac_ver(10, 5) raises SkipTest if the OS X version</span>
</span><span id="requires_mac_ver-633"><a href="#requires_mac_ver-633"><span class="linenos">633</span></a><span class="sd">    is lesser than 10.5.</span>
</span><span id="requires_mac_ver-634"><a href="#requires_mac_ver-634"><span class="linenos">634</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="requires_mac_ver-635"><a href="#requires_mac_ver-635"><span class="linenos">635</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="requires_mac_ver-636"><a href="#requires_mac_ver-636"><span class="linenos">636</span></a>        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="requires_mac_ver-637"><a href="#requires_mac_ver-637"><span class="linenos">637</span></a>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span><span id="requires_mac_ver-638"><a href="#requires_mac_ver-638"><span class="linenos">638</span></a>            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
</span><span id="requires_mac_ver-639"><a href="#requires_mac_ver-639"><span class="linenos">639</span></a>                <span class="n">version_txt</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">mac_ver</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="requires_mac_ver-640"><a href="#requires_mac_ver-640"><span class="linenos">640</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="requires_mac_ver-641"><a href="#requires_mac_ver-641"><span class="linenos">641</span></a>                    <span class="n">version</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">version_txt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)))</span>
</span><span id="requires_mac_ver-642"><a href="#requires_mac_ver-642"><span class="linenos">642</span></a>                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="requires_mac_ver-643"><a href="#requires_mac_ver-643"><span class="linenos">643</span></a>                    <span class="k">pass</span>
</span><span id="requires_mac_ver-644"><a href="#requires_mac_ver-644"><span class="linenos">644</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="requires_mac_ver-645"><a href="#requires_mac_ver-645"><span class="linenos">645</span></a>                    <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="n">min_version</span><span class="p">:</span>
</span><span id="requires_mac_ver-646"><a href="#requires_mac_ver-646"><span class="linenos">646</span></a>                        <span class="n">min_version_txt</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">min_version</span><span class="p">))</span>
</span><span id="requires_mac_ver-647"><a href="#requires_mac_ver-647"><span class="linenos">647</span></a>                        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
</span><span id="requires_mac_ver-648"><a href="#requires_mac_ver-648"><span class="linenos">648</span></a>                            <span class="s2">&quot;Mac OS X </span><span class="si">%s</span><span class="s2"> or higher required, not </span><span class="si">%s</span><span class="s2">&quot;</span>
</span><span id="requires_mac_ver-649"><a href="#requires_mac_ver-649"><span class="linenos">649</span></a>                            <span class="o">%</span> <span class="p">(</span><span class="n">min_version_txt</span><span class="p">,</span> <span class="n">version_txt</span><span class="p">))</span>
</span><span id="requires_mac_ver-650"><a href="#requires_mac_ver-650"><span class="linenos">650</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="requires_mac_ver-651"><a href="#requires_mac_ver-651"><span class="linenos">651</span></a>        <span class="n">wrapper</span><span class="o">.</span><span class="n">min_version</span> <span class="o">=</span> <span class="n">min_version</span>
</span><span id="requires_mac_ver-652"><a href="#requires_mac_ver-652"><span class="linenos">652</span></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="requires_mac_ver-653"><a href="#requires_mac_ver-653"><span class="linenos">653</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span></pre></div>


            <div class="docstring"><p>Decorator raising SkipTest if the OS is Mac OS X and the OS X
version if less than min_version.</p>

<p>For example, @requires_mac_ver(10, 5) raises SkipTest if the OS X version
is lesser than 10.5.</p>
</div>


                </section>
                <section id="requires_hashdigest">
                            <input id="requires_hashdigest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requires_hashdigest</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">digestname</span>, </span><span class="param"><span class="n">openssl</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="requires_hashdigest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#requires_hashdigest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="requires_hashdigest-656"><a href="#requires_hashdigest-656"><span class="linenos">656</span></a><span class="k">def</span> <span class="nf">requires_hashdigest</span><span class="p">(</span><span class="n">digestname</span><span class="p">,</span> <span class="n">openssl</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="requires_hashdigest-657"><a href="#requires_hashdigest-657"><span class="linenos">657</span></a>    <span class="sd">&quot;&quot;&quot;Decorator raising SkipTest if a hashing algorithm is not available</span>
</span><span id="requires_hashdigest-658"><a href="#requires_hashdigest-658"><span class="linenos">658</span></a>
</span><span id="requires_hashdigest-659"><a href="#requires_hashdigest-659"><span class="linenos">659</span></a><span class="sd">    The hashing algorithm could be missing or blocked by a strict crypto</span>
</span><span id="requires_hashdigest-660"><a href="#requires_hashdigest-660"><span class="linenos">660</span></a><span class="sd">    policy.</span>
</span><span id="requires_hashdigest-661"><a href="#requires_hashdigest-661"><span class="linenos">661</span></a>
</span><span id="requires_hashdigest-662"><a href="#requires_hashdigest-662"><span class="linenos">662</span></a><span class="sd">    If &#39;openssl&#39; is True, then the decorator checks that OpenSSL provides</span>
</span><span id="requires_hashdigest-663"><a href="#requires_hashdigest-663"><span class="linenos">663</span></a><span class="sd">    the algorithm. Otherwise the check falls back to built-in</span>
</span><span id="requires_hashdigest-664"><a href="#requires_hashdigest-664"><span class="linenos">664</span></a><span class="sd">    implementations.</span>
</span><span id="requires_hashdigest-665"><a href="#requires_hashdigest-665"><span class="linenos">665</span></a>
</span><span id="requires_hashdigest-666"><a href="#requires_hashdigest-666"><span class="linenos">666</span></a><span class="sd">    ValueError: [digital envelope routines: EVP_DigestInit_ex] disabled for FIPS</span>
</span><span id="requires_hashdigest-667"><a href="#requires_hashdigest-667"><span class="linenos">667</span></a><span class="sd">    ValueError: unsupported hash type md4</span>
</span><span id="requires_hashdigest-668"><a href="#requires_hashdigest-668"><span class="linenos">668</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="requires_hashdigest-669"><a href="#requires_hashdigest-669"><span class="linenos">669</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="requires_hashdigest-670"><a href="#requires_hashdigest-670"><span class="linenos">670</span></a>        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="requires_hashdigest-671"><a href="#requires_hashdigest-671"><span class="linenos">671</span></a>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="requires_hashdigest-672"><a href="#requires_hashdigest-672"><span class="linenos">672</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="requires_hashdigest-673"><a href="#requires_hashdigest-673"><span class="linenos">673</span></a>                <span class="k">if</span> <span class="n">openssl</span> <span class="ow">and</span> <span class="n">_hashlib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="requires_hashdigest-674"><a href="#requires_hashdigest-674"><span class="linenos">674</span></a>                    <span class="n">_hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digestname</span><span class="p">)</span>
</span><span id="requires_hashdigest-675"><a href="#requires_hashdigest-675"><span class="linenos">675</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="requires_hashdigest-676"><a href="#requires_hashdigest-676"><span class="linenos">676</span></a>                    <span class="n">hashlib</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">digestname</span><span class="p">)</span>
</span><span id="requires_hashdigest-677"><a href="#requires_hashdigest-677"><span class="linenos">677</span></a>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="requires_hashdigest-678"><a href="#requires_hashdigest-678"><span class="linenos">678</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
</span><span id="requires_hashdigest-679"><a href="#requires_hashdigest-679"><span class="linenos">679</span></a>                    <span class="sa">f</span><span class="s2">&quot;hash digest &#39;</span><span class="si">{</span><span class="n">digestname</span><span class="si">}</span><span class="s2">&#39; is not available.&quot;</span>
</span><span id="requires_hashdigest-680"><a href="#requires_hashdigest-680"><span class="linenos">680</span></a>                <span class="p">)</span>
</span><span id="requires_hashdigest-681"><a href="#requires_hashdigest-681"><span class="linenos">681</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="requires_hashdigest-682"><a href="#requires_hashdigest-682"><span class="linenos">682</span></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="requires_hashdigest-683"><a href="#requires_hashdigest-683"><span class="linenos">683</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span></pre></div>


            <div class="docstring"><p>Decorator raising SkipTest if a hashing algorithm is not available</p>

<p>The hashing algorithm could be missing or blocked by a strict crypto
policy.</p>

<p>If 'openssl' is True, then the decorator checks that OpenSSL provides
the algorithm. Otherwise the check falls back to built-in
implementations.</p>

<p>ValueError: [digital envelope routines: EVP_DigestInit_ex] disabled for FIPS
ValueError: unsupported hash type md4</p>
</div>


                </section>
                <section id="check_syntax_error">
                            <input id="check_syntax_error-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_syntax_error</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">testcase</span>, </span><span class="param"><span class="n">statement</span>, </span><span class="param"><span class="n">errtext</span><span class="o">=</span><span class="s1">&#39;&#39;</span>, </span><span class="param"><span class="o">*</span>, </span><span class="param"><span class="n">lineno</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">offset</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_syntax_error-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_syntax_error"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_syntax_error-1163"><a href="#check_syntax_error-1163"><span class="linenos">1163</span></a><span class="k">def</span> <span class="nf">check_syntax_error</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">errtext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="check_syntax_error-1164"><a href="#check_syntax_error-1164"><span class="linenos">1164</span></a>    <span class="k">with</span> <span class="n">testcase</span><span class="o">.</span><span class="n">assertRaisesRegex</span><span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="n">errtext</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
</span><span id="check_syntax_error-1165"><a href="#check_syntax_error-1165"><span class="linenos">1165</span></a>        <span class="nb">compile</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="s1">&#39;&lt;test string&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
</span><span id="check_syntax_error-1166"><a href="#check_syntax_error-1166"><span class="linenos">1166</span></a>    <span class="n">err</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">exception</span>
</span><span id="check_syntax_error-1167"><a href="#check_syntax_error-1167"><span class="linenos">1167</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
</span><span id="check_syntax_error-1168"><a href="#check_syntax_error-1168"><span class="linenos">1168</span></a>    <span class="k">if</span> <span class="n">lineno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="check_syntax_error-1169"><a href="#check_syntax_error-1169"><span class="linenos">1169</span></a>        <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
</span><span id="check_syntax_error-1170"><a href="#check_syntax_error-1170"><span class="linenos">1170</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
</span><span id="check_syntax_error-1171"><a href="#check_syntax_error-1171"><span class="linenos">1171</span></a>    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="check_syntax_error-1172"><a href="#check_syntax_error-1172"><span class="linenos">1172</span></a>        <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">err</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="check_syntax_warning">
                            <input id="check_syntax_warning-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_syntax_warning</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">testcase</span>, </span><span class="param"><span class="n">statement</span>, </span><span class="param"><span class="n">errtext</span><span class="o">=</span><span class="s1">&#39;&#39;</span>, </span><span class="param"><span class="o">*</span>, </span><span class="param"><span class="n">lineno</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">offset</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_syntax_warning-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_syntax_warning"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_syntax_warning-1174"><a href="#check_syntax_warning-1174"><span class="linenos">1174</span></a><span class="k">def</span> <span class="nf">check_syntax_warning</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">errtext</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="check_syntax_warning-1175"><a href="#check_syntax_warning-1175"><span class="linenos">1175</span></a>    <span class="c1"># Test also that a warning is emitted only once.</span>
</span><span id="check_syntax_warning-1176"><a href="#check_syntax_warning-1176"><span class="linenos">1176</span></a>    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">warns</span><span class="p">:</span>
</span><span id="check_syntax_warning-1177"><a href="#check_syntax_warning-1177"><span class="linenos">1177</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">)</span>
</span><span id="check_syntax_warning-1178"><a href="#check_syntax_warning-1178"><span class="linenos">1178</span></a>        <span class="nb">compile</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="s1">&#39;&lt;testcase&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">)</span>
</span><span id="check_syntax_warning-1179"><a href="#check_syntax_warning-1179"><span class="linenos">1179</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">warns</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">warns</span><span class="p">)</span>
</span><span id="check_syntax_warning-1180"><a href="#check_syntax_warning-1180"><span class="linenos">1180</span></a>
</span><span id="check_syntax_warning-1181"><a href="#check_syntax_warning-1181"><span class="linenos">1181</span></a>    <span class="n">warn</span><span class="p">,</span> <span class="o">=</span> <span class="n">warns</span>
</span><span id="check_syntax_warning-1182"><a href="#check_syntax_warning-1182"><span class="linenos">1182</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">category</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">),</span> <span class="n">warn</span><span class="o">.</span><span class="n">category</span><span class="p">)</span>
</span><span id="check_syntax_warning-1183"><a href="#check_syntax_warning-1183"><span class="linenos">1183</span></a>    <span class="k">if</span> <span class="n">errtext</span><span class="p">:</span>
</span><span id="check_syntax_warning-1184"><a href="#check_syntax_warning-1184"><span class="linenos">1184</span></a>        <span class="n">testcase</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">message</span><span class="p">),</span> <span class="n">errtext</span><span class="p">)</span>
</span><span id="check_syntax_warning-1185"><a href="#check_syntax_warning-1185"><span class="linenos">1185</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;&lt;testcase&gt;&#39;</span><span class="p">)</span>
</span><span id="check_syntax_warning-1186"><a href="#check_syntax_warning-1186"><span class="linenos">1186</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>
</span><span id="check_syntax_warning-1187"><a href="#check_syntax_warning-1187"><span class="linenos">1187</span></a>    <span class="k">if</span> <span class="n">lineno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="check_syntax_warning-1188"><a href="#check_syntax_warning-1188"><span class="linenos">1188</span></a>        <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">warn</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>
</span><span id="check_syntax_warning-1189"><a href="#check_syntax_warning-1189"><span class="linenos">1189</span></a>
</span><span id="check_syntax_warning-1190"><a href="#check_syntax_warning-1190"><span class="linenos">1190</span></a>    <span class="c1"># SyntaxWarning should be converted to SyntaxError when raised,</span>
</span><span id="check_syntax_warning-1191"><a href="#check_syntax_warning-1191"><span class="linenos">1191</span></a>    <span class="c1"># since the latter contains more information and provides better</span>
</span><span id="check_syntax_warning-1192"><a href="#check_syntax_warning-1192"><span class="linenos">1192</span></a>    <span class="c1"># error report.</span>
</span><span id="check_syntax_warning-1193"><a href="#check_syntax_warning-1193"><span class="linenos">1193</span></a>    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">warns</span><span class="p">:</span>
</span><span id="check_syntax_warning-1194"><a href="#check_syntax_warning-1194"><span class="linenos">1194</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">)</span>
</span><span id="check_syntax_warning-1195"><a href="#check_syntax_warning-1195"><span class="linenos">1195</span></a>        <span class="n">check_syntax_error</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">errtext</span><span class="p">,</span>
</span><span id="check_syntax_warning-1196"><a href="#check_syntax_warning-1196"><span class="linenos">1196</span></a>                           <span class="n">lineno</span><span class="o">=</span><span class="n">lineno</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">)</span>
</span><span id="check_syntax_warning-1197"><a href="#check_syntax_warning-1197"><span class="linenos">1197</span></a>    <span class="c1"># No warnings are leaked when a SyntaxError is raised.</span>
</span><span id="check_syntax_warning-1198"><a href="#check_syntax_warning-1198"><span class="linenos">1198</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">warns</span><span class="p">,</span> <span class="p">[])</span>
</span></pre></div>


    

                </section>
                <section id="TransientResource">
                            <input id="TransientResource-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TransientResource</span>:

                <label class="view-source-button" for="TransientResource-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TransientResource"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TransientResource-1489"><a href="#TransientResource-1489"><span class="linenos">1489</span></a><span class="k">class</span> <span class="nc">TransientResource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="TransientResource-1490"><a href="#TransientResource-1490"><span class="linenos">1490</span></a>
</span><span id="TransientResource-1491"><a href="#TransientResource-1491"><span class="linenos">1491</span></a>    <span class="sd">&quot;&quot;&quot;Raise ResourceDenied if an exception is raised while the context manager</span>
</span><span id="TransientResource-1492"><a href="#TransientResource-1492"><span class="linenos">1492</span></a><span class="sd">    is in effect that matches the specified exception and attributes.&quot;&quot;&quot;</span>
</span><span id="TransientResource-1493"><a href="#TransientResource-1493"><span class="linenos">1493</span></a>
</span><span id="TransientResource-1494"><a href="#TransientResource-1494"><span class="linenos">1494</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="TransientResource-1495"><a href="#TransientResource-1495"><span class="linenos">1495</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exc</span> <span class="o">=</span> <span class="n">exc</span>
</span><span id="TransientResource-1496"><a href="#TransientResource-1496"><span class="linenos">1496</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span><span id="TransientResource-1497"><a href="#TransientResource-1497"><span class="linenos">1497</span></a>
</span><span id="TransientResource-1498"><a href="#TransientResource-1498"><span class="linenos">1498</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TransientResource-1499"><a href="#TransientResource-1499"><span class="linenos">1499</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="TransientResource-1500"><a href="#TransientResource-1500"><span class="linenos">1500</span></a>
</span><span id="TransientResource-1501"><a href="#TransientResource-1501"><span class="linenos">1501</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="TransientResource-1502"><a href="#TransientResource-1502"><span class="linenos">1502</span></a>        <span class="sd">&quot;&quot;&quot;If type_ is a subclass of self.exc and value has attributes matching</span>
</span><span id="TransientResource-1503"><a href="#TransientResource-1503"><span class="linenos">1503</span></a><span class="sd">        self.attrs, raise ResourceDenied.  Otherwise let the exception</span>
</span><span id="TransientResource-1504"><a href="#TransientResource-1504"><span class="linenos">1504</span></a><span class="sd">        propagate (if any).&quot;&quot;&quot;</span>
</span><span id="TransientResource-1505"><a href="#TransientResource-1505"><span class="linenos">1505</span></a>        <span class="k">if</span> <span class="n">type_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exc</span><span class="p">,</span> <span class="n">type_</span><span class="p">):</span>
</span><span id="TransientResource-1506"><a href="#TransientResource-1506"><span class="linenos">1506</span></a>            <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">attr_value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="TransientResource-1507"><a href="#TransientResource-1507"><span class="linenos">1507</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
</span><span id="TransientResource-1508"><a href="#TransientResource-1508"><span class="linenos">1508</span></a>                    <span class="k">break</span>
</span><span id="TransientResource-1509"><a href="#TransientResource-1509"><span class="linenos">1509</span></a>                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">attr_value</span><span class="p">:</span>
</span><span id="TransientResource-1510"><a href="#TransientResource-1510"><span class="linenos">1510</span></a>                    <span class="k">break</span>
</span><span id="TransientResource-1511"><a href="#TransientResource-1511"><span class="linenos">1511</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="TransientResource-1512"><a href="#TransientResource-1512"><span class="linenos">1512</span></a>                <span class="k">raise</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="s2">&quot;an optional resource is not available&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Raise ResourceDenied if an exception is raised while the context manager
is in effect that matches the specified exception and attributes.</p>
</div>


                            <div id="TransientResource.__init__" class="classattr">
                                        <input id="TransientResource.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TransientResource</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">exc</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span>)</span>

                <label class="view-source-button" for="TransientResource.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TransientResource.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TransientResource.__init__-1494"><a href="#TransientResource.__init__-1494"><span class="linenos">1494</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="TransientResource.__init__-1495"><a href="#TransientResource.__init__-1495"><span class="linenos">1495</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">exc</span> <span class="o">=</span> <span class="n">exc</span>
</span><span id="TransientResource.__init__-1496"><a href="#TransientResource.__init__-1496"><span class="linenos">1496</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">kwargs</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="time_out">
                    <div class="attr variable">
            <span class="name">time_out</span><span class="default_value"> = &lt;<a href="#TransientResource">test.support.TransientResource</a> object&gt;</span>

        
    </div>
    <a class="headerlink" href="#time_out"></a>
    
    

                </section>
                <section id="socket_peer_reset">
                    <div class="attr variable">
            <span class="name">socket_peer_reset</span><span class="default_value"> = &lt;<a href="#TransientResource">test.support.TransientResource</a> object&gt;</span>

        
    </div>
    <a class="headerlink" href="#socket_peer_reset"></a>
    
    

                </section>
                <section id="ioerror_peer_reset">
                    <div class="attr variable">
            <span class="name">ioerror_peer_reset</span><span class="default_value"> = &lt;<a href="#TransientResource">test.support.TransientResource</a> object&gt;</span>

        
    </div>
    <a class="headerlink" href="#ioerror_peer_reset"></a>
    
    

                </section>
                <section id="transient_internet">
                            <input id="transient_internet-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@contextlib.contextmanager</div>

        <span class="def">def</span>
        <span class="name">transient_internet</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">resource_name</span>, </span><span class="param"><span class="o">*</span>, </span><span class="param"><span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span>, </span><span class="param"><span class="n">errnos</span><span class="o">=</span><span class="p">()</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="transient_internet-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#transient_internet"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="transient_internet-1543"><a href="#transient_internet-1543"><span class="linenos">1543</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="transient_internet-1544"><a href="#transient_internet-1544"><span class="linenos">1544</span></a><span class="k">def</span> <span class="nf">transient_internet</span><span class="p">(</span><span class="n">resource_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">errnos</span><span class="o">=</span><span class="p">()):</span>
</span><span id="transient_internet-1545"><a href="#transient_internet-1545"><span class="linenos">1545</span></a>    <span class="sd">&quot;&quot;&quot;Return a context manager that raises ResourceDenied when various issues</span>
</span><span id="transient_internet-1546"><a href="#transient_internet-1546"><span class="linenos">1546</span></a><span class="sd">    with the Internet connection manifest themselves as exceptions.&quot;&quot;&quot;</span>
</span><span id="transient_internet-1547"><a href="#transient_internet-1547"><span class="linenos">1547</span></a>    <span class="n">default_errnos</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="transient_internet-1548"><a href="#transient_internet-1548"><span class="linenos">1548</span></a>        <span class="p">(</span><span class="s1">&#39;ECONNREFUSED&#39;</span><span class="p">,</span> <span class="mi">111</span><span class="p">),</span>
</span><span id="transient_internet-1549"><a href="#transient_internet-1549"><span class="linenos">1549</span></a>        <span class="p">(</span><span class="s1">&#39;ECONNRESET&#39;</span><span class="p">,</span> <span class="mi">104</span><span class="p">),</span>
</span><span id="transient_internet-1550"><a href="#transient_internet-1550"><span class="linenos">1550</span></a>        <span class="p">(</span><span class="s1">&#39;EHOSTUNREACH&#39;</span><span class="p">,</span> <span class="mi">113</span><span class="p">),</span>
</span><span id="transient_internet-1551"><a href="#transient_internet-1551"><span class="linenos">1551</span></a>        <span class="p">(</span><span class="s1">&#39;ENETUNREACH&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">),</span>
</span><span id="transient_internet-1552"><a href="#transient_internet-1552"><span class="linenos">1552</span></a>        <span class="p">(</span><span class="s1">&#39;ETIMEDOUT&#39;</span><span class="p">,</span> <span class="mi">110</span><span class="p">),</span>
</span><span id="transient_internet-1553"><a href="#transient_internet-1553"><span class="linenos">1553</span></a>        <span class="c1"># socket.create_connection() fails randomly with</span>
</span><span id="transient_internet-1554"><a href="#transient_internet-1554"><span class="linenos">1554</span></a>        <span class="c1"># EADDRNOTAVAIL on Travis CI.</span>
</span><span id="transient_internet-1555"><a href="#transient_internet-1555"><span class="linenos">1555</span></a>        <span class="p">(</span><span class="s1">&#39;EADDRNOTAVAIL&#39;</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span>
</span><span id="transient_internet-1556"><a href="#transient_internet-1556"><span class="linenos">1556</span></a>    <span class="p">]</span>
</span><span id="transient_internet-1557"><a href="#transient_internet-1557"><span class="linenos">1557</span></a>    <span class="n">default_gai_errnos</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="transient_internet-1558"><a href="#transient_internet-1558"><span class="linenos">1558</span></a>        <span class="p">(</span><span class="s1">&#39;EAI_AGAIN&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">),</span>
</span><span id="transient_internet-1559"><a href="#transient_internet-1559"><span class="linenos">1559</span></a>        <span class="p">(</span><span class="s1">&#39;EAI_FAIL&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">),</span>
</span><span id="transient_internet-1560"><a href="#transient_internet-1560"><span class="linenos">1560</span></a>        <span class="p">(</span><span class="s1">&#39;EAI_NONAME&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span>
</span><span id="transient_internet-1561"><a href="#transient_internet-1561"><span class="linenos">1561</span></a>        <span class="p">(</span><span class="s1">&#39;EAI_NODATA&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">5</span><span class="p">),</span>
</span><span id="transient_internet-1562"><a href="#transient_internet-1562"><span class="linenos">1562</span></a>        <span class="c1"># Encountered when trying to resolve IPv6-only hostnames</span>
</span><span id="transient_internet-1563"><a href="#transient_internet-1563"><span class="linenos">1563</span></a>        <span class="p">(</span><span class="s1">&#39;WSANO_DATA&#39;</span><span class="p">,</span> <span class="mi">11004</span><span class="p">),</span>
</span><span id="transient_internet-1564"><a href="#transient_internet-1564"><span class="linenos">1564</span></a>    <span class="p">]</span>
</span><span id="transient_internet-1565"><a href="#transient_internet-1565"><span class="linenos">1565</span></a>
</span><span id="transient_internet-1566"><a href="#transient_internet-1566"><span class="linenos">1566</span></a>    <span class="n">denied</span> <span class="o">=</span> <span class="n">ResourceDenied</span><span class="p">(</span><span class="s2">&quot;Resource </span><span class="si">%r</span><span class="s2"> is not available&quot;</span> <span class="o">%</span> <span class="n">resource_name</span><span class="p">)</span>
</span><span id="transient_internet-1567"><a href="#transient_internet-1567"><span class="linenos">1567</span></a>    <span class="n">captured_errnos</span> <span class="o">=</span> <span class="n">errnos</span>
</span><span id="transient_internet-1568"><a href="#transient_internet-1568"><span class="linenos">1568</span></a>    <span class="n">gai_errnos</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="transient_internet-1569"><a href="#transient_internet-1569"><span class="linenos">1569</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">captured_errnos</span><span class="p">:</span>
</span><span id="transient_internet-1570"><a href="#transient_internet-1570"><span class="linenos">1570</span></a>        <span class="n">captured_errnos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span><span id="transient_internet-1571"><a href="#transient_internet-1571"><span class="linenos">1571</span></a>                           <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="ow">in</span> <span class="n">default_errnos</span><span class="p">]</span>
</span><span id="transient_internet-1572"><a href="#transient_internet-1572"><span class="linenos">1572</span></a>        <span class="n">gai_errnos</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</span><span id="transient_internet-1573"><a href="#transient_internet-1573"><span class="linenos">1573</span></a>                      <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="ow">in</span> <span class="n">default_gai_errnos</span><span class="p">]</span>
</span><span id="transient_internet-1574"><a href="#transient_internet-1574"><span class="linenos">1574</span></a>
</span><span id="transient_internet-1575"><a href="#transient_internet-1575"><span class="linenos">1575</span></a>    <span class="k">def</span> <span class="nf">filter_error</span><span class="p">(</span><span class="n">err</span><span class="p">):</span>
</span><span id="transient_internet-1576"><a href="#transient_internet-1576"><span class="linenos">1576</span></a>        <span class="n">n</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s1">&#39;errno&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="transient_internet-1577"><a href="#transient_internet-1577"><span class="linenos">1577</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="transient_internet-1578"><a href="#transient_internet-1578"><span class="linenos">1578</span></a>            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gaierror</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">gai_errnos</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="transient_internet-1579"><a href="#transient_internet-1579"><span class="linenos">1579</span></a>            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">)</span> <span class="ow">and</span>
</span><span id="transient_internet-1580"><a href="#transient_internet-1580"><span class="linenos">1580</span></a>             <span class="mi">500</span> <span class="o">&lt;=</span> <span class="n">err</span><span class="o">.</span><span class="n">code</span> <span class="o">&lt;=</span> <span class="mi">599</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="transient_internet-1581"><a href="#transient_internet-1581"><span class="linenos">1581</span></a>            <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">urllib</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">URLError</span><span class="p">)</span> <span class="ow">and</span>
</span><span id="transient_internet-1582"><a href="#transient_internet-1582"><span class="linenos">1582</span></a>                 <span class="p">((</span><span class="s2">&quot;ConnectionRefusedError&quot;</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="transient_internet-1583"><a href="#transient_internet-1583"><span class="linenos">1583</span></a>                  <span class="p">(</span><span class="s2">&quot;TimeoutError&quot;</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span> <span class="ow">or</span>
</span><span id="transient_internet-1584"><a href="#transient_internet-1584"><span class="linenos">1584</span></a>                  <span class="p">(</span><span class="s2">&quot;EOFError&quot;</span> <span class="ow">in</span> <span class="n">err</span><span class="o">.</span><span class="n">reason</span><span class="p">)))</span> <span class="ow">or</span>
</span><span id="transient_internet-1585"><a href="#transient_internet-1585"><span class="linenos">1585</span></a>            <span class="n">n</span> <span class="ow">in</span> <span class="n">captured_errnos</span><span class="p">):</span>
</span><span id="transient_internet-1586"><a href="#transient_internet-1586"><span class="linenos">1586</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="transient_internet-1587"><a href="#transient_internet-1587"><span class="linenos">1587</span></a>                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">denied</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="transient_internet-1588"><a href="#transient_internet-1588"><span class="linenos">1588</span></a>            <span class="k">raise</span> <span class="n">denied</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="transient_internet-1589"><a href="#transient_internet-1589"><span class="linenos">1589</span></a>
</span><span id="transient_internet-1590"><a href="#transient_internet-1590"><span class="linenos">1590</span></a>    <span class="n">old_timeout</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getdefaulttimeout</span><span class="p">()</span>
</span><span id="transient_internet-1591"><a href="#transient_internet-1591"><span class="linenos">1591</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="transient_internet-1592"><a href="#transient_internet-1592"><span class="linenos">1592</span></a>        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="transient_internet-1593"><a href="#transient_internet-1593"><span class="linenos">1593</span></a>            <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
</span><span id="transient_internet-1594"><a href="#transient_internet-1594"><span class="linenos">1594</span></a>        <span class="k">yield</span>
</span><span id="transient_internet-1595"><a href="#transient_internet-1595"><span class="linenos">1595</span></a>    <span class="k">except</span> <span class="n">nntplib</span><span class="o">.</span><span class="n">NNTPTemporaryError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="transient_internet-1596"><a href="#transient_internet-1596"><span class="linenos">1596</span></a>        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="transient_internet-1597"><a href="#transient_internet-1597"><span class="linenos">1597</span></a>            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">denied</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="transient_internet-1598"><a href="#transient_internet-1598"><span class="linenos">1598</span></a>        <span class="k">raise</span> <span class="n">denied</span> <span class="kn">from</span> <span class="nn">err</span>
</span><span id="transient_internet-1599"><a href="#transient_internet-1599"><span class="linenos">1599</span></a>    <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
</span><span id="transient_internet-1600"><a href="#transient_internet-1600"><span class="linenos">1600</span></a>        <span class="c1"># urllib can wrap original socket errors multiple times (!), we must</span>
</span><span id="transient_internet-1601"><a href="#transient_internet-1601"><span class="linenos">1601</span></a>        <span class="c1"># unwrap to get at the original error.</span>
</span><span id="transient_internet-1602"><a href="#transient_internet-1602"><span class="linenos">1602</span></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="transient_internet-1603"><a href="#transient_internet-1603"><span class="linenos">1603</span></a>            <span class="n">a</span> <span class="o">=</span> <span class="n">err</span><span class="o">.</span><span class="n">args</span>
</span><span id="transient_internet-1604"><a href="#transient_internet-1604"><span class="linenos">1604</span></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="ne">OSError</span><span class="p">):</span>
</span><span id="transient_internet-1605"><a href="#transient_internet-1605"><span class="linenos">1605</span></a>                <span class="n">err</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="transient_internet-1606"><a href="#transient_internet-1606"><span class="linenos">1606</span></a>            <span class="c1"># The error can also be wrapped as args[1]:</span>
</span><span id="transient_internet-1607"><a href="#transient_internet-1607"><span class="linenos">1607</span></a>            <span class="c1">#    except socket.error as msg:</span>
</span><span id="transient_internet-1608"><a href="#transient_internet-1608"><span class="linenos">1608</span></a>            <span class="c1">#        raise OSError(&#39;socket error&#39;, msg).with_traceback(sys.exc_info()[2])</span>
</span><span id="transient_internet-1609"><a href="#transient_internet-1609"><span class="linenos">1609</span></a>            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="ne">OSError</span><span class="p">):</span>
</span><span id="transient_internet-1610"><a href="#transient_internet-1610"><span class="linenos">1610</span></a>                <span class="n">err</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="transient_internet-1611"><a href="#transient_internet-1611"><span class="linenos">1611</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="transient_internet-1612"><a href="#transient_internet-1612"><span class="linenos">1612</span></a>                <span class="k">break</span>
</span><span id="transient_internet-1613"><a href="#transient_internet-1613"><span class="linenos">1613</span></a>        <span class="n">filter_error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
</span><span id="transient_internet-1614"><a href="#transient_internet-1614"><span class="linenos">1614</span></a>        <span class="k">raise</span>
</span><span id="transient_internet-1615"><a href="#transient_internet-1615"><span class="linenos">1615</span></a>    <span class="c1"># XXX should we catch generic exceptions and look for their</span>
</span><span id="transient_internet-1616"><a href="#transient_internet-1616"><span class="linenos">1616</span></a>    <span class="c1"># __cause__ or __context__?</span>
</span><span id="transient_internet-1617"><a href="#transient_internet-1617"><span class="linenos">1617</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="transient_internet-1618"><a href="#transient_internet-1618"><span class="linenos">1618</span></a>        <span class="n">socket</span><span class="o">.</span><span class="n">setdefaulttimeout</span><span class="p">(</span><span class="n">old_timeout</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Return a context manager that raises ResourceDenied when various issues
with the Internet connection manifest themselves as exceptions.</p>
</div>


                </section>
                <section id="BasicTestRunner">
                            <input id="BasicTestRunner-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BasicTestRunner</span>:

                <label class="view-source-button" for="BasicTestRunner-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BasicTestRunner"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BasicTestRunner-1929"><a href="#BasicTestRunner-1929"><span class="linenos">1929</span></a><span class="k">class</span> <span class="nc">BasicTestRunner</span><span class="p">:</span>
</span><span id="BasicTestRunner-1930"><a href="#BasicTestRunner-1930"><span class="linenos">1930</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
</span><span id="BasicTestRunner-1931"><a href="#BasicTestRunner-1931"><span class="linenos">1931</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestResult</span><span class="p">()</span>
</span><span id="BasicTestRunner-1932"><a href="#BasicTestRunner-1932"><span class="linenos">1932</span></a>        <span class="n">test</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="BasicTestRunner-1933"><a href="#BasicTestRunner-1933"><span class="linenos">1933</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


    

                            <div id="BasicTestRunner.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">BasicTestRunner</span><span class="signature pdoc-code condensed">()</span>

        
    </div>
    <a class="headerlink" href="#BasicTestRunner.__init__"></a>
    
    

                            </div>
                            <div id="BasicTestRunner.run" class="classattr">
                                        <input id="BasicTestRunner.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">test</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BasicTestRunner.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BasicTestRunner.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BasicTestRunner.run-1930"><a href="#BasicTestRunner.run-1930"><span class="linenos">1930</span></a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
</span><span id="BasicTestRunner.run-1931"><a href="#BasicTestRunner.run-1931"><span class="linenos">1931</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestResult</span><span class="p">()</span>
</span><span id="BasicTestRunner.run-1932"><a href="#BasicTestRunner.run-1932"><span class="linenos">1932</span></a>        <span class="n">test</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="BasicTestRunner.run-1933"><a href="#BasicTestRunner.run-1933"><span class="linenos">1933</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


    

                            </div>
                </section>
                <section id="run_unittest">
                            <input id="run_unittest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_unittest</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">classes</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="run_unittest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#run_unittest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="run_unittest-2138"><a href="#run_unittest-2138"><span class="linenos">2138</span></a><span class="k">def</span> <span class="nf">run_unittest</span><span class="p">(</span><span class="o">*</span><span class="n">classes</span><span class="p">):</span>
</span><span id="run_unittest-2139"><a href="#run_unittest-2139"><span class="linenos">2139</span></a>    <span class="sd">&quot;&quot;&quot;Run tests from unittest.TestCase-derived classes.&quot;&quot;&quot;</span>
</span><span id="run_unittest-2140"><a href="#run_unittest-2140"><span class="linenos">2140</span></a>    <span class="n">valid_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">)</span>
</span><span id="run_unittest-2141"><a href="#run_unittest-2141"><span class="linenos">2141</span></a>    <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">()</span>
</span><span id="run_unittest-2142"><a href="#run_unittest-2142"><span class="linenos">2142</span></a>    <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
</span><span id="run_unittest-2143"><a href="#run_unittest-2143"><span class="linenos">2143</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="run_unittest-2144"><a href="#run_unittest-2144"><span class="linenos">2144</span></a>            <span class="k">if</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
</span><span id="run_unittest-2145"><a href="#run_unittest-2145"><span class="linenos">2145</span></a>                <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">findTestCases</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="bp">cls</span><span class="p">]))</span>
</span><span id="run_unittest-2146"><a href="#run_unittest-2146"><span class="linenos">2146</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="run_unittest-2147"><a href="#run_unittest-2147"><span class="linenos">2147</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;str arguments must be keys in sys.modules&quot;</span><span class="p">)</span>
</span><span id="run_unittest-2148"><a href="#run_unittest-2148"><span class="linenos">2148</span></a>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">valid_types</span><span class="p">):</span>
</span><span id="run_unittest-2149"><a href="#run_unittest-2149"><span class="linenos">2149</span></a>            <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="run_unittest-2150"><a href="#run_unittest-2150"><span class="linenos">2150</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="run_unittest-2151"><a href="#run_unittest-2151"><span class="linenos">2151</span></a>            <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">makeSuite</span><span class="p">(</span><span class="bp">cls</span><span class="p">))</span>
</span><span id="run_unittest-2152"><a href="#run_unittest-2152"><span class="linenos">2152</span></a>    <span class="n">_filter_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="n">match_test</span><span class="p">)</span>
</span><span id="run_unittest-2153"><a href="#run_unittest-2153"><span class="linenos">2153</span></a>    <span class="n">_run_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Run tests from unittest.TestCase-derived classes.</p>
</div>


                </section>
                <section id="run_doctest">
                            <input id="run_doctest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_doctest</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">module</span>, </span><span class="param"><span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">optionflags</span><span class="o">=</span><span class="mi">0</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="run_doctest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#run_doctest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="run_doctest-2178"><a href="#run_doctest-2178"><span class="linenos">2178</span></a><span class="k">def</span> <span class="nf">run_doctest</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
</span><span id="run_doctest-2179"><a href="#run_doctest-2179"><span class="linenos">2179</span></a>    <span class="sd">&quot;&quot;&quot;Run doctest on the given module.  Return (#failures, #tests).</span>
</span><span id="run_doctest-2180"><a href="#run_doctest-2180"><span class="linenos">2180</span></a>
</span><span id="run_doctest-2181"><a href="#run_doctest-2181"><span class="linenos">2181</span></a><span class="sd">    If optional argument verbosity is not specified (or is None), pass</span>
</span><span id="run_doctest-2182"><a href="#run_doctest-2182"><span class="linenos">2182</span></a><span class="sd">    support&#39;s belief about verbosity on to doctest.  Else doctest&#39;s</span>
</span><span id="run_doctest-2183"><a href="#run_doctest-2183"><span class="linenos">2183</span></a><span class="sd">    usual behavior is used (it searches sys.argv for -v).</span>
</span><span id="run_doctest-2184"><a href="#run_doctest-2184"><span class="linenos">2184</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="run_doctest-2185"><a href="#run_doctest-2185"><span class="linenos">2185</span></a>
</span><span id="run_doctest-2186"><a href="#run_doctest-2186"><span class="linenos">2186</span></a>    <span class="kn">import</span> <span class="nn">doctest</span>
</span><span id="run_doctest-2187"><a href="#run_doctest-2187"><span class="linenos">2187</span></a>
</span><span id="run_doctest-2188"><a href="#run_doctest-2188"><span class="linenos">2188</span></a>    <span class="k">if</span> <span class="n">verbosity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="run_doctest-2189"><a href="#run_doctest-2189"><span class="linenos">2189</span></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbose</span>
</span><span id="run_doctest-2190"><a href="#run_doctest-2190"><span class="linenos">2190</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="run_doctest-2191"><a href="#run_doctest-2191"><span class="linenos">2191</span></a>        <span class="n">verbosity</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="run_doctest-2192"><a href="#run_doctest-2192"><span class="linenos">2192</span></a>
</span><span id="run_doctest-2193"><a href="#run_doctest-2193"><span class="linenos">2193</span></a>    <span class="n">f</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="n">optionflags</span><span class="p">)</span>
</span><span id="run_doctest-2194"><a href="#run_doctest-2194"><span class="linenos">2194</span></a>    <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
</span><span id="run_doctest-2195"><a href="#run_doctest-2195"><span class="linenos">2195</span></a>        <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> of </span><span class="si">%d</span><span class="s2"> doctests failed&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</span><span id="run_doctest-2196"><a href="#run_doctest-2196"><span class="linenos">2196</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="run_doctest-2197"><a href="#run_doctest-2197"><span class="linenos">2197</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;doctest (</span><span class="si">%s</span><span class="s1">) ... </span><span class="si">%d</span><span class="s1"> tests with zero failures&#39;</span> <span class="o">%</span>
</span><span id="run_doctest-2198"><a href="#run_doctest-2198"><span class="linenos">2198</span></a>              <span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</span><span id="run_doctest-2199"><a href="#run_doctest-2199"><span class="linenos">2199</span></a>    <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">t</span>
</span></pre></div>


            <div class="docstring"><p>Run doctest on the given module.  Return (#failures, #tests).</p>

<p>If optional argument verbosity is not specified (or is None), pass
support's belief about verbosity on to doctest.  Else doctest's
usual behavior is used (it searches sys.argv for -v).</p>
</div>


                </section>
                <section id="skip_unless_symlink">
                            <input id="skip_unless_symlink-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">skip_unless_symlink</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">test</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="skip_unless_symlink-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#skip_unless_symlink"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="skip_unless_symlink-2571"><a href="#skip_unless_symlink-2571"><span class="linenos">2571</span></a><span class="k">def</span> <span class="nf">skip_unless_symlink</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="skip_unless_symlink-2572"><a href="#skip_unless_symlink-2572"><span class="linenos">2572</span></a>    <span class="sd">&quot;&quot;&quot;Skip decorator for tests that require functional symlink&quot;&quot;&quot;</span>
</span><span id="skip_unless_symlink-2573"><a href="#skip_unless_symlink-2573"><span class="linenos">2573</span></a>    <span class="n">ok</span> <span class="o">=</span> <span class="n">can_symlink</span><span class="p">()</span>
</span><span id="skip_unless_symlink-2574"><a href="#skip_unless_symlink-2574"><span class="linenos">2574</span></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Requires functional symlink implementation&quot;</span>
</span><span id="skip_unless_symlink-2575"><a href="#skip_unless_symlink-2575"><span class="linenos">2575</span></a>    <span class="k">return</span> <span class="n">test</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Skip decorator for tests that require functional symlink</p>
</div>


                </section>
                <section id="requires_gzip">
                            <input id="requires_gzip-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requires_gzip</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">obj</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="requires_gzip-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#requires_gzip"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="requires_gzip-86"><a href="#requires_gzip-86"><span class="linenos">86</span></a><span class="k">def</span> <span class="nf">_id</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="requires_gzip-87"><a href="#requires_gzip-87"><span class="linenos">87</span></a>    <span class="k">return</span> <span class="n">obj</span>
</span></pre></div>


    

                </section>
                <section id="requires_bz2">
                            <input id="requires_bz2-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requires_bz2</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">obj</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="requires_bz2-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#requires_bz2"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="requires_bz2-86"><a href="#requires_bz2-86"><span class="linenos">86</span></a><span class="k">def</span> <span class="nf">_id</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="requires_bz2-87"><a href="#requires_bz2-87"><span class="linenos">87</span></a>    <span class="k">return</span> <span class="n">obj</span>
</span></pre></div>


    

                </section>
                <section id="requires_lzma">
                            <input id="requires_lzma-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requires_lzma</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">obj</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="requires_lzma-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#requires_lzma"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="requires_lzma-86"><a href="#requires_lzma-86"><span class="linenos">86</span></a><span class="k">def</span> <span class="nf">_id</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="requires_lzma-87"><a href="#requires_lzma-87"><span class="linenos">87</span></a>    <span class="k">return</span> <span class="n">obj</span>
</span></pre></div>


    

                </section>
                <section id="bigmemtest">
                            <input id="bigmemtest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bigmemtest</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">size</span>, </span><span class="param"><span class="n">memuse</span>, </span><span class="param"><span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="bigmemtest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#bigmemtest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="bigmemtest-1863"><a href="#bigmemtest-1863"><span class="linenos">1863</span></a><span class="k">def</span> <span class="nf">bigmemtest</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">memuse</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="bigmemtest-1864"><a href="#bigmemtest-1864"><span class="linenos">1864</span></a>    <span class="sd">&quot;&quot;&quot;Decorator for bigmem tests.</span>
</span><span id="bigmemtest-1865"><a href="#bigmemtest-1865"><span class="linenos">1865</span></a>
</span><span id="bigmemtest-1866"><a href="#bigmemtest-1866"><span class="linenos">1866</span></a><span class="sd">    &#39;size&#39; is a requested size for the test (in arbitrary, test-interpreted</span>
</span><span id="bigmemtest-1867"><a href="#bigmemtest-1867"><span class="linenos">1867</span></a><span class="sd">    units.) &#39;memuse&#39; is the number of bytes per unit for the test, or a good</span>
</span><span id="bigmemtest-1868"><a href="#bigmemtest-1868"><span class="linenos">1868</span></a><span class="sd">    estimate of it. For example, a test that needs two byte buffers, of 4 GiB</span>
</span><span id="bigmemtest-1869"><a href="#bigmemtest-1869"><span class="linenos">1869</span></a><span class="sd">    each, could be decorated with @bigmemtest(size=_4G, memuse=2).</span>
</span><span id="bigmemtest-1870"><a href="#bigmemtest-1870"><span class="linenos">1870</span></a>
</span><span id="bigmemtest-1871"><a href="#bigmemtest-1871"><span class="linenos">1871</span></a><span class="sd">    The &#39;size&#39; argument is normally passed to the decorated test method as an</span>
</span><span id="bigmemtest-1872"><a href="#bigmemtest-1872"><span class="linenos">1872</span></a><span class="sd">    extra argument. If &#39;dry_run&#39; is true, the value passed to the test method</span>
</span><span id="bigmemtest-1873"><a href="#bigmemtest-1873"><span class="linenos">1873</span></a><span class="sd">    may be less than the requested value. If &#39;dry_run&#39; is false, it means the</span>
</span><span id="bigmemtest-1874"><a href="#bigmemtest-1874"><span class="linenos">1874</span></a><span class="sd">    test doesn&#39;t support dummy runs when -M is not specified.</span>
</span><span id="bigmemtest-1875"><a href="#bigmemtest-1875"><span class="linenos">1875</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="bigmemtest-1876"><a href="#bigmemtest-1876"><span class="linenos">1876</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="bigmemtest-1877"><a href="#bigmemtest-1877"><span class="linenos">1877</span></a>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="bigmemtest-1878"><a href="#bigmemtest-1878"><span class="linenos">1878</span></a>            <span class="n">size</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">size</span>
</span><span id="bigmemtest-1879"><a href="#bigmemtest-1879"><span class="linenos">1879</span></a>            <span class="n">memuse</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">memuse</span>
</span><span id="bigmemtest-1880"><a href="#bigmemtest-1880"><span class="linenos">1880</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">real_max_memuse</span><span class="p">:</span>
</span><span id="bigmemtest-1881"><a href="#bigmemtest-1881"><span class="linenos">1881</span></a>                <span class="n">maxsize</span> <span class="o">=</span> <span class="mi">5147</span>
</span><span id="bigmemtest-1882"><a href="#bigmemtest-1882"><span class="linenos">1882</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="bigmemtest-1883"><a href="#bigmemtest-1883"><span class="linenos">1883</span></a>                <span class="n">maxsize</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="bigmemtest-1884"><a href="#bigmemtest-1884"><span class="linenos">1884</span></a>
</span><span id="bigmemtest-1885"><a href="#bigmemtest-1885"><span class="linenos">1885</span></a>            <span class="k">if</span> <span class="p">((</span><span class="n">real_max_memuse</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">)</span>
</span><span id="bigmemtest-1886"><a href="#bigmemtest-1886"><span class="linenos">1886</span></a>                <span class="ow">and</span> <span class="n">real_max_memuse</span> <span class="o">&lt;</span> <span class="n">maxsize</span> <span class="o">*</span> <span class="n">memuse</span><span class="p">):</span>
</span><span id="bigmemtest-1887"><a href="#bigmemtest-1887"><span class="linenos">1887</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
</span><span id="bigmemtest-1888"><a href="#bigmemtest-1888"><span class="linenos">1888</span></a>                    <span class="s2">&quot;not enough memory: </span><span class="si">%.1f</span><span class="s2">G minimum needed&quot;</span>
</span><span id="bigmemtest-1889"><a href="#bigmemtest-1889"><span class="linenos">1889</span></a>                    <span class="o">%</span> <span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">memuse</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)))</span>
</span><span id="bigmemtest-1890"><a href="#bigmemtest-1890"><span class="linenos">1890</span></a>
</span><span id="bigmemtest-1891"><a href="#bigmemtest-1891"><span class="linenos">1891</span></a>            <span class="k">if</span> <span class="n">real_max_memuse</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="bigmemtest-1892"><a href="#bigmemtest-1892"><span class="linenos">1892</span></a>                <span class="nb">print</span><span class="p">()</span>
</span><span id="bigmemtest-1893"><a href="#bigmemtest-1893"><span class="linenos">1893</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; ... expected peak memory use: </span><span class="si">{peak:.1f}</span><span class="s2">G&quot;</span>
</span><span id="bigmemtest-1894"><a href="#bigmemtest-1894"><span class="linenos">1894</span></a>                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">peak</span><span class="o">=</span><span class="n">size</span> <span class="o">*</span> <span class="n">memuse</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)))</span>
</span><span id="bigmemtest-1895"><a href="#bigmemtest-1895"><span class="linenos">1895</span></a>                <span class="n">watchdog</span> <span class="o">=</span> <span class="n">_MemoryWatchdog</span><span class="p">()</span>
</span><span id="bigmemtest-1896"><a href="#bigmemtest-1896"><span class="linenos">1896</span></a>                <span class="n">watchdog</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="bigmemtest-1897"><a href="#bigmemtest-1897"><span class="linenos">1897</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="bigmemtest-1898"><a href="#bigmemtest-1898"><span class="linenos">1898</span></a>                <span class="n">watchdog</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="bigmemtest-1899"><a href="#bigmemtest-1899"><span class="linenos">1899</span></a>
</span><span id="bigmemtest-1900"><a href="#bigmemtest-1900"><span class="linenos">1900</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="bigmemtest-1901"><a href="#bigmemtest-1901"><span class="linenos">1901</span></a>                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">)</span>
</span><span id="bigmemtest-1902"><a href="#bigmemtest-1902"><span class="linenos">1902</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="bigmemtest-1903"><a href="#bigmemtest-1903"><span class="linenos">1903</span></a>                <span class="k">if</span> <span class="n">watchdog</span><span class="p">:</span>
</span><span id="bigmemtest-1904"><a href="#bigmemtest-1904"><span class="linenos">1904</span></a>                    <span class="n">watchdog</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="bigmemtest-1905"><a href="#bigmemtest-1905"><span class="linenos">1905</span></a>
</span><span id="bigmemtest-1906"><a href="#bigmemtest-1906"><span class="linenos">1906</span></a>        <span class="n">wrapper</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
</span><span id="bigmemtest-1907"><a href="#bigmemtest-1907"><span class="linenos">1907</span></a>        <span class="n">wrapper</span><span class="o">.</span><span class="n">memuse</span> <span class="o">=</span> <span class="n">memuse</span>
</span><span id="bigmemtest-1908"><a href="#bigmemtest-1908"><span class="linenos">1908</span></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="bigmemtest-1909"><a href="#bigmemtest-1909"><span class="linenos">1909</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span></pre></div>


            <div class="docstring"><p>Decorator for bigmem tests.</p>

<p>'size' is a requested size for the test (in arbitrary, test-interpreted
units.) 'memuse' is the number of bytes per unit for the test, or a good
estimate of it. For example, a test that needs two byte buffers, of 4 GiB
each, could be decorated with @bigmemtest(size=_4G, memuse=2).</p>

<p>The 'size' argument is normally passed to the decorated test method as an
extra argument. If 'dry_run' is true, the value passed to the test method
may be less than the requested value. If 'dry_run' is false, it means the
test doesn't support dummy runs when -M is not specified.</p>
</div>


                </section>
                <section id="bigaddrspacetest">
                            <input id="bigaddrspacetest-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bigaddrspacetest</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">f</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="bigaddrspacetest-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#bigaddrspacetest"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="bigaddrspacetest-1911"><a href="#bigaddrspacetest-1911"><span class="linenos">1911</span></a><span class="k">def</span> <span class="nf">bigaddrspacetest</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="bigaddrspacetest-1912"><a href="#bigaddrspacetest-1912"><span class="linenos">1912</span></a>    <span class="sd">&quot;&quot;&quot;Decorator for tests that fill the address space.&quot;&quot;&quot;</span>
</span><span id="bigaddrspacetest-1913"><a href="#bigaddrspacetest-1913"><span class="linenos">1913</span></a>    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="bigaddrspacetest-1914"><a href="#bigaddrspacetest-1914"><span class="linenos">1914</span></a>        <span class="k">if</span> <span class="n">max_memuse</span> <span class="o">&lt;</span> <span class="n">MAX_Py_ssize_t</span><span class="p">:</span>
</span><span id="bigaddrspacetest-1915"><a href="#bigaddrspacetest-1915"><span class="linenos">1915</span></a>            <span class="k">if</span> <span class="n">MAX_Py_ssize_t</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">63</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">max_memuse</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">31</span><span class="p">:</span>
</span><span id="bigaddrspacetest-1916"><a href="#bigaddrspacetest-1916"><span class="linenos">1916</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
</span><span id="bigaddrspacetest-1917"><a href="#bigaddrspacetest-1917"><span class="linenos">1917</span></a>                    <span class="s2">&quot;not enough memory: try a 32-bit build instead&quot;</span><span class="p">)</span>
</span><span id="bigaddrspacetest-1918"><a href="#bigaddrspacetest-1918"><span class="linenos">1918</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="bigaddrspacetest-1919"><a href="#bigaddrspacetest-1919"><span class="linenos">1919</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span>
</span><span id="bigaddrspacetest-1920"><a href="#bigaddrspacetest-1920"><span class="linenos">1920</span></a>                    <span class="s2">&quot;not enough memory: </span><span class="si">%.1f</span><span class="s2">G minimum needed&quot;</span>
</span><span id="bigaddrspacetest-1921"><a href="#bigaddrspacetest-1921"><span class="linenos">1921</span></a>                    <span class="o">%</span> <span class="p">(</span><span class="n">MAX_Py_ssize_t</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)))</span>
</span><span id="bigaddrspacetest-1922"><a href="#bigaddrspacetest-1922"><span class="linenos">1922</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="bigaddrspacetest-1923"><a href="#bigaddrspacetest-1923"><span class="linenos">1923</span></a>            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="bigaddrspacetest-1924"><a href="#bigaddrspacetest-1924"><span class="linenos">1924</span></a>    <span class="k">return</span> <span class="n">wrapper</span>
</span></pre></div>


            <div class="docstring"><p>Decorator for tests that fill the address space.</p>
</div>


                </section>
                <section id="cpython_only">
                            <input id="cpython_only-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cpython_only</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">test</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="cpython_only-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#cpython_only"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="cpython_only-1946"><a href="#cpython_only-1946"><span class="linenos">1946</span></a><span class="k">def</span> <span class="nf">cpython_only</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="cpython_only-1947"><a href="#cpython_only-1947"><span class="linenos">1947</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="cpython_only-1948"><a href="#cpython_only-1948"><span class="linenos">1948</span></a><span class="sd">    Decorator for tests only applicable on CPython.</span>
</span><span id="cpython_only-1949"><a href="#cpython_only-1949"><span class="linenos">1949</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="cpython_only-1950"><a href="#cpython_only-1950"><span class="linenos">1950</span></a>    <span class="k">return</span> <span class="n">impl_detail</span><span class="p">(</span><span class="n">cpython</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Decorator for tests only applicable on CPython.</p>
</div>


                </section>
                <section id="get_attribute">
                            <input id="get_attribute-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_attribute</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">obj</span>, </span><span class="param"><span class="n">name</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_attribute-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_attribute"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_attribute-301"><a href="#get_attribute-301"><span class="linenos">301</span></a><span class="k">def</span> <span class="nf">get_attribute</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span id="get_attribute-302"><a href="#get_attribute-302"><span class="linenos">302</span></a>    <span class="sd">&quot;&quot;&quot;Get an attribute, raising SkipTest if AttributeError is raised.&quot;&quot;&quot;</span>
</span><span id="get_attribute-303"><a href="#get_attribute-303"><span class="linenos">303</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="get_attribute-304"><a href="#get_attribute-304"><span class="linenos">304</span></a>        <span class="n">attribute</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="get_attribute-305"><a href="#get_attribute-305"><span class="linenos">305</span></a>    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="get_attribute-306"><a href="#get_attribute-306"><span class="linenos">306</span></a>        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;object </span><span class="si">%r</span><span class="s2"> has no attribute </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
</span><span id="get_attribute-307"><a href="#get_attribute-307"><span class="linenos">307</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="get_attribute-308"><a href="#get_attribute-308"><span class="linenos">308</span></a>        <span class="k">return</span> <span class="n">attribute</span>
</span></pre></div>


            <div class="docstring"><p>Get an attribute, raising SkipTest if AttributeError is raised.</p>
</div>


                </section>
                <section id="requires_IEEE_754">
                            <input id="requires_IEEE_754-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requires_IEEE_754</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">obj</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="requires_IEEE_754-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#requires_IEEE_754"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="requires_IEEE_754-86"><a href="#requires_IEEE_754-86"><span class="linenos">86</span></a><span class="k">def</span> <span class="nf">_id</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="requires_IEEE_754-87"><a href="#requires_IEEE_754-87"><span class="linenos">87</span></a>    <span class="k">return</span> <span class="n">obj</span>
</span></pre></div>


    

                </section>
                <section id="skip_unless_xattr">
                            <input id="skip_unless_xattr-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">skip_unless_xattr</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">test</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="skip_unless_xattr-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#skip_unless_xattr"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="skip_unless_xattr-2707"><a href="#skip_unless_xattr-2707"><span class="linenos">2707</span></a><span class="k">def</span> <span class="nf">skip_unless_xattr</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="skip_unless_xattr-2708"><a href="#skip_unless_xattr-2708"><span class="linenos">2708</span></a>    <span class="sd">&quot;&quot;&quot;Skip decorator for tests that require functional extended attributes&quot;&quot;&quot;</span>
</span><span id="skip_unless_xattr-2709"><a href="#skip_unless_xattr-2709"><span class="linenos">2709</span></a>    <span class="n">ok</span> <span class="o">=</span> <span class="n">can_xattr</span><span class="p">()</span>
</span><span id="skip_unless_xattr-2710"><a href="#skip_unless_xattr-2710"><span class="linenos">2710</span></a>    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;no non-broken extended attribute support&quot;</span>
</span><span id="skip_unless_xattr-2711"><a href="#skip_unless_xattr-2711"><span class="linenos">2711</span></a>    <span class="k">return</span> <span class="n">test</span> <span class="k">if</span> <span class="n">ok</span> <span class="k">else</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Skip decorator for tests that require functional extended attributes</p>
</div>


                </section>
                <section id="requires_zlib">
                            <input id="requires_zlib-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">requires_zlib</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">obj</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="requires_zlib-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#requires_zlib"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="requires_zlib-86"><a href="#requires_zlib-86"><span class="linenos">86</span></a><span class="k">def</span> <span class="nf">_id</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="requires_zlib-87"><a href="#requires_zlib-87"><span class="linenos">87</span></a>    <span class="k">return</span> <span class="n">obj</span>
</span></pre></div>


    

                </section>
                <section id="anticipate_failure">
                            <input id="anticipate_failure-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">anticipate_failure</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">condition</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="anticipate_failure-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#anticipate_failure"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="anticipate_failure-221"><a href="#anticipate_failure-221"><span class="linenos">221</span></a><span class="k">def</span> <span class="nf">anticipate_failure</span><span class="p">(</span><span class="n">condition</span><span class="p">):</span>
</span><span id="anticipate_failure-222"><a href="#anticipate_failure-222"><span class="linenos">222</span></a>    <span class="sd">&quot;&quot;&quot;Decorator to mark a test that is known to be broken in some cases</span>
</span><span id="anticipate_failure-223"><a href="#anticipate_failure-223"><span class="linenos">223</span></a>
</span><span id="anticipate_failure-224"><a href="#anticipate_failure-224"><span class="linenos">224</span></a><span class="sd">       Any use of this decorator should have a comment identifying the</span>
</span><span id="anticipate_failure-225"><a href="#anticipate_failure-225"><span class="linenos">225</span></a><span class="sd">       associated tracker issue.</span>
</span><span id="anticipate_failure-226"><a href="#anticipate_failure-226"><span class="linenos">226</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="anticipate_failure-227"><a href="#anticipate_failure-227"><span class="linenos">227</span></a>    <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
</span><span id="anticipate_failure-228"><a href="#anticipate_failure-228"><span class="linenos">228</span></a>        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">expectedFailure</span>
</span><span id="anticipate_failure-229"><a href="#anticipate_failure-229"><span class="linenos">229</span></a>    <span class="k">return</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span>
</span></pre></div>


            <div class="docstring"><p>Decorator to mark a test that is known to be broken in some cases</p>

<p>Any use of this decorator should have a comment identifying the
associated tracker issue.</p>
</div>


                </section>
                <section id="load_package_tests">
                            <input id="load_package_tests-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load_package_tests</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">pkg_dir</span>, </span><span class="param"><span class="n">loader</span>, </span><span class="param"><span class="n">standard_tests</span>, </span><span class="param"><span class="n">pattern</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="load_package_tests-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#load_package_tests"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="load_package_tests-231"><a href="#load_package_tests-231"><span class="linenos">231</span></a><span class="k">def</span> <span class="nf">load_package_tests</span><span class="p">(</span><span class="n">pkg_dir</span><span class="p">,</span> <span class="n">loader</span><span class="p">,</span> <span class="n">standard_tests</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
</span><span id="load_package_tests-232"><a href="#load_package_tests-232"><span class="linenos">232</span></a>    <span class="sd">&quot;&quot;&quot;Generic load_tests implementation for simple test packages.</span>
</span><span id="load_package_tests-233"><a href="#load_package_tests-233"><span class="linenos">233</span></a>
</span><span id="load_package_tests-234"><a href="#load_package_tests-234"><span class="linenos">234</span></a><span class="sd">    Most packages can implement load_tests using this function as follows:</span>
</span><span id="load_package_tests-235"><a href="#load_package_tests-235"><span class="linenos">235</span></a>
</span><span id="load_package_tests-236"><a href="#load_package_tests-236"><span class="linenos">236</span></a><span class="sd">       def load_tests(*args):</span>
</span><span id="load_package_tests-237"><a href="#load_package_tests-237"><span class="linenos">237</span></a><span class="sd">           return load_package_tests(os.path.dirname(__file__), *args)</span>
</span><span id="load_package_tests-238"><a href="#load_package_tests-238"><span class="linenos">238</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="load_package_tests-239"><a href="#load_package_tests-239"><span class="linenos">239</span></a>    <span class="k">if</span> <span class="n">pattern</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="load_package_tests-240"><a href="#load_package_tests-240"><span class="linenos">240</span></a>        <span class="n">pattern</span> <span class="o">=</span> <span class="s2">&quot;test*&quot;</span>
</span><span id="load_package_tests-241"><a href="#load_package_tests-241"><span class="linenos">241</span></a>    <span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>              <span class="c1"># Lib</span>
</span><span id="load_package_tests-242"><a href="#load_package_tests-242"><span class="linenos">242</span></a>                  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span>              <span class="c1"># test</span>
</span><span id="load_package_tests-243"><a href="#load_package_tests-243"><span class="linenos">243</span></a>                      <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)))</span>   <span class="c1"># support</span>
</span><span id="load_package_tests-244"><a href="#load_package_tests-244"><span class="linenos">244</span></a>    <span class="n">package_tests</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">discover</span><span class="p">(</span><span class="n">start_dir</span><span class="o">=</span><span class="n">pkg_dir</span><span class="p">,</span>
</span><span id="load_package_tests-245"><a href="#load_package_tests-245"><span class="linenos">245</span></a>                                    <span class="n">top_level_dir</span><span class="o">=</span><span class="n">top_dir</span><span class="p">,</span>
</span><span id="load_package_tests-246"><a href="#load_package_tests-246"><span class="linenos">246</span></a>                                    <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">)</span>
</span><span id="load_package_tests-247"><a href="#load_package_tests-247"><span class="linenos">247</span></a>    <span class="n">standard_tests</span><span class="o">.</span><span class="n">addTests</span><span class="p">(</span><span class="n">package_tests</span><span class="p">)</span>
</span><span id="load_package_tests-248"><a href="#load_package_tests-248"><span class="linenos">248</span></a>    <span class="k">return</span> <span class="n">standard_tests</span>
</span></pre></div>


            <div class="docstring"><p>Generic load_tests implementation for simple test packages.</p>

<p>Most packages can implement load_tests using this function as follows:</p>

<p>def load_tests(*args):
       return load_package_tests(os.path.dirname(__file__), *args)</p>
</div>


                </section>
                <section id="detect_api_mismatch">
                            <input id="detect_api_mismatch-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">detect_api_mismatch</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">ref_api</span>, </span><span class="param"><span class="n">other_api</span>, </span><span class="param"><span class="o">*</span>, </span><span class="param"><span class="n">ignore</span><span class="o">=</span><span class="p">()</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="detect_api_mismatch-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#detect_api_mismatch"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="detect_api_mismatch-2755"><a href="#detect_api_mismatch-2755"><span class="linenos">2755</span></a><span class="k">def</span> <span class="nf">detect_api_mismatch</span><span class="p">(</span><span class="n">ref_api</span><span class="p">,</span> <span class="n">other_api</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="p">()):</span>
</span><span id="detect_api_mismatch-2756"><a href="#detect_api_mismatch-2756"><span class="linenos">2756</span></a>    <span class="sd">&quot;&quot;&quot;Returns the set of items in ref_api not in other_api, except for a</span>
</span><span id="detect_api_mismatch-2757"><a href="#detect_api_mismatch-2757"><span class="linenos">2757</span></a><span class="sd">    defined list of items to be ignored in this check.</span>
</span><span id="detect_api_mismatch-2758"><a href="#detect_api_mismatch-2758"><span class="linenos">2758</span></a>
</span><span id="detect_api_mismatch-2759"><a href="#detect_api_mismatch-2759"><span class="linenos">2759</span></a><span class="sd">    By default this skips private attributes beginning with &#39;_&#39; but</span>
</span><span id="detect_api_mismatch-2760"><a href="#detect_api_mismatch-2760"><span class="linenos">2760</span></a><span class="sd">    includes all magic methods, i.e. those starting and ending in &#39;__&#39;.</span>
</span><span id="detect_api_mismatch-2761"><a href="#detect_api_mismatch-2761"><span class="linenos">2761</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="detect_api_mismatch-2762"><a href="#detect_api_mismatch-2762"><span class="linenos">2762</span></a>    <span class="n">missing_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">ref_api</span><span class="p">))</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">other_api</span><span class="p">))</span>
</span><span id="detect_api_mismatch-2763"><a href="#detect_api_mismatch-2763"><span class="linenos">2763</span></a>    <span class="k">if</span> <span class="n">ignore</span><span class="p">:</span>
</span><span id="detect_api_mismatch-2764"><a href="#detect_api_mismatch-2764"><span class="linenos">2764</span></a>        <span class="n">missing_items</span> <span class="o">-=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ignore</span><span class="p">)</span>
</span><span id="detect_api_mismatch-2765"><a href="#detect_api_mismatch-2765"><span class="linenos">2765</span></a>    <span class="n">missing_items</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">missing_items</span>
</span><span id="detect_api_mismatch-2766"><a href="#detect_api_mismatch-2766"><span class="linenos">2766</span></a>                        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">m</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">))</span>
</span><span id="detect_api_mismatch-2767"><a href="#detect_api_mismatch-2767"><span class="linenos">2767</span></a>    <span class="k">return</span> <span class="n">missing_items</span>
</span></pre></div>


            <div class="docstring"><p>Returns the set of items in ref_api not in other_api, except for a
defined list of items to be ignored in this check.</p>

<p>By default this skips private attributes beginning with '_' but
includes all magic methods, i.e. those starting and ending in '__'.</p>
</div>


                </section>
                <section id="check__all__">
                            <input id="check__all__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check__all__</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">test_case</span>, </span><span class="param"><span class="n">module</span>, </span><span class="param"><span class="n">name_of_module</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">extra</span><span class="o">=</span><span class="p">()</span>, </span><span class="param"><span class="n">blacklist</span><span class="o">=</span><span class="p">()</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check__all__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check__all__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check__all__-2770"><a href="#check__all__-2770"><span class="linenos">2770</span></a><span class="k">def</span> <span class="nf">check__all__</span><span class="p">(</span><span class="n">test_case</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">name_of_module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">(),</span>
</span><span id="check__all__-2771"><a href="#check__all__-2771"><span class="linenos">2771</span></a>                 <span class="n">blacklist</span><span class="o">=</span><span class="p">()):</span>
</span><span id="check__all__-2772"><a href="#check__all__-2772"><span class="linenos">2772</span></a>    <span class="sd">&quot;&quot;&quot;Assert that the __all__ variable of &#39;module&#39; contains all public names.</span>
</span><span id="check__all__-2773"><a href="#check__all__-2773"><span class="linenos">2773</span></a>
</span><span id="check__all__-2774"><a href="#check__all__-2774"><span class="linenos">2774</span></a><span class="sd">    The module&#39;s public names (its API) are detected automatically based on</span>
</span><span id="check__all__-2775"><a href="#check__all__-2775"><span class="linenos">2775</span></a><span class="sd">    whether they match the public name convention and were defined in</span>
</span><span id="check__all__-2776"><a href="#check__all__-2776"><span class="linenos">2776</span></a><span class="sd">    &#39;module&#39;.</span>
</span><span id="check__all__-2777"><a href="#check__all__-2777"><span class="linenos">2777</span></a>
</span><span id="check__all__-2778"><a href="#check__all__-2778"><span class="linenos">2778</span></a><span class="sd">    The &#39;name_of_module&#39; argument can specify (as a string or tuple thereof)</span>
</span><span id="check__all__-2779"><a href="#check__all__-2779"><span class="linenos">2779</span></a><span class="sd">    what module(s) an API could be defined in in order to be detected as a</span>
</span><span id="check__all__-2780"><a href="#check__all__-2780"><span class="linenos">2780</span></a><span class="sd">    public API. One case for this is when &#39;module&#39; imports part of its public</span>
</span><span id="check__all__-2781"><a href="#check__all__-2781"><span class="linenos">2781</span></a><span class="sd">    API from other modules, possibly a C backend (like &#39;csv&#39; and its &#39;_csv&#39;).</span>
</span><span id="check__all__-2782"><a href="#check__all__-2782"><span class="linenos">2782</span></a>
</span><span id="check__all__-2783"><a href="#check__all__-2783"><span class="linenos">2783</span></a><span class="sd">    The &#39;extra&#39; argument can be a set of names that wouldn&#39;t otherwise be</span>
</span><span id="check__all__-2784"><a href="#check__all__-2784"><span class="linenos">2784</span></a><span class="sd">    automatically detected as &quot;public&quot;, like objects without a proper</span>
</span><span id="check__all__-2785"><a href="#check__all__-2785"><span class="linenos">2785</span></a><span class="sd">    &#39;__module__&#39; attribute. If provided, it will be added to the</span>
</span><span id="check__all__-2786"><a href="#check__all__-2786"><span class="linenos">2786</span></a><span class="sd">    automatically detected ones.</span>
</span><span id="check__all__-2787"><a href="#check__all__-2787"><span class="linenos">2787</span></a>
</span><span id="check__all__-2788"><a href="#check__all__-2788"><span class="linenos">2788</span></a><span class="sd">    The &#39;blacklist&#39; argument can be a set of names that must not be treated</span>
</span><span id="check__all__-2789"><a href="#check__all__-2789"><span class="linenos">2789</span></a><span class="sd">    as part of the public API even though their names indicate otherwise.</span>
</span><span id="check__all__-2790"><a href="#check__all__-2790"><span class="linenos">2790</span></a>
</span><span id="check__all__-2791"><a href="#check__all__-2791"><span class="linenos">2791</span></a><span class="sd">    Usage:</span>
</span><span id="check__all__-2792"><a href="#check__all__-2792"><span class="linenos">2792</span></a><span class="sd">        import bar</span>
</span><span id="check__all__-2793"><a href="#check__all__-2793"><span class="linenos">2793</span></a><span class="sd">        import foo</span>
</span><span id="check__all__-2794"><a href="#check__all__-2794"><span class="linenos">2794</span></a><span class="sd">        import unittest</span>
</span><span id="check__all__-2795"><a href="#check__all__-2795"><span class="linenos">2795</span></a><span class="sd">        from test import support</span>
</span><span id="check__all__-2796"><a href="#check__all__-2796"><span class="linenos">2796</span></a>
</span><span id="check__all__-2797"><a href="#check__all__-2797"><span class="linenos">2797</span></a><span class="sd">        class MiscTestCase(unittest.TestCase):</span>
</span><span id="check__all__-2798"><a href="#check__all__-2798"><span class="linenos">2798</span></a><span class="sd">            def test__all__(self):</span>
</span><span id="check__all__-2799"><a href="#check__all__-2799"><span class="linenos">2799</span></a><span class="sd">                support.check__all__(self, foo)</span>
</span><span id="check__all__-2800"><a href="#check__all__-2800"><span class="linenos">2800</span></a>
</span><span id="check__all__-2801"><a href="#check__all__-2801"><span class="linenos">2801</span></a><span class="sd">        class OtherTestCase(unittest.TestCase):</span>
</span><span id="check__all__-2802"><a href="#check__all__-2802"><span class="linenos">2802</span></a><span class="sd">            def test__all__(self):</span>
</span><span id="check__all__-2803"><a href="#check__all__-2803"><span class="linenos">2803</span></a><span class="sd">                extra = {&#39;BAR_CONST&#39;, &#39;FOO_CONST&#39;}</span>
</span><span id="check__all__-2804"><a href="#check__all__-2804"><span class="linenos">2804</span></a><span class="sd">                blacklist = {&#39;baz&#39;}  # Undocumented name.</span>
</span><span id="check__all__-2805"><a href="#check__all__-2805"><span class="linenos">2805</span></a><span class="sd">                # bar imports part of its API from _bar.</span>
</span><span id="check__all__-2806"><a href="#check__all__-2806"><span class="linenos">2806</span></a><span class="sd">                support.check__all__(self, bar, (&#39;bar&#39;, &#39;_bar&#39;),</span>
</span><span id="check__all__-2807"><a href="#check__all__-2807"><span class="linenos">2807</span></a><span class="sd">                                     extra=extra, blacklist=blacklist)</span>
</span><span id="check__all__-2808"><a href="#check__all__-2808"><span class="linenos">2808</span></a>
</span><span id="check__all__-2809"><a href="#check__all__-2809"><span class="linenos">2809</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check__all__-2810"><a href="#check__all__-2810"><span class="linenos">2810</span></a>
</span><span id="check__all__-2811"><a href="#check__all__-2811"><span class="linenos">2811</span></a>    <span class="k">if</span> <span class="n">name_of_module</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="check__all__-2812"><a href="#check__all__-2812"><span class="linenos">2812</span></a>        <span class="n">name_of_module</span> <span class="o">=</span> <span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">)</span>
</span><span id="check__all__-2813"><a href="#check__all__-2813"><span class="linenos">2813</span></a>    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_of_module</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="check__all__-2814"><a href="#check__all__-2814"><span class="linenos">2814</span></a>        <span class="n">name_of_module</span> <span class="o">=</span> <span class="p">(</span><span class="n">name_of_module</span><span class="p">,</span> <span class="p">)</span>
</span><span id="check__all__-2815"><a href="#check__all__-2815"><span class="linenos">2815</span></a>
</span><span id="check__all__-2816"><a href="#check__all__-2816"><span class="linenos">2816</span></a>    <span class="n">expected</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span>
</span><span id="check__all__-2817"><a href="#check__all__-2817"><span class="linenos">2817</span></a>
</span><span id="check__all__-2818"><a href="#check__all__-2818"><span class="linenos">2818</span></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">module</span><span class="p">):</span>
</span><span id="check__all__-2819"><a href="#check__all__-2819"><span class="linenos">2819</span></a>        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">:</span>
</span><span id="check__all__-2820"><a href="#check__all__-2820"><span class="linenos">2820</span></a>            <span class="k">continue</span>
</span><span id="check__all__-2821"><a href="#check__all__-2821"><span class="linenos">2821</span></a>        <span class="n">obj</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="check__all__-2822"><a href="#check__all__-2822"><span class="linenos">2822</span></a>        <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">in</span> <span class="n">name_of_module</span> <span class="ow">or</span>
</span><span id="check__all__-2823"><a href="#check__all__-2823"><span class="linenos">2823</span></a>                <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__module__&#39;</span><span class="p">)</span> <span class="ow">and</span>
</span><span id="check__all__-2824"><a href="#check__all__-2824"><span class="linenos">2824</span></a>                 <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">))):</span>
</span><span id="check__all__-2825"><a href="#check__all__-2825"><span class="linenos">2825</span></a>            <span class="n">expected</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="check__all__-2826"><a href="#check__all__-2826"><span class="linenos">2826</span></a>    <span class="n">test_case</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">__all__</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Assert that the __all__ variable of 'module' contains all public names.</p>

<p>The module's public names (its API) are detected automatically based on
whether they match the public name convention and were defined in
'module'.</p>

<p>The 'name_of_module' argument can specify (as a string or tuple thereof)
what module(s) an API could be defined in in order to be detected as a
public API. One case for this is when 'module' imports part of its public
API from other modules, possibly a C backend (like 'csv' and its '_csv').</p>

<p>The 'extra' argument can be a set of names that wouldn't otherwise be
automatically detected as "public", like objects without a proper
'__module__' attribute. If provided, it will be added to the
automatically detected ones.</p>

<p>The 'blacklist' argument can be a set of names that must not be treated
as part of the public API even though their names indicate otherwise.</p>

<p>Usage:
    import bar
    import foo
    import unittest
    from test import support</p>

<pre><code>class MiscTestCase(unittest.TestCase):
    def test__all__(self):
        support.check__all__(self, foo)

class OtherTestCase(unittest.TestCase):
    def test__all__(self):
        extra = {'BAR_CONST', 'FOO_CONST'}
        blacklist = {'baz'}  # Undocumented name.
        # bar imports part of its API from _bar.
        support.check__all__(self, bar, ('bar', '_bar'),
                             extra=extra, blacklist=blacklist)
</code></pre>
</div>


                </section>
                <section id="skip_unless_bind_unix_socket">
                            <input id="skip_unless_bind_unix_socket-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">skip_unless_bind_unix_socket</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">test</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="skip_unless_bind_unix_socket-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#skip_unless_bind_unix_socket"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="skip_unless_bind_unix_socket-2720"><a href="#skip_unless_bind_unix_socket-2720"><span class="linenos">2720</span></a><span class="k">def</span> <span class="nf">skip_unless_bind_unix_socket</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="skip_unless_bind_unix_socket-2721"><a href="#skip_unless_bind_unix_socket-2721"><span class="linenos">2721</span></a>    <span class="sd">&quot;&quot;&quot;Decorator for tests requiring a functional bind() for unix sockets.&quot;&quot;&quot;</span>
</span><span id="skip_unless_bind_unix_socket-2722"><a href="#skip_unless_bind_unix_socket-2722"><span class="linenos">2722</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;AF_UNIX&#39;</span><span class="p">):</span>
</span><span id="skip_unless_bind_unix_socket-2723"><a href="#skip_unless_bind_unix_socket-2723"><span class="linenos">2723</span></a>        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s1">&#39;No UNIX Sockets&#39;</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span><span id="skip_unless_bind_unix_socket-2724"><a href="#skip_unless_bind_unix_socket-2724"><span class="linenos">2724</span></a>    <span class="k">global</span> <span class="n">_bind_nix_socket_error</span>
</span><span id="skip_unless_bind_unix_socket-2725"><a href="#skip_unless_bind_unix_socket-2725"><span class="linenos">2725</span></a>    <span class="k">if</span> <span class="n">_bind_nix_socket_error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="skip_unless_bind_unix_socket-2726"><a href="#skip_unless_bind_unix_socket-2726"><span class="linenos">2726</span></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">TESTFN</span> <span class="o">+</span> <span class="s2">&quot;can_bind_unix_socket&quot;</span>
</span><span id="skip_unless_bind_unix_socket-2727"><a href="#skip_unless_bind_unix_socket-2727"><span class="linenos">2727</span></a>        <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span><span class="p">)</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
</span><span id="skip_unless_bind_unix_socket-2728"><a href="#skip_unless_bind_unix_socket-2728"><span class="linenos">2728</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="skip_unless_bind_unix_socket-2729"><a href="#skip_unless_bind_unix_socket-2729"><span class="linenos">2729</span></a>                <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="skip_unless_bind_unix_socket-2730"><a href="#skip_unless_bind_unix_socket-2730"><span class="linenos">2730</span></a>                <span class="n">_bind_nix_socket_error</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="skip_unless_bind_unix_socket-2731"><a href="#skip_unless_bind_unix_socket-2731"><span class="linenos">2731</span></a>            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="skip_unless_bind_unix_socket-2732"><a href="#skip_unless_bind_unix_socket-2732"><span class="linenos">2732</span></a>                <span class="n">_bind_nix_socket_error</span> <span class="o">=</span> <span class="n">e</span>
</span><span id="skip_unless_bind_unix_socket-2733"><a href="#skip_unless_bind_unix_socket-2733"><span class="linenos">2733</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="skip_unless_bind_unix_socket-2734"><a href="#skip_unless_bind_unix_socket-2734"><span class="linenos">2734</span></a>                <span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span id="skip_unless_bind_unix_socket-2735"><a href="#skip_unless_bind_unix_socket-2735"><span class="linenos">2735</span></a>    <span class="k">if</span> <span class="n">_bind_nix_socket_error</span><span class="p">:</span>
</span><span id="skip_unless_bind_unix_socket-2736"><a href="#skip_unless_bind_unix_socket-2736"><span class="linenos">2736</span></a>        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Requires a functional unix bind(): </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">_bind_nix_socket_error</span>
</span><span id="skip_unless_bind_unix_socket-2737"><a href="#skip_unless_bind_unix_socket-2737"><span class="linenos">2737</span></a>        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="n">msg</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span>
</span><span id="skip_unless_bind_unix_socket-2738"><a href="#skip_unless_bind_unix_socket-2738"><span class="linenos">2738</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="skip_unless_bind_unix_socket-2739"><a href="#skip_unless_bind_unix_socket-2739"><span class="linenos">2739</span></a>        <span class="k">return</span> <span class="n">test</span>
</span></pre></div>


            <div class="docstring"><p>Decorator for tests requiring a functional bind() for unix sockets.</p>
</div>


                </section>
                <section id="skip_if_buggy_ucrt_strfptime">
                            <input id="skip_if_buggy_ucrt_strfptime-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">skip_if_buggy_ucrt_strfptime</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">test</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="skip_if_buggy_ucrt_strfptime-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#skip_if_buggy_ucrt_strfptime"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="skip_if_buggy_ucrt_strfptime-2578"><a href="#skip_if_buggy_ucrt_strfptime-2578"><span class="linenos">2578</span></a><span class="k">def</span> <span class="nf">skip_if_buggy_ucrt_strfptime</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2579"><a href="#skip_if_buggy_ucrt_strfptime-2579"><span class="linenos">2579</span></a>    <span class="sd">&quot;&quot;&quot;</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2580"><a href="#skip_if_buggy_ucrt_strfptime-2580"><span class="linenos">2580</span></a><span class="sd">    Skip decorator for tests that use buggy strptime/strftime</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2581"><a href="#skip_if_buggy_ucrt_strfptime-2581"><span class="linenos">2581</span></a>
</span><span id="skip_if_buggy_ucrt_strfptime-2582"><a href="#skip_if_buggy_ucrt_strfptime-2582"><span class="linenos">2582</span></a><span class="sd">    If the UCRT bugs are present time.localtime().tm_zone will be</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2583"><a href="#skip_if_buggy_ucrt_strfptime-2583"><span class="linenos">2583</span></a><span class="sd">    an empty string, otherwise we assume the UCRT bugs are fixed</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2584"><a href="#skip_if_buggy_ucrt_strfptime-2584"><span class="linenos">2584</span></a>
</span><span id="skip_if_buggy_ucrt_strfptime-2585"><a href="#skip_if_buggy_ucrt_strfptime-2585"><span class="linenos">2585</span></a><span class="sd">    See bpo-37552 [Windows] strptime/strftime return invalid</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2586"><a href="#skip_if_buggy_ucrt_strfptime-2586"><span class="linenos">2586</span></a><span class="sd">    results with UCRT version 17763.615</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2587"><a href="#skip_if_buggy_ucrt_strfptime-2587"><span class="linenos">2587</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2588"><a href="#skip_if_buggy_ucrt_strfptime-2588"><span class="linenos">2588</span></a>    <span class="k">global</span> <span class="n">_buggy_ucrt</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2589"><a href="#skip_if_buggy_ucrt_strfptime-2589"><span class="linenos">2589</span></a>    <span class="k">if</span> <span class="n">_buggy_ucrt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2590"><a href="#skip_if_buggy_ucrt_strfptime-2590"><span class="linenos">2590</span></a>        <span class="k">if</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span> <span class="ow">and</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2591"><a href="#skip_if_buggy_ucrt_strfptime-2591"><span class="linenos">2591</span></a>                <span class="n">locale</span><span class="o">.</span><span class="n">getdefaultlocale</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">==</span> <span class="s1">&#39;cp65001&#39;</span> <span class="ow">and</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2592"><a href="#skip_if_buggy_ucrt_strfptime-2592"><span class="linenos">2592</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span><span class="o">.</span><span class="n">tm_zone</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2593"><a href="#skip_if_buggy_ucrt_strfptime-2593"><span class="linenos">2593</span></a>            <span class="n">_buggy_ucrt</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2594"><a href="#skip_if_buggy_ucrt_strfptime-2594"><span class="linenos">2594</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2595"><a href="#skip_if_buggy_ucrt_strfptime-2595"><span class="linenos">2595</span></a>            <span class="n">_buggy_ucrt</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="skip_if_buggy_ucrt_strfptime-2596"><a href="#skip_if_buggy_ucrt_strfptime-2596"><span class="linenos">2596</span></a>    <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">&quot;buggy MSVC UCRT strptime/strftime&quot;</span><span class="p">)(</span><span class="n">test</span><span class="p">)</span> <span class="k">if</span> <span class="n">_buggy_ucrt</span> <span class="k">else</span> <span class="n">test</span>
</span></pre></div>


            <div class="docstring"><p>Skip decorator for tests that use buggy strptime/strftime</p>

<p>If the UCRT bugs are present time.localtime().tm_zone will be
an empty string, otherwise we assume the UCRT bugs are fixed</p>

<p>See bpo-37552 [Windows] strptime/strftime return invalid
results with UCRT version 17763.615</p>
</div>


                </section>
                <section id="ignore_warnings">
                            <input id="ignore_warnings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">ignore_warnings</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span>, </span><span class="param"><span class="n">category</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="ignore_warnings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ignore_warnings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ignore_warnings-159"><a href="#ignore_warnings-159"><span class="linenos">159</span></a><span class="k">def</span> <span class="nf">ignore_warnings</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">category</span><span class="p">):</span>
</span><span id="ignore_warnings-160"><a href="#ignore_warnings-160"><span class="linenos">160</span></a>    <span class="sd">&quot;&quot;&quot;Decorator to suppress deprecation warnings.</span>
</span><span id="ignore_warnings-161"><a href="#ignore_warnings-161"><span class="linenos">161</span></a>
</span><span id="ignore_warnings-162"><a href="#ignore_warnings-162"><span class="linenos">162</span></a><span class="sd">    Use of context managers to hide warnings make diffs</span>
</span><span id="ignore_warnings-163"><a href="#ignore_warnings-163"><span class="linenos">163</span></a><span class="sd">    more noisy and tools like &#39;git blame&#39; less useful.</span>
</span><span id="ignore_warnings-164"><a href="#ignore_warnings-164"><span class="linenos">164</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ignore_warnings-165"><a href="#ignore_warnings-165"><span class="linenos">165</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">test</span><span class="p">):</span>
</span><span id="ignore_warnings-166"><a href="#ignore_warnings-166"><span class="linenos">166</span></a>        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</span><span id="ignore_warnings-167"><a href="#ignore_warnings-167"><span class="linenos">167</span></a>        <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="ignore_warnings-168"><a href="#ignore_warnings-168"><span class="linenos">168</span></a>            <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
</span><span id="ignore_warnings-169"><a href="#ignore_warnings-169"><span class="linenos">169</span></a>                <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
</span><span id="ignore_warnings-170"><a href="#ignore_warnings-170"><span class="linenos">170</span></a>                <span class="k">return</span> <span class="n">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="ignore_warnings-171"><a href="#ignore_warnings-171"><span class="linenos">171</span></a>        <span class="k">return</span> <span class="n">wrapper</span>
</span><span id="ignore_warnings-172"><a href="#ignore_warnings-172"><span class="linenos">172</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span></pre></div>


            <div class="docstring"><p>Decorator to suppress deprecation warnings.</p>

<p>Use of context managers to hide warnings make diffs
more noisy and tools like 'git blame' less useful.</p>
</div>


                </section>
                <section id="is_jython">
                    <div class="attr variable">
            <span class="name">is_jython</span><span class="default_value"> = False</span>

        
    </div>
    <a class="headerlink" href="#is_jython"></a>
    
    

                </section>
                <section id="is_android">
                    <div class="attr variable">
            <span class="name">is_android</span><span class="default_value"> = False</span>

        
    </div>
    <a class="headerlink" href="#is_android"></a>
    
    

                </section>
                <section id="check_impl_detail">
                            <input id="check_impl_detail-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">check_impl_detail</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">**</span><span class="n">guards</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_impl_detail-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_impl_detail"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_impl_detail-1975"><a href="#check_impl_detail-1975"><span class="linenos">1975</span></a><span class="k">def</span> <span class="nf">check_impl_detail</span><span class="p">(</span><span class="o">**</span><span class="n">guards</span><span class="p">):</span>
</span><span id="check_impl_detail-1976"><a href="#check_impl_detail-1976"><span class="linenos">1976</span></a>    <span class="sd">&quot;&quot;&quot;This function returns True or False depending on the host platform.</span>
</span><span id="check_impl_detail-1977"><a href="#check_impl_detail-1977"><span class="linenos">1977</span></a><span class="sd">       Examples:</span>
</span><span id="check_impl_detail-1978"><a href="#check_impl_detail-1978"><span class="linenos">1978</span></a><span class="sd">          if check_impl_detail():               # only on CPython (default)</span>
</span><span id="check_impl_detail-1979"><a href="#check_impl_detail-1979"><span class="linenos">1979</span></a><span class="sd">          if check_impl_detail(jython=True):    # only on Jython</span>
</span><span id="check_impl_detail-1980"><a href="#check_impl_detail-1980"><span class="linenos">1980</span></a><span class="sd">          if check_impl_detail(cpython=False):  # everywhere except on CPython</span>
</span><span id="check_impl_detail-1981"><a href="#check_impl_detail-1981"><span class="linenos">1981</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_impl_detail-1982"><a href="#check_impl_detail-1982"><span class="linenos">1982</span></a>    <span class="n">guards</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="n">_parse_guards</span><span class="p">(</span><span class="n">guards</span><span class="p">)</span>
</span><span id="check_impl_detail-1983"><a href="#check_impl_detail-1983"><span class="linenos">1983</span></a>    <span class="k">return</span> <span class="n">guards</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">platform</span><span class="o">.</span><span class="n">python_implementation</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">default</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>This function returns True or False depending on the host platform.
Examples:
   if check_impl_detail():               # only on CPython (default)
   if check_impl_detail(jython=True):    # only on Jython
   if check_impl_detail(cpython=False):  # everywhere except on CPython</p>
</div>


                </section>
                <section id="unix_shell">
                    <div class="attr variable">
            <span class="name">unix_shell</span><span class="default_value"> = &#39;/bin/sh&#39;</span>

        
    </div>
    <a class="headerlink" href="#unix_shell"></a>
    
    

                </section>
                <section id="setswitchinterval">
                            <input id="setswitchinterval-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setswitchinterval</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">interval</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="setswitchinterval-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#setswitchinterval"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="setswitchinterval-3041"><a href="#setswitchinterval-3041"><span class="linenos">3041</span></a><span class="k">def</span> <span class="nf">setswitchinterval</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
</span><span id="setswitchinterval-3042"><a href="#setswitchinterval-3042"><span class="linenos">3042</span></a>    <span class="c1"># Setting a very low gil interval on the Android emulator causes python</span>
</span><span id="setswitchinterval-3043"><a href="#setswitchinterval-3043"><span class="linenos">3043</span></a>    <span class="c1"># to hang (issue #26939).</span>
</span><span id="setswitchinterval-3044"><a href="#setswitchinterval-3044"><span class="linenos">3044</span></a>    <span class="n">minimum_interval</span> <span class="o">=</span> <span class="mf">1e-5</span>
</span><span id="setswitchinterval-3045"><a href="#setswitchinterval-3045"><span class="linenos">3045</span></a>    <span class="k">if</span> <span class="n">is_android</span> <span class="ow">and</span> <span class="n">interval</span> <span class="o">&lt;</span> <span class="n">minimum_interval</span><span class="p">:</span>
</span><span id="setswitchinterval-3046"><a href="#setswitchinterval-3046"><span class="linenos">3046</span></a>        <span class="k">global</span> <span class="n">_is_android_emulator</span>
</span><span id="setswitchinterval-3047"><a href="#setswitchinterval-3047"><span class="linenos">3047</span></a>        <span class="k">if</span> <span class="n">_is_android_emulator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="setswitchinterval-3048"><a href="#setswitchinterval-3048"><span class="linenos">3048</span></a>            <span class="n">_is_android_emulator</span> <span class="o">=</span> <span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
</span><span id="setswitchinterval-3049"><a href="#setswitchinterval-3049"><span class="linenos">3049</span></a>                               <span class="p">[</span><span class="s1">&#39;getprop&#39;</span><span class="p">,</span> <span class="s1">&#39;ro.kernel.qemu&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span><span id="setswitchinterval-3050"><a href="#setswitchinterval-3050"><span class="linenos">3050</span></a>        <span class="k">if</span> <span class="n">_is_android_emulator</span><span class="p">:</span>
</span><span id="setswitchinterval-3051"><a href="#setswitchinterval-3051"><span class="linenos">3051</span></a>            <span class="n">interval</span> <span class="o">=</span> <span class="n">minimum_interval</span>
</span><span id="setswitchinterval-3052"><a href="#setswitchinterval-3052"><span class="linenos">3052</span></a>    <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">setswitchinterval</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="HOST">
                    <div class="attr variable">
            <span class="name">HOST</span><span class="default_value"> = &#39;localhost&#39;</span>

        
    </div>
    <a class="headerlink" href="#HOST"></a>
    
    

                </section>
                <section id="IPV6_ENABLED">
                    <div class="attr variable">
            <span class="name">IPV6_ENABLED</span><span class="default_value"> = True</span>

        
    </div>
    <a class="headerlink" href="#IPV6_ENABLED"></a>
    
    

                </section>
                <section id="find_unused_port">
                            <input id="find_unused_port-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">find_unused_port</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">family</span><span class="o">=&lt;</span><span class="n">AddressFamily</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">:</span> <span class="mi">2</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">socktype</span><span class="o">=&lt;</span><span class="n">SocketKind</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">:</span> <span class="mi">1</span><span class="o">&gt;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="find_unused_port-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#find_unused_port"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="find_unused_port-691"><a href="#find_unused_port-691"><span class="linenos">691</span></a><span class="k">def</span> <span class="nf">find_unused_port</span><span class="p">(</span><span class="n">family</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socktype</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">):</span>
</span><span id="find_unused_port-692"><a href="#find_unused_port-692"><span class="linenos">692</span></a>    <span class="sd">&quot;&quot;&quot;Returns an unused port that should be suitable for binding.  This is</span>
</span><span id="find_unused_port-693"><a href="#find_unused_port-693"><span class="linenos">693</span></a><span class="sd">    achieved by creating a temporary socket with the same family and type as</span>
</span><span id="find_unused_port-694"><a href="#find_unused_port-694"><span class="linenos">694</span></a><span class="sd">    the &#39;sock&#39; parameter (default is AF_INET, SOCK_STREAM), and binding it to</span>
</span><span id="find_unused_port-695"><a href="#find_unused_port-695"><span class="linenos">695</span></a><span class="sd">    the specified host address (defaults to 0.0.0.0) with the port set to 0,</span>
</span><span id="find_unused_port-696"><a href="#find_unused_port-696"><span class="linenos">696</span></a><span class="sd">    eliciting an unused ephemeral port from the OS.  The temporary socket is</span>
</span><span id="find_unused_port-697"><a href="#find_unused_port-697"><span class="linenos">697</span></a><span class="sd">    then closed and deleted, and the ephemeral port is returned.</span>
</span><span id="find_unused_port-698"><a href="#find_unused_port-698"><span class="linenos">698</span></a>
</span><span id="find_unused_port-699"><a href="#find_unused_port-699"><span class="linenos">699</span></a><span class="sd">    Either this method or bind_port() should be used for any tests where a</span>
</span><span id="find_unused_port-700"><a href="#find_unused_port-700"><span class="linenos">700</span></a><span class="sd">    server socket needs to be bound to a particular port for the duration of</span>
</span><span id="find_unused_port-701"><a href="#find_unused_port-701"><span class="linenos">701</span></a><span class="sd">    the test.  Which one to use depends on whether the calling code is creating</span>
</span><span id="find_unused_port-702"><a href="#find_unused_port-702"><span class="linenos">702</span></a><span class="sd">    a python socket, or if an unused port needs to be provided in a constructor</span>
</span><span id="find_unused_port-703"><a href="#find_unused_port-703"><span class="linenos">703</span></a><span class="sd">    or passed to an external program (i.e. the -accept argument to openssl&#39;s</span>
</span><span id="find_unused_port-704"><a href="#find_unused_port-704"><span class="linenos">704</span></a><span class="sd">    s_server mode).  Always prefer bind_port() over find_unused_port() where</span>
</span><span id="find_unused_port-705"><a href="#find_unused_port-705"><span class="linenos">705</span></a><span class="sd">    possible.  Hard coded ports should *NEVER* be used.  As soon as a server</span>
</span><span id="find_unused_port-706"><a href="#find_unused_port-706"><span class="linenos">706</span></a><span class="sd">    socket is bound to a hard coded port, the ability to run multiple instances</span>
</span><span id="find_unused_port-707"><a href="#find_unused_port-707"><span class="linenos">707</span></a><span class="sd">    of the test simultaneously on the same host is compromised, which makes the</span>
</span><span id="find_unused_port-708"><a href="#find_unused_port-708"><span class="linenos">708</span></a><span class="sd">    test a ticking time bomb in a buildbot environment. On Unix buildbots, this</span>
</span><span id="find_unused_port-709"><a href="#find_unused_port-709"><span class="linenos">709</span></a><span class="sd">    may simply manifest as a failed test, which can be recovered from without</span>
</span><span id="find_unused_port-710"><a href="#find_unused_port-710"><span class="linenos">710</span></a><span class="sd">    intervention in most cases, but on Windows, the entire python process can</span>
</span><span id="find_unused_port-711"><a href="#find_unused_port-711"><span class="linenos">711</span></a><span class="sd">    completely and utterly wedge, requiring someone to log in to the buildbot</span>
</span><span id="find_unused_port-712"><a href="#find_unused_port-712"><span class="linenos">712</span></a><span class="sd">    and manually kill the affected process.</span>
</span><span id="find_unused_port-713"><a href="#find_unused_port-713"><span class="linenos">713</span></a>
</span><span id="find_unused_port-714"><a href="#find_unused_port-714"><span class="linenos">714</span></a><span class="sd">    (This is easy to reproduce on Windows, unfortunately, and can be traced to</span>
</span><span id="find_unused_port-715"><a href="#find_unused_port-715"><span class="linenos">715</span></a><span class="sd">    the SO_REUSEADDR socket option having different semantics on Windows versus</span>
</span><span id="find_unused_port-716"><a href="#find_unused_port-716"><span class="linenos">716</span></a><span class="sd">    Unix/Linux.  On Unix, you can&#39;t have two AF_INET SOCK_STREAM sockets bind,</span>
</span><span id="find_unused_port-717"><a href="#find_unused_port-717"><span class="linenos">717</span></a><span class="sd">    listen and then accept connections on identical host/ports.  An EADDRINUSE</span>
</span><span id="find_unused_port-718"><a href="#find_unused_port-718"><span class="linenos">718</span></a><span class="sd">    OSError will be raised at some point (depending on the platform and</span>
</span><span id="find_unused_port-719"><a href="#find_unused_port-719"><span class="linenos">719</span></a><span class="sd">    the order bind and listen were called on each socket).</span>
</span><span id="find_unused_port-720"><a href="#find_unused_port-720"><span class="linenos">720</span></a>
</span><span id="find_unused_port-721"><a href="#find_unused_port-721"><span class="linenos">721</span></a><span class="sd">    However, on Windows, if SO_REUSEADDR is set on the sockets, no EADDRINUSE</span>
</span><span id="find_unused_port-722"><a href="#find_unused_port-722"><span class="linenos">722</span></a><span class="sd">    will ever be raised when attempting to bind two identical host/ports. When</span>
</span><span id="find_unused_port-723"><a href="#find_unused_port-723"><span class="linenos">723</span></a><span class="sd">    accept() is called on each socket, the second caller&#39;s process will steal</span>
</span><span id="find_unused_port-724"><a href="#find_unused_port-724"><span class="linenos">724</span></a><span class="sd">    the port from the first caller, leaving them both in an awkwardly wedged</span>
</span><span id="find_unused_port-725"><a href="#find_unused_port-725"><span class="linenos">725</span></a><span class="sd">    state where they&#39;ll no longer respond to any signals or graceful kills, and</span>
</span><span id="find_unused_port-726"><a href="#find_unused_port-726"><span class="linenos">726</span></a><span class="sd">    must be forcibly killed via OpenProcess()/TerminateProcess().</span>
</span><span id="find_unused_port-727"><a href="#find_unused_port-727"><span class="linenos">727</span></a>
</span><span id="find_unused_port-728"><a href="#find_unused_port-728"><span class="linenos">728</span></a><span class="sd">    The solution on Windows is to use the SO_EXCLUSIVEADDRUSE socket option</span>
</span><span id="find_unused_port-729"><a href="#find_unused_port-729"><span class="linenos">729</span></a><span class="sd">    instead of SO_REUSEADDR, which effectively affords the same semantics as</span>
</span><span id="find_unused_port-730"><a href="#find_unused_port-730"><span class="linenos">730</span></a><span class="sd">    SO_REUSEADDR on Unix.  Given the propensity of Unix developers in the Open</span>
</span><span id="find_unused_port-731"><a href="#find_unused_port-731"><span class="linenos">731</span></a><span class="sd">    Source world compared to Windows ones, this is a common mistake.  A quick</span>
</span><span id="find_unused_port-732"><a href="#find_unused_port-732"><span class="linenos">732</span></a><span class="sd">    look over OpenSSL&#39;s 0.9.8g source shows that they use SO_REUSEADDR when</span>
</span><span id="find_unused_port-733"><a href="#find_unused_port-733"><span class="linenos">733</span></a><span class="sd">    openssl.exe is called with the &#39;s_server&#39; option, for example. See</span>
</span><span id="find_unused_port-734"><a href="#find_unused_port-734"><span class="linenos">734</span></a><span class="sd">    http://bugs.python.org/issue2550 for more info.  The following site also</span>
</span><span id="find_unused_port-735"><a href="#find_unused_port-735"><span class="linenos">735</span></a><span class="sd">    has a very thorough description about the implications of both REUSEADDR</span>
</span><span id="find_unused_port-736"><a href="#find_unused_port-736"><span class="linenos">736</span></a><span class="sd">    and EXCLUSIVEADDRUSE on Windows:</span>
</span><span id="find_unused_port-737"><a href="#find_unused_port-737"><span class="linenos">737</span></a><span class="sd">    http://msdn2.microsoft.com/en-us/library/ms740621(VS.85).aspx)</span>
</span><span id="find_unused_port-738"><a href="#find_unused_port-738"><span class="linenos">738</span></a>
</span><span id="find_unused_port-739"><a href="#find_unused_port-739"><span class="linenos">739</span></a><span class="sd">    XXX: although this approach is a vast improvement on previous attempts to</span>
</span><span id="find_unused_port-740"><a href="#find_unused_port-740"><span class="linenos">740</span></a><span class="sd">    elicit unused ports, it rests heavily on the assumption that the ephemeral</span>
</span><span id="find_unused_port-741"><a href="#find_unused_port-741"><span class="linenos">741</span></a><span class="sd">    port returned to us by the OS won&#39;t immediately be dished back out to some</span>
</span><span id="find_unused_port-742"><a href="#find_unused_port-742"><span class="linenos">742</span></a><span class="sd">    other process when we close and delete our temporary socket but before our</span>
</span><span id="find_unused_port-743"><a href="#find_unused_port-743"><span class="linenos">743</span></a><span class="sd">    calling code has a chance to bind the returned port.  We can deal with this</span>
</span><span id="find_unused_port-744"><a href="#find_unused_port-744"><span class="linenos">744</span></a><span class="sd">    issue if/when we come across it.</span>
</span><span id="find_unused_port-745"><a href="#find_unused_port-745"><span class="linenos">745</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="find_unused_port-746"><a href="#find_unused_port-746"><span class="linenos">746</span></a>
</span><span id="find_unused_port-747"><a href="#find_unused_port-747"><span class="linenos">747</span></a>    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">socktype</span><span class="p">)</span> <span class="k">as</span> <span class="n">tempsock</span><span class="p">:</span>
</span><span id="find_unused_port-748"><a href="#find_unused_port-748"><span class="linenos">748</span></a>        <span class="n">port</span> <span class="o">=</span> <span class="n">bind_port</span><span class="p">(</span><span class="n">tempsock</span><span class="p">)</span>
</span><span id="find_unused_port-749"><a href="#find_unused_port-749"><span class="linenos">749</span></a>    <span class="k">del</span> <span class="n">tempsock</span>
</span><span id="find_unused_port-750"><a href="#find_unused_port-750"><span class="linenos">750</span></a>    <span class="k">return</span> <span class="n">port</span>
</span></pre></div>


            <div class="docstring"><p>Returns an unused port that should be suitable for binding.  This is
achieved by creating a temporary socket with the same family and type as
the 'sock' parameter (default is AF_INET, SOCK_STREAM), and binding it to
the specified host address (defaults to 0.0.0.0) with the port set to 0,
eliciting an unused ephemeral port from the OS.  The temporary socket is
then closed and deleted, and the ephemeral port is returned.</p>

<p>Either this method or bind_port() should be used for any tests where a
server socket needs to be bound to a particular port for the duration of
the test.  Which one to use depends on whether the calling code is creating
a python socket, or if an unused port needs to be provided in a constructor
or passed to an external program (i.e. the -accept argument to openssl's
s_server mode).  Always prefer bind_port() over find_unused_port() where
possible.  Hard coded ports should <em>NEVER</em> be used.  As soon as a server
socket is bound to a hard coded port, the ability to run multiple instances
of the test simultaneously on the same host is compromised, which makes the
test a ticking time bomb in a buildbot environment. On Unix buildbots, this
may simply manifest as a failed test, which can be recovered from without
intervention in most cases, but on Windows, the entire python process can
completely and utterly wedge, requiring someone to log in to the buildbot
and manually kill the affected process.</p>

<p>(This is easy to reproduce on Windows, unfortunately, and can be traced to
the SO_REUSEADDR socket option having different semantics on Windows versus
Unix/Linux.  On Unix, you can't have two AF_INET SOCK_STREAM sockets bind,
listen and then accept connections on identical host/ports.  An EADDRINUSE
OSError will be raised at some point (depending on the platform and
the order bind and listen were called on each socket).</p>

<p>However, on Windows, if SO_REUSEADDR is set on the sockets, no EADDRINUSE
will ever be raised when attempting to bind two identical host/ports. When
accept() is called on each socket, the second caller's process will steal
the port from the first caller, leaving them both in an awkwardly wedged
state where they'll no longer respond to any signals or graceful kills, and
must be forcibly killed via OpenProcess()/TerminateProcess().</p>

<p>The solution on Windows is to use the SO_EXCLUSIVEADDRUSE socket option
instead of SO_REUSEADDR, which effectively affords the same semantics as
SO_REUSEADDR on Unix.  Given the propensity of Unix developers in the Open
Source world compared to Windows ones, this is a common mistake.  A quick
look over OpenSSL's 0.9.8g source shows that they use SO_REUSEADDR when
openssl.exe is called with the 's_server' option, for example. See
<a href="http://bugs.python.org/issue2550">http://bugs.python.org/issue2550</a> for more info.  The following site also
has a very thorough description about the implications of both REUSEADDR
and EXCLUSIVEADDRUSE on Windows:
<a href="http://msdn2.microsoft.com/en-us/library/ms740621(VS.85).aspx">http://msdn2.microsoft.com/en-us/library/ms740621(VS.85).aspx</a>)</p>

<p>XXX: although this approach is a vast improvement on previous attempts to
elicit unused ports, it rests heavily on the assumption that the ephemeral
port returned to us by the OS won't immediately be dished back out to some
other process when we close and delete our temporary socket but before our
calling code has a chance to bind the returned port.  We can deal with this
issue if/when we come across it.</p>
</div>


                </section>
                <section id="bind_port">
                            <input id="bind_port-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bind_port</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sock</span>, </span><span class="param"><span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="bind_port-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#bind_port"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="bind_port-752"><a href="#bind_port-752"><span class="linenos">752</span></a><span class="k">def</span> <span class="nf">bind_port</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">):</span>
</span><span id="bind_port-753"><a href="#bind_port-753"><span class="linenos">753</span></a>    <span class="sd">&quot;&quot;&quot;Bind the socket to a free port and return the port number.  Relies on</span>
</span><span id="bind_port-754"><a href="#bind_port-754"><span class="linenos">754</span></a><span class="sd">    ephemeral ports in order to ensure we are using an unbound port.  This is</span>
</span><span id="bind_port-755"><a href="#bind_port-755"><span class="linenos">755</span></a><span class="sd">    important as many tests may be running simultaneously, especially in a</span>
</span><span id="bind_port-756"><a href="#bind_port-756"><span class="linenos">756</span></a><span class="sd">    buildbot environment.  This method raises an exception if the sock.family</span>
</span><span id="bind_port-757"><a href="#bind_port-757"><span class="linenos">757</span></a><span class="sd">    is AF_INET and sock.type is SOCK_STREAM, *and* the socket has SO_REUSEADDR</span>
</span><span id="bind_port-758"><a href="#bind_port-758"><span class="linenos">758</span></a><span class="sd">    or SO_REUSEPORT set on it.  Tests should *never* set these socket options</span>
</span><span id="bind_port-759"><a href="#bind_port-759"><span class="linenos">759</span></a><span class="sd">    for TCP/IP sockets.  The only case for setting these options is testing</span>
</span><span id="bind_port-760"><a href="#bind_port-760"><span class="linenos">760</span></a><span class="sd">    multicasting via multiple UDP sockets.</span>
</span><span id="bind_port-761"><a href="#bind_port-761"><span class="linenos">761</span></a>
</span><span id="bind_port-762"><a href="#bind_port-762"><span class="linenos">762</span></a><span class="sd">    Additionally, if the SO_EXCLUSIVEADDRUSE socket option is available (i.e.</span>
</span><span id="bind_port-763"><a href="#bind_port-763"><span class="linenos">763</span></a><span class="sd">    on Windows), it will be set on the socket.  This will prevent anyone else</span>
</span><span id="bind_port-764"><a href="#bind_port-764"><span class="linenos">764</span></a><span class="sd">    from bind()&#39;ing to our host/port for the duration of the test.</span>
</span><span id="bind_port-765"><a href="#bind_port-765"><span class="linenos">765</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="bind_port-766"><a href="#bind_port-766"><span class="linenos">766</span></a>
</span><span id="bind_port-767"><a href="#bind_port-767"><span class="linenos">767</span></a>    <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span> <span class="ow">and</span> <span class="n">sock</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">:</span>
</span><span id="bind_port-768"><a href="#bind_port-768"><span class="linenos">768</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;SO_REUSEADDR&#39;</span><span class="p">):</span>
</span><span id="bind_port-769"><a href="#bind_port-769"><span class="linenos">769</span></a>            <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="bind_port-770"><a href="#bind_port-770"><span class="linenos">770</span></a>                <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s2">&quot;tests should never set the SO_REUSEADDR &quot;</span>   \
</span><span id="bind_port-771"><a href="#bind_port-771"><span class="linenos">771</span></a>                                 <span class="s2">&quot;socket option on TCP/IP sockets!&quot;</span><span class="p">)</span>
</span><span id="bind_port-772"><a href="#bind_port-772"><span class="linenos">772</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;SO_REUSEPORT&#39;</span><span class="p">):</span>
</span><span id="bind_port-773"><a href="#bind_port-773"><span class="linenos">773</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="bind_port-774"><a href="#bind_port-774"><span class="linenos">774</span></a>                <span class="k">if</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEPORT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="bind_port-775"><a href="#bind_port-775"><span class="linenos">775</span></a>                    <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s2">&quot;tests should never set the SO_REUSEPORT &quot;</span>   \
</span><span id="bind_port-776"><a href="#bind_port-776"><span class="linenos">776</span></a>                                     <span class="s2">&quot;socket option on TCP/IP sockets!&quot;</span><span class="p">)</span>
</span><span id="bind_port-777"><a href="#bind_port-777"><span class="linenos">777</span></a>            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="bind_port-778"><a href="#bind_port-778"><span class="linenos">778</span></a>                <span class="c1"># Python&#39;s socket module was compiled using modern headers</span>
</span><span id="bind_port-779"><a href="#bind_port-779"><span class="linenos">779</span></a>                <span class="c1"># thus defining SO_REUSEPORT but this process is running</span>
</span><span id="bind_port-780"><a href="#bind_port-780"><span class="linenos">780</span></a>                <span class="c1"># under an older kernel that does not support SO_REUSEPORT.</span>
</span><span id="bind_port-781"><a href="#bind_port-781"><span class="linenos">781</span></a>                <span class="k">pass</span>
</span><span id="bind_port-782"><a href="#bind_port-782"><span class="linenos">782</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="s1">&#39;SO_EXCLUSIVEADDRUSE&#39;</span><span class="p">):</span>
</span><span id="bind_port-783"><a href="#bind_port-783"><span class="linenos">783</span></a>            <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_EXCLUSIVEADDRUSE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="bind_port-784"><a href="#bind_port-784"><span class="linenos">784</span></a>
</span><span id="bind_port-785"><a href="#bind_port-785"><span class="linenos">785</span></a>    <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span id="bind_port-786"><a href="#bind_port-786"><span class="linenos">786</span></a>    <span class="n">port</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="bind_port-787"><a href="#bind_port-787"><span class="linenos">787</span></a>    <span class="k">return</span> <span class="n">port</span>
</span></pre></div>


            <div class="docstring"><p>Bind the socket to a free port and return the port number.  Relies on
ephemeral ports in order to ensure we are using an unbound port.  This is
important as many tests may be running simultaneously, especially in a
buildbot environment.  This method raises an exception if the sock.family
is AF_INET and sock.type is SOCK_STREAM, <em>and</em> the socket has SO_REUSEADDR
or SO_REUSEPORT set on it.  Tests should <em>never</em> set these socket options
for TCP/IP sockets.  The only case for setting these options is testing
multicasting via multiple UDP sockets.</p>

<p>Additionally, if the SO_EXCLUSIVEADDRUSE socket option is available (i.e.
on Windows), it will be set on the socket.  This will prevent anyone else
from bind()'ing to our host/port for the duration of the test.</p>
</div>


                </section>
                <section id="open_urlresource">
                            <input id="open_urlresource-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">open_urlresource</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">url</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kw</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="open_urlresource-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#open_urlresource"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="open_urlresource-1201"><a href="#open_urlresource-1201"><span class="linenos">1201</span></a><span class="k">def</span> <span class="nf">open_urlresource</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
</span><span id="open_urlresource-1202"><a href="#open_urlresource-1202"><span class="linenos">1202</span></a>    <span class="kn">import</span> <span class="nn">urllib.request</span><span class="o">,</span> <span class="nn">urllib.parse</span>
</span><span id="open_urlresource-1203"><a href="#open_urlresource-1203"><span class="linenos">1203</span></a>
</span><span id="open_urlresource-1204"><a href="#open_urlresource-1204"><span class="linenos">1204</span></a>    <span class="n">check</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;check&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="open_urlresource-1205"><a href="#open_urlresource-1205"><span class="linenos">1205</span></a>
</span><span id="open_urlresource-1206"><a href="#open_urlresource-1206"><span class="linenos">1206</span></a>    <span class="n">filename</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># &#39;/&#39;: it&#39;s URL!</span>
</span><span id="open_urlresource-1207"><a href="#open_urlresource-1207"><span class="linenos">1207</span></a>
</span><span id="open_urlresource-1208"><a href="#open_urlresource-1208"><span class="linenos">1208</span></a>    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">TEST_DATA_DIR</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span><span id="open_urlresource-1209"><a href="#open_urlresource-1209"><span class="linenos">1209</span></a>
</span><span id="open_urlresource-1210"><a href="#open_urlresource-1210"><span class="linenos">1210</span></a>    <span class="k">def</span> <span class="nf">check_valid_file</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span><span id="open_urlresource-1211"><a href="#open_urlresource-1211"><span class="linenos">1211</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="open_urlresource-1212"><a href="#open_urlresource-1212"><span class="linenos">1212</span></a>        <span class="k">if</span> <span class="n">check</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="open_urlresource-1213"><a href="#open_urlresource-1213"><span class="linenos">1213</span></a>            <span class="k">return</span> <span class="n">f</span>
</span><span id="open_urlresource-1214"><a href="#open_urlresource-1214"><span class="linenos">1214</span></a>        <span class="k">elif</span> <span class="n">check</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</span><span id="open_urlresource-1215"><a href="#open_urlresource-1215"><span class="linenos">1215</span></a>            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="open_urlresource-1216"><a href="#open_urlresource-1216"><span class="linenos">1216</span></a>            <span class="k">return</span> <span class="n">f</span>
</span><span id="open_urlresource-1217"><a href="#open_urlresource-1217"><span class="linenos">1217</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="open_urlresource-1218"><a href="#open_urlresource-1218"><span class="linenos">1218</span></a>
</span><span id="open_urlresource-1219"><a href="#open_urlresource-1219"><span class="linenos">1219</span></a>    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
</span><span id="open_urlresource-1220"><a href="#open_urlresource-1220"><span class="linenos">1220</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">check_valid_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span id="open_urlresource-1221"><a href="#open_urlresource-1221"><span class="linenos">1221</span></a>        <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="open_urlresource-1222"><a href="#open_urlresource-1222"><span class="linenos">1222</span></a>            <span class="k">return</span> <span class="n">f</span>
</span><span id="open_urlresource-1223"><a href="#open_urlresource-1223"><span class="linenos">1223</span></a>        <span class="n">unlink</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span id="open_urlresource-1224"><a href="#open_urlresource-1224"><span class="linenos">1224</span></a>
</span><span id="open_urlresource-1225"><a href="#open_urlresource-1225"><span class="linenos">1225</span></a>    <span class="c1"># Verify the requirement before downloading the file</span>
</span><span id="open_urlresource-1226"><a href="#open_urlresource-1226"><span class="linenos">1226</span></a>    <span class="n">requires</span><span class="p">(</span><span class="s1">&#39;urlfetch&#39;</span><span class="p">)</span>
</span><span id="open_urlresource-1227"><a href="#open_urlresource-1227"><span class="linenos">1227</span></a>
</span><span id="open_urlresource-1228"><a href="#open_urlresource-1228"><span class="linenos">1228</span></a>    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="open_urlresource-1229"><a href="#open_urlresource-1229"><span class="linenos">1229</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">fetching </span><span class="si">%s</span><span class="s1"> ...&#39;</span> <span class="o">%</span> <span class="n">url</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">get_original_stdout</span><span class="p">())</span>
</span><span id="open_urlresource-1230"><a href="#open_urlresource-1230"><span class="linenos">1230</span></a>    <span class="n">opener</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">build_opener</span><span class="p">()</span>
</span><span id="open_urlresource-1231"><a href="#open_urlresource-1231"><span class="linenos">1231</span></a>    <span class="k">if</span> <span class="n">gzip</span><span class="p">:</span>
</span><span id="open_urlresource-1232"><a href="#open_urlresource-1232"><span class="linenos">1232</span></a>        <span class="n">opener</span><span class="o">.</span><span class="n">addheaders</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;gzip&#39;</span><span class="p">))</span>
</span><span id="open_urlresource-1233"><a href="#open_urlresource-1233"><span class="linenos">1233</span></a>    <span class="n">f</span> <span class="o">=</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="open_urlresource-1234"><a href="#open_urlresource-1234"><span class="linenos">1234</span></a>    <span class="k">if</span> <span class="n">gzip</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Content-Encoding&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;gzip&#39;</span><span class="p">:</span>
</span><span id="open_urlresource-1235"><a href="#open_urlresource-1235"><span class="linenos">1235</span></a>        <span class="n">f</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">fileobj</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
</span><span id="open_urlresource-1236"><a href="#open_urlresource-1236"><span class="linenos">1236</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="open_urlresource-1237"><a href="#open_urlresource-1237"><span class="linenos">1237</span></a>        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
</span><span id="open_urlresource-1238"><a href="#open_urlresource-1238"><span class="linenos">1238</span></a>            <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="open_urlresource-1239"><a href="#open_urlresource-1239"><span class="linenos">1239</span></a>            <span class="k">while</span> <span class="n">s</span><span class="p">:</span>
</span><span id="open_urlresource-1240"><a href="#open_urlresource-1240"><span class="linenos">1240</span></a>                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span id="open_urlresource-1241"><a href="#open_urlresource-1241"><span class="linenos">1241</span></a>                <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span id="open_urlresource-1242"><a href="#open_urlresource-1242"><span class="linenos">1242</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="open_urlresource-1243"><a href="#open_urlresource-1243"><span class="linenos">1243</span></a>        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="open_urlresource-1244"><a href="#open_urlresource-1244"><span class="linenos">1244</span></a>
</span><span id="open_urlresource-1245"><a href="#open_urlresource-1245"><span class="linenos">1245</span></a>    <span class="n">f</span> <span class="o">=</span> <span class="n">check_valid_file</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
</span><span id="open_urlresource-1246"><a href="#open_urlresource-1246"><span class="linenos">1246</span></a>    <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="open_urlresource-1247"><a href="#open_urlresource-1247"><span class="linenos">1247</span></a>        <span class="k">return</span> <span class="n">f</span>
</span><span id="open_urlresource-1248"><a href="#open_urlresource-1248"><span class="linenos">1248</span></a>    <span class="k">raise</span> <span class="n">TestFailed</span><span class="p">(</span><span class="s1">&#39;invalid resource </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fn</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="bind_unix_socket">
                            <input id="bind_unix_socket-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">bind_unix_socket</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sock</span>, </span><span class="param"><span class="n">addr</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="bind_unix_socket-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#bind_unix_socket"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="bind_unix_socket-789"><a href="#bind_unix_socket-789"><span class="linenos">789</span></a><span class="k">def</span> <span class="nf">bind_unix_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">addr</span><span class="p">):</span>
</span><span id="bind_unix_socket-790"><a href="#bind_unix_socket-790"><span class="linenos">790</span></a>    <span class="sd">&quot;&quot;&quot;Bind a unix socket, raising SkipTest if PermissionError is raised.&quot;&quot;&quot;</span>
</span><span id="bind_unix_socket-791"><a href="#bind_unix_socket-791"><span class="linenos">791</span></a>    <span class="k">assert</span> <span class="n">sock</span><span class="o">.</span><span class="n">family</span> <span class="o">==</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_UNIX</span>
</span><span id="bind_unix_socket-792"><a href="#bind_unix_socket-792"><span class="linenos">792</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="bind_unix_socket-793"><a href="#bind_unix_socket-793"><span class="linenos">793</span></a>        <span class="n">sock</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
</span><span id="bind_unix_socket-794"><a href="#bind_unix_socket-794"><span class="linenos">794</span></a>    <span class="k">except</span> <span class="ne">PermissionError</span><span class="p">:</span>
</span><span id="bind_unix_socket-795"><a href="#bind_unix_socket-795"><span class="linenos">795</span></a>        <span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="bind_unix_socket-796"><a href="#bind_unix_socket-796"><span class="linenos">796</span></a>        <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s1">&#39;cannot bind AF_UNIX sockets&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Bind a unix socket, raising SkipTest if PermissionError is raised.</p>
</div>


                </section>
                <section id="temp_umask">
                            <input id="temp_umask-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@contextlib.contextmanager</div>

        <span class="def">def</span>
        <span class="name">temp_umask</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">umask</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="temp_umask-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#temp_umask"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="temp_umask-1103"><a href="#temp_umask-1103"><span class="linenos">1103</span></a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="temp_umask-1104"><a href="#temp_umask-1104"><span class="linenos">1104</span></a>    <span class="k">def</span> <span class="nf">temp_umask</span><span class="p">(</span><span class="n">umask</span><span class="p">):</span>
</span><span id="temp_umask-1105"><a href="#temp_umask-1105"><span class="linenos">1105</span></a>        <span class="sd">&quot;&quot;&quot;Context manager that temporarily sets the process umask.&quot;&quot;&quot;</span>
</span><span id="temp_umask-1106"><a href="#temp_umask-1106"><span class="linenos">1106</span></a>        <span class="n">oldmask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">umask</span><span class="p">)</span>
</span><span id="temp_umask-1107"><a href="#temp_umask-1107"><span class="linenos">1107</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="temp_umask-1108"><a href="#temp_umask-1108"><span class="linenos">1108</span></a>            <span class="k">yield</span>
</span><span id="temp_umask-1109"><a href="#temp_umask-1109"><span class="linenos">1109</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="temp_umask-1110"><a href="#temp_umask-1110"><span class="linenos">1110</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">oldmask</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Context manager that temporarily sets the process umask.</p>
</div>


                </section>
                <section id="reap_children">
                            <input id="reap_children-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reap_children</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="reap_children-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#reap_children"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="reap_children-2340"><a href="#reap_children-2340"><span class="linenos">2340</span></a><span class="k">def</span> <span class="nf">reap_children</span><span class="p">():</span>
</span><span id="reap_children-2341"><a href="#reap_children-2341"><span class="linenos">2341</span></a>    <span class="sd">&quot;&quot;&quot;Use this function at the end of test_main() whenever sub-processes</span>
</span><span id="reap_children-2342"><a href="#reap_children-2342"><span class="linenos">2342</span></a><span class="sd">    are started.  This will help ensure that no extra children (zombies)</span>
</span><span id="reap_children-2343"><a href="#reap_children-2343"><span class="linenos">2343</span></a><span class="sd">    stick around to hog resources and create problems when looking</span>
</span><span id="reap_children-2344"><a href="#reap_children-2344"><span class="linenos">2344</span></a><span class="sd">    for refleaks.</span>
</span><span id="reap_children-2345"><a href="#reap_children-2345"><span class="linenos">2345</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="reap_children-2346"><a href="#reap_children-2346"><span class="linenos">2346</span></a>    <span class="k">global</span> <span class="n">environment_altered</span>
</span><span id="reap_children-2347"><a href="#reap_children-2347"><span class="linenos">2347</span></a>
</span><span id="reap_children-2348"><a href="#reap_children-2348"><span class="linenos">2348</span></a>    <span class="c1"># Need os.waitpid(-1, os.WNOHANG): Windows is not supported</span>
</span><span id="reap_children-2349"><a href="#reap_children-2349"><span class="linenos">2349</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;waitpid&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;WNOHANG&#39;</span><span class="p">)):</span>
</span><span id="reap_children-2350"><a href="#reap_children-2350"><span class="linenos">2350</span></a>        <span class="k">return</span>
</span><span id="reap_children-2351"><a href="#reap_children-2351"><span class="linenos">2351</span></a>
</span><span id="reap_children-2352"><a href="#reap_children-2352"><span class="linenos">2352</span></a>    <span class="c1"># Reap all our dead child processes so we don&#39;t leave zombies around.</span>
</span><span id="reap_children-2353"><a href="#reap_children-2353"><span class="linenos">2353</span></a>    <span class="c1"># These hog resources and might be causing some of the buildbots to die.</span>
</span><span id="reap_children-2354"><a href="#reap_children-2354"><span class="linenos">2354</span></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="reap_children-2355"><a href="#reap_children-2355"><span class="linenos">2355</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="reap_children-2356"><a href="#reap_children-2356"><span class="linenos">2356</span></a>            <span class="c1"># Read the exit status of any child process which already completed</span>
</span><span id="reap_children-2357"><a href="#reap_children-2357"><span class="linenos">2357</span></a>            <span class="n">pid</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">waitpid</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">WNOHANG</span><span class="p">)</span>
</span><span id="reap_children-2358"><a href="#reap_children-2358"><span class="linenos">2358</span></a>        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="reap_children-2359"><a href="#reap_children-2359"><span class="linenos">2359</span></a>            <span class="k">break</span>
</span><span id="reap_children-2360"><a href="#reap_children-2360"><span class="linenos">2360</span></a>
</span><span id="reap_children-2361"><a href="#reap_children-2361"><span class="linenos">2361</span></a>        <span class="k">if</span> <span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="reap_children-2362"><a href="#reap_children-2362"><span class="linenos">2362</span></a>            <span class="k">break</span>
</span><span id="reap_children-2363"><a href="#reap_children-2363"><span class="linenos">2363</span></a>
</span><span id="reap_children-2364"><a href="#reap_children-2364"><span class="linenos">2364</span></a>        <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reap_children() reaped child process </span><span class="si">{</span><span class="n">pid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="reap_children-2365"><a href="#reap_children-2365"><span class="linenos">2365</span></a>        <span class="n">environment_altered</span> <span class="o">=</span> <span class="kc">True</span>
</span></pre></div>


            <div class="docstring"><p>Use this function at the end of test_main() whenever sub-processes
are started.  This will help ensure that no extra children (zombies)
stick around to hog resources and create problems when looking
for refleaks.</p>
</div>


                </section>
                <section id="TestHandler">
                            <input id="TestHandler-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TestHandler</span><wbr>(<span class="base">logging.handlers.BufferingHandler</span>):

                <label class="view-source-button" for="TestHandler-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TestHandler"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TestHandler-2493"><a href="#TestHandler-2493"><span class="linenos">2493</span></a><span class="k">class</span> <span class="nc">TestHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">BufferingHandler</span><span class="p">):</span>
</span><span id="TestHandler-2494"><a href="#TestHandler-2494"><span class="linenos">2494</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matcher</span><span class="p">):</span>
</span><span id="TestHandler-2495"><a href="#TestHandler-2495"><span class="linenos">2495</span></a>        <span class="c1"># BufferingHandler takes a &quot;capacity&quot; argument</span>
</span><span id="TestHandler-2496"><a href="#TestHandler-2496"><span class="linenos">2496</span></a>        <span class="c1"># so as to know when to flush. As we&#39;re overriding</span>
</span><span id="TestHandler-2497"><a href="#TestHandler-2497"><span class="linenos">2497</span></a>        <span class="c1"># shouldFlush anyway, we can set a capacity of zero.</span>
</span><span id="TestHandler-2498"><a href="#TestHandler-2498"><span class="linenos">2498</span></a>        <span class="c1"># You can call flush() manually to clear out the</span>
</span><span id="TestHandler-2499"><a href="#TestHandler-2499"><span class="linenos">2499</span></a>        <span class="c1"># buffer.</span>
</span><span id="TestHandler-2500"><a href="#TestHandler-2500"><span class="linenos">2500</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">BufferingHandler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="TestHandler-2501"><a href="#TestHandler-2501"><span class="linenos">2501</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span> <span class="o">=</span> <span class="n">matcher</span>
</span><span id="TestHandler-2502"><a href="#TestHandler-2502"><span class="linenos">2502</span></a>
</span><span id="TestHandler-2503"><a href="#TestHandler-2503"><span class="linenos">2503</span></a>    <span class="k">def</span> <span class="nf">shouldFlush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TestHandler-2504"><a href="#TestHandler-2504"><span class="linenos">2504</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span><span id="TestHandler-2505"><a href="#TestHandler-2505"><span class="linenos">2505</span></a>
</span><span id="TestHandler-2506"><a href="#TestHandler-2506"><span class="linenos">2506</span></a>    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
</span><span id="TestHandler-2507"><a href="#TestHandler-2507"><span class="linenos">2507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span id="TestHandler-2508"><a href="#TestHandler-2508"><span class="linenos">2508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="TestHandler-2509"><a href="#TestHandler-2509"><span class="linenos">2509</span></a>
</span><span id="TestHandler-2510"><a href="#TestHandler-2510"><span class="linenos">2510</span></a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="TestHandler-2511"><a href="#TestHandler-2511"><span class="linenos">2511</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TestHandler-2512"><a href="#TestHandler-2512"><span class="linenos">2512</span></a><span class="sd">        Look for a saved dict whose keys/values match the supplied arguments.</span>
</span><span id="TestHandler-2513"><a href="#TestHandler-2513"><span class="linenos">2513</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TestHandler-2514"><a href="#TestHandler-2514"><span class="linenos">2514</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="TestHandler-2515"><a href="#TestHandler-2515"><span class="linenos">2515</span></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
</span><span id="TestHandler-2516"><a href="#TestHandler-2516"><span class="linenos">2516</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="TestHandler-2517"><a href="#TestHandler-2517"><span class="linenos">2517</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="TestHandler-2518"><a href="#TestHandler-2518"><span class="linenos">2518</span></a>                <span class="k">break</span>
</span><span id="TestHandler-2519"><a href="#TestHandler-2519"><span class="linenos">2519</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>A handler class which buffers logging records in memory. Whenever each
record is added to the buffer, a check is made to see if the buffer should
be flushed. If it should, then flush() is expected to do what's needed.</p>
</div>


                            <div id="TestHandler.__init__" class="classattr">
                                        <input id="TestHandler.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TestHandler</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">matcher</span></span>)</span>

                <label class="view-source-button" for="TestHandler.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TestHandler.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TestHandler.__init__-2494"><a href="#TestHandler.__init__-2494"><span class="linenos">2494</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matcher</span><span class="p">):</span>
</span><span id="TestHandler.__init__-2495"><a href="#TestHandler.__init__-2495"><span class="linenos">2495</span></a>        <span class="c1"># BufferingHandler takes a &quot;capacity&quot; argument</span>
</span><span id="TestHandler.__init__-2496"><a href="#TestHandler.__init__-2496"><span class="linenos">2496</span></a>        <span class="c1"># so as to know when to flush. As we&#39;re overriding</span>
</span><span id="TestHandler.__init__-2497"><a href="#TestHandler.__init__-2497"><span class="linenos">2497</span></a>        <span class="c1"># shouldFlush anyway, we can set a capacity of zero.</span>
</span><span id="TestHandler.__init__-2498"><a href="#TestHandler.__init__-2498"><span class="linenos">2498</span></a>        <span class="c1"># You can call flush() manually to clear out the</span>
</span><span id="TestHandler.__init__-2499"><a href="#TestHandler.__init__-2499"><span class="linenos">2499</span></a>        <span class="c1"># buffer.</span>
</span><span id="TestHandler.__init__-2500"><a href="#TestHandler.__init__-2500"><span class="linenos">2500</span></a>        <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">BufferingHandler</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="TestHandler.__init__-2501"><a href="#TestHandler.__init__-2501"><span class="linenos">2501</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span> <span class="o">=</span> <span class="n">matcher</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the handler with the buffer size.</p>
</div>


                            </div>
                            <div id="TestHandler.shouldFlush" class="classattr">
                                        <input id="TestHandler.shouldFlush-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shouldFlush</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TestHandler.shouldFlush-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TestHandler.shouldFlush"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TestHandler.shouldFlush-2503"><a href="#TestHandler.shouldFlush-2503"><span class="linenos">2503</span></a>    <span class="k">def</span> <span class="nf">shouldFlush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TestHandler.shouldFlush-2504"><a href="#TestHandler.shouldFlush-2504"><span class="linenos">2504</span></a>        <span class="k">return</span> <span class="kc">False</span>
</span></pre></div>


            <div class="docstring"><p>Should the handler flush its buffer?</p>

<p>Returns true if the buffer is up to capacity. This method can be
overridden to implement custom flushing strategies.</p>
</div>


                            </div>
                            <div id="TestHandler.emit" class="classattr">
                                        <input id="TestHandler.emit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">emit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">record</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TestHandler.emit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TestHandler.emit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TestHandler.emit-2506"><a href="#TestHandler.emit-2506"><span class="linenos">2506</span></a>    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
</span><span id="TestHandler.emit-2507"><a href="#TestHandler.emit-2507"><span class="linenos">2507</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span><span id="TestHandler.emit-2508"><a href="#TestHandler.emit-2508"><span class="linenos">2508</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Emit a record.</p>

<p>Append the record. If shouldFlush() tells us to, call flush() to process
the buffer.</p>
</div>


                            </div>
                            <div id="TestHandler.matches" class="classattr">
                                        <input id="TestHandler.matches-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">matches</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TestHandler.matches-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TestHandler.matches"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TestHandler.matches-2510"><a href="#TestHandler.matches-2510"><span class="linenos">2510</span></a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="TestHandler.matches-2511"><a href="#TestHandler.matches-2511"><span class="linenos">2511</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="TestHandler.matches-2512"><a href="#TestHandler.matches-2512"><span class="linenos">2512</span></a><span class="sd">        Look for a saved dict whose keys/values match the supplied arguments.</span>
</span><span id="TestHandler.matches-2513"><a href="#TestHandler.matches-2513"><span class="linenos">2513</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TestHandler.matches-2514"><a href="#TestHandler.matches-2514"><span class="linenos">2514</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="TestHandler.matches-2515"><a href="#TestHandler.matches-2515"><span class="linenos">2515</span></a>        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffer</span><span class="p">:</span>
</span><span id="TestHandler.matches-2516"><a href="#TestHandler.matches-2516"><span class="linenos">2516</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matcher</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="TestHandler.matches-2517"><a href="#TestHandler.matches-2517"><span class="linenos">2517</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="TestHandler.matches-2518"><a href="#TestHandler.matches-2518"><span class="linenos">2518</span></a>                <span class="k">break</span>
</span><span id="TestHandler.matches-2519"><a href="#TestHandler.matches-2519"><span class="linenos">2519</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Look for a saved dict whose keys/values match the supplied arguments.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>logging.handlers.BufferingHandler</dt>
                                <dd id="TestHandler.flush" class="function">flush</dd>
                <dd id="TestHandler.close" class="function">close</dd>

            </div>
            <div><dt>logging.Handler</dt>
                                <dd id="TestHandler.get_name" class="function">get_name</dd>
                <dd id="TestHandler.set_name" class="function">set_name</dd>
                <dd id="TestHandler.name" class="variable">name</dd>
                <dd id="TestHandler.createLock" class="function">createLock</dd>
                <dd id="TestHandler.acquire" class="function">acquire</dd>
                <dd id="TestHandler.release" class="function">release</dd>
                <dd id="TestHandler.setLevel" class="function">setLevel</dd>
                <dd id="TestHandler.format" class="function">format</dd>
                <dd id="TestHandler.handle" class="function">handle</dd>
                <dd id="TestHandler.setFormatter" class="function">setFormatter</dd>
                <dd id="TestHandler.handleError" class="function">handleError</dd>

            </div>
            <div><dt>logging.Filterer</dt>
                                <dd id="TestHandler.addFilter" class="function">addFilter</dd>
                <dd id="TestHandler.removeFilter" class="function">removeFilter</dd>
                <dd id="TestHandler.filter" class="function">filter</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="threading_setup">
                            <input id="threading_setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">threading_setup</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="threading_setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#threading_setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="threading_setup-2249"><a href="#threading_setup-2249"><span class="linenos">2249</span></a><span class="k">def</span> <span class="nf">threading_setup</span><span class="p">():</span>
</span><span id="threading_setup-2250"><a href="#threading_setup-2250"><span class="linenos">2250</span></a>    <span class="k">return</span> <span class="n">_thread</span><span class="o">.</span><span class="n">_count</span><span class="p">(),</span> <span class="n">threading</span><span class="o">.</span><span class="n">_dangling</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span></pre></div>


    

                </section>
                <section id="threading_cleanup">
                            <input id="threading_cleanup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">threading_cleanup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">original_values</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="threading_cleanup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#threading_cleanup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="threading_cleanup-2252"><a href="#threading_cleanup-2252"><span class="linenos">2252</span></a><span class="k">def</span> <span class="nf">threading_cleanup</span><span class="p">(</span><span class="o">*</span><span class="n">original_values</span><span class="p">):</span>
</span><span id="threading_cleanup-2253"><a href="#threading_cleanup-2253"><span class="linenos">2253</span></a>    <span class="k">global</span> <span class="n">environment_altered</span>
</span><span id="threading_cleanup-2254"><a href="#threading_cleanup-2254"><span class="linenos">2254</span></a>
</span><span id="threading_cleanup-2255"><a href="#threading_cleanup-2255"><span class="linenos">2255</span></a>    <span class="n">_MAX_COUNT</span> <span class="o">=</span> <span class="mi">100</span>
</span><span id="threading_cleanup-2256"><a href="#threading_cleanup-2256"><span class="linenos">2256</span></a>
</span><span id="threading_cleanup-2257"><a href="#threading_cleanup-2257"><span class="linenos">2257</span></a>    <span class="k">for</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">_MAX_COUNT</span><span class="p">):</span>
</span><span id="threading_cleanup-2258"><a href="#threading_cleanup-2258"><span class="linenos">2258</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">_thread</span><span class="o">.</span><span class="n">_count</span><span class="p">(),</span> <span class="n">threading</span><span class="o">.</span><span class="n">_dangling</span>
</span><span id="threading_cleanup-2259"><a href="#threading_cleanup-2259"><span class="linenos">2259</span></a>        <span class="k">if</span> <span class="n">values</span> <span class="o">==</span> <span class="n">original_values</span><span class="p">:</span>
</span><span id="threading_cleanup-2260"><a href="#threading_cleanup-2260"><span class="linenos">2260</span></a>            <span class="k">break</span>
</span><span id="threading_cleanup-2261"><a href="#threading_cleanup-2261"><span class="linenos">2261</span></a>
</span><span id="threading_cleanup-2262"><a href="#threading_cleanup-2262"><span class="linenos">2262</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">count</span><span class="p">:</span>
</span><span id="threading_cleanup-2263"><a href="#threading_cleanup-2263"><span class="linenos">2263</span></a>            <span class="c1"># Display a warning at the first iteration</span>
</span><span id="threading_cleanup-2264"><a href="#threading_cleanup-2264"><span class="linenos">2264</span></a>            <span class="n">environment_altered</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="threading_cleanup-2265"><a href="#threading_cleanup-2265"><span class="linenos">2265</span></a>            <span class="n">dangling_threads</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="threading_cleanup-2266"><a href="#threading_cleanup-2266"><span class="linenos">2266</span></a>            <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;threading_cleanup() failed to cleanup &quot;</span>
</span><span id="threading_cleanup-2267"><a href="#threading_cleanup-2267"><span class="linenos">2267</span></a>                          <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">original_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> threads &quot;</span>
</span><span id="threading_cleanup-2268"><a href="#threading_cleanup-2268"><span class="linenos">2268</span></a>                          <span class="sa">f</span><span class="s2">&quot;(count: </span><span class="si">{</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="threading_cleanup-2269"><a href="#threading_cleanup-2269"><span class="linenos">2269</span></a>                          <span class="sa">f</span><span class="s2">&quot;dangling: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dangling_threads</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="threading_cleanup-2270"><a href="#threading_cleanup-2270"><span class="linenos">2270</span></a>            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">dangling_threads</span><span class="p">:</span>
</span><span id="threading_cleanup-2271"><a href="#threading_cleanup-2271"><span class="linenos">2271</span></a>                <span class="n">print_warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dangling thread: </span><span class="si">{</span><span class="n">thread</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="threading_cleanup-2272"><a href="#threading_cleanup-2272"><span class="linenos">2272</span></a>
</span><span id="threading_cleanup-2273"><a href="#threading_cleanup-2273"><span class="linenos">2273</span></a>            <span class="c1"># Don&#39;t hold references to threads</span>
</span><span id="threading_cleanup-2274"><a href="#threading_cleanup-2274"><span class="linenos">2274</span></a>            <span class="n">dangling_threads</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="threading_cleanup-2275"><a href="#threading_cleanup-2275"><span class="linenos">2275</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="threading_cleanup-2276"><a href="#threading_cleanup-2276"><span class="linenos">2276</span></a>
</span><span id="threading_cleanup-2277"><a href="#threading_cleanup-2277"><span class="linenos">2277</span></a>        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
</span><span id="threading_cleanup-2278"><a href="#threading_cleanup-2278"><span class="linenos">2278</span></a>        <span class="n">gc_collect</span><span class="p">()</span>
</span></pre></div>


    

                </section>
                <section id="reap_threads">
                            <input id="reap_threads-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reap_threads</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">func</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="reap_threads-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#reap_threads"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="reap_threads-2281"><a href="#reap_threads-2281"><span class="linenos">2281</span></a><span class="k">def</span> <span class="nf">reap_threads</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="reap_threads-2282"><a href="#reap_threads-2282"><span class="linenos">2282</span></a>    <span class="sd">&quot;&quot;&quot;Use this function when threads are being used.  This will</span>
</span><span id="reap_threads-2283"><a href="#reap_threads-2283"><span class="linenos">2283</span></a><span class="sd">    ensure that the threads are cleaned up even when the test fails.</span>
</span><span id="reap_threads-2284"><a href="#reap_threads-2284"><span class="linenos">2284</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="reap_threads-2285"><a href="#reap_threads-2285"><span class="linenos">2285</span></a>    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
</span><span id="reap_threads-2286"><a href="#reap_threads-2286"><span class="linenos">2286</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
</span><span id="reap_threads-2287"><a href="#reap_threads-2287"><span class="linenos">2287</span></a>        <span class="n">key</span> <span class="o">=</span> <span class="n">threading_setup</span><span class="p">()</span>
</span><span id="reap_threads-2288"><a href="#reap_threads-2288"><span class="linenos">2288</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="reap_threads-2289"><a href="#reap_threads-2289"><span class="linenos">2289</span></a>            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span id="reap_threads-2290"><a href="#reap_threads-2290"><span class="linenos">2290</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="reap_threads-2291"><a href="#reap_threads-2291"><span class="linenos">2291</span></a>            <span class="n">threading_cleanup</span><span class="p">(</span><span class="o">*</span><span class="n">key</span><span class="p">)</span>
</span><span id="reap_threads-2292"><a href="#reap_threads-2292"><span class="linenos">2292</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span></pre></div>


            <div class="docstring"><p>Use this function when threads are being used.  This will
ensure that the threads are cleaned up even when the test fails.</p>
</div>


                </section>
                <section id="start_threads">
                            <input id="start_threads-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@contextlib.contextmanager</div>

        <span class="def">def</span>
        <span class="name">start_threads</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">threads</span>, </span><span class="param"><span class="n">unlock</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="start_threads-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#start_threads"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="start_threads-2368"><a href="#start_threads-2368"><span class="linenos">2368</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="start_threads-2369"><a href="#start_threads-2369"><span class="linenos">2369</span></a><span class="k">def</span> <span class="nf">start_threads</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span> <span class="n">unlock</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="start_threads-2370"><a href="#start_threads-2370"><span class="linenos">2370</span></a>    <span class="n">threads</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">threads</span><span class="p">)</span>
</span><span id="start_threads-2371"><a href="#start_threads-2371"><span class="linenos">2371</span></a>    <span class="n">started</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="start_threads-2372"><a href="#start_threads-2372"><span class="linenos">2372</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="start_threads-2373"><a href="#start_threads-2373"><span class="linenos">2373</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="start_threads-2374"><a href="#start_threads-2374"><span class="linenos">2374</span></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
</span><span id="start_threads-2375"><a href="#start_threads-2375"><span class="linenos">2375</span></a>                <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="start_threads-2376"><a href="#start_threads-2376"><span class="linenos">2376</span></a>                <span class="n">started</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</span><span id="start_threads-2377"><a href="#start_threads-2377"><span class="linenos">2377</span></a>        <span class="k">except</span><span class="p">:</span>
</span><span id="start_threads-2378"><a href="#start_threads-2378"><span class="linenos">2378</span></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="start_threads-2379"><a href="#start_threads-2379"><span class="linenos">2379</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Can&#39;t start </span><span class="si">%d</span><span class="s2"> threads, only </span><span class="si">%d</span><span class="s2"> threads started&quot;</span> <span class="o">%</span>
</span><span id="start_threads-2380"><a href="#start_threads-2380"><span class="linenos">2380</span></a>                      <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">threads</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">started</span><span class="p">)))</span>
</span><span id="start_threads-2381"><a href="#start_threads-2381"><span class="linenos">2381</span></a>            <span class="k">raise</span>
</span><span id="start_threads-2382"><a href="#start_threads-2382"><span class="linenos">2382</span></a>        <span class="k">yield</span>
</span><span id="start_threads-2383"><a href="#start_threads-2383"><span class="linenos">2383</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="start_threads-2384"><a href="#start_threads-2384"><span class="linenos">2384</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="start_threads-2385"><a href="#start_threads-2385"><span class="linenos">2385</span></a>            <span class="k">if</span> <span class="n">unlock</span><span class="p">:</span>
</span><span id="start_threads-2386"><a href="#start_threads-2386"><span class="linenos">2386</span></a>                <span class="n">unlock</span><span class="p">()</span>
</span><span id="start_threads-2387"><a href="#start_threads-2387"><span class="linenos">2387</span></a>            <span class="n">endtime</span> <span class="o">=</span> <span class="n">starttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
</span><span id="start_threads-2388"><a href="#start_threads-2388"><span class="linenos">2388</span></a>            <span class="k">for</span> <span class="n">timeout</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
</span><span id="start_threads-2389"><a href="#start_threads-2389"><span class="linenos">2389</span></a>                <span class="n">endtime</span> <span class="o">+=</span> <span class="mi">60</span>
</span><span id="start_threads-2390"><a href="#start_threads-2390"><span class="linenos">2390</span></a>                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">started</span><span class="p">:</span>
</span><span id="start_threads-2391"><a href="#start_threads-2391"><span class="linenos">2391</span></a>                    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">(),</span> <span class="mf">0.01</span><span class="p">))</span>
</span><span id="start_threads-2392"><a href="#start_threads-2392"><span class="linenos">2392</span></a>                <span class="n">started</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">started</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()]</span>
</span><span id="start_threads-2393"><a href="#start_threads-2393"><span class="linenos">2393</span></a>                <span class="k">if</span> <span class="ow">not</span> <span class="n">started</span><span class="p">:</span>
</span><span id="start_threads-2394"><a href="#start_threads-2394"><span class="linenos">2394</span></a>                    <span class="k">break</span>
</span><span id="start_threads-2395"><a href="#start_threads-2395"><span class="linenos">2395</span></a>                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
</span><span id="start_threads-2396"><a href="#start_threads-2396"><span class="linenos">2396</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Unable to join </span><span class="si">%d</span><span class="s1"> threads during a period of &#39;</span>
</span><span id="start_threads-2397"><a href="#start_threads-2397"><span class="linenos">2397</span></a>                          <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> minutes&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">started</span><span class="p">),</span> <span class="n">timeout</span><span class="p">))</span>
</span><span id="start_threads-2398"><a href="#start_threads-2398"><span class="linenos">2398</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="start_threads-2399"><a href="#start_threads-2399"><span class="linenos">2399</span></a>            <span class="n">started</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">started</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()]</span>
</span><span id="start_threads-2400"><a href="#start_threads-2400"><span class="linenos">2400</span></a>            <span class="k">if</span> <span class="n">started</span><span class="p">:</span>
</span><span id="start_threads-2401"><a href="#start_threads-2401"><span class="linenos">2401</span></a>                <span class="n">faulthandler</span><span class="o">.</span><span class="n">dump_traceback</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
</span><span id="start_threads-2402"><a href="#start_threads-2402"><span class="linenos">2402</span></a>                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;Unable to join </span><span class="si">%d</span><span class="s1"> threads&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">started</span><span class="p">))</span>
</span></pre></div>


    

                </section>
                <section id="check_warnings">
                            <input id="check_warnings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@contextlib.contextmanager</div>

        <span class="def">def</span>
        <span class="name">check_warnings</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">filters</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_warnings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_warnings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_warnings-1313"><a href="#check_warnings-1313"><span class="linenos">1313</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="check_warnings-1314"><a href="#check_warnings-1314"><span class="linenos">1314</span></a><span class="k">def</span> <span class="nf">check_warnings</span><span class="p">(</span><span class="o">*</span><span class="n">filters</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="check_warnings-1315"><a href="#check_warnings-1315"><span class="linenos">1315</span></a>    <span class="sd">&quot;&quot;&quot;Context manager to silence warnings.</span>
</span><span id="check_warnings-1316"><a href="#check_warnings-1316"><span class="linenos">1316</span></a>
</span><span id="check_warnings-1317"><a href="#check_warnings-1317"><span class="linenos">1317</span></a><span class="sd">    Accept 2-tuples as positional arguments:</span>
</span><span id="check_warnings-1318"><a href="#check_warnings-1318"><span class="linenos">1318</span></a><span class="sd">        (&quot;message regexp&quot;, WarningCategory)</span>
</span><span id="check_warnings-1319"><a href="#check_warnings-1319"><span class="linenos">1319</span></a>
</span><span id="check_warnings-1320"><a href="#check_warnings-1320"><span class="linenos">1320</span></a><span class="sd">    Optional argument:</span>
</span><span id="check_warnings-1321"><a href="#check_warnings-1321"><span class="linenos">1321</span></a><span class="sd">     - if &#39;quiet&#39; is True, it does not fail if a filter catches nothing</span>
</span><span id="check_warnings-1322"><a href="#check_warnings-1322"><span class="linenos">1322</span></a><span class="sd">        (default True without argument,</span>
</span><span id="check_warnings-1323"><a href="#check_warnings-1323"><span class="linenos">1323</span></a><span class="sd">         default False if some filters are defined)</span>
</span><span id="check_warnings-1324"><a href="#check_warnings-1324"><span class="linenos">1324</span></a>
</span><span id="check_warnings-1325"><a href="#check_warnings-1325"><span class="linenos">1325</span></a><span class="sd">    Without argument, it defaults to:</span>
</span><span id="check_warnings-1326"><a href="#check_warnings-1326"><span class="linenos">1326</span></a><span class="sd">        check_warnings((&quot;&quot;, Warning), quiet=True)</span>
</span><span id="check_warnings-1327"><a href="#check_warnings-1327"><span class="linenos">1327</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_warnings-1328"><a href="#check_warnings-1328"><span class="linenos">1328</span></a>    <span class="n">quiet</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;quiet&#39;</span><span class="p">)</span>
</span><span id="check_warnings-1329"><a href="#check_warnings-1329"><span class="linenos">1329</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">filters</span><span class="p">:</span>
</span><span id="check_warnings-1330"><a href="#check_warnings-1330"><span class="linenos">1330</span></a>        <span class="n">filters</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ne">Warning</span><span class="p">),)</span>
</span><span id="check_warnings-1331"><a href="#check_warnings-1331"><span class="linenos">1331</span></a>        <span class="c1"># Preserve backward compatibility</span>
</span><span id="check_warnings-1332"><a href="#check_warnings-1332"><span class="linenos">1332</span></a>        <span class="k">if</span> <span class="n">quiet</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="check_warnings-1333"><a href="#check_warnings-1333"><span class="linenos">1333</span></a>            <span class="n">quiet</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="check_warnings-1334"><a href="#check_warnings-1334"><span class="linenos">1334</span></a>    <span class="k">return</span> <span class="n">_filterwarnings</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">quiet</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Context manager to silence warnings.</p>

<p>Accept 2-tuples as positional arguments:
    ("message regexp", WarningCategory)</p>

<p>Optional argument:</p>

<ul>
<li>if 'quiet' is True, it does not fail if a filter catches nothing
(default True without argument,
 default False if some filters are defined)</li>
</ul>

<p>Without argument, it defaults to:
    check_warnings(("", Warning), quiet=True)</p>
</div>


                </section>
                <section id="check_no_resource_warning">
                            <input id="check_no_resource_warning-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@contextlib.contextmanager</div>

        <span class="def">def</span>
        <span class="name">check_no_resource_warning</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">testcase</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_no_resource_warning-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_no_resource_warning"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_no_resource_warning-1361"><a href="#check_no_resource_warning-1361"><span class="linenos">1361</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="check_no_resource_warning-1362"><a href="#check_no_resource_warning-1362"><span class="linenos">1362</span></a><span class="k">def</span> <span class="nf">check_no_resource_warning</span><span class="p">(</span><span class="n">testcase</span><span class="p">):</span>
</span><span id="check_no_resource_warning-1363"><a href="#check_no_resource_warning-1363"><span class="linenos">1363</span></a>    <span class="sd">&quot;&quot;&quot;Context manager to check that no ResourceWarning is emitted.</span>
</span><span id="check_no_resource_warning-1364"><a href="#check_no_resource_warning-1364"><span class="linenos">1364</span></a>
</span><span id="check_no_resource_warning-1365"><a href="#check_no_resource_warning-1365"><span class="linenos">1365</span></a><span class="sd">    Usage:</span>
</span><span id="check_no_resource_warning-1366"><a href="#check_no_resource_warning-1366"><span class="linenos">1366</span></a>
</span><span id="check_no_resource_warning-1367"><a href="#check_no_resource_warning-1367"><span class="linenos">1367</span></a><span class="sd">        with check_no_resource_warning(self):</span>
</span><span id="check_no_resource_warning-1368"><a href="#check_no_resource_warning-1368"><span class="linenos">1368</span></a><span class="sd">            f = open(...)</span>
</span><span id="check_no_resource_warning-1369"><a href="#check_no_resource_warning-1369"><span class="linenos">1369</span></a><span class="sd">            ...</span>
</span><span id="check_no_resource_warning-1370"><a href="#check_no_resource_warning-1370"><span class="linenos">1370</span></a><span class="sd">            del f</span>
</span><span id="check_no_resource_warning-1371"><a href="#check_no_resource_warning-1371"><span class="linenos">1371</span></a>
</span><span id="check_no_resource_warning-1372"><a href="#check_no_resource_warning-1372"><span class="linenos">1372</span></a><span class="sd">    You must remove the object which may emit ResourceWarning before</span>
</span><span id="check_no_resource_warning-1373"><a href="#check_no_resource_warning-1373"><span class="linenos">1373</span></a><span class="sd">    the end of the context manager.</span>
</span><span id="check_no_resource_warning-1374"><a href="#check_no_resource_warning-1374"><span class="linenos">1374</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_no_resource_warning-1375"><a href="#check_no_resource_warning-1375"><span class="linenos">1375</span></a>    <span class="k">with</span> <span class="n">check_no_warnings</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">ResourceWarning</span><span class="p">,</span> <span class="n">force_gc</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="check_no_resource_warning-1376"><a href="#check_no_resource_warning-1376"><span class="linenos">1376</span></a>        <span class="k">yield</span>
</span></pre></div>


            <div class="docstring"><p>Context manager to check that no ResourceWarning is emitted.</p>

<p>Usage:</p>

<pre><code>with check_no_resource_warning(self):
    f = open(...)
    ...
    del f
</code></pre>

<p>You must remove the object which may emit ResourceWarning before
the end of the context manager.</p>
</div>


                </section>
                <section id="check_no_warnings">
                            <input id="check_no_warnings-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@contextlib.contextmanager</div>

        <span class="def">def</span>
        <span class="name">check_no_warnings</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">testcase</span>, </span><span class="param"><span class="n">message</span><span class="o">=</span><span class="s1">&#39;&#39;</span>, </span><span class="param">category=&lt;class &#x27;Warning&#x27;&gt;, </span><span class="param"><span class="n">force_gc</span><span class="o">=</span><span class="kc">False</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="check_no_warnings-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#check_no_warnings"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="check_no_warnings-1337"><a href="#check_no_warnings-1337"><span class="linenos">1337</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="check_no_warnings-1338"><a href="#check_no_warnings-1338"><span class="linenos">1338</span></a><span class="k">def</span> <span class="nf">check_no_warnings</span><span class="p">(</span><span class="n">testcase</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">Warning</span><span class="p">,</span> <span class="n">force_gc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span><span id="check_no_warnings-1339"><a href="#check_no_warnings-1339"><span class="linenos">1339</span></a>    <span class="sd">&quot;&quot;&quot;Context manager to check that no warnings are emitted.</span>
</span><span id="check_no_warnings-1340"><a href="#check_no_warnings-1340"><span class="linenos">1340</span></a>
</span><span id="check_no_warnings-1341"><a href="#check_no_warnings-1341"><span class="linenos">1341</span></a><span class="sd">    This context manager enables a given warning within its scope</span>
</span><span id="check_no_warnings-1342"><a href="#check_no_warnings-1342"><span class="linenos">1342</span></a><span class="sd">    and checks that no warnings are emitted even with that warning</span>
</span><span id="check_no_warnings-1343"><a href="#check_no_warnings-1343"><span class="linenos">1343</span></a><span class="sd">    enabled.</span>
</span><span id="check_no_warnings-1344"><a href="#check_no_warnings-1344"><span class="linenos">1344</span></a>
</span><span id="check_no_warnings-1345"><a href="#check_no_warnings-1345"><span class="linenos">1345</span></a><span class="sd">    If force_gc is True, a garbage collection is attempted before checking</span>
</span><span id="check_no_warnings-1346"><a href="#check_no_warnings-1346"><span class="linenos">1346</span></a><span class="sd">    for warnings. This may help to catch warnings emitted when objects</span>
</span><span id="check_no_warnings-1347"><a href="#check_no_warnings-1347"><span class="linenos">1347</span></a><span class="sd">    are deleted, such as ResourceWarning.</span>
</span><span id="check_no_warnings-1348"><a href="#check_no_warnings-1348"><span class="linenos">1348</span></a>
</span><span id="check_no_warnings-1349"><a href="#check_no_warnings-1349"><span class="linenos">1349</span></a><span class="sd">    Other keyword arguments are passed to warnings.filterwarnings().</span>
</span><span id="check_no_warnings-1350"><a href="#check_no_warnings-1350"><span class="linenos">1350</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="check_no_warnings-1351"><a href="#check_no_warnings-1351"><span class="linenos">1351</span></a>    <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">(</span><span class="n">record</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">warns</span><span class="p">:</span>
</span><span id="check_no_warnings-1352"><a href="#check_no_warnings-1352"><span class="linenos">1352</span></a>        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span>
</span><span id="check_no_warnings-1353"><a href="#check_no_warnings-1353"><span class="linenos">1353</span></a>                                <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
</span><span id="check_no_warnings-1354"><a href="#check_no_warnings-1354"><span class="linenos">1354</span></a>                                <span class="n">category</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
</span><span id="check_no_warnings-1355"><a href="#check_no_warnings-1355"><span class="linenos">1355</span></a>        <span class="k">yield</span>
</span><span id="check_no_warnings-1356"><a href="#check_no_warnings-1356"><span class="linenos">1356</span></a>        <span class="k">if</span> <span class="n">force_gc</span><span class="p">:</span>
</span><span id="check_no_warnings-1357"><a href="#check_no_warnings-1357"><span class="linenos">1357</span></a>            <span class="n">gc_collect</span><span class="p">()</span>
</span><span id="check_no_warnings-1358"><a href="#check_no_warnings-1358"><span class="linenos">1358</span></a>    <span class="n">testcase</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">warns</span><span class="p">,</span> <span class="p">[])</span>
</span></pre></div>


            <div class="docstring"><p>Context manager to check that no warnings are emitted.</p>

<p>This context manager enables a given warning within its scope
and checks that no warnings are emitted even with that warning
enabled.</p>

<p>If force_gc is True, a garbage collection is attempted before checking
for warnings. This may help to catch warnings emitted when objects
are deleted, such as ResourceWarning.</p>

<p>Other keyword arguments are passed to warnings.filterwarnings().</p>
</div>


                </section>
                <section id="EnvironmentVarGuard">
                            <input id="EnvironmentVarGuard-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EnvironmentVarGuard</span><wbr>(<span class="base">collections.abc.MutableMapping</span>):

                <label class="view-source-button" for="EnvironmentVarGuard-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EnvironmentVarGuard"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EnvironmentVarGuard-1411"><a href="#EnvironmentVarGuard-1411"><span class="linenos">1411</span></a><span class="k">class</span> <span class="nc">EnvironmentVarGuard</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1412"><a href="#EnvironmentVarGuard-1412"><span class="linenos">1412</span></a>
</span><span id="EnvironmentVarGuard-1413"><a href="#EnvironmentVarGuard-1413"><span class="linenos">1413</span></a>    <span class="sd">&quot;&quot;&quot;Class to help protect the environment variable properly.  Can be used as</span>
</span><span id="EnvironmentVarGuard-1414"><a href="#EnvironmentVarGuard-1414"><span class="linenos">1414</span></a><span class="sd">    a context manager.&quot;&quot;&quot;</span>
</span><span id="EnvironmentVarGuard-1415"><a href="#EnvironmentVarGuard-1415"><span class="linenos">1415</span></a>
</span><span id="EnvironmentVarGuard-1416"><a href="#EnvironmentVarGuard-1416"><span class="linenos">1416</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1417"><a href="#EnvironmentVarGuard-1417"><span class="linenos">1417</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
</span><span id="EnvironmentVarGuard-1418"><a href="#EnvironmentVarGuard-1418"><span class="linenos">1418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="EnvironmentVarGuard-1419"><a href="#EnvironmentVarGuard-1419"><span class="linenos">1419</span></a>
</span><span id="EnvironmentVarGuard-1420"><a href="#EnvironmentVarGuard-1420"><span class="linenos">1420</span></a>    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1421"><a href="#EnvironmentVarGuard-1421"><span class="linenos">1421</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>
</span><span id="EnvironmentVarGuard-1422"><a href="#EnvironmentVarGuard-1422"><span class="linenos">1422</span></a>
</span><span id="EnvironmentVarGuard-1423"><a href="#EnvironmentVarGuard-1423"><span class="linenos">1423</span></a>    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1424"><a href="#EnvironmentVarGuard-1424"><span class="linenos">1424</span></a>        <span class="c1"># Remember the initial value on the first access</span>
</span><span id="EnvironmentVarGuard-1425"><a href="#EnvironmentVarGuard-1425"><span class="linenos">1425</span></a>        <span class="k">if</span> <span class="n">envvar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">:</span>
</span><span id="EnvironmentVarGuard-1426"><a href="#EnvironmentVarGuard-1426"><span class="linenos">1426</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">envvar</span><span class="p">)</span>
</span><span id="EnvironmentVarGuard-1427"><a href="#EnvironmentVarGuard-1427"><span class="linenos">1427</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="EnvironmentVarGuard-1428"><a href="#EnvironmentVarGuard-1428"><span class="linenos">1428</span></a>
</span><span id="EnvironmentVarGuard-1429"><a href="#EnvironmentVarGuard-1429"><span class="linenos">1429</span></a>    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1430"><a href="#EnvironmentVarGuard-1430"><span class="linenos">1430</span></a>        <span class="c1"># Remember the initial value on the first access</span>
</span><span id="EnvironmentVarGuard-1431"><a href="#EnvironmentVarGuard-1431"><span class="linenos">1431</span></a>        <span class="k">if</span> <span class="n">envvar</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">:</span>
</span><span id="EnvironmentVarGuard-1432"><a href="#EnvironmentVarGuard-1432"><span class="linenos">1432</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">envvar</span><span class="p">)</span>
</span><span id="EnvironmentVarGuard-1433"><a href="#EnvironmentVarGuard-1433"><span class="linenos">1433</span></a>        <span class="k">if</span> <span class="n">envvar</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">:</span>
</span><span id="EnvironmentVarGuard-1434"><a href="#EnvironmentVarGuard-1434"><span class="linenos">1434</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>
</span><span id="EnvironmentVarGuard-1435"><a href="#EnvironmentVarGuard-1435"><span class="linenos">1435</span></a>
</span><span id="EnvironmentVarGuard-1436"><a href="#EnvironmentVarGuard-1436"><span class="linenos">1436</span></a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1437"><a href="#EnvironmentVarGuard-1437"><span class="linenos">1437</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="EnvironmentVarGuard-1438"><a href="#EnvironmentVarGuard-1438"><span class="linenos">1438</span></a>
</span><span id="EnvironmentVarGuard-1439"><a href="#EnvironmentVarGuard-1439"><span class="linenos">1439</span></a>    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1440"><a href="#EnvironmentVarGuard-1440"><span class="linenos">1440</span></a>        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">)</span>
</span><span id="EnvironmentVarGuard-1441"><a href="#EnvironmentVarGuard-1441"><span class="linenos">1441</span></a>
</span><span id="EnvironmentVarGuard-1442"><a href="#EnvironmentVarGuard-1442"><span class="linenos">1442</span></a>    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1443"><a href="#EnvironmentVarGuard-1443"><span class="linenos">1443</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">)</span>
</span><span id="EnvironmentVarGuard-1444"><a href="#EnvironmentVarGuard-1444"><span class="linenos">1444</span></a>
</span><span id="EnvironmentVarGuard-1445"><a href="#EnvironmentVarGuard-1445"><span class="linenos">1445</span></a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1446"><a href="#EnvironmentVarGuard-1446"><span class="linenos">1446</span></a>        <span class="bp">self</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="EnvironmentVarGuard-1447"><a href="#EnvironmentVarGuard-1447"><span class="linenos">1447</span></a>
</span><span id="EnvironmentVarGuard-1448"><a href="#EnvironmentVarGuard-1448"><span class="linenos">1448</span></a>    <span class="k">def</span> <span class="nf">unset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1449"><a href="#EnvironmentVarGuard-1449"><span class="linenos">1449</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>
</span><span id="EnvironmentVarGuard-1450"><a href="#EnvironmentVarGuard-1450"><span class="linenos">1450</span></a>
</span><span id="EnvironmentVarGuard-1451"><a href="#EnvironmentVarGuard-1451"><span class="linenos">1451</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1452"><a href="#EnvironmentVarGuard-1452"><span class="linenos">1452</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="EnvironmentVarGuard-1453"><a href="#EnvironmentVarGuard-1453"><span class="linenos">1453</span></a>
</span><span id="EnvironmentVarGuard-1454"><a href="#EnvironmentVarGuard-1454"><span class="linenos">1454</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard-1455"><a href="#EnvironmentVarGuard-1455"><span class="linenos">1455</span></a>        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="EnvironmentVarGuard-1456"><a href="#EnvironmentVarGuard-1456"><span class="linenos">1456</span></a>            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="EnvironmentVarGuard-1457"><a href="#EnvironmentVarGuard-1457"><span class="linenos">1457</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">:</span>
</span><span id="EnvironmentVarGuard-1458"><a href="#EnvironmentVarGuard-1458"><span class="linenos">1458</span></a>                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="EnvironmentVarGuard-1459"><a href="#EnvironmentVarGuard-1459"><span class="linenos">1459</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="EnvironmentVarGuard-1460"><a href="#EnvironmentVarGuard-1460"><span class="linenos">1460</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
</span><span id="EnvironmentVarGuard-1461"><a href="#EnvironmentVarGuard-1461"><span class="linenos">1461</span></a>        <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span>
</span></pre></div>


            <div class="docstring"><p>Class to help protect the environment variable properly.  Can be used as
a context manager.</p>
</div>


                            <div id="EnvironmentVarGuard.__init__" class="classattr">
                                        <input id="EnvironmentVarGuard.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">EnvironmentVarGuard</span><span class="signature pdoc-code condensed">()</span>

                <label class="view-source-button" for="EnvironmentVarGuard.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EnvironmentVarGuard.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EnvironmentVarGuard.__init__-1416"><a href="#EnvironmentVarGuard.__init__-1416"><span class="linenos">1416</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard.__init__-1417"><a href="#EnvironmentVarGuard.__init__-1417"><span class="linenos">1417</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
</span><span id="EnvironmentVarGuard.__init__-1418"><a href="#EnvironmentVarGuard.__init__-1418"><span class="linenos">1418</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span> <span class="o">=</span> <span class="p">{}</span>
</span></pre></div>


    

                            </div>
                            <div id="EnvironmentVarGuard.keys" class="classattr">
                                        <input id="EnvironmentVarGuard.keys-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">keys</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="EnvironmentVarGuard.keys-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EnvironmentVarGuard.keys"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EnvironmentVarGuard.keys-1436"><a href="#EnvironmentVarGuard.keys-1436"><span class="linenos">1436</span></a>    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard.keys-1437"><a href="#EnvironmentVarGuard.keys-1437"><span class="linenos">1437</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_environ</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>D.keys() -> a set-like object providing a view on D's keys</p>
</div>


                            </div>
                            <div id="EnvironmentVarGuard.set" class="classattr">
                                        <input id="EnvironmentVarGuard.set-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">envvar</span>, </span><span class="param"><span class="n">value</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="EnvironmentVarGuard.set-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EnvironmentVarGuard.set"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EnvironmentVarGuard.set-1445"><a href="#EnvironmentVarGuard.set-1445"><span class="linenos">1445</span></a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard.set-1446"><a href="#EnvironmentVarGuard.set-1446"><span class="linenos">1446</span></a>        <span class="bp">self</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span></pre></div>


    

                            </div>
                            <div id="EnvironmentVarGuard.unset" class="classattr">
                                        <input id="EnvironmentVarGuard.unset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">unset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">envvar</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="EnvironmentVarGuard.unset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EnvironmentVarGuard.unset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EnvironmentVarGuard.unset-1448"><a href="#EnvironmentVarGuard.unset-1448"><span class="linenos">1448</span></a>    <span class="k">def</span> <span class="nf">unset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envvar</span><span class="p">):</span>
</span><span id="EnvironmentVarGuard.unset-1449"><a href="#EnvironmentVarGuard.unset-1449"><span class="linenos">1449</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="p">[</span><span class="n">envvar</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>collections.abc.MutableMapping</dt>
                                <dd id="EnvironmentVarGuard.pop" class="function">pop</dd>
                <dd id="EnvironmentVarGuard.popitem" class="function">popitem</dd>
                <dd id="EnvironmentVarGuard.clear" class="function">clear</dd>
                <dd id="EnvironmentVarGuard.update" class="function">update</dd>
                <dd id="EnvironmentVarGuard.setdefault" class="function">setdefault</dd>

            </div>
            <div><dt>collections.abc.Mapping</dt>
                                <dd id="EnvironmentVarGuard.get" class="function">get</dd>
                <dd id="EnvironmentVarGuard.items" class="function">items</dd>
                <dd id="EnvironmentVarGuard.values" class="function">values</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="run_with_locale">
                            <input id="run_with_locale-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_with_locale</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">catstr</span>, </span><span class="param"><span class="o">*</span><span class="n">locales</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="run_with_locale-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#run_with_locale"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="run_with_locale-1733"><a href="#run_with_locale-1733"><span class="linenos">1733</span></a><span class="k">def</span> <span class="nf">run_with_locale</span><span class="p">(</span><span class="n">catstr</span><span class="p">,</span> <span class="o">*</span><span class="n">locales</span><span class="p">):</span>
</span><span id="run_with_locale-1734"><a href="#run_with_locale-1734"><span class="linenos">1734</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="run_with_locale-1735"><a href="#run_with_locale-1735"><span class="linenos">1735</span></a>        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
</span><span id="run_with_locale-1736"><a href="#run_with_locale-1736"><span class="linenos">1736</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="run_with_locale-1737"><a href="#run_with_locale-1737"><span class="linenos">1737</span></a>                <span class="kn">import</span> <span class="nn">locale</span>
</span><span id="run_with_locale-1738"><a href="#run_with_locale-1738"><span class="linenos">1738</span></a>                <span class="n">category</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">locale</span><span class="p">,</span> <span class="n">catstr</span><span class="p">)</span>
</span><span id="run_with_locale-1739"><a href="#run_with_locale-1739"><span class="linenos">1739</span></a>                <span class="n">orig_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
</span><span id="run_with_locale-1740"><a href="#run_with_locale-1740"><span class="linenos">1740</span></a>            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="run_with_locale-1741"><a href="#run_with_locale-1741"><span class="linenos">1741</span></a>                <span class="c1"># if the test author gives us an invalid category string</span>
</span><span id="run_with_locale-1742"><a href="#run_with_locale-1742"><span class="linenos">1742</span></a>                <span class="k">raise</span>
</span><span id="run_with_locale-1743"><a href="#run_with_locale-1743"><span class="linenos">1743</span></a>            <span class="k">except</span><span class="p">:</span>
</span><span id="run_with_locale-1744"><a href="#run_with_locale-1744"><span class="linenos">1744</span></a>                <span class="c1"># cannot retrieve original locale, so do nothing</span>
</span><span id="run_with_locale-1745"><a href="#run_with_locale-1745"><span class="linenos">1745</span></a>                <span class="n">locale</span> <span class="o">=</span> <span class="n">orig_locale</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="run_with_locale-1746"><a href="#run_with_locale-1746"><span class="linenos">1746</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="run_with_locale-1747"><a href="#run_with_locale-1747"><span class="linenos">1747</span></a>                <span class="k">for</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">locales</span><span class="p">:</span>
</span><span id="run_with_locale-1748"><a href="#run_with_locale-1748"><span class="linenos">1748</span></a>                    <span class="k">try</span><span class="p">:</span>
</span><span id="run_with_locale-1749"><a href="#run_with_locale-1749"><span class="linenos">1749</span></a>                        <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span>
</span><span id="run_with_locale-1750"><a href="#run_with_locale-1750"><span class="linenos">1750</span></a>                        <span class="k">break</span>
</span><span id="run_with_locale-1751"><a href="#run_with_locale-1751"><span class="linenos">1751</span></a>                    <span class="k">except</span><span class="p">:</span>
</span><span id="run_with_locale-1752"><a href="#run_with_locale-1752"><span class="linenos">1752</span></a>                        <span class="k">pass</span>
</span><span id="run_with_locale-1753"><a href="#run_with_locale-1753"><span class="linenos">1753</span></a>
</span><span id="run_with_locale-1754"><a href="#run_with_locale-1754"><span class="linenos">1754</span></a>            <span class="c1"># now run the function, resetting the locale on exceptions</span>
</span><span id="run_with_locale-1755"><a href="#run_with_locale-1755"><span class="linenos">1755</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="run_with_locale-1756"><a href="#run_with_locale-1756"><span class="linenos">1756</span></a>                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</span><span id="run_with_locale-1757"><a href="#run_with_locale-1757"><span class="linenos">1757</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="run_with_locale-1758"><a href="#run_with_locale-1758"><span class="linenos">1758</span></a>                <span class="k">if</span> <span class="n">locale</span> <span class="ow">and</span> <span class="n">orig_locale</span><span class="p">:</span>
</span><span id="run_with_locale-1759"><a href="#run_with_locale-1759"><span class="linenos">1759</span></a>                    <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">orig_locale</span><span class="p">)</span>
</span><span id="run_with_locale-1760"><a href="#run_with_locale-1760"><span class="linenos">1760</span></a>        <span class="n">inner</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="run_with_locale-1761"><a href="#run_with_locale-1761"><span class="linenos">1761</span></a>        <span class="n">inner</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span id="run_with_locale-1762"><a href="#run_with_locale-1762"><span class="linenos">1762</span></a>        <span class="k">return</span> <span class="n">inner</span>
</span><span id="run_with_locale-1763"><a href="#run_with_locale-1763"><span class="linenos">1763</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span></pre></div>


    

                </section>
                <section id="swap_item">
                            <input id="swap_item-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@contextlib.contextmanager</div>

        <span class="def">def</span>
        <span class="name">swap_item</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">obj</span>, </span><span class="param"><span class="n">item</span>, </span><span class="param"><span class="n">new_val</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="swap_item-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#swap_item"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="swap_item-2435"><a href="#swap_item-2435"><span class="linenos">2435</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="swap_item-2436"><a href="#swap_item-2436"><span class="linenos">2436</span></a><span class="k">def</span> <span class="nf">swap_item</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">new_val</span><span class="p">):</span>
</span><span id="swap_item-2437"><a href="#swap_item-2437"><span class="linenos">2437</span></a>    <span class="sd">&quot;&quot;&quot;Temporary swap out an item with a new object.</span>
</span><span id="swap_item-2438"><a href="#swap_item-2438"><span class="linenos">2438</span></a>
</span><span id="swap_item-2439"><a href="#swap_item-2439"><span class="linenos">2439</span></a><span class="sd">    Usage:</span>
</span><span id="swap_item-2440"><a href="#swap_item-2440"><span class="linenos">2440</span></a><span class="sd">        with swap_item(obj, &quot;item&quot;, 5):</span>
</span><span id="swap_item-2441"><a href="#swap_item-2441"><span class="linenos">2441</span></a><span class="sd">            ...</span>
</span><span id="swap_item-2442"><a href="#swap_item-2442"><span class="linenos">2442</span></a>
</span><span id="swap_item-2443"><a href="#swap_item-2443"><span class="linenos">2443</span></a><span class="sd">        This will set obj[&quot;item&quot;] to 5 for the duration of the with: block,</span>
</span><span id="swap_item-2444"><a href="#swap_item-2444"><span class="linenos">2444</span></a><span class="sd">        restoring the old value at the end of the block. If `item` doesn&#39;t</span>
</span><span id="swap_item-2445"><a href="#swap_item-2445"><span class="linenos">2445</span></a><span class="sd">        exist on `obj`, it will be created and then deleted at the end of the</span>
</span><span id="swap_item-2446"><a href="#swap_item-2446"><span class="linenos">2446</span></a><span class="sd">        block.</span>
</span><span id="swap_item-2447"><a href="#swap_item-2447"><span class="linenos">2447</span></a>
</span><span id="swap_item-2448"><a href="#swap_item-2448"><span class="linenos">2448</span></a><span class="sd">        The old value (or None if it doesn&#39;t exist) will be assigned to the</span>
</span><span id="swap_item-2449"><a href="#swap_item-2449"><span class="linenos">2449</span></a><span class="sd">        target of the &quot;as&quot; clause, if there is one.</span>
</span><span id="swap_item-2450"><a href="#swap_item-2450"><span class="linenos">2450</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="swap_item-2451"><a href="#swap_item-2451"><span class="linenos">2451</span></a>    <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
</span><span id="swap_item-2452"><a href="#swap_item-2452"><span class="linenos">2452</span></a>        <span class="n">real_val</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
</span><span id="swap_item-2453"><a href="#swap_item-2453"><span class="linenos">2453</span></a>        <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
</span><span id="swap_item-2454"><a href="#swap_item-2454"><span class="linenos">2454</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="swap_item-2455"><a href="#swap_item-2455"><span class="linenos">2455</span></a>            <span class="k">yield</span> <span class="n">real_val</span>
</span><span id="swap_item-2456"><a href="#swap_item-2456"><span class="linenos">2456</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="swap_item-2457"><a href="#swap_item-2457"><span class="linenos">2457</span></a>            <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">real_val</span>
</span><span id="swap_item-2458"><a href="#swap_item-2458"><span class="linenos">2458</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="swap_item-2459"><a href="#swap_item-2459"><span class="linenos">2459</span></a>        <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_val</span>
</span><span id="swap_item-2460"><a href="#swap_item-2460"><span class="linenos">2460</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="swap_item-2461"><a href="#swap_item-2461"><span class="linenos">2461</span></a>            <span class="k">yield</span>
</span><span id="swap_item-2462"><a href="#swap_item-2462"><span class="linenos">2462</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="swap_item-2463"><a href="#swap_item-2463"><span class="linenos">2463</span></a>            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
</span><span id="swap_item-2464"><a href="#swap_item-2464"><span class="linenos">2464</span></a>                <span class="k">del</span> <span class="n">obj</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Temporary swap out an item with a new object.</p>

<p>Usage:
    with swap_item(obj, "item", 5):
        ...</p>

<pre><code>This will set obj["item"] to 5 for the duration of the with: block,
restoring the old value at the end of the block. If `item` doesn't
exist on `obj`, it will be created and then deleted at the end of the
block.

The old value (or None if it doesn't exist) will be assigned to the
target of the "as" clause, if there is one.
</code></pre>
</div>


                </section>
                <section id="swap_attr">
                            <input id="swap_attr-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@contextlib.contextmanager</div>

        <span class="def">def</span>
        <span class="name">swap_attr</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">obj</span>, </span><span class="param"><span class="n">attr</span>, </span><span class="param"><span class="n">new_val</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="swap_attr-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#swap_attr"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="swap_attr-2404"><a href="#swap_attr-2404"><span class="linenos">2404</span></a><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
</span><span id="swap_attr-2405"><a href="#swap_attr-2405"><span class="linenos">2405</span></a><span class="k">def</span> <span class="nf">swap_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span><span class="p">):</span>
</span><span id="swap_attr-2406"><a href="#swap_attr-2406"><span class="linenos">2406</span></a>    <span class="sd">&quot;&quot;&quot;Temporary swap out an attribute with a new object.</span>
</span><span id="swap_attr-2407"><a href="#swap_attr-2407"><span class="linenos">2407</span></a>
</span><span id="swap_attr-2408"><a href="#swap_attr-2408"><span class="linenos">2408</span></a><span class="sd">    Usage:</span>
</span><span id="swap_attr-2409"><a href="#swap_attr-2409"><span class="linenos">2409</span></a><span class="sd">        with swap_attr(obj, &quot;attr&quot;, 5):</span>
</span><span id="swap_attr-2410"><a href="#swap_attr-2410"><span class="linenos">2410</span></a><span class="sd">            ...</span>
</span><span id="swap_attr-2411"><a href="#swap_attr-2411"><span class="linenos">2411</span></a>
</span><span id="swap_attr-2412"><a href="#swap_attr-2412"><span class="linenos">2412</span></a><span class="sd">        This will set obj.attr to 5 for the duration of the with: block,</span>
</span><span id="swap_attr-2413"><a href="#swap_attr-2413"><span class="linenos">2413</span></a><span class="sd">        restoring the old value at the end of the block. If `attr` doesn&#39;t</span>
</span><span id="swap_attr-2414"><a href="#swap_attr-2414"><span class="linenos">2414</span></a><span class="sd">        exist on `obj`, it will be created and then deleted at the end of the</span>
</span><span id="swap_attr-2415"><a href="#swap_attr-2415"><span class="linenos">2415</span></a><span class="sd">        block.</span>
</span><span id="swap_attr-2416"><a href="#swap_attr-2416"><span class="linenos">2416</span></a>
</span><span id="swap_attr-2417"><a href="#swap_attr-2417"><span class="linenos">2417</span></a><span class="sd">        The old value (or None if it doesn&#39;t exist) will be assigned to the</span>
</span><span id="swap_attr-2418"><a href="#swap_attr-2418"><span class="linenos">2418</span></a><span class="sd">        target of the &quot;as&quot; clause, if there is one.</span>
</span><span id="swap_attr-2419"><a href="#swap_attr-2419"><span class="linenos">2419</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="swap_attr-2420"><a href="#swap_attr-2420"><span class="linenos">2420</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
</span><span id="swap_attr-2421"><a href="#swap_attr-2421"><span class="linenos">2421</span></a>        <span class="n">real_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span><span id="swap_attr-2422"><a href="#swap_attr-2422"><span class="linenos">2422</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
</span><span id="swap_attr-2423"><a href="#swap_attr-2423"><span class="linenos">2423</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="swap_attr-2424"><a href="#swap_attr-2424"><span class="linenos">2424</span></a>            <span class="k">yield</span> <span class="n">real_val</span>
</span><span id="swap_attr-2425"><a href="#swap_attr-2425"><span class="linenos">2425</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="swap_attr-2426"><a href="#swap_attr-2426"><span class="linenos">2426</span></a>            <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">real_val</span><span class="p">)</span>
</span><span id="swap_attr-2427"><a href="#swap_attr-2427"><span class="linenos">2427</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="swap_attr-2428"><a href="#swap_attr-2428"><span class="linenos">2428</span></a>        <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">new_val</span><span class="p">)</span>
</span><span id="swap_attr-2429"><a href="#swap_attr-2429"><span class="linenos">2429</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="swap_attr-2430"><a href="#swap_attr-2430"><span class="linenos">2430</span></a>            <span class="k">yield</span>
</span><span id="swap_attr-2431"><a href="#swap_attr-2431"><span class="linenos">2431</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="swap_attr-2432"><a href="#swap_attr-2432"><span class="linenos">2432</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
</span><span id="swap_attr-2433"><a href="#swap_attr-2433"><span class="linenos">2433</span></a>                <span class="nb">delattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Temporary swap out an attribute with a new object.</p>

<p>Usage:
    with swap_attr(obj, "attr", 5):
        ...</p>

<pre><code>This will set obj.attr to 5 for the duration of the with: block,
restoring the old value at the end of the block. If `attr` doesn't
exist on `obj`, it will be created and then deleted at the end of the
block.

The old value (or None if it doesn't exist) will be assigned to the
target of the "as" clause, if there is one.
</code></pre>
</div>


                </section>
                <section id="Matcher">
                            <input id="Matcher-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Matcher</span>:

                <label class="view-source-button" for="Matcher-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Matcher"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Matcher-2521"><a href="#Matcher-2521"><span class="linenos">2521</span></a><span class="k">class</span> <span class="nc">Matcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span id="Matcher-2522"><a href="#Matcher-2522"><span class="linenos">2522</span></a>
</span><span id="Matcher-2523"><a href="#Matcher-2523"><span class="linenos">2523</span></a>    <span class="n">_partial_matches</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;msg&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">)</span>
</span><span id="Matcher-2524"><a href="#Matcher-2524"><span class="linenos">2524</span></a>
</span><span id="Matcher-2525"><a href="#Matcher-2525"><span class="linenos">2525</span></a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Matcher-2526"><a href="#Matcher-2526"><span class="linenos">2526</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Matcher-2527"><a href="#Matcher-2527"><span class="linenos">2527</span></a><span class="sd">        Try to match a single dict with the supplied arguments.</span>
</span><span id="Matcher-2528"><a href="#Matcher-2528"><span class="linenos">2528</span></a>
</span><span id="Matcher-2529"><a href="#Matcher-2529"><span class="linenos">2529</span></a><span class="sd">        Keys whose values are strings and which are in self._partial_matches</span>
</span><span id="Matcher-2530"><a href="#Matcher-2530"><span class="linenos">2530</span></a><span class="sd">        will be checked for partial (i.e. substring) matches. You can extend</span>
</span><span id="Matcher-2531"><a href="#Matcher-2531"><span class="linenos">2531</span></a><span class="sd">        this scheme to (for example) do regular expression matching, etc.</span>
</span><span id="Matcher-2532"><a href="#Matcher-2532"><span class="linenos">2532</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Matcher-2533"><a href="#Matcher-2533"><span class="linenos">2533</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Matcher-2534"><a href="#Matcher-2534"><span class="linenos">2534</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="Matcher-2535"><a href="#Matcher-2535"><span class="linenos">2535</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="Matcher-2536"><a href="#Matcher-2536"><span class="linenos">2536</span></a>            <span class="n">dv</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span id="Matcher-2537"><a href="#Matcher-2537"><span class="linenos">2537</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_value</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span id="Matcher-2538"><a href="#Matcher-2538"><span class="linenos">2538</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Matcher-2539"><a href="#Matcher-2539"><span class="linenos">2539</span></a>                <span class="k">break</span>
</span><span id="Matcher-2540"><a href="#Matcher-2540"><span class="linenos">2540</span></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="Matcher-2541"><a href="#Matcher-2541"><span class="linenos">2541</span></a>
</span><span id="Matcher-2542"><a href="#Matcher-2542"><span class="linenos">2542</span></a>    <span class="k">def</span> <span class="nf">match_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span id="Matcher-2543"><a href="#Matcher-2543"><span class="linenos">2543</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Matcher-2544"><a href="#Matcher-2544"><span class="linenos">2544</span></a><span class="sd">        Try to match a single stored value (dv) with a supplied value (v).</span>
</span><span id="Matcher-2545"><a href="#Matcher-2545"><span class="linenos">2545</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Matcher-2546"><a href="#Matcher-2546"><span class="linenos">2546</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv</span><span class="p">):</span>
</span><span id="Matcher-2547"><a href="#Matcher-2547"><span class="linenos">2547</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Matcher-2548"><a href="#Matcher-2548"><span class="linenos">2548</span></a>        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_matches</span><span class="p">:</span>
</span><span id="Matcher-2549"><a href="#Matcher-2549"><span class="linenos">2549</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">dv</span><span class="p">)</span>
</span><span id="Matcher-2550"><a href="#Matcher-2550"><span class="linenos">2550</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Matcher-2551"><a href="#Matcher-2551"><span class="linenos">2551</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
</span><span id="Matcher-2552"><a href="#Matcher-2552"><span class="linenos">2552</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


    

                            <div id="Matcher.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Matcher</span><span class="signature pdoc-code condensed">()</span>

        
    </div>
    <a class="headerlink" href="#Matcher.__init__"></a>
    
    

                            </div>
                            <div id="Matcher.matches" class="classattr">
                                        <input id="Matcher.matches-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">matches</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">d</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Matcher.matches-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Matcher.matches"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Matcher.matches-2525"><a href="#Matcher.matches-2525"><span class="linenos">2525</span></a>    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span id="Matcher.matches-2526"><a href="#Matcher.matches-2526"><span class="linenos">2526</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Matcher.matches-2527"><a href="#Matcher.matches-2527"><span class="linenos">2527</span></a><span class="sd">        Try to match a single dict with the supplied arguments.</span>
</span><span id="Matcher.matches-2528"><a href="#Matcher.matches-2528"><span class="linenos">2528</span></a>
</span><span id="Matcher.matches-2529"><a href="#Matcher.matches-2529"><span class="linenos">2529</span></a><span class="sd">        Keys whose values are strings and which are in self._partial_matches</span>
</span><span id="Matcher.matches-2530"><a href="#Matcher.matches-2530"><span class="linenos">2530</span></a><span class="sd">        will be checked for partial (i.e. substring) matches. You can extend</span>
</span><span id="Matcher.matches-2531"><a href="#Matcher.matches-2531"><span class="linenos">2531</span></a><span class="sd">        this scheme to (for example) do regular expression matching, etc.</span>
</span><span id="Matcher.matches-2532"><a href="#Matcher.matches-2532"><span class="linenos">2532</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Matcher.matches-2533"><a href="#Matcher.matches-2533"><span class="linenos">2533</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Matcher.matches-2534"><a href="#Matcher.matches-2534"><span class="linenos">2534</span></a>        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="Matcher.matches-2535"><a href="#Matcher.matches-2535"><span class="linenos">2535</span></a>            <span class="n">v</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="Matcher.matches-2536"><a href="#Matcher.matches-2536"><span class="linenos">2536</span></a>            <span class="n">dv</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span id="Matcher.matches-2537"><a href="#Matcher.matches-2537"><span class="linenos">2537</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_value</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span id="Matcher.matches-2538"><a href="#Matcher.matches-2538"><span class="linenos">2538</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Matcher.matches-2539"><a href="#Matcher.matches-2539"><span class="linenos">2539</span></a>                <span class="k">break</span>
</span><span id="Matcher.matches-2540"><a href="#Matcher.matches-2540"><span class="linenos">2540</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Try to match a single dict with the supplied arguments.</p>

<p>Keys whose values are strings and which are in self._partial_matches
will be checked for partial (i.e. substring) matches. You can extend
this scheme to (for example) do regular expression matching, etc.</p>
</div>


                            </div>
                            <div id="Matcher.match_value" class="classattr">
                                        <input id="Matcher.match_value-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">match_value</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">k</span>, </span><span class="param"><span class="n">dv</span>, </span><span class="param"><span class="n">v</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Matcher.match_value-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Matcher.match_value"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Matcher.match_value-2542"><a href="#Matcher.match_value-2542"><span class="linenos">2542</span></a>    <span class="k">def</span> <span class="nf">match_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
</span><span id="Matcher.match_value-2543"><a href="#Matcher.match_value-2543"><span class="linenos">2543</span></a>        <span class="sd">&quot;&quot;&quot;</span>
</span><span id="Matcher.match_value-2544"><a href="#Matcher.match_value-2544"><span class="linenos">2544</span></a><span class="sd">        Try to match a single stored value (dv) with a supplied value (v).</span>
</span><span id="Matcher.match_value-2545"><a href="#Matcher.match_value-2545"><span class="linenos">2545</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Matcher.match_value-2546"><a href="#Matcher.match_value-2546"><span class="linenos">2546</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv</span><span class="p">):</span>
</span><span id="Matcher.match_value-2547"><a href="#Matcher.match_value-2547"><span class="linenos">2547</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Matcher.match_value-2548"><a href="#Matcher.match_value-2548"><span class="linenos">2548</span></a>        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dv</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">or</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_partial_matches</span><span class="p">:</span>
</span><span id="Matcher.match_value-2549"><a href="#Matcher.match_value-2549"><span class="linenos">2549</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">dv</span><span class="p">)</span>
</span><span id="Matcher.match_value-2550"><a href="#Matcher.match_value-2550"><span class="linenos">2550</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Matcher.match_value-2551"><a href="#Matcher.match_value-2551"><span class="linenos">2551</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">dv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
</span><span id="Matcher.match_value-2552"><a href="#Matcher.match_value-2552"><span class="linenos">2552</span></a>        <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Try to match a single stored value (dv) with a supplied value (v).</p>
</div>


                            </div>
                </section>
                <section id="set_memlimit">
                            <input id="set_memlimit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_memlimit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">limit</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="set_memlimit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#set_memlimit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="set_memlimit-1811"><a href="#set_memlimit-1811"><span class="linenos">1811</span></a><span class="k">def</span> <span class="nf">set_memlimit</span><span class="p">(</span><span class="n">limit</span><span class="p">):</span>
</span><span id="set_memlimit-1812"><a href="#set_memlimit-1812"><span class="linenos">1812</span></a>    <span class="k">global</span> <span class="n">max_memuse</span>
</span><span id="set_memlimit-1813"><a href="#set_memlimit-1813"><span class="linenos">1813</span></a>    <span class="k">global</span> <span class="n">real_max_memuse</span>
</span><span id="set_memlimit-1814"><a href="#set_memlimit-1814"><span class="linenos">1814</span></a>    <span class="n">sizes</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="set_memlimit-1815"><a href="#set_memlimit-1815"><span class="linenos">1815</span></a>        <span class="s1">&#39;k&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
</span><span id="set_memlimit-1816"><a href="#set_memlimit-1816"><span class="linenos">1816</span></a>        <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="n">_1M</span><span class="p">,</span>
</span><span id="set_memlimit-1817"><a href="#set_memlimit-1817"><span class="linenos">1817</span></a>        <span class="s1">&#39;g&#39;</span><span class="p">:</span> <span class="n">_1G</span><span class="p">,</span>
</span><span id="set_memlimit-1818"><a href="#set_memlimit-1818"><span class="linenos">1818</span></a>        <span class="s1">&#39;t&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="o">*</span><span class="n">_1G</span><span class="p">,</span>
</span><span id="set_memlimit-1819"><a href="#set_memlimit-1819"><span class="linenos">1819</span></a>    <span class="p">}</span>
</span><span id="set_memlimit-1820"><a href="#set_memlimit-1820"><span class="linenos">1820</span></a>    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\d+(\.\d+)?) (K|M|G|T)b?$&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span>
</span><span id="set_memlimit-1821"><a href="#set_memlimit-1821"><span class="linenos">1821</span></a>                 <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span> <span class="o">|</span> <span class="n">re</span><span class="o">.</span><span class="n">VERBOSE</span><span class="p">)</span>
</span><span id="set_memlimit-1822"><a href="#set_memlimit-1822"><span class="linenos">1822</span></a>    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="set_memlimit-1823"><a href="#set_memlimit-1823"><span class="linenos">1823</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid memory limit </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">limit</span><span class="p">,))</span>
</span><span id="set_memlimit-1824"><a href="#set_memlimit-1824"><span class="linenos">1824</span></a>    <span class="n">memlimit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">sizes</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()])</span>
</span><span id="set_memlimit-1825"><a href="#set_memlimit-1825"><span class="linenos">1825</span></a>    <span class="n">real_max_memuse</span> <span class="o">=</span> <span class="n">memlimit</span>
</span><span id="set_memlimit-1826"><a href="#set_memlimit-1826"><span class="linenos">1826</span></a>    <span class="k">if</span> <span class="n">memlimit</span> <span class="o">&gt;</span> <span class="n">MAX_Py_ssize_t</span><span class="p">:</span>
</span><span id="set_memlimit-1827"><a href="#set_memlimit-1827"><span class="linenos">1827</span></a>        <span class="n">memlimit</span> <span class="o">=</span> <span class="n">MAX_Py_ssize_t</span>
</span><span id="set_memlimit-1828"><a href="#set_memlimit-1828"><span class="linenos">1828</span></a>    <span class="k">if</span> <span class="n">memlimit</span> <span class="o">&lt;</span> <span class="n">_2G</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="set_memlimit-1829"><a href="#set_memlimit-1829"><span class="linenos">1829</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Memory limit </span><span class="si">%r</span><span class="s1"> too low to be useful&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">limit</span><span class="p">,))</span>
</span><span id="set_memlimit-1830"><a href="#set_memlimit-1830"><span class="linenos">1830</span></a>    <span class="n">max_memuse</span> <span class="o">=</span> <span class="n">memlimit</span>
</span></pre></div>


    

                </section>
                <section id="SuppressCrashReport">
                            <input id="SuppressCrashReport-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SuppressCrashReport</span>:

                <label class="view-source-button" for="SuppressCrashReport-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SuppressCrashReport"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SuppressCrashReport-2850"><a href="#SuppressCrashReport-2850"><span class="linenos">2850</span></a><span class="k">class</span> <span class="nc">SuppressCrashReport</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2851"><a href="#SuppressCrashReport-2851"><span class="linenos">2851</span></a>    <span class="sd">&quot;&quot;&quot;Try to prevent a crash report from popping up.</span>
</span><span id="SuppressCrashReport-2852"><a href="#SuppressCrashReport-2852"><span class="linenos">2852</span></a>
</span><span id="SuppressCrashReport-2853"><a href="#SuppressCrashReport-2853"><span class="linenos">2853</span></a><span class="sd">    On Windows, don&#39;t display the Windows Error Reporting dialog.  On UNIX,</span>
</span><span id="SuppressCrashReport-2854"><a href="#SuppressCrashReport-2854"><span class="linenos">2854</span></a><span class="sd">    disable the creation of coredump file.</span>
</span><span id="SuppressCrashReport-2855"><a href="#SuppressCrashReport-2855"><span class="linenos">2855</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="SuppressCrashReport-2856"><a href="#SuppressCrashReport-2856"><span class="linenos">2856</span></a>    <span class="n">old_value</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SuppressCrashReport-2857"><a href="#SuppressCrashReport-2857"><span class="linenos">2857</span></a>    <span class="n">old_modes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="SuppressCrashReport-2858"><a href="#SuppressCrashReport-2858"><span class="linenos">2858</span></a>
</span><span id="SuppressCrashReport-2859"><a href="#SuppressCrashReport-2859"><span class="linenos">2859</span></a>    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SuppressCrashReport-2860"><a href="#SuppressCrashReport-2860"><span class="linenos">2860</span></a>        <span class="sd">&quot;&quot;&quot;On Windows, disable Windows Error Reporting dialogs using</span>
</span><span id="SuppressCrashReport-2861"><a href="#SuppressCrashReport-2861"><span class="linenos">2861</span></a><span class="sd">        SetErrorMode() and CrtSetReportMode().</span>
</span><span id="SuppressCrashReport-2862"><a href="#SuppressCrashReport-2862"><span class="linenos">2862</span></a>
</span><span id="SuppressCrashReport-2863"><a href="#SuppressCrashReport-2863"><span class="linenos">2863</span></a><span class="sd">        On UNIX, try to save the previous core file size limit, then set</span>
</span><span id="SuppressCrashReport-2864"><a href="#SuppressCrashReport-2864"><span class="linenos">2864</span></a><span class="sd">        soft limit to 0.</span>
</span><span id="SuppressCrashReport-2865"><a href="#SuppressCrashReport-2865"><span class="linenos">2865</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SuppressCrashReport-2866"><a href="#SuppressCrashReport-2866"><span class="linenos">2866</span></a>        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">):</span>
</span><span id="SuppressCrashReport-2867"><a href="#SuppressCrashReport-2867"><span class="linenos">2867</span></a>            <span class="c1"># see http://msdn.microsoft.com/en-us/library/windows/desktop/ms680621.aspx</span>
</span><span id="SuppressCrashReport-2868"><a href="#SuppressCrashReport-2868"><span class="linenos">2868</span></a>            <span class="c1"># GetErrorMode is not available on Windows XP and Windows Server 2003,</span>
</span><span id="SuppressCrashReport-2869"><a href="#SuppressCrashReport-2869"><span class="linenos">2869</span></a>            <span class="c1"># but SetErrorMode returns the previous value, so we can use that</span>
</span><span id="SuppressCrashReport-2870"><a href="#SuppressCrashReport-2870"><span class="linenos">2870</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2871"><a href="#SuppressCrashReport-2871"><span class="linenos">2871</span></a>                <span class="kn">import</span> <span class="nn">msvcrt</span>
</span><span id="SuppressCrashReport-2872"><a href="#SuppressCrashReport-2872"><span class="linenos">2872</span></a>            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2873"><a href="#SuppressCrashReport-2873"><span class="linenos">2873</span></a>                <span class="k">return</span>
</span><span id="SuppressCrashReport-2874"><a href="#SuppressCrashReport-2874"><span class="linenos">2874</span></a>
</span><span id="SuppressCrashReport-2875"><a href="#SuppressCrashReport-2875"><span class="linenos">2875</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_NOGPFAULTERRORBOX</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2876"><a href="#SuppressCrashReport-2876"><span class="linenos">2876</span></a>
</span><span id="SuppressCrashReport-2877"><a href="#SuppressCrashReport-2877"><span class="linenos">2877</span></a>            <span class="n">msvcrt</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">|</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">SEM_NOGPFAULTERRORBOX</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2878"><a href="#SuppressCrashReport-2878"><span class="linenos">2878</span></a>
</span><span id="SuppressCrashReport-2879"><a href="#SuppressCrashReport-2879"><span class="linenos">2879</span></a>            <span class="c1"># bpo-23314: Suppress assert dialogs in debug builds.</span>
</span><span id="SuppressCrashReport-2880"><a href="#SuppressCrashReport-2880"><span class="linenos">2880</span></a>            <span class="c1"># CrtSetReportMode() is only available in debug build.</span>
</span><span id="SuppressCrashReport-2881"><a href="#SuppressCrashReport-2881"><span class="linenos">2881</span></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msvcrt</span><span class="p">,</span> <span class="s1">&#39;CrtSetReportMode&#39;</span><span class="p">):</span>
</span><span id="SuppressCrashReport-2882"><a href="#SuppressCrashReport-2882"><span class="linenos">2882</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">old_modes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SuppressCrashReport-2883"><a href="#SuppressCrashReport-2883"><span class="linenos">2883</span></a>                <span class="k">for</span> <span class="n">report_type</span> <span class="ow">in</span> <span class="p">[</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_WARN</span><span class="p">,</span>
</span><span id="SuppressCrashReport-2884"><a href="#SuppressCrashReport-2884"><span class="linenos">2884</span></a>                                    <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ERROR</span><span class="p">,</span>
</span><span id="SuppressCrashReport-2885"><a href="#SuppressCrashReport-2885"><span class="linenos">2885</span></a>                                    <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ASSERT</span><span class="p">]:</span>
</span><span id="SuppressCrashReport-2886"><a href="#SuppressCrashReport-2886"><span class="linenos">2886</span></a>                    <span class="n">old_mode</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span>
</span><span id="SuppressCrashReport-2887"><a href="#SuppressCrashReport-2887"><span class="linenos">2887</span></a>                            <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRTDBG_MODE_FILE</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2888"><a href="#SuppressCrashReport-2888"><span class="linenos">2888</span></a>                    <span class="n">old_file</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportFile</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span>
</span><span id="SuppressCrashReport-2889"><a href="#SuppressCrashReport-2889"><span class="linenos">2889</span></a>                            <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRTDBG_FILE_STDERR</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2890"><a href="#SuppressCrashReport-2890"><span class="linenos">2890</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">old_modes</span><span class="p">[</span><span class="n">report_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_mode</span><span class="p">,</span> <span class="n">old_file</span>
</span><span id="SuppressCrashReport-2891"><a href="#SuppressCrashReport-2891"><span class="linenos">2891</span></a>
</span><span id="SuppressCrashReport-2892"><a href="#SuppressCrashReport-2892"><span class="linenos">2892</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2893"><a href="#SuppressCrashReport-2893"><span class="linenos">2893</span></a>            <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2894"><a href="#SuppressCrashReport-2894"><span class="linenos">2894</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2895"><a href="#SuppressCrashReport-2895"><span class="linenos">2895</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="o">=</span> <span class="n">resource</span><span class="o">.</span><span class="n">getrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2896"><a href="#SuppressCrashReport-2896"><span class="linenos">2896</span></a>                    <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">,</span>
</span><span id="SuppressCrashReport-2897"><a href="#SuppressCrashReport-2897"><span class="linenos">2897</span></a>                                       <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span><span id="SuppressCrashReport-2898"><a href="#SuppressCrashReport-2898"><span class="linenos">2898</span></a>                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
</span><span id="SuppressCrashReport-2899"><a href="#SuppressCrashReport-2899"><span class="linenos">2899</span></a>                    <span class="k">pass</span>
</span><span id="SuppressCrashReport-2900"><a href="#SuppressCrashReport-2900"><span class="linenos">2900</span></a>
</span><span id="SuppressCrashReport-2901"><a href="#SuppressCrashReport-2901"><span class="linenos">2901</span></a>            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;darwin&#39;</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2902"><a href="#SuppressCrashReport-2902"><span class="linenos">2902</span></a>                <span class="c1"># Check if the &#39;Crash Reporter&#39; on OSX was configured</span>
</span><span id="SuppressCrashReport-2903"><a href="#SuppressCrashReport-2903"><span class="linenos">2903</span></a>                <span class="c1"># in &#39;Developer&#39; mode and warn that it will get triggered</span>
</span><span id="SuppressCrashReport-2904"><a href="#SuppressCrashReport-2904"><span class="linenos">2904</span></a>                <span class="c1"># when it is.</span>
</span><span id="SuppressCrashReport-2905"><a href="#SuppressCrashReport-2905"><span class="linenos">2905</span></a>                <span class="c1">#</span>
</span><span id="SuppressCrashReport-2906"><a href="#SuppressCrashReport-2906"><span class="linenos">2906</span></a>                <span class="c1"># This assumes that this context manager is used in tests</span>
</span><span id="SuppressCrashReport-2907"><a href="#SuppressCrashReport-2907"><span class="linenos">2907</span></a>                <span class="c1"># that might trigger the next manager.</span>
</span><span id="SuppressCrashReport-2908"><a href="#SuppressCrashReport-2908"><span class="linenos">2908</span></a>                <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/usr/bin/defaults&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span>
</span><span id="SuppressCrashReport-2909"><a href="#SuppressCrashReport-2909"><span class="linenos">2909</span></a>                       <span class="s1">&#39;com.apple.CrashReporter&#39;</span><span class="p">,</span> <span class="s1">&#39;DialogType&#39;</span><span class="p">]</span>
</span><span id="SuppressCrashReport-2910"><a href="#SuppressCrashReport-2910"><span class="linenos">2910</span></a>                <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span>
</span><span id="SuppressCrashReport-2911"><a href="#SuppressCrashReport-2911"><span class="linenos">2911</span></a>                                        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
</span><span id="SuppressCrashReport-2912"><a href="#SuppressCrashReport-2912"><span class="linenos">2912</span></a>                                        <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2913"><a href="#SuppressCrashReport-2913"><span class="linenos">2913</span></a>                <span class="k">with</span> <span class="n">proc</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2914"><a href="#SuppressCrashReport-2914"><span class="linenos">2914</span></a>                    <span class="n">stdout</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="SuppressCrashReport-2915"><a href="#SuppressCrashReport-2915"><span class="linenos">2915</span></a>                <span class="k">if</span> <span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;developer&#39;</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2916"><a href="#SuppressCrashReport-2916"><span class="linenos">2916</span></a>                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;this test triggers the Crash Reporter, &quot;</span>
</span><span id="SuppressCrashReport-2917"><a href="#SuppressCrashReport-2917"><span class="linenos">2917</span></a>                          <span class="s2">&quot;that is intentional&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2918"><a href="#SuppressCrashReport-2918"><span class="linenos">2918</span></a>
</span><span id="SuppressCrashReport-2919"><a href="#SuppressCrashReport-2919"><span class="linenos">2919</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="SuppressCrashReport-2920"><a href="#SuppressCrashReport-2920"><span class="linenos">2920</span></a>
</span><span id="SuppressCrashReport-2921"><a href="#SuppressCrashReport-2921"><span class="linenos">2921</span></a>    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">ignore_exc</span><span class="p">):</span>
</span><span id="SuppressCrashReport-2922"><a href="#SuppressCrashReport-2922"><span class="linenos">2922</span></a>        <span class="sd">&quot;&quot;&quot;Restore Windows ErrorMode or core file behavior to initial value.&quot;&quot;&quot;</span>
</span><span id="SuppressCrashReport-2923"><a href="#SuppressCrashReport-2923"><span class="linenos">2923</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2924"><a href="#SuppressCrashReport-2924"><span class="linenos">2924</span></a>            <span class="k">return</span>
</span><span id="SuppressCrashReport-2925"><a href="#SuppressCrashReport-2925"><span class="linenos">2925</span></a>
</span><span id="SuppressCrashReport-2926"><a href="#SuppressCrashReport-2926"><span class="linenos">2926</span></a>        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">):</span>
</span><span id="SuppressCrashReport-2927"><a href="#SuppressCrashReport-2927"><span class="linenos">2927</span></a>            <span class="kn">import</span> <span class="nn">msvcrt</span>
</span><span id="SuppressCrashReport-2928"><a href="#SuppressCrashReport-2928"><span class="linenos">2928</span></a>            <span class="n">msvcrt</span><span class="o">.</span><span class="n">SetErrorMode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_value</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2929"><a href="#SuppressCrashReport-2929"><span class="linenos">2929</span></a>
</span><span id="SuppressCrashReport-2930"><a href="#SuppressCrashReport-2930"><span class="linenos">2930</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_modes</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2931"><a href="#SuppressCrashReport-2931"><span class="linenos">2931</span></a>                <span class="k">for</span> <span class="n">report_type</span><span class="p">,</span> <span class="p">(</span><span class="n">old_mode</span><span class="p">,</span> <span class="n">old_file</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="SuppressCrashReport-2932"><a href="#SuppressCrashReport-2932"><span class="linenos">2932</span></a>                    <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span> <span class="n">old_mode</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2933"><a href="#SuppressCrashReport-2933"><span class="linenos">2933</span></a>                    <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportFile</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span> <span class="n">old_file</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2934"><a href="#SuppressCrashReport-2934"><span class="linenos">2934</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2935"><a href="#SuppressCrashReport-2935"><span class="linenos">2935</span></a>            <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2936"><a href="#SuppressCrashReport-2936"><span class="linenos">2936</span></a>                <span class="k">try</span><span class="p">:</span>
</span><span id="SuppressCrashReport-2937"><a href="#SuppressCrashReport-2937"><span class="linenos">2937</span></a>                    <span class="n">resource</span><span class="o">.</span><span class="n">setrlimit</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">RLIMIT_CORE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_value</span><span class="p">)</span>
</span><span id="SuppressCrashReport-2938"><a href="#SuppressCrashReport-2938"><span class="linenos">2938</span></a>                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
</span><span id="SuppressCrashReport-2939"><a href="#SuppressCrashReport-2939"><span class="linenos">2939</span></a>                    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Try to prevent a crash report from popping up.</p>

<p>On Windows, don't display the Windows Error Reporting dialog.  On UNIX,
disable the creation of coredump file.</p>
</div>


                            <div id="SuppressCrashReport.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">SuppressCrashReport</span><span class="signature pdoc-code condensed">()</span>

        
    </div>
    <a class="headerlink" href="#SuppressCrashReport.__init__"></a>
    
    

                            </div>
                            <div id="SuppressCrashReport.old_value" class="classattr">
                                <div class="attr variable">
            <span class="name">old_value</span><span class="default_value"> = None</span>

        
    </div>
    <a class="headerlink" href="#SuppressCrashReport.old_value"></a>
    
    

                            </div>
                            <div id="SuppressCrashReport.old_modes" class="classattr">
                                <div class="attr variable">
            <span class="name">old_modes</span><span class="default_value"> = None</span>

        
    </div>
    <a class="headerlink" href="#SuppressCrashReport.old_modes"></a>
    
    

                            </div>
                </section>
                <section id="sortdict">
                            <input id="sortdict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sortdict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="nb">dict</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="sortdict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#sortdict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="sortdict-1143"><a href="#sortdict-1143"><span class="linenos">1143</span></a><span class="k">def</span> <span class="nf">sortdict</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
</span><span id="sortdict-1144"><a href="#sortdict-1144"><span class="linenos">1144</span></a>    <span class="s2">&quot;Like repr(dict), but in sorted order.&quot;</span>
</span><span id="sortdict-1145"><a href="#sortdict-1145"><span class="linenos">1145</span></a>    <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span><span id="sortdict-1146"><a href="#sortdict-1146"><span class="linenos">1146</span></a>    <span class="n">reprpairs</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2">: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pair</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
</span><span id="sortdict-1147"><a href="#sortdict-1147"><span class="linenos">1147</span></a>    <span class="n">withcommas</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">reprpairs</span><span class="p">)</span>
</span><span id="sortdict-1148"><a href="#sortdict-1148"><span class="linenos">1148</span></a>    <span class="k">return</span> <span class="s2">&quot;{</span><span class="si">%s</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">withcommas</span>
</span></pre></div>


            <div class="docstring"><p>Like repr(dict), but in sorted order.</p>
</div>


                </section>
                <section id="run_with_tz">
                            <input id="run_with_tz-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run_with_tz</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">tz</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="run_with_tz-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#run_with_tz"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="run_with_tz-1769"><a href="#run_with_tz-1769"><span class="linenos">1769</span></a><span class="k">def</span> <span class="nf">run_with_tz</span><span class="p">(</span><span class="n">tz</span><span class="p">):</span>
</span><span id="run_with_tz-1770"><a href="#run_with_tz-1770"><span class="linenos">1770</span></a>    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
</span><span id="run_with_tz-1771"><a href="#run_with_tz-1771"><span class="linenos">1771</span></a>        <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
</span><span id="run_with_tz-1772"><a href="#run_with_tz-1772"><span class="linenos">1772</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="run_with_tz-1773"><a href="#run_with_tz-1773"><span class="linenos">1773</span></a>                <span class="n">tzset</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">tzset</span>
</span><span id="run_with_tz-1774"><a href="#run_with_tz-1774"><span class="linenos">1774</span></a>            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
</span><span id="run_with_tz-1775"><a href="#run_with_tz-1775"><span class="linenos">1775</span></a>                <span class="k">raise</span> <span class="n">unittest</span><span class="o">.</span><span class="n">SkipTest</span><span class="p">(</span><span class="s2">&quot;tzset required&quot;</span><span class="p">)</span>
</span><span id="run_with_tz-1776"><a href="#run_with_tz-1776"><span class="linenos">1776</span></a>            <span class="k">if</span> <span class="s1">&#39;TZ&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
</span><span id="run_with_tz-1777"><a href="#run_with_tz-1777"><span class="linenos">1777</span></a>                <span class="n">orig_tz</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TZ&#39;</span><span class="p">]</span>
</span><span id="run_with_tz-1778"><a href="#run_with_tz-1778"><span class="linenos">1778</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="run_with_tz-1779"><a href="#run_with_tz-1779"><span class="linenos">1779</span></a>                <span class="n">orig_tz</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="run_with_tz-1780"><a href="#run_with_tz-1780"><span class="linenos">1780</span></a>            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tz</span>
</span><span id="run_with_tz-1781"><a href="#run_with_tz-1781"><span class="linenos">1781</span></a>            <span class="n">tzset</span><span class="p">()</span>
</span><span id="run_with_tz-1782"><a href="#run_with_tz-1782"><span class="linenos">1782</span></a>
</span><span id="run_with_tz-1783"><a href="#run_with_tz-1783"><span class="linenos">1783</span></a>            <span class="c1"># now run the function, resetting the tz on exceptions</span>
</span><span id="run_with_tz-1784"><a href="#run_with_tz-1784"><span class="linenos">1784</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="run_with_tz-1785"><a href="#run_with_tz-1785"><span class="linenos">1785</span></a>                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
</span><span id="run_with_tz-1786"><a href="#run_with_tz-1786"><span class="linenos">1786</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="run_with_tz-1787"><a href="#run_with_tz-1787"><span class="linenos">1787</span></a>                <span class="k">if</span> <span class="n">orig_tz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="run_with_tz-1788"><a href="#run_with_tz-1788"><span class="linenos">1788</span></a>                    <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TZ&#39;</span><span class="p">]</span>
</span><span id="run_with_tz-1789"><a href="#run_with_tz-1789"><span class="linenos">1789</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="run_with_tz-1790"><a href="#run_with_tz-1790"><span class="linenos">1790</span></a>                    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;TZ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_tz</span>
</span><span id="run_with_tz-1791"><a href="#run_with_tz-1791"><span class="linenos">1791</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">tzset</span><span class="p">()</span>
</span><span id="run_with_tz-1792"><a href="#run_with_tz-1792"><span class="linenos">1792</span></a>
</span><span id="run_with_tz-1793"><a href="#run_with_tz-1793"><span class="linenos">1793</span></a>        <span class="n">inner</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="run_with_tz-1794"><a href="#run_with_tz-1794"><span class="linenos">1794</span></a>        <span class="n">inner</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span id="run_with_tz-1795"><a href="#run_with_tz-1795"><span class="linenos">1795</span></a>        <span class="k">return</span> <span class="n">inner</span>
</span><span id="run_with_tz-1796"><a href="#run_with_tz-1796"><span class="linenos">1796</span></a>    <span class="k">return</span> <span class="n">decorator</span>
</span></pre></div>


    

                </section>
                <section id="PGO">
                    <div class="attr variable">
            <span class="name">PGO</span><span class="default_value"> = False</span>

        
    </div>
    <a class="headerlink" href="#PGO"></a>
    
    

                </section>
                <section id="missing_compiler_executable">
                            <input id="missing_compiler_executable-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">missing_compiler_executable</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">cmd_names</span><span class="o">=</span><span class="p">[]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="missing_compiler_executable-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#missing_compiler_executable"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="missing_compiler_executable-3015"><a href="#missing_compiler_executable-3015"><span class="linenos">3015</span></a><span class="k">def</span> <span class="nf">missing_compiler_executable</span><span class="p">(</span><span class="n">cmd_names</span><span class="o">=</span><span class="p">[]):</span>
</span><span id="missing_compiler_executable-3016"><a href="#missing_compiler_executable-3016"><span class="linenos">3016</span></a>    <span class="sd">&quot;&quot;&quot;Check if the compiler components used to build the interpreter exist.</span>
</span><span id="missing_compiler_executable-3017"><a href="#missing_compiler_executable-3017"><span class="linenos">3017</span></a>
</span><span id="missing_compiler_executable-3018"><a href="#missing_compiler_executable-3018"><span class="linenos">3018</span></a><span class="sd">    Check for the existence of the compiler executables whose names are listed</span>
</span><span id="missing_compiler_executable-3019"><a href="#missing_compiler_executable-3019"><span class="linenos">3019</span></a><span class="sd">    in &#39;cmd_names&#39; or all the compiler executables when &#39;cmd_names&#39; is empty</span>
</span><span id="missing_compiler_executable-3020"><a href="#missing_compiler_executable-3020"><span class="linenos">3020</span></a><span class="sd">    and return the first missing executable or None when none is found</span>
</span><span id="missing_compiler_executable-3021"><a href="#missing_compiler_executable-3021"><span class="linenos">3021</span></a><span class="sd">    missing.</span>
</span><span id="missing_compiler_executable-3022"><a href="#missing_compiler_executable-3022"><span class="linenos">3022</span></a>
</span><span id="missing_compiler_executable-3023"><a href="#missing_compiler_executable-3023"><span class="linenos">3023</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="missing_compiler_executable-3024"><a href="#missing_compiler_executable-3024"><span class="linenos">3024</span></a>    <span class="kn">from</span> <span class="nn">distutils</span> <span class="kn">import</span> <span class="n">ccompiler</span><span class="p">,</span> <span class="n">sysconfig</span><span class="p">,</span> <span class="n">spawn</span>
</span><span id="missing_compiler_executable-3025"><a href="#missing_compiler_executable-3025"><span class="linenos">3025</span></a>    <span class="n">compiler</span> <span class="o">=</span> <span class="n">ccompiler</span><span class="o">.</span><span class="n">new_compiler</span><span class="p">()</span>
</span><span id="missing_compiler_executable-3026"><a href="#missing_compiler_executable-3026"><span class="linenos">3026</span></a>    <span class="n">sysconfig</span><span class="o">.</span><span class="n">customize_compiler</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
</span><span id="missing_compiler_executable-3027"><a href="#missing_compiler_executable-3027"><span class="linenos">3027</span></a>    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">compiler</span><span class="o">.</span><span class="n">executables</span><span class="p">:</span>
</span><span id="missing_compiler_executable-3028"><a href="#missing_compiler_executable-3028"><span class="linenos">3028</span></a>        <span class="k">if</span> <span class="n">cmd_names</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cmd_names</span><span class="p">:</span>
</span><span id="missing_compiler_executable-3029"><a href="#missing_compiler_executable-3029"><span class="linenos">3029</span></a>            <span class="k">continue</span>
</span><span id="missing_compiler_executable-3030"><a href="#missing_compiler_executable-3030"><span class="linenos">3030</span></a>        <span class="n">cmd</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="missing_compiler_executable-3031"><a href="#missing_compiler_executable-3031"><span class="linenos">3031</span></a>        <span class="k">if</span> <span class="n">cmd_names</span><span class="p">:</span>
</span><span id="missing_compiler_executable-3032"><a href="#missing_compiler_executable-3032"><span class="linenos">3032</span></a>            <span class="k">assert</span> <span class="n">cmd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> \
</span><span id="missing_compiler_executable-3033"><a href="#missing_compiler_executable-3033"><span class="linenos">3033</span></a>                    <span class="s2">&quot;the &#39;</span><span class="si">%s</span><span class="s2">&#39; executable is not configured&quot;</span> <span class="o">%</span> <span class="n">name</span>
</span><span id="missing_compiler_executable-3034"><a href="#missing_compiler_executable-3034"><span class="linenos">3034</span></a>        <span class="k">elif</span> <span class="ow">not</span> <span class="n">cmd</span><span class="p">:</span>
</span><span id="missing_compiler_executable-3035"><a href="#missing_compiler_executable-3035"><span class="linenos">3035</span></a>            <span class="k">continue</span>
</span><span id="missing_compiler_executable-3036"><a href="#missing_compiler_executable-3036"><span class="linenos">3036</span></a>        <span class="k">if</span> <span class="n">spawn</span><span class="o">.</span><span class="n">find_executable</span><span class="p">(</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="missing_compiler_executable-3037"><a href="#missing_compiler_executable-3037"><span class="linenos">3037</span></a>            <span class="k">return</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Check if the compiler components used to build the interpreter exist.</p>

<p>Check for the existence of the compiler executables whose names are listed
in 'cmd_names' or all the compiler executables when 'cmd_names' is empty
and return the first missing executable or None when none is found
missing.</p>
</div>


                </section>
                <section id="fd_count">
                            <input id="fd_count-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fd_count</span><span class="signature pdoc-code condensed">(<span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fd_count-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fd_count"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fd_count-3071"><a href="#fd_count-3071"><span class="linenos">3071</span></a><span class="k">def</span> <span class="nf">fd_count</span><span class="p">():</span>
</span><span id="fd_count-3072"><a href="#fd_count-3072"><span class="linenos">3072</span></a>    <span class="sd">&quot;&quot;&quot;Count the number of open file descriptors.</span>
</span><span id="fd_count-3073"><a href="#fd_count-3073"><span class="linenos">3073</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="fd_count-3074"><a href="#fd_count-3074"><span class="linenos">3074</span></a>    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="s1">&#39;freebsd&#39;</span><span class="p">)):</span>
</span><span id="fd_count-3075"><a href="#fd_count-3075"><span class="linenos">3075</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="fd_count-3076"><a href="#fd_count-3076"><span class="linenos">3076</span></a>            <span class="n">names</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s2">&quot;/proc/self/fd&quot;</span><span class="p">)</span>
</span><span id="fd_count-3077"><a href="#fd_count-3077"><span class="linenos">3077</span></a>            <span class="c1"># Subtract one because listdir() internally opens a file</span>
</span><span id="fd_count-3078"><a href="#fd_count-3078"><span class="linenos">3078</span></a>            <span class="c1"># descriptor to list the content of the /proc/self/fd/ directory.</span>
</span><span id="fd_count-3079"><a href="#fd_count-3079"><span class="linenos">3079</span></a>            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="fd_count-3080"><a href="#fd_count-3080"><span class="linenos">3080</span></a>        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
</span><span id="fd_count-3081"><a href="#fd_count-3081"><span class="linenos">3081</span></a>            <span class="k">pass</span>
</span><span id="fd_count-3082"><a href="#fd_count-3082"><span class="linenos">3082</span></a>
</span><span id="fd_count-3083"><a href="#fd_count-3083"><span class="linenos">3083</span></a>    <span class="n">MAXFD</span> <span class="o">=</span> <span class="mi">256</span>
</span><span id="fd_count-3084"><a href="#fd_count-3084"><span class="linenos">3084</span></a>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s1">&#39;sysconf&#39;</span><span class="p">):</span>
</span><span id="fd_count-3085"><a href="#fd_count-3085"><span class="linenos">3085</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="fd_count-3086"><a href="#fd_count-3086"><span class="linenos">3086</span></a>            <span class="n">MAXFD</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s2">&quot;SC_OPEN_MAX&quot;</span><span class="p">)</span>
</span><span id="fd_count-3087"><a href="#fd_count-3087"><span class="linenos">3087</span></a>        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
</span><span id="fd_count-3088"><a href="#fd_count-3088"><span class="linenos">3088</span></a>            <span class="k">pass</span>
</span><span id="fd_count-3089"><a href="#fd_count-3089"><span class="linenos">3089</span></a>
</span><span id="fd_count-3090"><a href="#fd_count-3090"><span class="linenos">3090</span></a>    <span class="n">old_modes</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="fd_count-3091"><a href="#fd_count-3091"><span class="linenos">3091</span></a>    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s1">&#39;win32&#39;</span><span class="p">:</span>
</span><span id="fd_count-3092"><a href="#fd_count-3092"><span class="linenos">3092</span></a>        <span class="c1"># bpo-25306, bpo-31009: Call CrtSetReportMode() to not kill the process</span>
</span><span id="fd_count-3093"><a href="#fd_count-3093"><span class="linenos">3093</span></a>        <span class="c1"># on invalid file descriptor if Python is compiled in debug mode</span>
</span><span id="fd_count-3094"><a href="#fd_count-3094"><span class="linenos">3094</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="fd_count-3095"><a href="#fd_count-3095"><span class="linenos">3095</span></a>            <span class="kn">import</span> <span class="nn">msvcrt</span>
</span><span id="fd_count-3096"><a href="#fd_count-3096"><span class="linenos">3096</span></a>            <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span>
</span><span id="fd_count-3097"><a href="#fd_count-3097"><span class="linenos">3097</span></a>        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
</span><span id="fd_count-3098"><a href="#fd_count-3098"><span class="linenos">3098</span></a>            <span class="c1"># no msvcrt or a release build</span>
</span><span id="fd_count-3099"><a href="#fd_count-3099"><span class="linenos">3099</span></a>            <span class="k">pass</span>
</span><span id="fd_count-3100"><a href="#fd_count-3100"><span class="linenos">3100</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="fd_count-3101"><a href="#fd_count-3101"><span class="linenos">3101</span></a>            <span class="n">old_modes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="fd_count-3102"><a href="#fd_count-3102"><span class="linenos">3102</span></a>            <span class="k">for</span> <span class="n">report_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_WARN</span><span class="p">,</span>
</span><span id="fd_count-3103"><a href="#fd_count-3103"><span class="linenos">3103</span></a>                                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ERROR</span><span class="p">,</span>
</span><span id="fd_count-3104"><a href="#fd_count-3104"><span class="linenos">3104</span></a>                                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ASSERT</span><span class="p">):</span>
</span><span id="fd_count-3105"><a href="#fd_count-3105"><span class="linenos">3105</span></a>                <span class="n">old_modes</span><span class="p">[</span><span class="n">report_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="fd_count-3106"><a href="#fd_count-3106"><span class="linenos">3106</span></a>
</span><span id="fd_count-3107"><a href="#fd_count-3107"><span class="linenos">3107</span></a>    <span class="k">try</span><span class="p">:</span>
</span><span id="fd_count-3108"><a href="#fd_count-3108"><span class="linenos">3108</span></a>        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="fd_count-3109"><a href="#fd_count-3109"><span class="linenos">3109</span></a>        <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAXFD</span><span class="p">):</span>
</span><span id="fd_count-3110"><a href="#fd_count-3110"><span class="linenos">3110</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="fd_count-3111"><a href="#fd_count-3111"><span class="linenos">3111</span></a>                <span class="c1"># Prefer dup() over fstat(). fstat() can require input/output</span>
</span><span id="fd_count-3112"><a href="#fd_count-3112"><span class="linenos">3112</span></a>                <span class="c1"># whereas dup() doesn&#39;t.</span>
</span><span id="fd_count-3113"><a href="#fd_count-3113"><span class="linenos">3113</span></a>                <span class="n">fd2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</span><span id="fd_count-3114"><a href="#fd_count-3114"><span class="linenos">3114</span></a>            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="fd_count-3115"><a href="#fd_count-3115"><span class="linenos">3115</span></a>                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EBADF</span><span class="p">:</span>
</span><span id="fd_count-3116"><a href="#fd_count-3116"><span class="linenos">3116</span></a>                    <span class="k">raise</span>
</span><span id="fd_count-3117"><a href="#fd_count-3117"><span class="linenos">3117</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="fd_count-3118"><a href="#fd_count-3118"><span class="linenos">3118</span></a>                <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fd2</span><span class="p">)</span>
</span><span id="fd_count-3119"><a href="#fd_count-3119"><span class="linenos">3119</span></a>                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="fd_count-3120"><a href="#fd_count-3120"><span class="linenos">3120</span></a>    <span class="k">finally</span><span class="p">:</span>
</span><span id="fd_count-3121"><a href="#fd_count-3121"><span class="linenos">3121</span></a>        <span class="k">if</span> <span class="n">old_modes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="fd_count-3122"><a href="#fd_count-3122"><span class="linenos">3122</span></a>            <span class="k">for</span> <span class="n">report_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_WARN</span><span class="p">,</span>
</span><span id="fd_count-3123"><a href="#fd_count-3123"><span class="linenos">3123</span></a>                                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ERROR</span><span class="p">,</span>
</span><span id="fd_count-3124"><a href="#fd_count-3124"><span class="linenos">3124</span></a>                                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CRT_ASSERT</span><span class="p">):</span>
</span><span id="fd_count-3125"><a href="#fd_count-3125"><span class="linenos">3125</span></a>                <span class="n">msvcrt</span><span class="o">.</span><span class="n">CrtSetReportMode</span><span class="p">(</span><span class="n">report_type</span><span class="p">,</span> <span class="n">old_modes</span><span class="p">[</span><span class="n">report_type</span><span class="p">])</span>
</span><span id="fd_count-3126"><a href="#fd_count-3126"><span class="linenos">3126</span></a>
</span><span id="fd_count-3127"><a href="#fd_count-3127"><span class="linenos">3127</span></a>    <span class="k">return</span> <span class="n">count</span>
</span></pre></div>


            <div class="docstring"><p>Count the number of open file descriptors.</p>
</div>


                </section>
                <section id="ALWAYS_EQ">
                    <div class="attr variable">
            <span class="name">ALWAYS_EQ</span><span class="default_value"> = &lt;test.support._ALWAYS_EQ object&gt;</span>

        
    </div>
    <a class="headerlink" href="#ALWAYS_EQ"></a>
    
    

                </section>
                <section id="LARGEST">
                    <div class="attr variable">
            <span class="name">LARGEST</span><span class="default_value"> = &lt;test.support._LARGEST object&gt;</span>

        
    </div>
    <a class="headerlink" href="#LARGEST"></a>
    
    

                </section>
                <section id="SMALLEST">
                    <div class="attr variable">
            <span class="name">SMALLEST</span><span class="default_value"> = &lt;test.support._SMALLEST object&gt;</span>

        
    </div>
    <a class="headerlink" href="#SMALLEST"></a>
    
    

                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>